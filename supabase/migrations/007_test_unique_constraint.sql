-- æ¸¬è©¦è…³æœ¬ï¼šé©—è­‰å”¯ä¸€æ€§ç´„æŸæ˜¯å¦æ­£å¸¸é‹ä½œ
-- ç”¨é€”ï¼šç¢ºèª unique_active_listing_per_user_item ç´„æŸèƒ½é˜²æ­¢é‡è¤‡åˆŠç™»
-- åŸ·è¡Œæ–¹å¼ï¼šåœ¨ Supabase Dashboard SQL Editor ä¸­åŸ·è¡Œ
--
-- âš ï¸ æ³¨æ„ï¼šæ­¤è…³æœ¬åƒ…ä¾›æ¸¬è©¦ï¼Œæœƒåœ¨æœ€å¾Œæ¸…ç†æ¸¬è©¦è³‡æ–™

-- ============================================================
-- 1. æª¢æŸ¥å”¯ä¸€ç´¢å¼•æ˜¯å¦å·²å»ºç«‹
-- ============================================================

SELECT
  indexname,
  indexdef
FROM pg_indexes
WHERE indexname = 'unique_active_listing_per_user_item';

-- é æœŸçµæœï¼šæ‡‰è©²è¿”å› 1 ç­†è¨˜éŒ„
-- indexdef æ‡‰åŒ…å« "WHERE ((status = 'active'::text) AND (deleted_at IS NULL))"

-- ============================================================
-- 2. å»ºç«‹æ¸¬è©¦ç”¨æˆ¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
-- ============================================================

DO $$
DECLARE
  test_user_id UUID;
BEGIN
  -- æª¢æŸ¥æ˜¯å¦å·²æœ‰æ¸¬è©¦ç”¨æˆ¶
  SELECT id INTO test_user_id
  FROM users
  WHERE email = 'test_unique_constraint@test.local'
  LIMIT 1;

  -- å¦‚æœæ²’æœ‰ï¼Œå»ºç«‹æ¸¬è©¦ç”¨æˆ¶
  IF test_user_id IS NULL THEN
    INSERT INTO users (id, email, username, created_at)
    VALUES (
      '00000000-0000-0000-0000-000000000001'::UUID,
      'test_unique_constraint@test.local',
      'test_user_unique',
      NOW()
    )
    ON CONFLICT (id) DO NOTHING;

    RAISE NOTICE 'æ¸¬è©¦ç”¨æˆ¶å·²å»ºç«‹ï¼š00000000-0000-0000-0000-000000000001';
  ELSE
    RAISE NOTICE 'æ¸¬è©¦ç”¨æˆ¶å·²å­˜åœ¨ï¼š%', test_user_id;
  END IF;
END $$;

-- ============================================================
-- 3. æ¸¬è©¦ 1ï¼šæ­£å¸¸æ’å…¥ï¼ˆæ‡‰è©²æˆåŠŸï¼‰
-- ============================================================

INSERT INTO listings (
  user_id,
  item_id,
  trade_type,
  price,
  quantity,
  status,
  created_at
) VALUES (
  '00000000-0000-0000-0000-000000000001'::UUID,
  1002000,  -- æ¸¬è©¦ç‰©å“ ID
  'sell',
  1000000,
  1,
  'active',
  NOW()
)
ON CONFLICT DO NOTHING
RETURNING id, item_id, status;

-- é æœŸçµæœï¼šæ‡‰è©²è¿”å› 1 ç­†æ–°æ’å…¥çš„è¨˜éŒ„

RAISE NOTICE 'âœ… æ¸¬è©¦ 1 é€šéï¼šæ­£å¸¸æ’å…¥æˆåŠŸ';

-- ============================================================
-- 4. æ¸¬è©¦ 2ï¼šé‡è¤‡æ’å…¥ç›¸åŒç‰©å“ï¼ˆæ‡‰è©²å¤±æ•—ï¼‰
-- ============================================================

DO $$
BEGIN
  -- å˜—è©¦æ’å…¥é‡è¤‡çš„æ´»èºåˆŠç™»
  INSERT INTO listings (
    user_id,
    item_id,
    trade_type,
    price,
    quantity,
    status,
    created_at
  ) VALUES (
    '00000000-0000-0000-0000-000000000001'::UUID,
    1002000,  -- ç›¸åŒçš„ç‰©å“ ID
    'sell',
    2000000,  -- ä¸åŒçš„åƒ¹æ ¼ï¼ˆä½†ç‰©å“ç›¸åŒï¼‰
    1,
    'active',
    NOW()
  );

  -- å¦‚æœåŸ·è¡Œåˆ°é€™è£¡ï¼Œè¡¨ç¤ºç´„æŸå¤±æ•ˆ
  RAISE EXCEPTION 'âŒ æ¸¬è©¦ 2 å¤±æ•—ï¼šå”¯ä¸€æ€§ç´„æŸæœªç”Ÿæ•ˆï¼';

EXCEPTION
  WHEN unique_violation THEN
    -- é æœŸæœƒæ‹‹å‡ºå”¯ä¸€æ€§é•åéŒ¯èª¤
    RAISE NOTICE 'âœ… æ¸¬è©¦ 2 é€šéï¼šå”¯ä¸€æ€§ç´„æŸæ­£å¸¸é‹ä½œï¼ˆé˜»æ­¢é‡è¤‡åˆŠç™»ï¼‰';
    RAISE NOTICE 'éŒ¯èª¤ä»£ç¢¼ï¼š23505ï¼ˆunique_violationï¼‰';
END $$;

-- ============================================================
-- 5. æ¸¬è©¦ 3ï¼šä¸åŒç‹€æ…‹çš„åˆŠç™»ï¼ˆæ‡‰è©²æˆåŠŸï¼‰
-- ============================================================

INSERT INTO listings (
  user_id,
  item_id,
  trade_type,
  price,
  quantity,
  status,
  created_at
) VALUES (
  '00000000-0000-0000-0000-000000000001'::UUID,
  1002000,  -- ç›¸åŒçš„ç‰©å“ ID
  'sell',
  1500000,
  1,
  'sold',  -- ä¸åŒçš„ç‹€æ…‹ï¼ˆä¸æ˜¯ 'active'ï¼‰
  NOW()
)
RETURNING id, item_id, status;

-- é æœŸçµæœï¼šæ‡‰è©²æˆåŠŸï¼Œå› ç‚º status != 'active'

RAISE NOTICE 'âœ… æ¸¬è©¦ 3 é€šéï¼šä¸åŒç‹€æ…‹çš„åˆŠç™»å¯ä»¥å…±å­˜';

-- ============================================================
-- 6. æ¸¬è©¦ 4ï¼šå·²åˆªé™¤çš„åˆŠç™»ï¼ˆæ‡‰è©²æˆåŠŸï¼‰
-- ============================================================

INSERT INTO listings (
  user_id,
  item_id,
  trade_type,
  price,
  quantity,
  status,
  deleted_at,
  created_at
) VALUES (
  '00000000-0000-0000-0000-000000000001'::UUID,
  1002000,  -- ç›¸åŒçš„ç‰©å“ ID
  'sell',
  1200000,
  1,
  'active',
  NOW(),  -- æ¨™è¨˜ç‚ºå·²åˆªé™¤
  NOW()
)
RETURNING id, item_id, status, deleted_at IS NOT NULL AS is_deleted;

-- é æœŸçµæœï¼šæ‡‰è©²æˆåŠŸï¼Œå› ç‚º deleted_at IS NOT NULL

RAISE NOTICE 'âœ… æ¸¬è©¦ 4 é€šéï¼šå·²åˆªé™¤çš„åˆŠç™»ä¸å—ç´„æŸå½±éŸ¿';

-- ============================================================
-- 7. æ¸¬è©¦ 5ï¼šä¸åŒç”¨æˆ¶åˆŠç™»ç›¸åŒç‰©å“ï¼ˆæ‡‰è©²æˆåŠŸï¼‰
-- ============================================================

-- å»ºç«‹ç¬¬äºŒå€‹æ¸¬è©¦ç”¨æˆ¶
INSERT INTO users (id, email, username, created_at)
VALUES (
  '00000000-0000-0000-0000-000000000002'::UUID,
  'test_unique_constraint_2@test.local',
  'test_user_unique_2',
  NOW()
)
ON CONFLICT (id) DO NOTHING;

INSERT INTO listings (
  user_id,
  item_id,
  trade_type,
  price,
  quantity,
  status,
  created_at
) VALUES (
  '00000000-0000-0000-0000-000000000002'::UUID,  -- ä¸åŒçš„ç”¨æˆ¶
  1002000,  -- ç›¸åŒçš„ç‰©å“ ID
  'sell',
  999999,
  1,
  'active',
  NOW()
)
RETURNING id, user_id, item_id, status;

-- é æœŸçµæœï¼šæ‡‰è©²æˆåŠŸï¼Œå› ç‚º user_id ä¸åŒ

RAISE NOTICE 'âœ… æ¸¬è©¦ 5 é€šéï¼šä¸åŒç”¨æˆ¶å¯ä»¥åˆŠç™»ç›¸åŒç‰©å“';

-- ============================================================
-- 8. æ¸…ç†æ¸¬è©¦è³‡æ–™
-- ============================================================

DELETE FROM listings
WHERE user_id IN (
  '00000000-0000-0000-0000-000000000001'::UUID,
  '00000000-0000-0000-0000-000000000002'::UUID
);

DELETE FROM users
WHERE id IN (
  '00000000-0000-0000-0000-000000000001'::UUID,
  '00000000-0000-0000-0000-000000000002'::UUID
);

RAISE NOTICE 'ğŸ§¹ æ¸¬è©¦è³‡æ–™å·²æ¸…ç†';

-- ============================================================
-- æ¸¬è©¦å®Œæˆï¼
-- ============================================================

RAISE NOTICE '========================================';
RAISE NOTICE 'ğŸ‰ æ‰€æœ‰æ¸¬è©¦é€šéï¼å”¯ä¸€æ€§ç´„æŸé‹ä½œæ­£å¸¸';
RAISE NOTICE '========================================';
RAISE NOTICE '';
RAISE NOTICE 'æ‘˜è¦ï¼š';
RAISE NOTICE 'âœ… æ¸¬è©¦ 1ï¼šæ­£å¸¸æ’å…¥æˆåŠŸ';
RAISE NOTICE 'âœ… æ¸¬è©¦ 2ï¼šé‡è¤‡åˆŠç™»è¢«é˜»æ­¢ï¼ˆ23505 éŒ¯èª¤ï¼‰';
RAISE NOTICE 'âœ… æ¸¬è©¦ 3ï¼šä¸åŒç‹€æ…‹çš„åˆŠç™»å¯ä»¥å…±å­˜';
RAISE NOTICE 'âœ… æ¸¬è©¦ 4ï¼šå·²åˆªé™¤çš„åˆŠç™»ä¸å—ç´„æŸå½±éŸ¿';
RAISE NOTICE 'âœ… æ¸¬è©¦ 5ï¼šä¸åŒç”¨æˆ¶å¯ä»¥åˆŠç™»ç›¸åŒç‰©å“';
RAISE NOTICE '';
RAISE NOTICE 'ä¸‹ä¸€æ­¥ï¼š';
RAISE NOTICE '1. æ›´æ–° API éŒ¯èª¤è™•ç†ï¼Œæ•ç² 23505 éŒ¯èª¤';
RAISE NOTICE '2. è¿”å›å‹å–„çš„éŒ¯èª¤è¨Šæ¯ï¼šã€Œæ‚¨å·²åˆŠç™»æ­¤ç‰©å“ã€';
RAISE NOTICE '3. å‰ç«¯é¡¯ç¤ºé©ç•¶çš„æç¤º';
