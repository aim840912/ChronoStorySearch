# ç„¡ç™»å…¥ç‰©å“æ„å‘ç™»è¨˜ç³»çµ±æ¶æ§‹è¨­è¨ˆ

> **å°ˆæ¡ˆéœ€æ±‚**ï¼šå®Œå…¨ä¿¡ä»»ã€ä¸­å‹è¦æ¨¡ï¼ˆ1200-1600 MAUï¼Œ**åŸºæ–¼å¯¦éš›æµé‡**ï¼‰ã€ç´”è³‡è¨Šåª’åˆã€å…è²»é¡åº¦
>
> **æœ€å¾Œæ›´æ–°**ï¼š2025-10-25 | **ç‰ˆæœ¬**ï¼šv3.1ï¼ˆå¯¦éš›æµé‡ä¿®æ­£ç‰ˆï¼‰
>
> âš ï¸ **é‡è¦**ï¼šå¯¦éš›æµé‡æ•¸æ“šé¡¯ç¤º 1559 visitors/å¤©ï¼Œæ¨ç®— MAU 1200-1600ï¼Œ**å·²è¶…å‡ºå…è²»é¡åº¦**

---

## ç›®éŒ„

1. [ç³»çµ±æ¦‚è¿°](#ç³»çµ±æ¦‚è¿°)
2. [ç³»çµ±æ¶æ§‹](#ç³»çµ±æ¶æ§‹)
3. [è³‡æ–™åº«è¨­è¨ˆ](#è³‡æ–™åº«è¨­è¨ˆ)
4. [API è¨­è¨ˆ](#api-è¨­è¨ˆ)
5. [å®‰å…¨æ€§è¨­è¨ˆ](#å®‰å…¨æ€§è¨­è¨ˆ)
6. [å¯é æ€§è¨­è¨ˆ](#å¯é æ€§è¨­è¨ˆ)
7. [æ•ˆèƒ½å„ªåŒ–](#æ•ˆèƒ½å„ªåŒ–)
8. [ç›£æ§èˆ‡ç¶­è­·](#ç›£æ§èˆ‡ç¶­è­·)
9. [æ¸¬è©¦ç­–ç•¥](#æ¸¬è©¦ç­–ç•¥)
10. [æ“´å±•æ€§è€ƒé‡](#æ“´å±•æ€§è€ƒé‡)
11. [æˆæœ¬é ä¼°](#æˆæœ¬é ä¼°)
12. [å¯¦ä½œè·¯ç·šåœ–](#å¯¦ä½œè·¯ç·šåœ–)
13. [è¨­è¨ˆæ±ºç­–è¨˜éŒ„](#è¨­è¨ˆæ±ºç­–è¨˜éŒ„)

---

## ç³»çµ±æ¦‚è¿°

### æ¥­å‹™ç›®æ¨™

å»ºç«‹ä¸€å€‹**ç„¡éœ€å‚³çµ±ç™»å…¥**çš„è™›æ“¬ç‰©å“æ„å‘åª’åˆå¹³å°ï¼Œå…è¨±ç”¨æˆ¶ï¼š
- ä½¿ç”¨è§’è‰² ID ç²å–è¨ªå•ä»¤ç‰Œï¼ˆTokenï¼‰
- ç™¼å¸ƒç‰©å“è²©å”®è³‡è¨Šï¼ˆå«åƒ¹æ ¼å’Œè¯çµ¡æ–¹å¼ï¼‰
- ç€è¦½å¸‚å ´ä¸¦ç™»è¨˜è³¼è²·æ„å‘
- é€éå¹³å°å¤–è¯çµ¡æ–¹å¼å®Œæˆå¯¦éš›äº¤æ˜“ï¼ˆéŠæˆ²å…§äº¤æ˜“ï¼‰

### æ ¸å¿ƒç‰¹æ€§

- **é›¶æ‘©æ“¦é€²å…¥**ï¼šç„¡éœ€è¨»å†Šï¼Œè¼¸å…¥è§’è‰² ID å³å¯é–‹å§‹
- **è³‡è¨Šåª’åˆå¹³å°**ï¼šç³»çµ±åƒ…è² è²¬é…å°è²·è³£é›™æ–¹ï¼Œäº¤æ˜“åœ¨éŠæˆ²å…§å®Œæˆ
- **ç°¡åŒ–æµç¨‹**ï¼šè³£å®¶ç™¼å¸ƒç‰©å“â†’è²·å®¶ç™»è¨˜æ„å‘â†’é›™æ–¹è‡ªè¡Œè¯çµ¡â†’éŠæˆ²å…§äº¤æ˜“
- **å®Œå…¨ä¿¡ä»»æ¨¡å¼**ï¼šå‡è¨­ç”¨æˆ¶èª å¯¦ï¼Œé‡é»åœ¨é˜²æ¿«ç”¨è€Œéé˜²æ¬ºè©
- **å…è²»é‹ç‡Ÿ**ï¼šå®Œå…¨ä¾è³´å…è²»æœå‹™é¡åº¦ï¼ˆVercel + Supabase + Upstashï¼‰
- **å¯æ“´å±•è¨­è¨ˆ**ï¼šç•¶å‰æ”¯æ´ 1200-1600 æœˆæ´»èºç”¨æˆ¶ï¼ˆ**å¯¦éš›æµé‡ï¼Œå·²è¶…å‡ºå…è²»é¡åº¦**ï¼‰

### éç›®æ¨™

- âŒ ç³»çµ±å…§å®Œæˆäº¤æ˜“ï¼ˆç„¡ç‰©å“è½‰ç§»é‚è¼¯ï¼‰
- âŒ çœŸå¯¦è²¨å¹£äº¤æ˜“
- âŒ è¤‡é›œçš„æ¬Šé™ç³»çµ±
- âŒ è·¨ä¼ºæœå™¨/è·¨å€åŸŸåŒæ­¥
- âŒ å³æ™‚é€šè¨ŠåŠŸèƒ½
- âŒ è­°åƒ¹åŠŸèƒ½ï¼ˆå›ºå®šåƒ¹æ ¼ï¼‰

---

## ç³»çµ±æ¶æ§‹

### æ•´é«”æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ¶ç«¯    â”‚ (Next.js App Router)
â”‚  Browser    â”‚ - React Context ç‹€æ…‹ç®¡ç†
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ - localStorage Token å­˜å„²
       â”‚
       â”‚ HTTPS
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚ Vercel Edge â”‚
â”‚  Functions  â”‚ - Rate Limiting (Middleware)
â”‚             â”‚ - API Routes (App Router)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase   â”‚ â”‚  Upstash   â”‚
â”‚ PostgreSQL  â”‚ â”‚   Redis    â”‚
â”‚             â”‚ â”‚            â”‚
â”‚ - RLS       â”‚ â”‚ - Rate     â”‚
â”‚ - Indexes   â”‚ â”‚   Limit    â”‚
â”‚ - Functions â”‚ â”‚   Storage  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€è¡“æ£§é¸æ“‡

| å±¤ç´š | æŠ€è¡“ | é¸æ“‡ç†ç”± |
|------|------|----------|
| **å‰ç«¯** | Next.js 15 + App Router | SSR/SSG æ”¯æ´ã€å„ªç§€çš„ DXã€Vercel åŸç”Ÿæ•´åˆ |
| **è³‡æ–™åº«** | Supabase PostgreSQL | RLS å…§å»ºã€å…è²»é¡åº¦å……è¶³ã€Real-time å¯é¸ |
| **Rate Limiting** | Upstash Redis | åˆ†æ•£å¼å¯é ã€å…è²» 10K å‘½ä»¤/å¤©ã€é‚Šç·£å„ªåŒ– |
| **ç‹€æ…‹ç®¡ç†** | React Context | è¼•é‡ã€å¤ ç”¨ã€ç„¡éœ€é¡å¤–ä¾è³´ |
| **éƒ¨ç½²** | Vercel | å…è²»é¡åº¦ã€Edge Networkã€Cron Jobs |

### é—œéµä¾è³´

```bash
# æ ¸å¿ƒä¾è³´
npm install @supabase/supabase-js    # Supabase å®¢æˆ¶ç«¯
npm install @upstash/redis           # Rate Limiting

# å¯é¸ä¾è³´
npm install zustand                  # è¤‡é›œç‹€æ…‹ç®¡ç†ï¼ˆè‹¥éœ€è¦ï¼‰
```

---

## è³‡æ–™åº«è¨­è¨ˆ

### æ ¸å¿ƒè¡¨çµæ§‹

#### 1. è¨ªå•ä»¤ç‰Œè¡¨ (access_tokens)

**è¨­è¨ˆç›®æ¨™**ï¼šç„¡å¯†ç¢¼èªè­‰ï¼Œé˜²æ­¢æ¿«ç”¨

```sql
CREATE TABLE access_tokens (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  character_id TEXT NOT NULL,
  token TEXT UNIQUE NOT NULL,
  created_ip INET NOT NULL,            -- å‰µå»ºæ™‚çš„ IP åœ°å€
  last_ip INET,                        -- æœ€å¾Œä½¿ç”¨çš„ IP
  ip_subnet CIDR,                      -- IP å­ç¶²ï¼ˆ/24ï¼‰ï¼Œå…è¨±å°ç¯„åœåˆ‡æ›
  expires_at TIMESTAMPTZ NOT NULL,     -- æ˜ç¢ºéæœŸæ™‚é–“ï¼ˆ3å¤©ï¼‰
  last_active_at TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT valid_expiry CHECK (expires_at > created_at)
);

CREATE INDEX idx_token ON access_tokens(token);
CREATE INDEX idx_expires ON access_tokens(expires_at) WHERE expires_at > NOW();
CREATE INDEX idx_character_tokens ON access_tokens(character_id, created_at DESC)
  WHERE expires_at > NOW();
CREATE INDEX idx_ip_tracking ON access_tokens(created_ip, created_at DESC);

-- âœ… å”¯ä¸€ç´„æŸï¼šæ¯å€‹ character_id åŒæ™‚åªèƒ½æœ‰ä¸€å€‹æœ‰æ•ˆ Token
CREATE UNIQUE INDEX idx_unique_active_character
  ON access_tokens(character_id)
  WHERE expires_at > NOW();
```

**è¨­è¨ˆè¦é»ï¼ˆå„ªåŒ–å¾Œï¼‰**ï¼š
- âœ… **ç§»é™¤ç€è¦½å™¨æŒ‡ç´‹**ï¼ˆä¸å¯é ï¼Œæ˜“ç¹éï¼‰
- âœ… **æ”¹ç”¨ IP è¿½è¹¤**ï¼šè¨˜éŒ„å‰µå»º IP å’Œæœ€å¾Œä½¿ç”¨ IP
- âœ… **IP å­ç¶²ç¶å®š**ï¼šå…è¨±åŒä¸€ /24 å­ç¶²å…§åˆ‡æ›ï¼ˆå¦‚å®¶ç”¨ç¶²è·¯ DHCPï¼‰
- âœ… **éæœŸæ™‚é–“ç¸®çŸ­ç‚º 3 å¤©**ï¼ˆvs 7 å¤©ï¼‰ï¼Œæ¸›å°‘ Token æ´©æ¼é¢¨éšª
- âœ… å¢åŠ  IP ç´¢å¼•ï¼Œç”¨æ–¼ç•°å¸¸æª¢æ¸¬å’Œé€Ÿç‡é™åˆ¶
- âœ… **Character ID å”¯ä¸€ç¶å®š**ï¼šåŒä¸€è§’è‰²åŒæ™‚åªèƒ½æœ‰ä¸€å€‹æœ‰æ•ˆ Tokenï¼ˆæ”¯æ´æ‰¾å›ï¼‰

---

#### 2. ç‰©å“åˆŠç™»è¡¨ (listings)

**è¨­è¨ˆç›®æ¨™**ï¼šå„²å­˜è³£å®¶åˆŠç™»çš„ç‰©å“è³‡è¨Šå’Œè¯çµ¡æ–¹å¼

```sql
CREATE TABLE listings (
  id BIGSERIAL PRIMARY KEY,
  character_id TEXT NOT NULL,
  item_id INT NOT NULL,                -- éŠæˆ²ç‰©å“ ID
  quantity INT DEFAULT 1 CHECK (quantity > 0),
  price BIGINT NOT NULL CHECK (price > 0),
  contact_method TEXT NOT NULL,        -- 'discord' | 'ingame'
  contact_info TEXT,                   -- Discord ID æˆ– éŠæˆ²è§’è‰²å
  status TEXT DEFAULT 'active',        -- 'active', 'sold', 'cancelled', 'expired', 'suspended'
  view_count INT DEFAULT 0,            -- ç€è¦½æ¬¡æ•¸ï¼ˆåˆ†æç†±é–€åº¦ï¼‰
  interest_count INT DEFAULT 0,        -- æ„å‘ç™»è¨˜æ•¸ï¼ˆå¿«å–ï¼Œé¿å… JOINï¼‰
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  completed_at TIMESTAMPTZ,            -- æ¨™è¨˜äº¤æ˜“å®Œæˆæ™‚é–“
  deleted_at TIMESTAMPTZ,              -- è»Ÿåˆªé™¤ï¼ˆä¿ç•™æ­·å²è³‡æ–™ï¼‰

  CONSTRAINT valid_contact_method CHECK (
    contact_method IN ('discord', 'ingame')
  ),
  CONSTRAINT valid_status CHECK (
    status IN ('active', 'sold', 'cancelled', 'expired', 'suspended')
  )
);

-- ç´¢å¼•ï¼šæ”¯æ´å¸‚å ´æŸ¥è©¢
CREATE INDEX idx_active_listings ON listings(status, created_at DESC)
  WHERE status = 'active' AND deleted_at IS NULL;
CREATE INDEX idx_item_search ON listings(item_id, price)
  WHERE status = 'active' AND deleted_at IS NULL;
CREATE INDEX idx_character_listings ON listings(character_id, created_at DESC)
  WHERE deleted_at IS NULL;
CREATE INDEX idx_hot_listings ON listings(interest_count DESC, created_at DESC)
  WHERE status = 'active' AND deleted_at IS NULL;
```

**è¨­è¨ˆè¦é»**ï¼š
- âœ… å®Œæ•´çš„ç‹€æ…‹ç®¡ç†ï¼ˆ5 ç¨®ç‹€æ…‹ï¼šactive, sold, cancelled, expired, suspendedï¼‰
- âœ… è»Ÿåˆªé™¤æ©Ÿåˆ¶ï¼ˆ`deleted_at`ï¼‰ä¿ç•™æ­·å²è³‡æ–™
- âœ… å¿«å– `interest_count` é¿å…é »ç¹ JOIN æŸ¥è©¢
- âœ… `view_count` è¿½è¹¤ç†±é–€åº¦
- âœ… éƒ¨åˆ†ç´¢å¼•åªç´¢å¼•æœ‰æ•ˆä¸”æœªåˆªé™¤çš„åˆŠç™»

---

#### 3. è³¼è²·æ„å‘è¡¨ (interests)

**è¨­è¨ˆç›®æ¨™**ï¼šè¨˜éŒ„è²·å®¶å°ç‰¹å®šåˆŠç™»çš„è³¼è²·æ„å‘ä¸¦è¿½è¹¤äº¤æ˜“é€²åº¦

```sql
CREATE TABLE interests (
  id BIGSERIAL PRIMARY KEY,
  listing_id BIGINT REFERENCES listings(id) ON DELETE CASCADE,
  buyer_id TEXT NOT NULL,
  status TEXT DEFAULT 'pending',       -- 'pending', 'contacted', 'completed', 'cancelled'
  contacted_at TIMESTAMPTZ,            -- è²·å®¶é¦–æ¬¡è¯çµ¡æ™‚é–“
  notes TEXT,                          -- è²·å®¶äº¤æ˜“å‚™è¨»ï¼ˆç§å¯†ï¼‰
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  -- åŒä¸€è²·å®¶å°åŒä¸€åˆŠç™»åªèƒ½ç™»è¨˜ä¸€æ¬¡æ„å‘
  CONSTRAINT unique_interest UNIQUE (listing_id, buyer_id),
  CONSTRAINT valid_status CHECK (
    status IN ('pending', 'contacted', 'completed', 'cancelled')
  )
);

CREATE INDEX idx_listing_interests ON interests(listing_id, status, created_at DESC);
CREATE INDEX idx_buyer_interests ON interests(buyer_id, status, created_at DESC);
CREATE INDEX idx_pending_interests ON interests(status, created_at DESC)
  WHERE status = 'pending';
```

**è¨­è¨ˆè¦é»**ï¼š
- âœ… å®Œæ•´çš„æ„å‘ç‹€æ…‹è¿½è¹¤ï¼ˆpending â†’ contacted â†’ completed/cancelledï¼‰
- âœ… `contacted_at` è¨˜éŒ„è²·å®¶å¯¦éš›è¯çµ¡æ™‚é–“
- âœ… `notes` å…è¨±è²·å®¶è¨˜éŒ„äº¤æ˜“å‚™è¨»ï¼ˆå¦‚éŠæˆ²å…§ç´„å®šæ™‚é–“ï¼‰
- âœ… å”¯ä¸€ç´„æŸé˜²æ­¢é‡è¤‡ç™»è¨˜
- âœ… CASCADE åˆªé™¤ï¼šåˆŠç™»åˆªé™¤æ™‚è‡ªå‹•æ¸…ç†ç›¸é—œæ„å‘
- âœ… éƒ¨åˆ†ç´¢å¼•å„ªåŒ–æŸ¥è©¢å¾…è™•ç†æ„å‘

---

#### 4. èˆ‰å ±è¡¨ (reports)

**è¨­è¨ˆç›®æ¨™**ï¼šè¨˜éŒ„ç”¨æˆ¶å°åˆŠç™»çš„èˆ‰å ±ï¼Œç”¨æ–¼ç®¡ç†å“¡å¯©æ ¸

```sql
CREATE TABLE reports (
  id BIGSERIAL PRIMARY KEY,
  listing_id BIGINT REFERENCES listings(id) ON DELETE CASCADE,
  reporter_id TEXT NOT NULL,
  reason TEXT NOT NULL,                -- èˆ‰å ±åŸå› ï¼ˆè©é¨™ã€åƒ¹æ ¼ä¸å¯¦ã€é¨·æ“¾ç­‰ï¼‰
  status TEXT DEFAULT 'pending',       -- 'pending', 'reviewing', 'resolved', 'dismissed'
  admin_notes TEXT,                    -- ç®¡ç†å“¡å‚™è¨»
  created_at TIMESTAMPTZ DEFAULT NOW(),
  resolved_at TIMESTAMPTZ,

  CONSTRAINT valid_status CHECK (
    status IN ('pending', 'reviewing', 'resolved', 'dismissed')
  )
);

CREATE INDEX idx_pending_reports ON reports(status, created_at DESC)
  WHERE status IN ('pending', 'reviewing');
CREATE INDEX idx_listing_reports ON reports(listing_id, created_at DESC);
```

**è¨­è¨ˆè¦é»**ï¼š
- âœ… å…è¨±ç”¨æˆ¶èˆ‰å ±å¯ç–‘åˆŠç™»
- âœ… ç®¡ç†å“¡å¯å¯©æ ¸ä¸¦è™•ç†èˆ‰å ±
- âœ… è¿½è¹¤èˆ‰å ±ç‹€æ…‹å’Œè™•ç†æ™‚é–“
- âœ… CASCADE åˆªé™¤ï¼šåˆŠç™»åˆªé™¤æ™‚æ¸…ç†ç›¸é—œèˆ‰å ±

---

#### 5. ç”¨æˆ¶é…é¡è¡¨ (user_quotas)

**è¨­è¨ˆç›®æ¨™**ï¼šè¿½è¹¤ç”¨æˆ¶è¡Œç‚ºä¸¦å¯¦æ–½é…é¡é™åˆ¶ï¼Œé˜²æ­¢æ¿«ç”¨

```sql
CREATE TABLE user_quotas (
  character_id TEXT PRIMARY KEY,
  active_listings_count INT DEFAULT 0 CHECK (active_listings_count >= 0),
  total_interests_count INT DEFAULT 0 CHECK (total_interests_count >= 0),
  interests_today INT DEFAULT 0 CHECK (interests_today >= 0),
  last_interest_date DATE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  -- é…é¡é™åˆ¶
  CONSTRAINT quota_listings CHECK (active_listings_count <= 50),
  CONSTRAINT quota_interests CHECK (total_interests_count <= 100),
  CONSTRAINT quota_interests_daily CHECK (interests_today <= 20)
);

CREATE INDEX idx_quota_violations ON user_quotas(active_listings_count DESC)
  WHERE active_listings_count > 40;
```

**è¨­è¨ˆè¦é»**ï¼š
- âœ… é™åˆ¶æ¯äººæœ€å¤š 50 ç­†æœ‰æ•ˆåˆŠç™»
- âœ… é™åˆ¶æ¯äººæœ€å¤š 100 ç­†ç¸½æ„å‘ï¼ˆé˜²æ­¢ç„¡é™ç´¯ç©ï¼‰
- âœ… é™åˆ¶æ¯å¤©æœ€å¤š 20 ç­†æ–°æ„å‘ï¼ˆé˜²æ­¢åˆ·æ„å‘é¨·æ“¾ï¼‰
- âœ… è‡ªå‹•é‡ç½® `interests_today`ï¼ˆåŸºæ–¼ `last_interest_date`ï¼‰
- âœ… CHECK ç´„æŸåœ¨è³‡æ–™åº«å±¤é¢å¼·åˆ¶åŸ·è¡Œé…é¡

---

#### 6. IP é…é¡è¡¨ (ip_quotas)

**è¨­è¨ˆç›®æ¨™**ï¼šé˜²æ­¢æƒ¡æ„ç”¨æˆ¶ç”¨å¤šå€‹å¸³è™Ÿç¹é user_quotas é¨·æ“¾è³£å®¶

```sql
CREATE TABLE ip_quotas (
  ip_address INET PRIMARY KEY,
  contact_views_today INT DEFAULT 0 CHECK (contact_views_today >= 0),
  last_contact_view_date DATE,
  total_contact_views INT DEFAULT 0 CHECK (total_contact_views >= 0),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  -- é…é¡é™åˆ¶ï¼ˆè·¨å¸³è™Ÿ IP ç´šåˆ¥ï¼‰
  CONSTRAINT quota_contact_views_daily CHECK (contact_views_today <= 30)
);

CREATE INDEX idx_ip_contact_views ON ip_quotas(contact_views_today DESC)
  WHERE contact_views_today > 20;
```

**è¨­è¨ˆè¦é»**ï¼š
- âœ… **IP ç´šåˆ¥é…é¡**ï¼šå–®ä¸€ IP æ¯å¤©æœ€å¤šæŸ¥çœ‹ 30 ç­†è¯çµ¡æ–¹å¼ï¼ˆè·¨æ‰€æœ‰å¸³è™Ÿï¼‰
- âœ… é˜²æ­¢ç”¨æˆ¶å‰µå»º 10 å€‹å¸³è™Ÿç¹é Token é…é¡ï¼ˆ10 å¸³è™Ÿ * 30 æ¬¡ = 300 æ¬¡ï¼‰
- âœ… è¿½è¹¤ç¸½æŸ¥çœ‹æ¬¡æ•¸ï¼Œç”¨æ–¼ç•°å¸¸è¡Œç‚ºåˆ†æ
- âœ… è‡ªå‹•é‡ç½®æ¯æ—¥é…é¡ï¼ˆåŸºæ–¼ `last_contact_view_date`ï¼‰

**é˜²è­·æ•ˆæœå°æ¯”**ï¼š

| é˜²è­·å±¤ç´š | æ©Ÿåˆ¶ | é™åˆ¶ | ç¹éé›£åº¦ |
|---------|------|------|---------|
| Token é…é¡ | user_quotas | 20 æ¬¡/å¤©/å¸³è™Ÿ | âŒ ç°¡å–®ï¼ˆå‰µå»ºå¤šå¸³è™Ÿï¼‰ |
| IP é…é¡ | ip_quotas | 30 æ¬¡/å¤©/IP | âœ… å›°é›£ï¼ˆéœ€è¦ä»£ç†æ± ï¼‰ |
| Rate Limiting | Redis | 10 æ¬¡/å°æ™‚ | âœ… å›°é›£ï¼ˆéœ€è¦å¤§é‡ Tokenï¼‰ |

---

### è³‡æ–™æ¸…ç†ç­–ç•¥

#### å®šæœŸæ¸…ç†å‡½æ•¸

```sql
-- æ¸…ç†éæœŸ token
CREATE FUNCTION cleanup_expired_tokens() RETURNS void AS $$
  DELETE FROM access_tokens WHERE expires_at < NOW();
$$ LANGUAGE sql;

-- æ¸…ç†å·²å®Œæˆ/å·²å–æ¶ˆçš„æ„å‘ï¼ˆä¿ç•™ 30 å¤©ï¼‰
CREATE FUNCTION cleanup_old_interests() RETURNS void AS $$
  DELETE FROM interests
  WHERE status IN ('completed', 'cancelled')
    AND updated_at < NOW() - INTERVAL '30 days';
$$ LANGUAGE sql;

-- è»Ÿåˆªé™¤é•·æœŸç„¡æ•ˆåˆŠç™»ï¼ˆè¶…é 30 å¤©ï¼‰
CREATE FUNCTION soft_delete_inactive_listings() RETURNS void AS $$
  UPDATE listings
  SET deleted_at = NOW()
  WHERE status IN ('sold', 'cancelled', 'expired')
    AND updated_at < NOW() - INTERVAL '30 days'
    AND deleted_at IS NULL;
$$ LANGUAGE sql;

-- ç‰©ç†åˆªé™¤é•·æœŸè»Ÿåˆªé™¤çš„åˆŠç™»ï¼ˆä¿ç•™ 1 å¹´ï¼‰
CREATE FUNCTION hard_delete_old_listings() RETURNS void AS $$
  DELETE FROM listings
  WHERE deleted_at < NOW() - INTERVAL '1 year';
$$ LANGUAGE sql;

-- æ¸…ç†å·²è™•ç†çš„èˆ‰å ±ï¼ˆä¿ç•™ 90 å¤©ï¼‰
CREATE FUNCTION cleanup_old_reports() RETURNS void AS $$
  DELETE FROM reports
  WHERE status IN ('resolved', 'dismissed')
    AND resolved_at < NOW() - INTERVAL '90 days';
$$ LANGUAGE sql;

-- é‡ç½®æ¯æ—¥æ„å‘é…é¡ï¼ˆå‡Œæ™¨ 0 é»åŸ·è¡Œï¼‰
CREATE FUNCTION reset_daily_interest_quotas() RETURNS void AS $$
  UPDATE user_quotas
  SET interests_today = 0
  WHERE last_interest_date < CURRENT_DATE;
$$ LANGUAGE sql;

-- é‡ç½®æ¯æ—¥ IP é…é¡ï¼ˆå‡Œæ™¨ 0 é»åŸ·è¡Œï¼‰
CREATE FUNCTION reset_daily_ip_quotas() RETURNS void AS $$
  UPDATE ip_quotas
  SET contact_views_today = 0
  WHERE last_contact_view_date < CURRENT_DATE;
$$ LANGUAGE sql;

-- æ¸…ç†èˆŠ IP é…é¡è¨˜éŒ„ï¼ˆæ¯æœˆåŸ·è¡Œï¼Œé˜²æ­¢è³‡æ–™è¡¨ç„¡é™å¢é•·ï¼‰
CREATE FUNCTION cleanup_old_ip_quotas() RETURNS void AS $$
  DELETE FROM ip_quotas
  WHERE last_contact_view_date < CURRENT_DATE - INTERVAL '30 days';
$$ LANGUAGE sql;
```

**æ¸…ç†ç­–ç•¥ï¼ˆå„ªåŒ–å¾Œï¼‰**ï¼š
- Tokenï¼šéæœŸç«‹å³æ¸…ç†ï¼ˆ**3 å¤©**ï¼‰
- æ„å‘è¨˜éŒ„ï¼šå·²å®Œæˆ/å·²å–æ¶ˆçš„ä¿ç•™ 30 å¤©
- åˆŠç™»ï¼šè»Ÿåˆªé™¤ç„¡æ•ˆåˆŠç™»ï¼ˆ30 å¤©å¾Œï¼‰â†’ **ç‰©ç†åˆªé™¤ï¼ˆ1 å¹´å¾Œï¼‰**
- èˆ‰å ±ï¼šå·²è™•ç†çš„ä¿ç•™ 90 å¤©
- æ¯æ—¥é…é¡ï¼šæ¯å¤©å‡Œæ™¨é‡ç½®
- **IP é…é¡ï¼šç„¡æ´»å‹•è¶…é 30 å¤©çš„è¨˜éŒ„æ¯æœˆæ¸…ç†**ï¼ˆé˜²æ­¢è³‡æ–™è¡¨ç„¡é™å¢é•·ï¼‰

**åˆŠç™»è³‡æ–™ç”Ÿå‘½é€±æœŸ**ï¼š
```
å‰µå»º â†’ æœ‰æ•ˆ â†’ é—œé–‰ï¼ˆsold/cancelled/expiredï¼‰
  â†“      â†“                    â†“
 +0å¤©   ä¸å®š                 +30å¤©ï¼ˆè»Ÿåˆªé™¤ï¼‰
                                â†“
                             +1å¹´ï¼ˆç‰©ç†åˆªé™¤ï¼‰
```

**è³‡æ–™åº«ç©ºé–“é ä¼°ï¼ˆä¿®æ­£å¾Œï¼‰**ï¼š
```
å‡è¨­ï¼š1000 ç”¨æˆ¶ã€æ¯äººå¹³å‡ 10 ç­†åˆŠç™»/æœˆ

1 å¹´ç´¯ç©ï¼š
- æ–°å¢åˆŠç™»ï¼š120,000 ç­† * 300 bytes = 36 MB
- è»Ÿåˆªé™¤åˆŠç™»ï¼š~100,000 ç­† * 300 bytes = 30 MB
- ç¸½è¨ˆï¼š66 MBï¼ˆå«ç´¢å¼• ~130 MBï¼‰

5 å¹´ç©©å®šç‹€æ…‹ï¼š
- æœ‰æ•ˆåˆŠç™»ï¼š50,000 ç­† = 15 MB
- è»Ÿåˆªé™¤ï¼ˆ1å¹´å…§ï¼‰ï¼š40,000 ç­† = 12 MB
- ç¸½è¨ˆï¼š27 MBï¼ˆå«ç´¢å¼• ~55 MBï¼‰âœ…

çµè«–ï¼š5å¹´å¾Œè³‡æ–™åº«å¤§å°ç©©å®šåœ¨ 200 MB ä»¥å…§
```

---

## API è¨­è¨ˆ

### API ç«¯é»ç¸½è¦½

| ç«¯é» | æ–¹æ³• | åŠŸèƒ½ | èªè­‰ | Rate Limit |
|------|------|------|------|------------|
| `/api/auth/token` | POST | ç²å–è¨ªå•ä»¤ç‰Œ | âŒ | 10/å°æ™‚ |
| `/api/listings` | GET | æŸ¥è©¢æˆ‘çš„åˆŠç™» | âœ… | 60/åˆ†é˜ |
| `/api/listings` | POST | å»ºç«‹åˆŠç™» | âœ… | 5/å°æ™‚ |
| `/api/listings/[id]` | PATCH | æ›´æ–°åˆŠç™»ï¼ˆåƒ¹æ ¼/è¯çµ¡æ–¹å¼ï¼‰ | âœ… | 30/åˆ†é˜ |
| `/api/listings/[id]` | DELETE | é—œé–‰/è»Ÿåˆªé™¤åˆŠç™» | âœ… | 30/åˆ†é˜ |
| `/api/listings/[id]/contact` | GET | æŸ¥çœ‹è¯çµ¡æ–¹å¼ | âœ… | 10/å°æ™‚ |
| `/api/listings/[id]/complete` | POST | æ¨™è¨˜äº¤æ˜“å®Œæˆ | âœ… | 30/åˆ†é˜ |
| `/api/listings/[id]/report` | POST | èˆ‰å ±åˆŠç™» | âœ… | 5/å°æ™‚ |
| `/api/market` | GET | å¸‚å ´åˆ—è¡¨ï¼ˆåˆ†é ï¼‰ | âœ… | 100/å°æ™‚ |
| `/api/market/search` | GET | æœå°‹/ç¯©é¸ | âœ… | 100/å°æ™‚ |
| `/api/interests` | POST | ç™»è¨˜è³¼è²·æ„å‘ | âœ… | 20/å°æ™‚ |
| `/api/interests` | GET | æˆ‘çš„è³¼è²·æ„å‘ | âœ… | 60/åˆ†é˜ |
| `/api/interests/[id]` | PATCH | æ›´æ–°æ„å‘ç‹€æ…‹ | âœ… | 30/åˆ†é˜ |
| `/api/interests/[id]` | DELETE | æ’¤éŠ·è³¼è²·æ„å‘ | âœ… | 30/åˆ†é˜ |
| `/api/interests/received` | GET | æ”¶åˆ°çš„è³¼è²·æ„å‘ | âœ… | 60/åˆ†é˜ |

### ç›®éŒ„çµæ§‹

```
src/
â”œâ”€â”€ app/api/
â”‚   â”œâ”€â”€ auth/token/route.ts
â”‚   â”œâ”€â”€ listings/
â”‚   â”‚   â”œâ”€â”€ route.ts                      # GET: æˆ‘çš„åˆŠç™», POST: å»ºç«‹åˆŠç™»
â”‚   â”‚   â””â”€â”€ [id]/
â”‚   â”‚       â”œâ”€â”€ route.ts                  # PATCH: æ›´æ–°, DELETE: é—œé–‰
â”‚   â”‚       â”œâ”€â”€ contact/route.ts          # GET: æŸ¥çœ‹è¯çµ¡æ–¹å¼ï¼ˆéœ€æ¬Šé™ï¼‰
â”‚   â”‚       â”œâ”€â”€ complete/route.ts         # POST: æ¨™è¨˜å®Œæˆ
â”‚   â”‚       â””â”€â”€ report/route.ts           # POST: èˆ‰å ±
â”‚   â”œâ”€â”€ market/
â”‚   â”‚   â”œâ”€â”€ route.ts                      # GET: å¸‚å ´åˆ—è¡¨
â”‚   â”‚   â””â”€â”€ search/route.ts              # GET: æœå°‹
â”‚   â”œâ”€â”€ interests/
â”‚   â”‚   â”œâ”€â”€ route.ts                      # POST: ç™»è¨˜æ„å‘, GET: æˆ‘çš„æ„å‘
â”‚   â”‚   â”œâ”€â”€ [id]/route.ts                # PATCH: æ›´æ–°ç‹€æ…‹, DELETE: æ’¤éŠ·
â”‚   â”‚   â””â”€â”€ received/route.ts            # GET: æ”¶åˆ°çš„æ„å‘
â”‚   â””â”€â”€ maintenance/
â”‚       â”œâ”€â”€ cleanup/route.ts             # Cron Job
â”‚       â””â”€â”€ stats/route.ts               # çµ±è¨ˆ
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ supabase/
â”‚   â”‚   â”œâ”€â”€ client.ts                    # å®¢æˆ¶ç«¯å¯¦ä¾‹
â”‚   â”‚   â””â”€â”€ server.ts                    # æœå‹™ç«¯å¯¦ä¾‹
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”œâ”€â”€ rate-limit.ts                # Rate Limiting
â”‚   â”‚   â”œâ”€â”€ auth.ts                      # Token é©—è­‰
â”‚   â”‚   â””â”€â”€ quota-check.ts               # é…é¡æª¢æŸ¥ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ quota-service.ts             # é…é¡ç®¡ç†ï¼ˆæ–°å¢ï¼‰
â”‚   â”‚   â””â”€â”€ contact-service.ts           # è¯çµ¡æ–¹å¼å­˜å–æ§åˆ¶ï¼ˆæ–°å¢ï¼‰
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ fingerprint.ts               # ç€è¦½å™¨æŒ‡ç´‹
â”‚       â””â”€â”€ token.ts                     # Token ç”Ÿæˆ
â””â”€â”€ components/trade/
    â”œâ”€â”€ MarketList.tsx                   # å¸‚å ´åˆ—è¡¨
    â”œâ”€â”€ MyListings.tsx                   # æˆ‘çš„åˆŠç™»
    â”œâ”€â”€ MyInterests.tsx                  # æˆ‘çš„è³¼è²·æ„å‘
    â”œâ”€â”€ ReceivedInterests.tsx            # æ”¶åˆ°çš„æ„å‘
    â””â”€â”€ ReportModal.tsx                  # èˆ‰å ±å½ˆçª—ï¼ˆæ–°å¢ï¼‰
```

### èªè­‰æµç¨‹ï¼ˆå« Token æ‰¾å›æ©Ÿåˆ¶ï¼‰

```
1. ç”¨æˆ¶è¼¸å…¥è§’è‰² ID â†’ POST /api/auth/token
   â†“
2. å¾Œç«¯æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æœ‰æ•ˆ Token (character_id å”¯ä¸€ç´„æŸ)
   â”œâ”€ å­˜åœ¨ â†’ è¿”å›ç¾æœ‰ Tokenï¼ˆæ”¯æ´æ‰¾å›ï¼‰
   â””â”€ ä¸å­˜åœ¨ â†’ ç”Ÿæˆæ–° Tokenï¼Œå­˜å…¥ access_tokens
   â†“
3. è¿”å› { token, characterId, isExisting }
   â†“
4. å‰ç«¯å­˜å…¥ localStorageï¼Œå¾ŒçºŒè«‹æ±‚å¸¶ä¸Š Authorization: Bearer {token}
   â†“
5. ä¸­é–“ä»¶é©—è­‰ tokenï¼ˆæª¢æŸ¥éæœŸã€å­˜åœ¨æ€§ï¼‰
```

**Token æ ¼å¼**ï¼š
```typescript
// ä½¿ç”¨ crypto.randomBytes ç”Ÿæˆ 32 å­—ç¯€éš¨æ©Ÿ token
const token = crypto.randomBytes(32).toString('base64url')
// ç¯„ä¾‹: "xK7j2mP9vQ4wR8nL5tY3zA1bC6fD0hE8"
```

**Token æ‰¾å›é‚è¼¯**ï¼š

```typescript
// POST /api/auth/token
async function getOrCreateToken(characterId: string, requestIP: string) {
  // 1. æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æœ‰æ•ˆ Token
  const { data: existingToken } = await supabase
    .from('access_tokens')
    .select('token, created_at, expires_at')
    .eq('character_id', characterId)
    .gt('expires_at', new Date().toISOString())
    .single()

  if (existingToken) {
    // âœ… è¿”å›ç¾æœ‰ Tokenï¼ˆç”¨æˆ¶å¯æ‰¾å›ï¼‰
    logger.info('token_recovered', {
      characterId,
      requestIP,
      tokenAge: Date.now() - new Date(existingToken.created_at).getTime(),
      message: 'ç”¨æˆ¶æ‰¾å›ç¾æœ‰ Token'
    })

    return {
      token: existingToken.token,
      characterId,
      isExisting: true,
      expiresAt: existingToken.expires_at
    }
  }

  // 2. ä¸å­˜åœ¨æœ‰æ•ˆ Tokenï¼Œå‰µå»ºæ–°çš„
  const token = crypto.randomBytes(32).toString('base64url')
  const ipSubnet = getSubnet(requestIP, 24)
  const expiresAt = new Date(Date.now() + 3 * 24 * 60 * 60 * 1000)  // 3 å¤©

  const { error } = await supabase
    .from('access_tokens')
    .insert({
      character_id: characterId,
      token,
      created_ip: requestIP,
      last_ip: requestIP,
      ip_subnet: ipSubnet,
      expires_at: expiresAt
    })

  if (error && error.code === '23505') {
    // å”¯ä¸€ç´„æŸè¡çªï¼ˆç«¶æ…‹æ¢ä»¶ï¼‰ï¼Œé‡æ–°æŸ¥è©¢ç¾æœ‰ Token
    return getOrCreateToken(characterId, requestIP)
  }

  logger.info('token_created', { characterId, requestIP, expiresAt })

  return {
    token,
    characterId,
    isExisting: false,
    expiresAt
  }
}
```

**Token æ‰¾å›å„ªå‹¢**ï¼š

| å ´æ™¯ | èˆŠè¨­è¨ˆï¼ˆç„¡æ‰¾å›ï¼‰ | æ–°è¨­è¨ˆï¼ˆæœ‰æ‰¾å›ï¼‰ |
|------|----------------|----------------|
| æ¸…é™¤ localStorage | âŒ éœ€è¦ç­‰å¾… 7 å¤©éæœŸ | âœ… é‡æ–°è¼¸å…¥ character_id å³å¯æ‰¾å› |
| åˆ‡æ›è£ç½® | âŒ ç„¡æ³•å­˜å–åŸå¸³è™Ÿè³‡æ–™ | âœ… ä»»ä½•è£ç½®éƒ½å¯ç™»å…¥åŒä¸€å¸³è™Ÿ |
| Token æ´©æ¼ | âš ï¸ å¤šå€‹ Token åŒæ™‚æœ‰æ•ˆ | âœ… åªæœ‰ä¸€å€‹ Token æœ‰æ•ˆï¼ˆæ›´å®‰å…¨ï¼‰ |
| è³‡æ–™åº«æˆé•· | âŒ Token è¡¨ç„¡é™å¢é•· | âœ… å—é™æ–¼ç”¨æˆ¶æ•¸ï¼ˆ800 MAU = 800 Tokenï¼‰ |

**è¨­è¨ˆæ¬Šè¡¡**ï¼š
- âœ… å¤§å¹…æ”¹å–„ä½¿ç”¨è€…é«”é©—ï¼ˆToken å¯æ‰¾å›ï¼‰
- âœ… æ¸›å°‘ Token è¡¨å¤§å°ï¼ˆå¾æ½›åœ¨ç„¡é™åˆ°å›ºå®š 800 ç­†ï¼‰
- âœ… æ›´å®‰å…¨ï¼ˆåŒä¸€å¸³è™Ÿåªæœ‰ä¸€å€‹æœ‰æ•ˆ Tokenï¼‰
- âš ï¸ ç”¨æˆ¶ç„¡æ³•åœ¨å¤šè£ç½®åŒæ™‚ç™»å…¥ï¼ˆå¯æ¥å—ï¼Œé¡ä¼¼å–®ä¸€ sessionï¼‰

---

### å…¬é–‹ API é˜²è­·ç­–ç•¥

#### å•é¡Œåˆ†æ

**åŸè¨­è¨ˆé¢¨éšª**ï¼š
- å¸‚å ´æŸ¥è©¢ API å®Œå…¨å…¬é–‹ï¼ˆç„¡éœ€èªè­‰ï¼‰
- åƒ…ç”¨ IP é™åˆ¶ï¼ˆ20 æ¬¡/åˆ†é˜ï¼‰
- çˆ¬èŸ²å¯ç”¨ä»£ç†æ± è¼•æ˜“ç¹éï¼ˆ1000 å€‹ IP * 20 æ¬¡ = æ¯åˆ†é˜ 2 è¬æ¬¡ï¼‰
- Redis å‘½ä»¤æ•¸æš´å¢è‡³ 20 è¬+/å¤©ï¼ˆè¶…æ¨™ 2000%ï¼‰

#### è§£æ±ºæ–¹æ¡ˆï¼šå¼·åˆ¶èªè­‰æŸ¥è©¢

**æ ¸å¿ƒè®Šæ›´**ï¼š
- `/api/market` å’Œ `/api/market/search` **æ”¹ç‚ºéœ€è¦èªè­‰**
- Rate Limit èª¿æ•´ç‚º 100 æ¬¡/å°æ™‚ï¼ˆåŸºæ–¼ Tokenï¼‰
- ç”¨æˆ¶å¿…é ˆå…ˆç²å–è¨ªå•ä»¤ç‰Œæ‰èƒ½æŸ¥è©¢å¸‚å ´

**è¨ªå®¢é«”é©—å„ªåŒ–**ï¼š

```typescript
// æ–¹æ¡ˆï¼šé¦–é å±•ç¤ºç†±é–€åˆŠç™»ï¼ˆç„¡éœ€èªè­‰ï¼‰+ è¼•é‡ç´šé è¦½
// 1. æä¾› /api/market/trending ç«¯é»ï¼ˆç„¡éœ€èªè­‰ï¼Œåš´æ ¼é™åˆ¶ï¼‰
//    - è¿”å›å‰ 20 ç­†ç†±é–€åˆŠç™»ï¼ˆæŒ‰ interest_count æ’åºï¼‰
//    - åŒ…å«åŸºæœ¬è³‡è¨Šï¼šitem_id, price, quantity, created_at
//    - ä¸åŒ…å«è¯çµ¡æ–¹å¼å’Œå®Œæ•´åˆ—è¡¨
//    - Rate Limit: IP é™åˆ¶ **10 æ¬¡/å°æ™‚**ï¼ˆ2 Redis å‘½ä»¤/æ¬¡ï¼‰
//    - **User-Agent æª¢æŸ¥**ï¼šæ‹’çµ•å·²çŸ¥çˆ¬èŸ²

// 2. æŸ¥çœ‹å®Œæ•´å¸‚å ´åˆ—è¡¨éœ€è¦ç™»å…¥
//    - ç”¨æˆ¶è¼¸å…¥ character_id â†’ ç²å– Token
//    - Token ç¶å®š character_idï¼ˆå”¯ä¸€ï¼Œå¯æ¢å¾©ï¼‰
//    - Rate Limit: Token é™åˆ¶ 100 æ¬¡/å°æ™‚

// ç¯„ä¾‹ API å¯¦ä½œï¼ˆå¢å¼·ç‰ˆï¼‰
// GET /api/market/trending ï¼ˆç„¡éœ€èªè­‰ï¼Œåš´æ ¼é™åˆ¶ï¼‰
export async function GET(request: NextRequest) {
  // 1. Bot Detectionï¼ˆUser-Agent æª¢æŸ¥ï¼‰
  const userAgent = request.headers.get('user-agent') || ''

  // æ‹’çµ•å¸¸è¦‹çˆ¬èŸ²
  const botPatterns = /bot|crawler|spider|scraper|curl|wget|python-requests/i
  if (botPatterns.test(userAgent)) {
    return Response.json(
      { error: 'æ­¤ç«¯é»ä¸æ”¯æ´è‡ªå‹•åŒ–è¨ªå•' },
      { status: 403 }
    )
  }

  // æ‹’çµ•ç„¡ User-Agent
  if (!userAgent) {
    return Response.json(
      { error: 'ç¼ºå°‘ User-Agent header' },
      { status: 400 }
    )
  }

  // 2. åš´æ ¼ Rate Limitï¼ˆ10 æ¬¡/å°æ™‚ï¼‰
  const clientIP = getClientIP(request)
  const rateLimitResult = await rateLimit(
    `trending:${clientIP}`,
    10,  // å¾ 100 é™è‡³ 10
    3600  // 1 å°æ™‚
  )

  if (!rateLimitResult.success) {
    return Response.json(
      {
        error: 'Rate limit exceeded',
        resetAt: rateLimitResult.resetAt,
        message: 'æ‚¨è¨ªå•éæ–¼é »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦'
      },
      { status: 429 }
    )
  }

  // 3. è¿”å›ç†±é–€åˆŠç™»
  const { data } = await supabase
    .from('listings')
    .select('id, item_id, quantity, price, status, created_at, interest_count')
    .eq('status', 'active')
    .is('deleted_at', null)
    .order('interest_count', { ascending: false })
    .limit(20)

  return Response.json({
    data,
    message: 'å®Œæ•´åˆ—è¡¨éœ€è¦ç™»å…¥',
    remaining: rateLimitResult.remaining
  })
}
```

**é˜²è­·æ•ˆæœï¼ˆå¢å¼·ç‰ˆï¼‰**ï¼š
- âœ… **åš´æ ¼é™åˆ¶ Rate Limitï¼ˆ100 â†’ 10 æ¬¡/å°æ™‚ï¼‰**ï¼Œæ¸›å°‘ 90% ç„¡æ•ˆè«‹æ±‚
- âœ… **User-Agent æª¢æŸ¥**ï¼Œè‡ªå‹•éæ¿¾å·²çŸ¥çˆ¬èŸ²ï¼ˆbot, crawler, spiderç­‰ï¼‰
- âœ… **æ‹’çµ•ç„¡ User-Agent**ï¼Œé˜²æ­¢ curl/wget ç­‰å·¥å…·ç›´æ¥è¨ªå•
- âœ… çˆ¬èŸ²ç„¡æ³•ç²å–å®Œæ•´åˆ—è¡¨ï¼ˆåƒ…å‰ 20 ç­†ç†±é–€ï¼‰
- âœ… Redis å‘½ä»¤æ•¸ï¼šå¾ 312 æ¬¡/å¤© â†’ **31 æ¬¡/å¤©**ï¼ˆæ¸›å°‘ 90%ï¼‰
- âš ï¸ çœŸå¯¦ç”¨æˆ¶å½±éŸ¿æ¥µå°ï¼ˆæ­£å¸¸è¨ªå• < 10 æ¬¡/å°æ™‚ï¼‰

**é æœŸæ•ˆæœï¼ˆåŸºæ–¼å¯¦éš›æµé‡ï¼‰**ï¼š
- ç•¶å‰ trending è«‹æ±‚ï¼š~156 IP * 2 æ¬¡ = 312 æ¬¡/å¤©
- Bot éæ¿¾å¾Œï¼š~50 IP * 2 æ¬¡ = 100 æ¬¡/å¤©ï¼ˆ-68%ï¼‰
- é™ç´šæ¨¡å¼ï¼š10 æ¬¡/å°æ™‚é™åˆ¶ = ~50 æ¬¡/å¤©ï¼ˆ-84%ï¼‰
- **ç¸½æ¸›å°‘ï¼š262 æ¬¡/å¤© * 2 å‘½ä»¤ = 524 Redis å‘½ä»¤/å¤©**

---

## å®‰å…¨æ€§è¨­è¨ˆ

### 1. Token å®‰å…¨ç®¡ç†ï¼ˆå¢å¼·ç‰ˆï¼‰

**Token ç”Ÿå‘½é€±æœŸ**ï¼š

| éšæ®µ | æªæ–½ | æ™‚é–“ |
|------|------|------|
| ç”Ÿæˆ | crypto.randomBytes(32)ã€**IP ç¶å®š** | - |
| å„²å­˜ | ç´”æ–‡æœ¬ï¼ˆå·²è¶³å¤ éš¨æ©Ÿï¼‰ã€åŠ å¯†å‚³è¼¸ï¼ˆHTTPSï¼‰ | - |
| ä½¿ç”¨ | é©—è­‰éæœŸæ™‚é–“ + **IP å­ç¶²æª¢æŸ¥** | **3 å¤©** |
| éæœŸ | è‡ªå‹•æ¸…ç†ã€æ‹’çµ•è«‹æ±‚ | 3 å¤©å¾Œ |
| æ’¤éŠ· | æ”¯æ´ä¸»å‹•åˆªé™¤ï¼ˆç™»å‡ºï¼‰ | - |

**é˜²ç¯„æªæ–½ï¼ˆå„ªåŒ–å¾Œï¼‰**ï¼š
- âœ… Token æœ‰æ˜ç¢ºéæœŸæ™‚é–“ï¼ˆexpires_atï¼‰ï¼Œ**ç¸®çŸ­ç‚º 3 å¤©**
- âœ… **IP ç¶å®š**ï¼šToken ç¶å®šå‰µå»ºæ™‚çš„ IP å­ç¶²ï¼ˆ/24ï¼‰
- âœ… **ç•°å¸¸æª¢æ¸¬**ï¼šIP è·¨å­ç¶²åˆ‡æ›æ™‚è¦æ±‚é‡æ–°é©—è­‰
- âœ… **IP Rate Limiting**ï¼šå–®ä¸€ IP æ¯å°æ™‚æœ€å¤šå‰µå»º 5 å€‹ Token
- âœ… æ”¯æ´ä¸»å‹•ç™»å‡ºï¼ˆåˆªé™¤ tokenï¼‰

**IP é©—è­‰é‚è¼¯ï¼ˆå¯¬é¬†æ¨¡å¼ï¼Œæ¨è–¦ï¼‰**ï¼š

```typescript
async function validateToken(token: string, requestIP: string): Promise<boolean> {
  const tokenData = await db.query(
    'SELECT * FROM access_tokens WHERE token = $1 AND expires_at > NOW()',
    [token]
  )

  if (!tokenData) {
    throw new UnauthorizedError('Token ç„¡æ•ˆæˆ–å·²éæœŸ')
  }

  // æª¢æŸ¥ IP å­ç¶²ï¼ˆå…è¨±åŒä¸€ /24 ç¶²æ®µï¼‰
  const createdSubnet = tokenData.ip_subnet  // ä¾‹å¦‚ï¼š192.168.1.0/24
  const requestSubnet = getSubnet(requestIP, 24)

  if (createdSubnet !== requestSubnet) {
    // âœ… å¯¬é¬†æ¨¡å¼ï¼šåƒ…è¨˜éŒ„ç•°å¸¸ï¼Œä¸æ‹’çµ•è«‹æ±‚
    logger.warn('token_ip_mismatch', {
      characterId: tokenData.character_id,
      createdIP: tokenData.created_ip,
      createdSubnet,
      requestIP,
      requestSubnet,
      token: token.substring(0, 8),  // åªè¨˜éŒ„éƒ¨åˆ† token
      severity: 'low'  // æ¨™è¨˜ç‚ºä½é¢¨éšªï¼ˆå¸¸è¦‹æ–¼æ‰‹æ©Ÿç¶²è·¯åˆ‡æ›ï¼‰
    })

    // âš ï¸ ä¸æ‹‹å‡ºéŒ¯èª¤ï¼Œå…è¨±è«‹æ±‚ç¹¼çºŒï¼ˆç”¨æˆ¶é«”é©—å„ªå…ˆï¼‰
    // ç•°å¸¸ IP è¨˜éŒ„æœƒç”¨æ–¼å¾ŒçºŒåˆ†æå’Œç›£æ§
  }

  // æ›´æ–°æœ€å¾Œä½¿ç”¨ IP å’Œæ™‚é–“ï¼ˆç„¡è«–æ˜¯å¦åŒ¹é…ï¼‰
  await db.query(
    'UPDATE access_tokens SET last_ip = $1, last_active_at = NOW() WHERE token = $2',
    [requestIP, token]
  )

  return true
}

// è¨ˆç®— IP å­ç¶²
function getSubnet(ip: string, prefixLength: number): string {
  // å¯¦ä½œçœç•¥ï¼Œè¿”å›å¦‚ "192.168.1.0/24"
}
```

**å¯¬é¬†æ¨¡å¼ vs åš´æ ¼æ¨¡å¼å°æ¯”**ï¼š

| æ¨¡å¼ | IP ä¸åŒ¹é…è¡Œç‚º | å„ªé» | ç¼ºé» | æ¨è–¦å ´æ™¯ |
|------|-------------|------|------|----------|
| **å¯¬é¬†æ¨¡å¼** | åƒ…è¨˜éŒ„æ—¥èªŒ | âœ… UX å‹å–„ï¼ˆæ‰‹æ©Ÿ/VPN å¯ç”¨ï¼‰<br>âœ… é™ä½æ”¯æ´æˆæœ¬ | âš ï¸ Token æ´©æ¼æ™‚é˜²è­·è¼ƒå¼± | **å®Œå…¨ä¿¡ä»»æ¨¡å¼**ï¼ˆæ¨è–¦ï¼‰ |
| åš´æ ¼æ¨¡å¼ | æ‹’çµ•è«‹æ±‚ | âœ… å®‰å…¨æ€§é«˜ | âŒ UX å·®ï¼ˆé »ç¹é‡æ–°ç™»å…¥ï¼‰<br>âŒ æ‰‹æ©Ÿç”¨æˆ¶ç„¡æ³•ä½¿ç”¨ | é‡‘èç´šæ‡‰ç”¨ |

**æ¬Šè¡¡èªªæ˜**ï¼š
- âœ… **æ¡ç”¨å¯¬é¬†æ¨¡å¼**ï¼šç¬¦åˆå°ˆæ¡ˆã€Œå®Œå…¨ä¿¡ä»»ã€å®šä½ï¼Œç”¨æˆ¶é«”é©—å„ªå…ˆ
- âœ… **ä»ä¿ç•™ IP è¿½è¹¤**ï¼šå¯ç”¨æ–¼ç›£æ§ç•°å¸¸è¡Œç‚ºæ¨¡å¼ï¼ˆå¦‚çŸ­æ™‚é–“å…§ä¾†è‡ª 50+ ä¸åŒ IPï¼‰
- âœ… **3 å¤©éæœŸæ™‚é–“**ï¼šå³ä½¿ Token æ´©æ¼ï¼Œæå®³ä¹Ÿé™åˆ¶åœ¨ 3 å¤©å…§
- âœ… **å¯å¾ŒçºŒå‡ç´š**ï¼šç›£æ§ç™¼ç¾æ¿«ç”¨æ™‚å¯åˆ‡æ›ç‚ºåš´æ ¼æ¨¡å¼

---

### 2. Rate Limiting ç­–ç•¥

#### Upstash Redis å¯¦ä½œï¼ˆæ¨è–¦ï¼‰

**å›ºå®šçª—å£ç®—æ³•**ï¼ˆå„ªåŒ–ç‰ˆï¼‰ï¼š

```typescript
// æ ¸å¿ƒé‚è¼¯ï¼ˆå„ªåŒ–å¾Œï¼Œæ¸›å°‘ 50% Redis å‘½ä»¤ï¼‰
async function rateLimit(identifier: string, limit: number, window: number) {
  const key = `rate_limit:${identifier}:${Math.floor(Date.now() / (window * 1000))}`

  // 1. åŸå­æ€§å¢åŠ è¨ˆæ•¸
  const count = await redis.incr(key)

  // 2. é¦–æ¬¡è«‹æ±‚è¨­ç½®éæœŸæ™‚é–“
  if (count === 1) {
    await redis.expire(key, window)
  }

  return {
    success: count <= limit,
    remaining: Math.max(0, limit - count),
    resetAt: Math.ceil(Date.now() / (window * 1000)) * (window * 1000)
  }
}
```

**å„ªé»**ï¼š
- âœ… **å‘½ä»¤æ•¸æ¸›åŠ**ï¼š2 å‘½ä»¤ vs æ»‘å‹•çª—å£çš„ 4 å‘½ä»¤
- âœ… åŸå­æ€§æ“ä½œï¼ˆINCR + EXPIREï¼‰
- âœ… åˆ†æ•£å¼ç’°å¢ƒå¯é 
- âœ… ç¬¦åˆå…è²»é¡åº¦é™åˆ¶ï¼ˆ10K å‘½ä»¤/å¤©ï¼‰

**æ¬Šè¡¡**ï¼š
- âš ï¸ çª—å£é‚Šç•Œå¯èƒ½æœ‰çŸ­æš«çˆ†ç™¼ï¼ˆå¯æ¥å—ï¼‰
- âœ… å°ç”¨æˆ¶é«”é©—å½±éŸ¿æ¥µå°

**Rate Limit é…ç½®**ï¼ˆå„ªåŒ–ç‰ˆï¼Œæ¸›å°‘ Redis å‘½ä»¤æ•¸ï¼‰ï¼š

| æ“ä½œ | è­˜åˆ¥ç¬¦ | é™åˆ¶ | çª—å£ | ç†ç”± | Redis å‘½ä»¤/æ¬¡ |
|------|-------|------|------|------|--------------|
| ç²å– token | IP | 5 | 1 å°æ™‚ | é˜²æ­¢å¤§é‡å‰µå»º token | 2 |
| å»ºç«‹åˆŠç™» | Token | 10 | 24 å°æ™‚ | é˜²æ­¢åƒåœ¾åˆŠç™»ï¼ˆæ¯å¤© 10 ç­†ï¼‰ | 2 |
| ç™»è¨˜æ„å‘ | Token | 30 | 24 å°æ™‚ | é˜²æ­¢åˆ·æ„å‘é¨·æ“¾ï¼ˆæ¯å¤© 30 ç­†ï¼‰ | 2 |
| æŸ¥è©¢å¸‚å ´ | Token | 100 | 1 å°æ™‚ | **æ”¹ç‚ºéœ€èªè­‰**ï¼ˆè¦‹ä¸‹æ–¹èªªæ˜ï¼‰ | 2 |
| æŸ¥çœ‹è¯çµ¡æ–¹å¼ | Token | 20 | 24 å°æ™‚ | é˜²æ­¢æ¿«ç”¨è¯çµ¡è³‡è¨Šï¼ˆæ¯å¤© 20 æ¬¡ï¼‰ | 2 |
| èˆ‰å ±åˆŠç™» | Token | 3 | 24 å°æ™‚ | é˜²æ­¢æƒ¡æ„èˆ‰å ±ï¼ˆæ¯å¤© 3 æ¬¡ï¼‰ | 2 |
| å…¶ä»–èªè­‰ API | Token | 200 | 1 å°æ™‚ | æ›´æ–°ã€åˆªé™¤ã€æŸ¥è©¢ç­‰æ“ä½œ | 2 |

**é—œéµè®Šæ›´**ï¼š
- âœ… å»¶é•·çª—å£æ™‚é–“ï¼ˆ1 å°æ™‚ â†’ 24 å°æ™‚ï¼‰ï¼Œæ¸›å°‘ Redis key å‰µå»ºé »ç‡
- âœ… æŸ¥è©¢å¸‚å ´**æ”¹ç‚ºéœ€è¦èªè­‰**ï¼ˆé˜²æ­¢çˆ¬èŸ²ï¼Œè¦‹ P0-2ï¼‰
- âœ… æ¯æ¬¡è«‹æ±‚åªéœ€ 2 å€‹ Redis å‘½ä»¤ï¼ˆINCR + EXPIREï¼‰

---

### 3. è¯çµ¡æ–¹å¼ä¿è­·æ©Ÿåˆ¶

**æ ¸å¿ƒå•é¡Œ**ï¼šè¯çµ¡æ–¹å¼å®Œå…¨æš´éœ²æœƒå°è‡´éš±ç§æ´©æ¼ã€çˆ¬èŸ²æ¿«ç”¨ã€é¨·æ“¾é¢¨éšªã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼šæ‡‰ç”¨å±¤æ¬Šé™æ§åˆ¶ + å°ˆç”¨ API

#### ä¿è­·ç­–ç•¥

```typescript
// å¸‚å ´åˆ—è¡¨æŸ¥è©¢ï¼šè‡ªå‹•éæ¿¾è¯çµ¡æ–¹å¼
async function getMarketListings() {
  const { data } = await supabase
    .from('listings')
    .select('id, character_id, item_id, quantity, price, status, created_at')
    // âŒ ä¸é¸æ“‡ contact_method, contact_info
    .eq('status', 'active')

  return data
}

// æŸ¥çœ‹è¯çµ¡æ–¹å¼ï¼šå¤šå±¤æ¬Šé™é©—è­‰ï¼ˆå¢å¼·ç‰ˆï¼‰
async function getContactInfo(listingId: string, userId: string, requestIP: string) {
  // 1. æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²ç™»è¨˜æ„å‘
  const { data: interest } = await supabase
    .from('interests')
    .select('id, created_at')
    .eq('listing_id', listingId)
    .eq('buyer_id', userId)
    .single()

  if (!interest) {
    throw new ForbiddenError('éœ€è¦å…ˆç™»è¨˜è³¼è²·æ„å‘æ‰èƒ½æŸ¥çœ‹è¯çµ¡æ–¹å¼')
  }

  // 2. å†·å»æœŸæª¢æŸ¥ï¼ˆé˜²æ­¢å¿«é€Ÿé¨·æ“¾ï¼‰
  const timeSinceInterest = Date.now() - new Date(interest.created_at).getTime()
  const cooldownPeriod = 2 * 60 * 1000  // 2 åˆ†é˜ï¼ˆå„ªåŒ–å¾Œï¼Œå¹³è¡¡ç”¨æˆ¶é«”é©—èˆ‡å®‰å…¨æ€§ï¼‰

  if (timeSinceInterest < cooldownPeriod) {
    const remainingSeconds = Math.ceil((cooldownPeriod - timeSinceInterest) / 1000)
    throw new ForbiddenError(
      `è«‹ç­‰å¾… ${remainingSeconds} ç§’å¾Œå†æŸ¥çœ‹è¯çµ¡æ–¹å¼ï¼ˆé˜²æ­¢å¿«é€Ÿé¨·æ“¾ï¼‰`
    )
  }

  // 3. IP é…é¡æª¢æŸ¥ï¼ˆè·¨å¸³è™Ÿé˜²è­·ï¼‰
  const { data: ipQuota } = await supabase
    .from('ip_quotas')
    .select('contact_views_today, last_contact_view_date')
    .eq('ip_address', requestIP)
    .single()

  if (ipQuota) {
    const isToday = ipQuota.last_contact_view_date === new Date().toISOString().split('T')[0]
    if (isToday && ipQuota.contact_views_today >= 30) {
      throw new ForbiddenError('æ‚¨ä»Šæ—¥æŸ¥çœ‹è¯çµ¡æ–¹å¼æ¬¡æ•¸å·²é”ä¸Šé™ï¼ˆ30 æ¬¡ï¼‰')
    }
  }

  // 4. æ›´æ–° IP é…é¡
  await supabase.rpc('increment_ip_contact_quota', {
    p_ip_address: requestIP
  })

  // 5. è¨˜éŒ„å­˜å–æ—¥èªŒï¼ˆé˜²æ¿«ç”¨è¿½è¹¤ï¼‰
  logger.info('contact_info_accessed', {
    listingId,
    buyerId: userId,
    requestIP,
    timestamp: new Date(),
    timeSinceInterest: `${Math.floor(timeSinceInterest / 1000)}s`
  })

  // 6. è¿”å›è¯çµ¡æ–¹å¼
  const { data } = await supabase
    .from('listings')
    .select('contact_method, contact_info')
    .eq('id', listingId)
    .single()

  return data
}
```

**IP é…é¡ RPC å‡½æ•¸**ï¼š

```sql
-- å¢åŠ  IP è¯çµ¡æ–¹å¼é…é¡
CREATE FUNCTION increment_ip_contact_quota(p_ip_address INET) RETURNS void AS $$
  INSERT INTO ip_quotas (ip_address, contact_views_today, total_contact_views, last_contact_view_date)
  VALUES (p_ip_address, 1, 1, CURRENT_DATE)
  ON CONFLICT (ip_address)
  DO UPDATE SET
    contact_views_today = CASE
      WHEN ip_quotas.last_contact_view_date = CURRENT_DATE
      THEN ip_quotas.contact_views_today + 1
      ELSE 1
    END,
    total_contact_views = ip_quotas.total_contact_views + 1,
    last_contact_view_date = CURRENT_DATE,
    updated_at = NOW();
$$ LANGUAGE sql;
```

**å¤šå±¤é˜²è­·ç¸½çµ**ï¼š

| é˜²è­·å±¤ | æ©Ÿåˆ¶ | é™åˆ¶ | ç›®çš„ |
|-------|------|------|------|
| 1. æ„å‘æª¢æŸ¥ | interests è¡¨ | å¿…é ˆç™»è¨˜æ„å‘ | é˜²æ­¢éš¨æ„æŸ¥çœ‹ |
| 2. å†·å»æœŸ | æ™‚é–“æª¢æŸ¥ | ç™»è¨˜å¾Œ **2 åˆ†é˜** | é˜²æ­¢å¿«é€Ÿé¨·æ“¾ |
| 3. Token é…é¡ | user_quotas | 20 æ¬¡/å¤©/å¸³è™Ÿ | é™åˆ¶å–®å¸³è™Ÿæ¿«ç”¨ |
| 4. IP é…é¡ | ip_quotas | 30 æ¬¡/å¤©/IP | é˜²æ­¢å¤šå¸³è™Ÿç¹é |
| 5. Rate Limit | Redis | 10 æ¬¡/å°æ™‚ | é˜²æ­¢æš´åŠ›è«‹æ±‚ |

**é¡å¤–ä¿è­·**ï¼š
- âœ… æŸ¥çœ‹è¯çµ¡æ–¹å¼çš„ API é™åˆ¶ç‚º 10 æ¬¡/å°æ™‚
- âœ… è¨˜éŒ„æ‰€æœ‰è¯çµ¡æ–¹å¼å­˜å–ï¼ˆè¿½è¹¤ç•°å¸¸è¡Œç‚ºï¼‰
- âœ… è³£å®¶å¯æŸ¥çœ‹ã€Œèª°æŸ¥çœ‹äº†è¯çµ¡æ–¹å¼ã€ï¼ˆé€æ˜åº¦ï¼‰
- âœ… å†·å»æœŸé¿å…å¿«é€Ÿé¨·æ“¾ï¼ˆç™»è¨˜æ„å‘å¾Œç­‰å¾… **2 åˆ†é˜**ï¼Œå„ªåŒ–ç”¨æˆ¶é«”é©—ï¼‰
- âœ… IP ç´šåˆ¥é…é¡é˜²æ­¢ç”¨æˆ¶å‰µå»ºå¤§é‡å¸³è™Ÿç¹éé™åˆ¶

**å†·å»æœŸå„ªåŒ–åˆ†æï¼ˆ5 åˆ†é˜ â†’ 2 åˆ†é˜ï¼‰**ï¼š

| è©•ä¼°é¢å‘ | 5 åˆ†é˜ | 2 åˆ†é˜ | çµè«– |
|---------|-------|-------|------|
| **ç”¨æˆ¶é«”é©—** | âŒ ç­‰å¾…éä¹…ï¼Œå½±éŸ¿äº¤æ˜“æ•ˆç‡ | âœ… åˆç†ç­‰å¾…ï¼Œä¸å½±éŸ¿æ­£å¸¸ä½¿ç”¨ | 2 åˆ†é˜è¶³å¤  |
| **é˜²è­·æ•ˆæœ** | âœ… å¼·åŠ›é˜²è­· | âœ… ä»æœ‰æ•ˆï¼ˆé…åˆå…¶ä»– 4 å±¤é˜²è­·ï¼‰ | å®‰å…¨ç„¡è™ |
| **é¨·æ“¾æˆæœ¬** | æ¯ 5 åˆ†é˜ 1 æ¬¡ | æ¯ 2 åˆ†é˜ 1 æ¬¡ | Rate Limit (10/å°æ™‚) å·²è¶³å¤  |
| **å¯¦éš›å½±éŸ¿** | 1 å°æ™‚æœ€å¤š 12 æ¬¡ | 1 å°æ™‚æœ€å¤š 30 æ¬¡ | Rate Limit é™åˆ¶ç‚º 10 æ¬¡/å°æ™‚ |

**ç‚ºä»€éº¼å¯ä»¥å®‰å…¨ç¸®çŸ­ï¼Ÿ**

1. **å¤šå±¤é˜²è­·æ©Ÿåˆ¶**ï¼š
   - âœ… Rate Limitï¼š10 æ¬¡/å°æ™‚ï¼ˆ**ä¸»è¦é˜²ç·š**ï¼‰
   - âœ… IP é…é¡ï¼š30 æ¬¡/å¤©ï¼ˆè·¨å¸³è™Ÿé˜²è­·ï¼‰
   - âœ… Token é…é¡ï¼š20 æ¬¡/å¤©ï¼ˆå–®å¸³è™Ÿé™åˆ¶ï¼‰
   - âœ… å†·å»æœŸï¼š2 åˆ†é˜ï¼ˆè¼”åŠ©é˜²è­·ï¼‰

2. **å¯¦éš›æ”»æ“Šå ´æ™¯åˆ†æ**ï¼š
   ```
   æ”»æ“Šè€…å˜—è©¦é¨·æ“¾ï¼š
   - 0:00 - ç¬¬ 1 æ¬¡æŸ¥çœ‹ï¼ˆå†·å»æœŸé–‹å§‹ï¼‰
   - 0:02 - ç¬¬ 2 æ¬¡æŸ¥çœ‹ï¼ˆâœ… å†·å»æœŸå…è¨±ï¼‰
   - 0:04 - ç¬¬ 3 æ¬¡æŸ¥çœ‹
   - ...
   - 1:00 - ç¬¬ 30 æ¬¡å˜—è©¦ âŒ Rate Limit é˜»æ“‹ï¼ˆè¶…é 10 æ¬¡/å°æ™‚ï¼‰

   çµè«–ï¼šå³ä½¿å†·å»æœŸåªæœ‰ 2 åˆ†é˜ï¼ŒRate Limit ä»æœƒåœ¨ 1 å°æ™‚å…§é™åˆ¶ç‚º 10 æ¬¡
   ```

3. **çœŸå¯¦ç”¨æˆ¶è¡Œç‚º**ï¼š
   - æ­£å¸¸ç”¨æˆ¶ï¼šç™»è¨˜æ„å‘å¾Œé€šå¸¸ç«‹å³æŸ¥çœ‹ï¼ˆ< 1 åˆ†é˜ï¼‰
   - 5 åˆ†é˜å†·å»æœŸæœƒå°è‡´ç”¨æˆ¶å¿˜è¨˜æˆ–æ”¾æ£„äº¤æ˜“
   - 2 åˆ†é˜å†·å»æœŸï¼šè¶³ä»¥è®“ç”¨æˆ¶é–±è®€ç‰©å“æè¿°ã€è€ƒæ…®åƒ¹æ ¼ï¼Œä¸å½±éŸ¿äº¤æ˜“æµç¨‹

4. **å„ªåŒ–æ•ˆç›Š**ï¼š
   - âœ… é™ä½ç”¨æˆ¶æµå¤±ç‡ï¼ˆæ¸›å°‘ç­‰å¾…æ”¾æ£„ï¼‰
   - âœ… æå‡äº¤æ˜“è½‰æ›ç‡ï¼ˆæ›´å¿«å®Œæˆäº¤æ˜“ï¼‰
   - âœ… ä¿æŒå®‰å…¨æ€§ï¼ˆä¾è³´ Rate Limit å’Œé…é¡ç³»çµ±ï¼‰

---

### 4. ç”¨æˆ¶é…é¡ç³»çµ±

**æ ¸å¿ƒå•é¡Œ**ï¼šç„¡é™åˆ¶åˆŠç™»/ç™»è¨˜æ„å‘æœƒå°è‡´åƒåœ¾å…§å®¹æ³›æ¿«ã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼šè³‡æ–™åº«é…é¡è¡¨ + æ‡‰ç”¨å±¤æª¢æŸ¥

#### é…é¡é™åˆ¶

```typescript
const QUOTAS = {
  maxActiveListings: 50,        // æ¯äººæœ€å¤š 50 ç­†æœ‰æ•ˆåˆŠç™»
  maxTotalInterests: 100,       // æ¯äººæœ€å¤š 100 ç­†ç¸½æ„å‘
  maxInterestsPerDay: 20,       // æ¯å¤©æœ€å¤š 20 ç­†æ–°æ„å‘
}

// å»ºç«‹åˆŠç™»å‰æª¢æŸ¥é…é¡
async function checkListingQuota(userId: string) {
  const { data: quota } = await supabase
    .from('user_quotas')
    .select('active_listings_count')
    .eq('character_id', userId)
    .single()

  if (quota && quota.active_listings_count >= QUOTAS.maxActiveListings) {
    throw new QuotaExceededError(`åˆŠç™»æ•¸å·²é”ä¸Šé™ï¼ˆ${QUOTAS.maxActiveListings}ï¼‰`)
  }
}

// ç™»è¨˜æ„å‘å‰æª¢æŸ¥é…é¡
async function checkInterestQuota(userId: string) {
  const { data: quota } = await supabase
    .from('user_quotas')
    .select('total_interests_count, interests_today, last_interest_date')
    .eq('character_id', userId)
    .single()

  if (quota) {
    // æª¢æŸ¥ç¸½æ•¸é™åˆ¶
    if (quota.total_interests_count >= QUOTAS.maxTotalInterests) {
      throw new QuotaExceededError(`ç¸½æ„å‘æ•¸å·²é”ä¸Šé™ï¼ˆ${QUOTAS.maxTotalInterests}ï¼‰`)
    }

    // æª¢æŸ¥æ¯æ—¥é™åˆ¶
    const isToday = quota.last_interest_date === new Date().toISOString().split('T')[0]
    if (isToday && quota.interests_today >= QUOTAS.maxInterestsPerDay) {
      throw new QuotaExceededError(`ä»Šæ—¥æ„å‘æ•¸å·²é”ä¸Šé™ï¼ˆ${QUOTAS.maxInterestsPerDay}ï¼‰`)
    }
  }
}

// åˆŠç™»å»ºç«‹å¾Œæ›´æ–°é…é¡
async function incrementListingQuota(userId: string) {
  await supabase.rpc('increment_listing_quota', { p_user_id: userId })
}

// æ„å‘å»ºç«‹å¾Œæ›´æ–°é…é¡
async function incrementInterestQuota(userId: string) {
  await supabase.rpc('increment_interest_quota', { p_user_id: userId })
}
```

**é…é¡ RPC å‡½æ•¸**ï¼š

```sql
-- å¢åŠ åˆŠç™»é…é¡
CREATE FUNCTION increment_listing_quota(p_user_id TEXT) RETURNS void AS $$
  INSERT INTO user_quotas (character_id, active_listings_count)
  VALUES (p_user_id, 1)
  ON CONFLICT (character_id)
  DO UPDATE SET active_listings_count = user_quotas.active_listings_count + 1;
$$ LANGUAGE sql;

-- å¢åŠ æ„å‘é…é¡
CREATE FUNCTION increment_interest_quota(p_user_id TEXT) RETURNS void AS $$
  INSERT INTO user_quotas (character_id, total_interests_count, interests_today, last_interest_date)
  VALUES (p_user_id, 1, 1, CURRENT_DATE)
  ON CONFLICT (character_id)
  DO UPDATE SET
    total_interests_count = user_quotas.total_interests_count + 1,
    interests_today = CASE
      WHEN user_quotas.last_interest_date = CURRENT_DATE
      THEN user_quotas.interests_today + 1
      ELSE 1
    END,
    last_interest_date = CURRENT_DATE;
$$ LANGUAGE sql;
```

---

### 5. è¼¸å…¥é©—è­‰

**å¤šå±¤é©—è­‰ç­–ç•¥**ï¼š

```typescript
// 1. é¡å‹é©—è­‰ï¼ˆTypeScriptï¼‰
interface CreateListingRequest {
  itemId: number
  quantity: number
  price: number
  contactMethod: 'discord' | 'ingame'  // æ”¯æ´å…©ç¨®è¯çµ¡æ–¹å¼
  contactInfo: string
}

// 2. æ¥­å‹™é‚è¼¯é©—è­‰
function validateListingData(data: CreateListingRequest) {
  if (!Number.isInteger(data.itemId) || data.itemId <= 0) {
    throw new ValidationError('ç‰©å“ ID å¿…é ˆæ˜¯æ­£æ•´æ•¸')
  }

  if (data.quantity < 1 || data.quantity > 9999) {
    throw new ValidationError('æ•¸é‡ç¯„åœï¼š1-9999')
  }

  if (data.price <= 0 || data.price > 1e12) {
    throw new ValidationError('åƒ¹æ ¼ç¯„åœï¼š1-1,000,000,000,000')
  }

  if (!['discord', 'ingame'].includes(data.contactMethod)) {
    throw new ValidationError('è¯çµ¡æ–¹å¼å¿…é ˆæ˜¯ discord æˆ– ingame')
  }

  // æ ¹æ“šè¯çµ¡æ–¹å¼é©—è­‰æ ¼å¼
  if (data.contactMethod === 'discord') {
    // Discord ID æ ¼å¼ï¼šusername æˆ– username#1234ï¼ˆèˆŠæ ¼å¼ï¼‰
    if (!data.contactInfo.match(/^[\w]{2,32}(#\d{4})?$/)) {
      throw new ValidationError('ç„¡æ•ˆçš„ Discord ç”¨æˆ¶åæ ¼å¼')
    }
  } else if (data.contactMethod === 'ingame') {
    // éŠæˆ²è§’è‰²åé•·åº¦é™åˆ¶
    if (data.contactInfo.length < 2 || data.contactInfo.length > 13) {
      throw new ValidationError('éŠæˆ²è§’è‰²åé•·åº¦ï¼š2-13 å€‹å­—å…ƒ')
    }
  }

  if (!data.contactInfo || data.contactInfo.length > 200) {
    throw new ValidationError('è¯çµ¡è³‡è¨Šé•·åº¦ï¼š1-200 å­—å…ƒ')
  }
}

// 3. è³‡æ–™åº«ç´„æŸï¼ˆæœ€å¾Œé˜²ç·šï¼‰
CHECK (quantity > 0 AND quantity <= 9999)
CHECK (contact_method IN ('discord', 'ingame'))
```

---

### 4. CSRF èˆ‡ XSS é˜²è­·

#### CSRF é˜²è­·

**ç­–ç•¥**ï¼šä½¿ç”¨ Same-Site Cookie + Custom Header

```typescript
// API è¦æ±‚å¿…é ˆå¸¶ä¸Šè‡ªå®šç¾© header
const headers = {
  'Content-Type': 'application/json',
  'X-Requested-With': 'XMLHttpRequest',  // CSRF é˜²è­·
  'Authorization': `Bearer ${token}`
}
```

#### XSS é˜²è­·

**ç­–ç•¥**ï¼š
- âœ… Next.js è‡ªå‹• HTML è½‰ç¾©
- âœ… é¿å… `dangerouslySetInnerHTML`
- âœ… Content-Security-Policy headerï¼ˆå¯é¸ï¼‰

```typescript
// next.config.ts
const securityHeaders = [
  {
    key: 'X-Content-Type-Options',
    value: 'nosniff'
  },
  {
    key: 'X-Frame-Options',
    value: 'DENY'
  }
]
```

---

### 5. Row Level Security (RLS)

**Supabase RLS ç­–ç•¥ç¯„ä¾‹**ï¼š

```sql
-- å•Ÿç”¨ RLS
ALTER TABLE listings ENABLE ROW LEVEL SECURITY;
ALTER TABLE interests ENABLE ROW LEVEL SECURITY;
ALTER TABLE reports ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_quotas ENABLE ROW LEVEL SECURITY;

-- åˆŠç™»è¡¨ RLS
-- æ‰€æœ‰äººå¯æŸ¥çœ‹æœ‰æ•ˆåˆŠç™»ï¼ˆä½†æ‡‰ç”¨å±¤æœƒéæ¿¾ contact_infoï¼‰
CREATE POLICY "view_active_listings" ON listings
  FOR SELECT USING (
    status = 'active' AND deleted_at IS NULL
  );

-- å¯æŸ¥çœ‹è‡ªå·±çš„æ‰€æœ‰åˆŠç™»ï¼ˆåŒ…å«å·²é—œé–‰å’Œå·²åˆªé™¤ï¼‰
CREATE POLICY "view_own_listings" ON listings
  FOR SELECT USING (
    character_id = current_setting('app.character_id', true)
  );

-- åªèƒ½ä¿®æ”¹è‡ªå·±çš„åˆŠç™»
CREATE POLICY "update_own_listings" ON listings
  FOR UPDATE USING (
    character_id = current_setting('app.character_id', true)
  );

-- æ„å‘è¡¨ RLS
-- å¯æŸ¥çœ‹è‡ªå·±ä½œç‚ºè²·å®¶çš„æ„å‘
CREATE POLICY "view_own_interests_buyer" ON interests
  FOR SELECT USING (
    buyer_id = current_setting('app.character_id', true)
  );

-- å¯æŸ¥çœ‹è‡ªå·±åˆŠç™»æ”¶åˆ°çš„æ„å‘
CREATE POLICY "view_received_interests" ON interests
  FOR SELECT USING (
    listing_id IN (
      SELECT id FROM listings
      WHERE character_id = current_setting('app.character_id', true)
    )
  );

-- åªèƒ½å»ºç«‹è‡ªå·±çš„æ„å‘
CREATE POLICY "create_own_interests" ON interests
  FOR INSERT WITH CHECK (
    buyer_id = current_setting('app.character_id', true)
  );

-- åªèƒ½ä¿®æ”¹/åˆªé™¤è‡ªå·±çš„æ„å‘
CREATE POLICY "manage_own_interests" ON interests
  FOR UPDATE USING (
    buyer_id = current_setting('app.character_id', true)
  );

CREATE POLICY "delete_own_interests" ON interests
  FOR DELETE USING (
    buyer_id = current_setting('app.character_id', true)
  );

-- èˆ‰å ±è¡¨ RLS
-- å¯æŸ¥çœ‹è‡ªå·±æäº¤çš„èˆ‰å ±
CREATE POLICY "view_own_reports" ON reports
  FOR SELECT USING (
    reporter_id = current_setting('app.character_id', true)
  );

-- å¯å»ºç«‹èˆ‰å ±
CREATE POLICY "create_reports" ON reports
  FOR INSERT WITH CHECK (
    reporter_id = current_setting('app.character_id', true)
  );

-- é…é¡è¡¨ RLS
-- åªèƒ½æŸ¥çœ‹è‡ªå·±çš„é…é¡
CREATE POLICY "view_own_quota" ON user_quotas
  FOR SELECT USING (
    character_id = current_setting('app.character_id', true)
  );
```

**ä½¿ç”¨æ–¹å¼**ï¼š
```typescript
// åœ¨æ¯å€‹è«‹æ±‚ä¸­è¨­ç½® character_id
await supabase.rpc('set_config', {
  parameter: 'app.character_id',
  value: characterId
})
```

---

## å¯é æ€§è¨­è¨ˆ

### 1. éŒ¯èª¤è™•ç†ç­–ç•¥

#### éŒ¯èª¤åˆ†é¡

| é¡åˆ¥ | HTTP ç‹€æ…‹ç¢¼ | è™•ç†æ–¹å¼ | é‡è©¦ |
|------|------------|---------|------|
| è¼¸å…¥éŒ¯èª¤ | 400 | è¿”å›è©³ç´°éŒ¯èª¤è¨Šæ¯ | âŒ |
| èªè­‰éŒ¯èª¤ | 401 | è¦æ±‚é‡æ–°ç™»å…¥ | âŒ |
| æ¬Šé™éŒ¯èª¤ | 403 | æ‹’çµ•è¨ªå• | âŒ |
| è³‡æºä¸å­˜åœ¨ | 404 | è¿”å›éŒ¯èª¤è¨Šæ¯ | âŒ |
| å”¯ä¸€ç´„æŸè¡çª | 409 | è¿”å›å‹å–„è¨Šæ¯ï¼ˆå¦‚ã€Œå·²ç™»è¨˜éæ„å‘ã€ï¼‰ | âŒ |
| Rate Limit | 429 | è¿”å› Retry-After | âœ… |
| ä¼ºæœå™¨éŒ¯èª¤ | 500 | è¨˜éŒ„éŒ¯èª¤ã€é€šç”¨è¨Šæ¯ | âœ… |
| è³‡æ–™åº«éŒ¯èª¤ | 503 | æš«æ™‚ä¸å¯ç”¨ | âœ… |

#### é‡è©¦æ©Ÿåˆ¶

**æŒ‡æ•¸é€€é¿ç­–ç•¥**ï¼š

```typescript
async function retryWithBackoff<T>(
  fn: () => Promise<T>,
  maxRetries: number = 3,
  baseDelay: number = 1000
): Promise<T> {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      return await fn()
    } catch (error) {
      if (attempt === maxRetries || !isRetriableError(error)) {
        throw error
      }

      // æŒ‡æ•¸é€€é¿ï¼š1s, 2s, 4s
      const delay = baseDelay * Math.pow(2, attempt - 1)
      await sleep(delay)
    }
  }
  throw new Error('Max retries exceeded')
}

function isRetriableError(error: any): boolean {
  // 429 (é™æµ), 500, 503 å¯é‡è©¦
  return [429, 500, 503].includes(error.status)
}
```

---

### 2. è³‡æ–™ä¸€è‡´æ€§

#### ç°¡åŒ–çš„ä¸€è‡´æ€§ä¿è­‰

ç”±æ–¼ç³»çµ±ä¸æ¶‰åŠè¤‡é›œçš„äº¤æ˜“é‚è¼¯ï¼Œè³‡æ–™ä¸€è‡´æ€§ä¸»è¦ä¾è³´ï¼š

1. **è³‡æ–™åº«ç´„æŸ**ï¼šCHECK ç´„æŸã€UNIQUE ç´„æŸã€å¤–éµç´„æŸ
2. **æ‡‰ç”¨å±¤é©—è­‰**ï¼šæ¥­å‹™é‚è¼¯é©—è­‰ï¼ˆåƒ¹æ ¼ã€è¯çµ¡æ–¹å¼ç­‰ï¼‰
3. **å”¯ä¸€ç´„æŸ**ï¼šé˜²æ­¢é‡è¤‡ç™»è¨˜æ„å‘

**ä¸€è‡´æ€§æª¢æŸ¥**ï¼ˆå®šæœŸåŸ·è¡Œï¼‰ï¼š

```sql
-- æª¢æŸ¥åˆŠç™»è³‡æ–™å®Œæ•´æ€§
SELECT COUNT(*) FROM listings
WHERE is_active = TRUE
  AND (price IS NULL OR price <= 0 OR contact_method IS NULL);

-- æª¢æŸ¥å­¤ç«‹æ„å‘è¨˜éŒ„ï¼ˆæ‡‰è©²ç‚º 0ï¼ŒCASCADE æœƒè‡ªå‹•æ¸…ç†ï¼‰
SELECT COUNT(*) FROM interests i
LEFT JOIN listings l ON i.listing_id = l.id
WHERE l.id IS NULL;
```

---

### 3. ç›£æ§èˆ‡å‘Šè­¦

#### é—œéµç›£æ§æŒ‡æ¨™

| æŒ‡æ¨™ | é–¾å€¼ | å‘Šè­¦ç´šåˆ¥ | è™•ç†æ–¹å¼ |
|------|------|---------|---------|
| **Redis å‘½ä»¤æ•¸** | > 6,000/å¤©ï¼ˆ60%ï¼‰ | ğŸŸ¡ Warning | æª¢æŸ¥ç•°å¸¸æµé‡ |
| **Redis å‘½ä»¤æ•¸** | > 7,000/å¤©ï¼ˆ70%ï¼‰ | ğŸ”´ Critical | **è‡ªå‹•å•Ÿç”¨é™ç´šæ¨¡å¼** |
| **Redis å‘½ä»¤æ•¸** | > 10,000/å¤©ï¼ˆ100%ï¼‰ | ğŸš¨ Emergency | **å·²è¶…æ¨™ï¼Œç«‹å³æ‰‹å‹•é™ç´š** |
| API éŒ¯èª¤ç‡ | > 5% | ğŸ”´ Critical | ç«‹å³æª¢æŸ¥ |
| API å»¶é² P95 | > 2s | ğŸŸ¡ Warning | å„ªåŒ–æŸ¥è©¢ |
| è³‡æ–™åº«é€£æ¥æ•¸ | > 80% | ğŸŸ¡ Warning | æª¢æŸ¥é€£æ¥æ´©æ¼ |
| è³‡æ–™åº«å¤§å° | > 400MB | ğŸŸ¡ Warning | åŸ·è¡Œæ¸…ç† |
| Token å‰µå»ºé€Ÿç‡ | > 100/å°æ™‚ | ğŸŸ¡ Warning | æª¢æŸ¥æ¿«ç”¨ |
| æ„å‘ç™»è¨˜å¤±æ•—ç‡ | > 5% | ğŸŸ¡ Warning | æª¢æŸ¥å”¯ä¸€ç´„æŸè¡çª |
| é…é¡é•è¦ç‡ | > 1% | ğŸŸ¡ Warning | æª¢æŸ¥æƒ¡æ„ç”¨æˆ¶ |
| ç„¡æ•ˆåˆŠç™»ç‡ | > 20% | ğŸŸ¡ Warning | æé†’è³£å®¶æ›´æ–°ç‹€æ…‹ |
| èˆ‰å ±è™•ç†æ™‚é–“ | > 24å°æ™‚ | ğŸŸ¡ Warning | æª¢æŸ¥ç®¡ç†å“¡å·¥ä½œé‡ |
| è¯çµ¡æ–¹å¼å­˜å–ç•°å¸¸ | > 50/å°æ™‚ | ğŸ”´ Critical | æª¢æŸ¥çˆ¬èŸ²æˆ–æ¿«ç”¨ |

#### Redis å‘½ä»¤è‡ªè¿½è¹¤ï¼ˆé—œéµå¯¦ä½œï¼‰

**å•é¡Œ**ï¼šUpstash å…è²»ç‰ˆä¸æä¾›å‘½ä»¤æ•¸ç›£æ§ï¼Œå¿…é ˆè‡ªè¡Œè¿½è¹¤ä»¥é¿å…è¶…æ¨™ã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼šåœ¨ Supabase ä¸­å»ºç«‹è¨ˆæ•¸å™¨è¡¨ï¼Œæ¯æ¬¡ Rate Limit æª¢æŸ¥æ™‚è‡ªå‹•å¢åŠ ã€‚

```sql
-- Redis å‘½ä»¤è¨ˆæ•¸å™¨è¡¨
CREATE TABLE redis_command_counter (
  date DATE PRIMARY KEY DEFAULT CURRENT_DATE,
  command_count INT DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- å¢åŠ è¨ˆæ•¸å™¨ RPC å‡½æ•¸ï¼ˆæ”¹ç‚º Cron Job èª¿ç”¨ï¼Œä¸å†æ¯æ¬¡ API èª¿ç”¨ï¼‰
CREATE FUNCTION increment_redis_counter(p_commands INT DEFAULT 2) RETURNS void AS $$
  INSERT INTO redis_command_counter (date, command_count)
  VALUES (CURRENT_DATE, p_commands)
  ON CONFLICT (date)
  DO UPDATE SET
    command_count = redis_command_counter.command_count + p_commands,
    updated_at = NOW();
$$ LANGUAGE sql;
```

**Cron Job é…ç½®ï¼ˆå¤šä»»å‹™æ’ç¨‹ï¼‰**ï¼š

```json
// vercel.json
{
  "crons": [
    {
      "path": "/api/maintenance/cleanup",
      "schedule": "0 2 * * *"  // æ¯å¤©å‡Œæ™¨ 2 é»æ¸…ç†ï¼ˆæ—¥å¸¸ä»»å‹™ï¼‰
    },
    {
      "path": "/api/maintenance/check-redis-usage",
      "schedule": "0 * * * *"  // æ¯å°æ™‚æª¢æŸ¥ Redis ä½¿ç”¨ç‡
    },
    {
      "path": "/api/maintenance/cleanup-ip-quotas",
      "schedule": "0 3 1 * *"  // æ¯æœˆ 1 è™Ÿå‡Œæ™¨ 3 é»æ¸…ç† IP é…é¡
    }
  ]
}
```

**Cron Job API å¯¦ä½œ**ï¼š

```typescript
// GET /api/maintenance/check-redis-usage
export async function GET(request: NextRequest) {
  // é©—è­‰ Cron Secret
  const authHeader = request.headers.get('authorization')
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return Response.json({ error: 'Unauthorized' }, { status: 401 })
  }

  // 1. çµ±è¨ˆç•¶å‰å°æ™‚çš„ API èª¿ç”¨æ•¸ï¼ˆå¾æ—¥èªŒæˆ–ç°¡åŒ–ä¼°ç®—ï¼‰
  // ç°¡åŒ–ç‰ˆï¼šç›´æ¥ä¼°ç®—æ¯å°æ™‚ ~222 æ¬¡ API èª¿ç”¨ï¼ˆ5334 / 24ï¼‰
  const estimatedCallsPerHour = Math.floor(5334 / 24)  // ~222 æ¬¡/å°æ™‚

  // 2. ä¼°ç®— Redis å‘½ä»¤æ•¸ï¼ˆæ¯æ¬¡ API èª¿ç”¨ = 2 å‘½ä»¤ï¼‰
  const estimatedCommands = estimatedCallsPerHour * 2  // ~444 å‘½ä»¤/å°æ™‚

  // 3. æ›´æ–°è¨ˆæ•¸å™¨
  await supabase.rpc('increment_redis_counter', {
    p_commands: estimatedCommands
  })

  // 4. æª¢æŸ¥ä½¿ç”¨ç‡ä¸¦è§¸ç™¼å‘Šè­¦
  const { data } = await supabase
    .from('redis_command_counter')
    .select('command_count')
    .eq('date', new Date().toISOString().split('T')[0])
    .single()

  const usage = ((data?.command_count || 0) / 10000) * 100

  if (usage >= 70) {
    // è‡ªå‹•å•Ÿç”¨é™ç´šæ¨¡å¼ï¼ˆç’°å¢ƒè®Šæ•¸æˆ–è³‡æ–™åº«æ¨™è¨˜ï¼‰
    logger.error('redis_quota_critical_auto_degradation', {
      commandCount: data.command_count,
      usage: `${usage.toFixed(1)}%`,
      action: 'Auto degradation mode enabled'
    })
  }

  return Response.json({
    success: true,
    estimatedCallsPerHour,
    estimatedCommands,
    totalToday: data?.command_count || 0,
    usage: `${usage.toFixed(1)}%`,
    degradationMode: usage >= 70
  })
}
```

```typescript
// GET /api/maintenance/cleanup-ip-quotas
export async function GET(request: NextRequest) {
  // é©—è­‰ Cron Secret
  const authHeader = request.headers.get('authorization')
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return Response.json({ error: 'Unauthorized' }, { status: 401 })
  }

  // åŸ·è¡Œæ¸…ç†ï¼ˆåˆªé™¤ 30 å¤©ç„¡æ´»å‹•çš„ IP è¨˜éŒ„ï¼‰
  const { data, error } = await supabase.rpc('cleanup_old_ip_quotas')

  if (error) {
    logger.error('cleanup_ip_quotas_failed', {
      error: error.message,
      code: error.code
    })
    return Response.json({ error: 'Cleanup failed' }, { status: 500 })
  }

  // çµ±è¨ˆæ¸…ç†çµæœ
  const deletedCount = data || 0  // å‡è¨­ RPC è¿”å›åˆªé™¤ç­†æ•¸

  logger.info('cleanup_ip_quotas_success', {
    deletedCount,
    threshold: '30 days',
    nextRun: 'Next month 1st day 3:00 AM'
  })

  return Response.json({
    success: true,
    deletedCount,
    message: `Cleaned up ${deletedCount} old IP quota records`,
    nextSchedule: '0 3 1 * *'
  })
}
```

**å„ªåŒ–æ•ˆæœ**ï¼š

**Redis ä½¿ç”¨ç‡ç›£æ§**ï¼š
- âœ… è³‡æ–™åº«èª¿ç”¨ï¼š5,334 æ¬¡/å¤© â†’ **24 æ¬¡/å¤©**ï¼ˆ-99.5%ï¼‰
- âœ… API å»¶é²ï¼šæ¸›å°‘ 10-50msï¼ˆç§»é™¤å³æ™‚ RPC èª¿ç”¨ï¼‰
- âœ… æº–ç¢ºæ€§ï¼šæ¯å°æ™‚çµ±è¨ˆä¸€æ¬¡ï¼Œè¶³ä»¥è§¸ç™¼å‘Šè­¦
- âš ï¸ å»¶é²æ€§ï¼šæœ€å¤š 1 å°æ™‚æ‰ç™¼ç¾è¶…æ¨™ï¼ˆå¯æ¥å—ï¼‰

**IP é…é¡è¡¨æ¸…ç†**ï¼š
- âœ… é˜²æ­¢è³‡æ–™è¡¨ç„¡é™å¢é•·ï¼ˆé ä¼°æ¯æœˆæ¸…ç† ~3,000 ç­†èˆŠè¨˜éŒ„ï¼‰
- âœ… è³‡æ–™åº«ç©ºé–“ç¯€çœï¼š~0.36 MB/æœˆï¼ˆ3,000 ç­† * 120 bytesï¼‰
- âœ… æŸ¥è©¢æ•ˆèƒ½æå‡ï¼šç´¢å¼•å¤§å°æ¸›å°‘ï¼ŒæŸ¥è©¢æ›´å¿«
- âœ… 1 å¹´å¾Œç©©å®šåœ¨ ~3,000-5,000 ç­†è¨˜éŒ„ï¼ˆvs ç„¡æ¸…ç†æ™‚ 284,505 ç­†ï¼‰

---

**Rate Limiter æ•´åˆï¼ˆå„ªåŒ–ç‰ˆï¼Œç§»é™¤å³æ™‚è¿½è¹¤ï¼‰**ï¼š

```typescript
// lib/middleware/rate-limit.ts
async function rateLimit(identifier: string, limit: number, window: number) {
  // 1. æª¢æŸ¥æ˜¯å¦è™•æ–¼é™ç´šæ¨¡å¼
  const isDegraded = await checkDegradationMode()

  if (isDegraded) {
    // é™ç´šæ¨¡å¼ï¼šä½¿ç”¨æ›´å¯¬é¬†çš„é™åˆ¶æˆ–è·³é Rate Limit
    logger.warn('rate_limit_degraded', { identifier, reason: 'redis_quota_exceeded' })
    return { success: true, degraded: true }
  }

  // 2. æ­£å¸¸åŸ·è¡Œ Rate Limit
  const key = `rate_limit:${identifier}:${Math.floor(Date.now() / (window * 1000))}`
  const count = await redis.incr(key)

  if (count === 1) {
    await redis.expire(key, window)
  }

  // âŒ ç§»é™¤å³æ™‚è¿½è¹¤ï¼ˆæ¯æ¬¡ API èª¿ç”¨éƒ½è¨˜éŒ„ï¼Œé–‹éŠ·å¤ªå¤§ï¼‰
  // await supabase.rpc('increment_redis_counter', { p_commands: 2 })

  // âœ… æ”¹ç‚º Cron Job æ¯å°æ™‚åŸ·è¡Œä¸€æ¬¡ï¼ˆè¦‹ä¸‹æ–¹ï¼‰
  //    å¾ 5,334 æ¬¡è³‡æ–™åº«èª¿ç”¨/å¤© â†’ 24 æ¬¡/å¤©ï¼ˆ-99.5%ï¼‰

  return {
    success: count <= limit,
    remaining: Math.max(0, limit - count),
    resetAt: Math.ceil(Date.now() / (window * 1000)) * (window * 1000)
  }
}

// æª¢æŸ¥é™ç´šæ¨¡å¼
async function checkDegradationMode(): Promise<boolean> {
  const { data } = await supabase
    .from('redis_command_counter')
    .select('command_count')
    .eq('date', new Date().toISOString().split('T')[0])
    .single()

  if (!data) return false

  // è¶…é 70%ï¼ˆ7,000 å‘½ä»¤ï¼‰å•Ÿç”¨é™ç´šæ¨¡å¼
  // âš ï¸ èª¿æ•´ç†ç”±ï¼šå¯¦éš›æµé‡ 10,668 å‘½ä»¤/å¤©å·²è¶…æ¨™
  //    å¿…é ˆåœ¨é”åˆ°é™åˆ¶å‰å•Ÿå‹•é™ç´šï¼Œçµ¦ç³»çµ±åæ‡‰æ™‚é–“
  return data.command_count >= 7000
}
```

**ç›£æ§ API ç«¯é»**ï¼š

```typescript
// GET /api/maintenance/redis-usage
export async function GET() {
  const today = new Date().toISOString().split('T')[0]

  const { data } = await supabase
    .from('redis_command_counter')
    .select('command_count')
    .eq('date', today)
    .single()

  const commandCount = data?.command_count || 0
  const limit = 10000
  const usage = (commandCount / limit) * 100

  // 60% è­¦å‘Š
  if (usage >= 60 && usage < 70) {
    logger.warn('redis_quota_warning', {
      commandCount,
      usage: `${usage.toFixed(1)}%`,
      remaining: limit - commandCount,
      message: 'æ¥è¿‘é™åˆ¶ï¼Œå»ºè­°æª¢æŸ¥æµé‡ä¾†æº'
    })
  }

  // 70% å•Ÿç”¨é™ç´šæ¨¡å¼
  if (usage >= 70 && usage < 100) {
    logger.error('redis_quota_critical', {
      commandCount,
      usage: `${usage.toFixed(1)}%`,
      remaining: limit - commandCount,
      degradationMode: true,
      message: 'å·²è‡ªå‹•å•Ÿç”¨é™ç´šæ¨¡å¼'
    })
  }

  // 100% è¶…æ¨™ç·Šæ€¥é€šçŸ¥
  if (usage >= 100) {
    logger.error('redis_quota_exceeded', {
      commandCount,
      usage: `${usage.toFixed(1)}%`,
      exceeded: commandCount - limit,
      message: 'å·²è¶…å‡ºå…è²»é¡åº¦ï¼Œè«‹ç«‹å³æ‰‹å‹•å•Ÿç”¨ EMERGENCY_DEGRADATION'
    })
  }

  return Response.json({
    date: today,
    commandCount,
    limit,
    usage: `${usage.toFixed(1)}%`,
    degradationMode: usage >= 70,
    warningThreshold: usage >= 60,
    exceeded: usage >= 100
  })
}
```

**é™ç´šæ¨¡å¼è¡Œç‚ºï¼ˆè§¸ç™¼é–¾å€¼å°æ¯”ï¼‰**ï¼š

| é–¾å€¼ | Redis å‘½ä»¤æ•¸ | è§¸ç™¼æ¢ä»¶ | è¡Œç‚º |
|------|------------|---------|------|
| 60% | 6,000/å¤© | è­¦å‘Š | åƒ…è¨˜éŒ„æ—¥èªŒï¼Œç„¡å‹•ä½œ |
| **70%** | **7,000/å¤©** | **è‡ªå‹•é™ç´š** | åœç”¨éƒ¨åˆ† Rate Limit |
| 100% | 10,000/å¤© | è¶…æ¨™ | ç·Šæ€¥é€šçŸ¥ï¼Œå»ºè­°æ‰‹å‹•é™ç´š |

**é™ç´šæ¨¡å¼åŠŸèƒ½å°æ¯”**ï¼š

| åŠŸèƒ½ | æ­£å¸¸æ¨¡å¼ | é™ç´šæ¨¡å¼ï¼ˆ70%+ï¼‰ | ç·Šæ€¥é™ç´šï¼ˆEMERGENCYï¼‰ |
|------|---------|----------------|-------------------|
| Token å‰µå»º | Rate Limit: 5/å°æ™‚ | åœç”¨ï¼ˆåƒ… IP è¨˜éŒ„ï¼‰ | åœç”¨ |
| å¸‚å ´æŸ¥è©¢ | Rate Limit: 100/å°æ™‚ | åœç”¨ï¼ˆä¾è³´ user_quotasï¼‰ | åœç”¨ |
| ç™»è¨˜æ„å‘ | Rate Limit: 30/å¤© | åœç”¨ï¼ˆä¾è³´ user_quotasï¼‰ | åœç”¨ |
| è¯çµ¡æ–¹å¼ | Rate Limit: 10/å°æ™‚ | åœç”¨ï¼ˆä¾è³´ ip_quotasï¼‰ | åœç”¨ |
| trending é è¦½ | IP: 100/å°æ™‚ | **10/å°æ™‚ï¼ˆåŠ åš´ï¼‰** | 10/å°æ™‚ + Bot æª¢æŸ¥ |

**å‘Šè­¦é€šçŸ¥ï¼ˆå¯é¸æ•´åˆï¼‰**ï¼š

```typescript
// æ•´åˆ Email æˆ– Discord Webhook
async function sendAlert(level: 'warning' | 'critical', message: string) {
  if (level === 'critical') {
    await fetch(process.env.DISCORD_WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        content: `ğŸš¨ **Critical Alert**: ${message}\næ™‚é–“: ${new Date().toISOString()}`
      })
    })
  }
}
```

---

#### ç·Šæ€¥é™ç´šæ¨¡å¼ï¼ˆæ‰‹å‹•è§¸ç™¼ï¼‰

**ä½¿ç”¨å ´æ™¯**ï¼šç•¶ Redis å‘½ä»¤æ•¸è¶…æ¨™ï¼ˆ>100%ï¼‰æ™‚ï¼Œç«‹å³æ‰‹å‹•å•Ÿç”¨å®Œå…¨é™ç´šæ¨¡å¼ã€‚

**ç’°å¢ƒè®Šæ•¸é…ç½®**ï¼š

```bash
# Vercel ç’°å¢ƒè®Šæ•¸
EMERGENCY_DEGRADATION=true  # å•Ÿç”¨ç·Šæ€¥é™ç´šæ¨¡å¼
```

**Rate Limiter å¯¦ä½œï¼ˆæ”¯æ´ç·Šæ€¥é™ç´šï¼‰**ï¼š

```typescript
// lib/middleware/rate-limit.ts
async function rateLimit(identifier: string, limit: number, window: number) {
  // 0. æª¢æŸ¥ç·Šæ€¥é™ç´šæ¨¡å¼ï¼ˆæœ€é«˜å„ªå…ˆç´šï¼‰
  if (process.env.EMERGENCY_DEGRADATION === 'true') {
    logger.warn('emergency_degradation_active', {
      identifier,
      message: 'ç·Šæ€¥é™ç´šæ¨¡å¼ï¼šåœç”¨æ‰€æœ‰ Rate Limit'
    })
    return { success: true, degraded: true, emergency: true }
  }

  // 1. æª¢æŸ¥è‡ªå‹•é™ç´šæ¨¡å¼ï¼ˆ70%+ ä½¿ç”¨ç‡ï¼‰
  const isDegraded = await checkDegradationMode()

  if (isDegraded) {
    logger.warn('rate_limit_degraded', {
      identifier,
      reason: 'redis_quota_exceeded'
    })
    return { success: true, degraded: true }
  }

  // 2. æ­£å¸¸åŸ·è¡Œ Rate Limit
  const key = `rate_limit:${identifier}:${Math.floor(Date.now() / (window * 1000))}`
  const count = await redis.incr(key)

  if (count === 1) {
    await redis.expire(key, window)
  }

  return {
    success: count <= limit,
    remaining: Math.max(0, limit - count),
    resetAt: Math.ceil(Date.now() / (window * 1000)) * (window * 1000)
  }
}
```

**ç·Šæ€¥é™ç´šæ•ˆæœ**ï¼š

| æŒ‡æ¨™ | æ­£å¸¸æ¨¡å¼ | è‡ªå‹•é™ç´šï¼ˆ70%ï¼‰ | **ç·Šæ€¥é™ç´šï¼ˆæ‰‹å‹•ï¼‰** |
|------|---------|---------------|-------------------|
| Redis å‘½ä»¤æ•¸ | 10,668/å¤© | ~5,000/å¤© | **~200/å¤©** |
| Rate Limit | å…¨éƒ¨å•Ÿç”¨ | éƒ¨åˆ†åœç”¨ | **å…¨éƒ¨åœç”¨** |
| é˜²è­·æ©Ÿåˆ¶ | Rate Limit + é…é¡ | åƒ…é…é¡ | **åƒ…é…é¡** |
| API å»¶é² | æ­£å¸¸ | æ­£å¸¸ | **æ›´å¿«ï¼ˆ-10-50msï¼‰** |
| trending ç«¯é» | 10/å°æ™‚ + Bot æª¢æŸ¥ | 10/å°æ™‚ + Bot æª¢æŸ¥ | **10/å°æ™‚ + Bot æª¢æŸ¥**ï¼ˆä¿ç•™ï¼‰ |

**ä½•æ™‚å•Ÿç”¨ç·Šæ€¥é™ç´š**ï¼š

1. **Redis è¶…æ¨™ï¼ˆ>100%ï¼‰**ï¼šç•¶å‰ 10,668 å‘½ä»¤/å¤©ï¼Œç«‹å³å•Ÿç”¨
2. **Upstash æœå‹™ç•°å¸¸**ï¼šRedis é€£æ¥å¤±æ•—æˆ–éŸ¿æ‡‰ç·©æ…¢
3. **æ¸¬è©¦ç’°å¢ƒ**ï¼šé©—è­‰ç³»çµ±åœ¨ç„¡ Rate Limit ä¸‹çš„è¡Œç‚º
4. **è‡¨æ™‚é«˜å³°**ï¼šé æœŸçŸ­æ™‚é–“å…§æµé‡æš´å¢

**å•Ÿç”¨æ­¥é©Ÿ**ï¼š

```bash
# 1. åœ¨ Vercel æ§åˆ¶å°è¨­ç½®ç’°å¢ƒè®Šæ•¸
EMERGENCY_DEGRADATION=true

# 2. è§¸ç™¼é‡æ–°éƒ¨ç½²ï¼ˆæˆ–ç­‰å¾…ä¸‹ä¸€æ¬¡ API èª¿ç”¨è‡ªå‹•ç”Ÿæ•ˆï¼‰
vercel --prod

# 3. é©—è­‰é™ç´šæ¨¡å¼å·²å•Ÿç”¨
curl https://your-domain.com/api/maintenance/redis-usage
# æ‡‰è¿”å›ï¼š{ "degradationMode": true, "emergency": true }

# 4. ç›£æ§ç³»çµ±è¡Œç‚º
#    - æª¢æŸ¥ Redis å‘½ä»¤æ•¸æ˜¯å¦é™è‡³ ~200/å¤©
#    - ç¢ºèªç”¨æˆ¶é«”é©—æœªå—åš´é‡å½±éŸ¿
#    - è§€å¯Ÿ user_quotas å’Œ ip_quotas æ˜¯å¦æ­£å¸¸å·¥ä½œ

# 5. å•é¡Œè§£æ±ºå¾Œç§»é™¤ç’°å¢ƒè®Šæ•¸
#    åˆªé™¤ EMERGENCY_DEGRADATION æˆ–è¨­ç‚º false
```

**é¢¨éšªèˆ‡é™åˆ¶**ï¼š

âš ï¸ **é¢¨éšª**ï¼š
- ç„¡ Rate Limit ä¿è­·ï¼Œä¾è³´ user_quotas å’Œ ip_quotas
- æƒ¡æ„ç”¨æˆ¶å¯èƒ½å¿«é€Ÿå‰µå»ºå¤§é‡å¸³è™Ÿç¹éé…é¡
- trending ç«¯é»ä»ä¿ç•™é™åˆ¶ï¼ˆ10/å°æ™‚ + Bot æª¢æŸ¥ï¼‰

âœ… **ç·©è§£æªæ–½**ï¼š
- user_quotasï¼šæ¯äººæœ€å¤š 50 ç­†åˆŠç™»
- ip_quotasï¼šæ¯ IP æ¯å¤©æœ€å¤š 30 ç­†è¯çµ¡æ–¹å¼
- trending ç«¯é»ï¼š10/å°æ™‚ + Bot Detection
- ç›£æ§ç•°å¸¸è¡Œç‚ºæ¨¡å¼ï¼ˆå¦‚çŸ­æ™‚é–“å‰µå»ºå¤§é‡å¸³è™Ÿï¼‰

**çµè«–**ï¼šç·Šæ€¥é™ç´šæ¨¡å¼æ˜¯è‡¨æ™‚æ–¹æ¡ˆï¼Œæ‡‰ç›¡å¿«å¯¦ä½œ Bot Detection æˆ–å‡ç´š Upstash Proã€‚

---

#### Bot Detection å¯¦ä½œæ–¹æ¡ˆï¼ˆæ¸›å°‘ 60-80% ç„¡æ•ˆæµé‡ï¼‰

**å•é¡Œåˆ†æ**ï¼š
```
å¯¦éš›æµé‡æ•¸æ“šï¼ˆ5å¤©ç›£æ¸¬ï¼‰ï¼š
- ç¸½è¨ªå•æ•¸ï¼š7,794 / 5 = 1,559 visitors/å¤©
- æ¨ç®—çœŸå¯¦ç”¨æˆ¶ï¼š1,559 * 30% = 468 DAU
- æ¨ç®— Bot æµé‡ï¼š1,559 * 70% = 1,091 bots/å¤©ï¼ˆ60-80% æ˜¯çˆ¬èŸ²æˆ–ç„¡æ•ˆè«‹æ±‚ï¼‰

å½±éŸ¿ï¼š
- Bot æµé‡æ¶ˆè€—å¤§é‡ Redis å‘½ä»¤æ•¸ï¼ˆæ¯æ¬¡è«‹æ±‚ = 2 å‘½ä»¤ï¼‰
- å°è‡´ Redis è¶…æ¨™ 6.68%ï¼ˆ10,668 vs 10,000ï¼‰
- éœ€è¦å•Ÿç”¨ç·Šæ€¥é™ç´šæ¨¡å¼
```

**è§£æ±ºæ–¹æ¡ˆï¼šå¤šå±¤ Bot æª¢æ¸¬æ©Ÿåˆ¶**

##### 1. User-Agent æª¢æ¸¬ï¼ˆç¬¬ä¸€å±¤ï¼Œå·²å¯¦ä½œæ–¼ trending ç«¯é»ï¼‰

```typescript
// lib/bot-detection.ts
export function isBot(userAgent: string): boolean {
  // å¸¸è¦‹çˆ¬èŸ² User-Agent æ¨¡å¼
  const botPatterns = [
    /bot/i,                    // Google Bot, Bing Bot, etc.
    /crawler/i,                // Web crawlers
    /spider/i,                 // Search engine spiders
    /scraper/i,                // Data scrapers
    /curl/i,                   // curl å‘½ä»¤è¡Œå·¥å…·
    /wget/i,                   // wget å·¥å…·
    /python-requests/i,        // Python requests åº«
    /axios/i,                  // Axios HTTP å®¢æˆ¶ç«¯
    /postman/i,                // API æ¸¬è©¦å·¥å…·
    /insomnia/i,               // REST å®¢æˆ¶ç«¯
    /headless/i,               // Headless ç€è¦½å™¨
    /phantom/i,                // PhantomJS
    /selenium/i,               // Selenium è‡ªå‹•åŒ–å·¥å…·
  ]

  // æª¢æŸ¥æ˜¯å¦åŒ¹é…ä»»ä½• Bot æ¨¡å¼
  if (!userAgent) return true  // ç„¡ User-Agent è¦–ç‚º Bot

  return botPatterns.some(pattern => pattern.test(userAgent))
}

export function getBotType(userAgent: string): string | null {
  if (/google/i.test(userAgent)) return 'GoogleBot'
  if (/bing/i.test(userAgent)) return 'BingBot'
  if (/baidu/i.test(userAgent)) return 'BaiduSpider'
  if (/curl|wget/i.test(userAgent)) return 'CLI Tool'
  if (/python|axios/i.test(userAgent)) return 'HTTP Library'
  if (/headless|phantom|selenium/i.test(userAgent)) return 'Automation'
  return null
}
```

##### 2. è¡Œç‚ºæ¨¡å¼æª¢æ¸¬ï¼ˆç¬¬äºŒå±¤ï¼Œæ¨è–¦å¯¦ä½œï¼‰

```typescript
// lib/bot-detection.ts
interface RequestPattern {
  ip: string
  requestCount: number
  firstSeen: Date
  lastSeen: Date
  endpoints: Set<string>
}

// å„²å­˜åœ¨ Redisï¼ˆè‡¨æ™‚å¿«å–ï¼Œ1 å°æ™‚éæœŸï¼‰
export async function detectSuspiciousBehavior(
  ip: string,
  endpoint: string
): Promise<{ isBot: boolean; reason?: string }> {

  const key = `behavior:${ip}`

  // ç²å– IP çš„è«‹æ±‚æ¨¡å¼
  const pattern = await redis.get(key) as RequestPattern | null

  if (!pattern) {
    // é¦–æ¬¡è«‹æ±‚ï¼Œè¨˜éŒ„æ¨¡å¼
    await redis.setex(key, 3600, {
      ip,
      requestCount: 1,
      firstSeen: new Date(),
      lastSeen: new Date(),
      endpoints: new Set([endpoint])
    })
    return { isBot: false }
  }

  // æ›´æ–°æ¨¡å¼
  pattern.requestCount++
  pattern.lastSeen = new Date()
  pattern.endpoints.add(endpoint)

  // æª¢æ¸¬ç•°å¸¸è¡Œç‚º
  const timeDiff = pattern.lastSeen.getTime() - pattern.firstSeen.getTime()
  const requestsPerMinute = (pattern.requestCount / timeDiff) * 60000

  // Bot ç‰¹å¾µæª¢æ¸¬
  if (requestsPerMinute > 30) {
    // æ¯åˆ†é˜ > 30 æ¬¡è«‹æ±‚ï¼ˆæ­£å¸¸ç”¨æˆ¶ < 10 æ¬¡ï¼‰
    return { isBot: true, reason: 'high_frequency' }
  }

  if (pattern.endpoints.size > 20 && timeDiff < 60000) {
    // 1 åˆ†é˜å…§è¨ªå• > 20 å€‹ä¸åŒç«¯é»
    return { isBot: true, reason: 'scanning' }
  }

  // æ›´æ–° Redis
  await redis.setex(key, 3600, pattern)

  return { isBot: false }
}
```

##### 3. ä¸­é–“ä»¶æ•´åˆï¼ˆçµ±ä¸€æ‡‰ç”¨ï¼‰

```typescript
// lib/middleware/bot-protection.ts
import { NextRequest, NextResponse } from 'next/server'
import { isBot, getBotType, detectSuspiciousBehavior } from '@/lib/bot-detection'
import { logger } from '@/lib/logger'

export async function withBotProtection(
  handler: (req: NextRequest) => Promise<Response>,
  options: {
    allowSearchEngines?: boolean  // æ˜¯å¦å…è¨±æœå°‹å¼•æ“çˆ¬èŸ²
    checkBehavior?: boolean        // æ˜¯å¦æª¢æŸ¥è¡Œç‚ºæ¨¡å¼
  } = {}
) {
  return async (req: NextRequest) => {
    const userAgent = req.headers.get('user-agent') || ''
    const clientIP = req.headers.get('x-forwarded-for') || req.ip || 'unknown'

    // 1. User-Agent æª¢æ¸¬
    if (isBot(userAgent)) {
      const botType = getBotType(userAgent)

      // å…è¨±æœå°‹å¼•æ“çˆ¬èŸ²ï¼ˆSEOï¼‰
      if (options.allowSearchEngines &&
          ['GoogleBot', 'BingBot'].includes(botType || '')) {
        logger.info('bot_allowed', { botType, ip: clientIP })
        return handler(req)
      }

      // æ‹’çµ•å…¶ä»– Bot
      logger.warn('bot_blocked', {
        userAgent,
        botType,
        ip: clientIP,
        path: req.nextUrl.pathname
      })

      return Response.json(
        { error: 'æ­¤ç«¯é»ä¸æ”¯æ´è‡ªå‹•åŒ–è¨ªå•' },
        { status: 403 }
      )
    }

    // 2. è¡Œç‚ºæ¨¡å¼æª¢æ¸¬ï¼ˆå¯é¸ï¼‰
    if (options.checkBehavior) {
      const { isBot: isSuspicious, reason } = await detectSuspiciousBehavior(
        clientIP,
        req.nextUrl.pathname
      )

      if (isSuspicious) {
        logger.warn('suspicious_behavior_blocked', {
          ip: clientIP,
          reason,
          path: req.nextUrl.pathname
        })

        return Response.json(
          { error: 'æª¢æ¸¬åˆ°ç•°å¸¸è¡Œç‚ºï¼Œè«‹ç¨å¾Œå†è©¦' },
          { status: 429 }
        )
      }
    }

    // é€šéæª¢æ¸¬ï¼ŒåŸ·è¡Œæ­£å¸¸è™•ç†
    return handler(req)
  }
}
```

##### 4. API ç«¯é»æ‡‰ç”¨ç¯„ä¾‹

```typescript
// app/api/market/trending/route.ts
import { withBotProtection } from '@/lib/middleware/bot-protection'
import { withErrorHandler } from '@/lib/middleware/api-middleware'

async function handleGET(req: NextRequest) {
  // åŸæœ‰é‚è¼¯ï¼ˆå·²ç§»é™¤ Bot Detectionï¼Œç”±ä¸­é–“ä»¶è™•ç†ï¼‰
  const { data } = await supabase
    .from('listings')
    .select('id, item_id, quantity, price, status, created_at, interest_count')
    .eq('status', 'active')
    .is('deleted_at', null)
    .order('interest_count', { ascending: false })
    .limit(20)

  return Response.json({ data })
}

// çµ„åˆä¸­é–“ä»¶
export const GET = withErrorHandler(
  withBotProtection(handleGET, {
    allowSearchEngines: true,   // å…è¨±æœå°‹å¼•æ“ï¼ˆSEOï¼‰
    checkBehavior: true          // æª¢æŸ¥ç•°å¸¸è¡Œç‚º
  }),
  { module: 'TrendingAPI' }
)
```

```typescript
// app/api/auth/token/route.tsï¼ˆéœ€è¦åš´æ ¼é˜²è­·çš„ç«¯é»ï¼‰
export const POST = withErrorHandler(
  withBotProtection(handlePOST, {
    allowSearchEngines: false,   // ä¸å…è¨±ä»»ä½• Bot
    checkBehavior: true           // æª¢æŸ¥ç•°å¸¸è¡Œç‚º
  }),
  { module: 'AuthAPI' }
)
```

##### 5. éƒ¨ç½²ç­–ç•¥èˆ‡æ•ˆæœé ä¼°

**éšæ®µ 1ï¼štrending ç«¯é»ï¼ˆå·²éƒ¨ç½²ï¼‰**
```
ç•¶å‰æ•ˆæœï¼š
- trending ç«¯é»ï¼š10/å°æ™‚ + User-Agent æª¢æ¸¬
- é ä¼°æ¸›å°‘ï¼š200-300 Bot è«‹æ±‚/å¤©
- Redis ç¯€çœï¼š400-600 å‘½ä»¤/å¤©
```

**éšæ®µ 2ï¼šå…¨ç«¯é» User-Agent æª¢æ¸¬ï¼ˆæ¨è–¦å„ªå…ˆï¼‰**
```
è¦†è“‹ç¯„åœï¼šæ‰€æœ‰ API ç«¯é»ï¼ˆé™¤æœå°‹å¼•æ“ç™½åå–®ï¼‰
é æœŸæ•ˆæœï¼š
- Bot æµé‡æ¸›å°‘ï¼š60-70%ï¼ˆ1,091 â†’ 327-437 bots/å¤©ï¼‰
- Redis å‘½ä»¤æ•¸ï¼š10,668 â†’ 6,000-7,000/å¤©ï¼ˆ60-70% ä½¿ç”¨ç‡ï¼‰
- ç‹€æ…‹ï¼šâœ… å¯ç©©å®šé‹è¡Œåœ¨å…è²»ç‰ˆ
```

**éšæ®µ 3ï¼šè¡Œç‚ºæ¨¡å¼æª¢æ¸¬ï¼ˆå®Œæ•´é˜²è­·ï¼‰**
```
é¡å¤–é˜²è­·ï¼š
- é˜»æ“‹é«˜é »çˆ¬èŸ²ï¼ˆ> 30 æ¬¡/åˆ†é˜ï¼‰
- é˜»æ“‹æƒæè¡Œç‚ºï¼ˆå¿«é€Ÿè¨ªå•å¤šå€‹ç«¯é»ï¼‰
é æœŸæ•ˆæœï¼š
- Bot æµé‡æ¸›å°‘ï¼š70-80%ï¼ˆ1,091 â†’ 218-327 bots/å¤©ï¼‰
- Redis å‘½ä»¤æ•¸ï¼š10,668 â†’ 4,800-6,000/å¤©ï¼ˆ48-60% ä½¿ç”¨ç‡ï¼‰
- ç‹€æ…‹ï¼šâœ… å…è²»ç‰ˆå¯é•·æœŸç©©å®šé‹è¡Œ
```

##### 6. ç›£æ§èˆ‡æ—¥èªŒ

```typescript
// å®šæœŸåˆ†æ Bot æµé‡ï¼ˆåŠ å…¥æ—¥å¸¸æ¸…ç†ä»»å‹™ï¼‰
export async function analyzeBotTraffic() {
  const logs = await supabase
    .from('api_logs')
    .select('user_agent, ip_address, endpoint, created_at')
    .gte('created_at', new Date(Date.now() - 24 * 3600 * 1000))  // éå» 24 å°æ™‚

  const botRequests = logs.data?.filter(log => isBot(log.user_agent))
  const totalRequests = logs.data?.length || 0
  const botPercentage = ((botRequests?.length || 0) / totalRequests) * 100

  logger.info('bot_traffic_analysis', {
    totalRequests,
    botRequests: botRequests?.length,
    botPercentage: `${botPercentage.toFixed(1)}%`,
    topBots: getTopBots(botRequests || [])
  })

  return {
    totalRequests,
    botRequests: botRequests?.length,
    botPercentage
  }
}

function getTopBots(requests: any[]): Record<string, number> {
  const botCounts: Record<string, number> = {}

  requests.forEach(req => {
    const botType = getBotType(req.user_agent) || 'Unknown'
    botCounts[botType] = (botCounts[botType] || 0) + 1
  })

  return Object.entries(botCounts)
    .sort(([, a], [, b]) => b - a)
    .slice(0, 5)
    .reduce((acc, [bot, count]) => ({ ...acc, [bot]: count }), {})
}
```

**æ•ˆæœç¸½çµ**ï¼š

| éšæ®µ | Bot éæ¿¾ç‡ | Redis å‘½ä»¤æ•¸/å¤© | ä½¿ç”¨ç‡ | ç‹€æ…‹ |
|------|-----------|---------------|-------|------|
| ç•¶å‰ï¼ˆtrending é™åˆ¶ï¼‰ | ~20% | 10,668 | 107% | âŒ å·²è¶…æ¨™ |
| éšæ®µ 2ï¼ˆUser-Agent å…¨é¢ï¼‰ | 60-70% | 6,000-7,000 | 60-70% | âœ… å¯é‹è¡Œ |
| éšæ®µ 3ï¼ˆè¡Œç‚ºæª¢æ¸¬ï¼‰ | 70-80% | 4,800-6,000 | 48-60% | âœ… ç©©å®š |

**å¯¦ä½œæˆæœ¬**ï¼š
- âœ… ç„¡éœ€é¡å¤–ä¾è³´ï¼ˆä½¿ç”¨ç¾æœ‰ Redisï¼‰
- âœ… é–‹ç™¼æ™‚é–“ï¼š2-3 å¤©
- âœ… ç¶­è­·æˆæœ¬ï¼šä½ï¼ˆåƒ…éœ€å®šæœŸæ›´æ–° Bot æ¨¡å¼ï¼‰

**å»ºè­°å„ªå…ˆç´š**ï¼š
1. **ç«‹å³å¯¦ä½œ**ï¼šå…¨ç«¯é» User-Agent æª¢æ¸¬ï¼ˆæœ€é«˜ ROIï¼‰
2. **1 é€±å…§**ï¼šè¡Œç‚ºæ¨¡å¼æª¢æ¸¬ï¼ˆå®Œæ•´é˜²è­·ï¼‰
3. **æŒçºŒå„ªåŒ–**ï¼šæ ¹æ“šæ—¥èªŒæ›´æ–° Bot æ¨¡å¼

---

#### æ—¥èªŒç­–ç•¥

```typescript
// ä½¿ç”¨çµæ§‹åŒ–æ—¥èªŒ
logger.info('register_interest', {
  listingId,
  buyerId,
  duration: Date.now() - startTime,
  success: true
})

logger.error('register_interest_failed', {
  listingId,
  buyerId,
  error: error.message,
  reason: error.code === '23505' ? 'duplicate' : 'unknown'
})
```

---

## æ•ˆèƒ½å„ªåŒ–

### 1. å¿«å–ç­–ç•¥ï¼ˆå„ªåŒ–ç‰ˆï¼Œç¯€çœ Redis å‘½ä»¤æ•¸ï¼‰

#### å¤šå±¤å¿«å–æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Browser     â”‚ â†’ localStorage (Token, ç”¨æˆ¶è³‡è¨Š)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚ Vercel Edge â”‚ â†’ Edge Config (éœæ…‹é…ç½®ï¼Œå…è²»)
â”‚   Config    â”‚ â†’ ç†±é–€ç‰©å“åˆ—è¡¨ï¼ˆæ‰‹å‹•æ›´æ–°ï¼‰
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚ PostgreSQL  â”‚ â†’ æ°¸ä¹…å­˜å„² + éƒ¨åˆ†ç´¢å¼•ï¼ˆå¿«é€ŸæŸ¥è©¢ï¼‰
â”‚ (Supabase)  â”‚ â†’ ç„¡é™åˆ¶æŸ¥è©¢æ¬¡æ•¸
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âŒ ä¸ä½¿ç”¨ Redis å¿«å–ï¼ˆç¯€çœå‘½ä»¤æ•¸ï¼Œåƒ…ç”¨æ–¼ Rate Limitingï¼‰
```

**å¿«å–ç­–ç•¥ï¼ˆå„ªåŒ–å¾Œï¼‰**ï¼š

| è³‡æ–™é¡å‹ | å¿«å–ä½ç½® | TTL | ç†ç”± |
|---------|---------|-----|------|
| å¸‚å ´åˆ—è¡¨ | **ç„¡å¿«å–** | - | ç›´æ¥æŸ¥è©¢è³‡æ–™åº«ï¼ˆSupabase ç„¡é™åˆ¶ï¼‰ |
| ç†±é–€åˆŠç™»ï¼ˆé¦–é ï¼‰ | Vercel Edge Config | æ‰‹å‹•æ›´æ–° | å…è²»ã€ç„¡å‘½ä»¤æ•¸é™åˆ¶ |
| ç”¨æˆ¶ Token | Browser | **3 å¤©** | ç™»å‡º/éæœŸ |
| æ„å‘åˆ—è¡¨ | ç„¡å¿«å– | - | å¯¦æ™‚æŸ¥è©¢ |

**ç‚ºä»€éº¼ä¸ç”¨ Redis å¿«å–ï¼Ÿ**
- âŒ Redis å‘½ä»¤æ•¸æœ‰é™ï¼ˆ10K/å¤©ï¼‰ï¼Œå„ªå…ˆä¿ç•™çµ¦ Rate Limiting
- âœ… Supabase æŸ¥è©¢ç„¡é™åˆ¶ï¼ŒåŠ ä¸Šéƒ¨åˆ†ç´¢å¼•å·²ç¶“å¾ˆå¿«ï¼ˆ< 100msï¼‰
- âœ… å¸‚å ´åˆ—è¡¨éœ€è¦**å³æ™‚æ€§**ï¼ˆæ–°åˆŠç™»ç«‹å³é¡¯ç¤ºï¼‰
- âœ… å¿«å–å¤±æ•ˆé‚è¼¯è¤‡é›œï¼Œå¢åŠ é–‹ç™¼å’Œç¶­è­·æˆæœ¬

**è³‡æ–™åº«æŸ¥è©¢å„ªåŒ–ï¼ˆæ›¿ä»£å¿«å–ï¼‰**ï¼š

```sql
-- å¸‚å ´åˆ—è¡¨æŸ¥è©¢å·²ç¶“éå„ªåŒ–
CREATE INDEX idx_active_listings ON listings(status, created_at DESC)
  WHERE status = 'active' AND deleted_at IS NULL;

-- é…åˆ Cursor åˆ†é ï¼Œå³ä½¿ 10 è¬ç­†è³‡æ–™ä¹Ÿèƒ½å¿«é€ŸæŸ¥è©¢
SELECT * FROM listings
WHERE status = 'active'
  AND deleted_at IS NULL
  AND id > $cursor
ORDER BY created_at DESC
LIMIT 20;

-- æŸ¥è©¢æ™‚é–“ï¼š~50-100msï¼ˆç„¡å¿«å–ä¹Ÿå¤ å¿«ï¼‰
```

**å¯é¸å„ªåŒ–**ï¼šä½¿ç”¨ Vercel Edge Config å­˜å„²ç†±é–€åˆŠç™»

```typescript
// åƒ…åœ¨é¦–é å±•ç¤ºï¼Œç„¡éœ€å‹•æ…‹æ›´æ–°
const trendingListings = await getEdgeConfig('trending_listings')  // å…è²»

// æˆ–é€šéç®¡ç†å“¡æ‰‹å‹•æ›´æ–°ï¼ˆæ¯å¤© 1-2 æ¬¡ï¼‰
// ä¸æ¶ˆè€— Redis å‘½ä»¤æ•¸
```

---

### 2. è³‡æ–™åº«æŸ¥è©¢å„ªåŒ–

#### Cursor-based åˆ†é 

```typescript
// âŒ Offset åˆ†é ï¼ˆå¤§é æ•¸æ™‚æ…¢ï¼‰
SELECT * FROM listings WHERE is_active = TRUE OFFSET 10000 LIMIT 20;

// âœ… Cursor åˆ†é ï¼ˆå§‹çµ‚å¿«é€Ÿï¼‰
SELECT * FROM listings
WHERE is_active = TRUE AND id > $cursor
ORDER BY id ASC
LIMIT 20;
```

#### é¿å… N+1 æŸ¥è©¢

```typescript
// âŒ N+1 æŸ¥è©¢
const listings = await getMarketListings()
for (const listing of listings) {
  listing.seller = await getCharacter(listing.character_id)  // N æ¬¡æŸ¥è©¢
}

// âœ… ä½¿ç”¨ JOIN æˆ– INï¼ˆå¦‚æœæœ‰ characters è¡¨ï¼‰
const listings = await supabase
  .from('listings')
  .select('*, seller:characters(name)')  // 1 æ¬¡æŸ¥è©¢
  .eq('is_active', true)
```

---

### 3. é€£æ¥æ± ç®¡ç†ï¼ˆServerless ç’°å¢ƒï¼‰

**é‡è¦æé†’**ï¼šServerless ç’°å¢ƒçš„é€£æ¥ç®¡ç†èˆ‡å‚³çµ±ä¼ºæœå™¨ä¸åŒï¼

#### Supabase é€£æ¥æ± é…ç½®ï¼ˆæ­£ç¢ºç†è§£ï¼‰

```typescript
// âš ï¸ é€™å€‹ã€Œå–®ä¾‹ã€åªåœ¨å–®ä¸€å‡½æ•¸å¯¦ä¾‹å…§æœ‰æ•ˆ
//    ä¸åŒ Vercel Functions å¯¦ä¾‹ä¸å…±äº«è¨˜æ†¶é«”
let supabaseClient: SupabaseClient | null = null

export function getSupabase() {
  if (!supabaseClient) {
    supabaseClient = createClient(url, key, {
      db: {
        schema: 'public'
      },
      auth: {
        persistSession: false,  // API ä¸éœ€è¦æŒä¹… session
      },
      global: {
        headers: { 'x-connection-source': 'vercel-function' }
      }
    })
  }
  return supabaseClient
}
```

#### Serverless ç’°å¢ƒçš„é€£æ¥è¡Œç‚º

```
çœŸå¯¦å ´æ™¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Vercel Edge Network (å…¨çƒåˆ†ä½ˆ)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Region 1 (ç¾åœ‹æ±éƒ¨)                     â”‚
â”‚  â”œâ”€ Instance A: ç¨ç«‹çš„ supabaseClient   â”‚
â”‚  â”œâ”€ Instance B: ç¨ç«‹çš„ supabaseClient   â”‚
â”‚  â””â”€ Instance C: ç¨ç«‹çš„ supabaseClient   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Region 2 (æ­æ´²)                         â”‚
â”‚  â”œâ”€ Instance D: ç¨ç«‹çš„ supabaseClient   â”‚
â”‚  â””â”€ Instance E: ç¨ç«‹çš„ supabaseClient   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“ æ¯å€‹å¯¦ä¾‹éƒ½æœƒå»ºç«‹é€£æ¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase PostgreSQL (å–®ä¸€å¯¦ä¾‹)          â”‚
â”‚ å…è²»ç‰ˆé€£æ¥é™åˆ¶ï¼š~60 ä¸¦ç™¼é€£æ¥            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ½›åœ¨å•é¡Œ**ï¼š
- 10 å€‹ Vercel å¯¦ä¾‹ Ã— 10 å€‹ä¸¦ç™¼è«‹æ±‚ = 100 å€‹é€£æ¥
- è¶…é Supabase å…è²»ç‰ˆé™åˆ¶ï¼ˆ60 é€£æ¥ï¼‰
- æœƒå°è‡´ `too many connections` éŒ¯èª¤

#### è§£æ±ºæ–¹æ¡ˆï¼šä½¿ç”¨ Supabase Connection Pooling

```typescript
// ä½¿ç”¨ Supabase çš„é€£æ¥æ±  URLï¼ˆæ¨è–¦ï¼‰
const supabaseUrl = process.env.SUPABASE_URL
const poolerUrl = supabaseUrl.replace(
  '.supabase.co',
  '.pooler.supabase.com'
)

const supabase = createClient(poolerUrl, anonKey, {
  db: {
    schema: 'public'
  },
  auth: {
    persistSession: false
  }
})
```

**Supabase Pooler å„ªé»**ï¼š
- âœ… è‡ªå‹•ç®¡ç†é€£æ¥æ± ï¼ˆä½¿ç”¨ PgBouncerï¼‰
- âœ… æ”¯æ´æ•¸åƒå€‹ä¸¦ç™¼è«‹æ±‚
- âœ… å…è²»ç‰ˆä¹Ÿå¯ä½¿ç”¨
- âœ… ç„¡éœ€ä¿®æ”¹æŸ¥è©¢èªæ³•

#### ç›£æ§é€£æ¥

```sql
-- æª¢æŸ¥æ´»èºé€£æ¥æ•¸
SELECT count(*) FROM pg_stat_activity;

-- æª¢æŸ¥é•·æ™‚é–“é‹è¡Œçš„æŸ¥è©¢
SELECT pid, now() - query_start AS duration, query, application_name
FROM pg_stat_activity
WHERE state = 'active'
ORDER BY duration DESC;

-- æª¢æŸ¥é€£æ¥ä¾†æº
SELECT application_name, count(*)
FROM pg_stat_activity
GROUP BY application_name;
```

**ç›£æ§é–¾å€¼**ï¼š
- âš ï¸ æ´»èºé€£æ¥ > 40ï¼ˆå…è²»ç‰ˆçš„ 67%ï¼‰â†’ æª¢æŸ¥æ˜¯å¦æœ‰é€£æ¥æ´©æ¼
- ğŸ”´ æ´»èºé€£æ¥ > 55ï¼ˆå…è²»ç‰ˆçš„ 92%ï¼‰â†’ ç«‹å³ä½¿ç”¨ Pooler æˆ–å‡ç´š

---

## ç›£æ§èˆ‡ç¶­è­·

### 1. ç›£æ§å„€è¡¨æ¿

**é—œéµæŒ‡æ¨™**ï¼š

```typescript
// ç›£æ§ API
GET /api/maintenance/stats

Response:
{
  "database": {
    "size": "48.5 MB",
    "usage": "9.7%",
    "limit": "500 MB"
  },
  "tables": {
    "listings": { "active": 6234, "total": 8423 },
    "interests": { "pending": 1245, "total": 2156 },
    "reports": { "pending": 12, "total": 156 },
    "user_quotas": 1042,
    "tokens": 245
  },
  "quotas": {
    "violations": {
      "listings": 5,
      "interests": 12
    },
    "avgListingsPerUser": 8.1,
    "avgInterestsPerUser": 15.3
  },
  "performance": {
    "avgQueryTime": "38ms",
    "p95QueryTime": "125ms",
    "errorRate": "0.4%"
  },
  "traffic": {
    "requestsToday": 5420,
    "activeUsers": 87,
    "contactViewsToday": 234
  }
}
```

---

### 2. å®šæœŸæ¸…ç†ä»»å‹™

**Vercel Cron Job é…ç½®**ï¼š

```json
// vercel.json
{
  "crons": [
    {
      "path": "/api/maintenance/cleanup",
      "schedule": "0 2 * * *"  // æ¯å¤©å‡Œæ™¨ 2 é»
    }
  ]
}
```

**æ¸…ç†ä»»å‹™**ï¼š

```typescript
// æ¸…ç†ä»»å‹™åŸ·è¡Œé †åº
async function runCleanup() {
  // 1. æ¸…ç†éæœŸ token
  await supabase.rpc('cleanup_expired_tokens')

  // 2. æ¸…ç†èˆŠæ„å‘è¨˜éŒ„ï¼ˆä¿ç•™ 30 å¤©ï¼‰
  await supabase.rpc('cleanup_old_interests')

  // 3. è»Ÿåˆªé™¤ç„¡æ•ˆåˆŠç™»ï¼ˆé—œé–‰è¶…é 30 å¤©ï¼‰
  await supabase.rpc('soft_delete_inactive_listings')

  // 4. æ¸…ç†å·²è™•ç†çš„èˆ‰å ±ï¼ˆä¿ç•™ 90 å¤©ï¼‰
  await supabase.rpc('cleanup_old_reports')

  // 5. é‡ç½®æ¯æ—¥æ„å‘é…é¡ï¼ˆå‡Œæ™¨åŸ·è¡Œï¼‰
  await supabase.rpc('reset_daily_interest_quotas')

  // 6. æ¸…ç†èˆŠ IP é…é¡è¨˜éŒ„ï¼ˆæ¯æœˆ1è™ŸåŸ·è¡Œï¼Œé˜²æ­¢è³‡æ–™è¡¨ç„¡é™å¢é•·ï¼‰
  // è¨»ï¼šæ­¤ä»»å‹™æ‡‰åœ¨ç¨ç«‹çš„æœˆåº¦ Cron ä¸­åŸ·è¡Œï¼Œæ­¤è™•åƒ…ä½œæ–‡æª”è¨˜éŒ„
  // await supabase.rpc('cleanup_old_ip_quotas')

  // 7. æ¸…ç† Redis éæœŸ rate limit è¨˜éŒ„ï¼ˆè‡ªå‹•ï¼‰

  // 8. åˆ†æè³‡æ–™åº«ï¼ˆå„ªåŒ–æŸ¥è©¢è¨ˆåŠƒï¼‰
  await supabase.rpc('analyze_tables')

  return { success: true, timestamp: new Date() }
}
```

---

### 3. å‚™ä»½èˆ‡æ¢å¾©

**å‚™ä»½ç­–ç•¥**ï¼š

| å‚™ä»½é¡å‹ | é »ç‡ | ä¿ç•™æœŸé™ | å„²å­˜ä½ç½® |
|---------|------|---------|---------|
| å®Œæ•´å‚™ä»½ | æ¯å¤© | 7 å¤© | Supabase è‡ªå‹• |
| å¢é‡å‚™ä»½ | æ¯å°æ™‚ | 24 å°æ™‚ | Supabase è‡ªå‹• |
| æ‰‹å‹•å‚™ä»½ | ç™¼å¸ƒå‰ | 30 å¤© | æ‰‹å‹•è§¸ç™¼ |

**æ¢å¾©æ¸¬è©¦**ï¼š
- æ¯æœˆæ¸¬è©¦ä¸€æ¬¡å‚™ä»½æ¢å¾©
- ç¢ºèª RTOï¼ˆRecovery Time Objectiveï¼‰< 4 å°æ™‚
- ç¢ºèª RPOï¼ˆRecovery Point Objectiveï¼‰< 1 å°æ™‚

---

#### ç½é›£æ¢å¾©æµç¨‹ï¼ˆè©³ç´°æ­¥é©Ÿï¼‰

**å ´æ™¯ 1ï¼šè³‡æ–™åº«å®Œå…¨å¤±æ•ˆ**

| æ­¥é©Ÿ | å‹•ä½œ | è²¬ä»»äºº | é è¨ˆæ™‚é–“ | æª¢æŸ¥é» |
|-----|------|-------|---------|-------|
| 1 | ç¢ºèªè³‡æ–™åº«ç„¡æ³•é€£æ¥ | é–‹ç™¼è€… | 5 åˆ†é˜ | é€£çºŒ 3 æ¬¡å¥åº·æª¢æŸ¥å¤±æ•— |
| 2 | åˆ‡æ›åˆ°ç¶­è­·æ¨¡å¼ | é–‹ç™¼è€… | 5 åˆ†é˜ | é¦–é é¡¯ç¤ºç¶­è­·è¨Šæ¯ |
| 3 | é€šçŸ¥ç”¨æˆ¶ï¼ˆè¦‹æ¨¡æ¿ Aï¼‰ | ç‡Ÿé‹ | 10 åˆ†é˜ | Discord/Twitter å…¬å‘Š |
| 4 | è¯çµ¡ Supabase æ”¯æ´ | é–‹ç™¼è€… | 15 åˆ†é˜ | æäº¤ Support Ticket |
| 5 | æº–å‚™æ¢å¾©ç’°å¢ƒ | é–‹ç™¼è€… | 30 åˆ†é˜ | æ–° Supabase å¯¦ä¾‹å°±ç·’ |
| 6 | å¾å‚™ä»½æ¢å¾©è³‡æ–™ | é–‹ç™¼è€… | 60 åˆ†é˜ | è³‡æ–™å®Œæ•´æ€§é©—è­‰ |
| 7 | æ›´æ–°ç’°å¢ƒè®Šæ•¸ | é–‹ç™¼è€… | 10 åˆ†é˜ | Vercel éƒ¨ç½²å®Œæˆ |
| 8 | åŸ·è¡Œç…™éœ§æ¸¬è©¦ | é–‹ç™¼è€… | 20 åˆ†é˜ | é—œéµæµç¨‹é©—è­‰ |
| 9 | è§£é™¤ç¶­è­·æ¨¡å¼ | é–‹ç™¼è€… | 5 åˆ†é˜ | ç¶²ç«™æ¢å¾©æ­£å¸¸ |
| 10 | é€šçŸ¥ç”¨æˆ¶æ¢å¾©ï¼ˆè¦‹æ¨¡æ¿ Bï¼‰ | ç‡Ÿé‹ | 10 åˆ†é˜ | Discord/Twitter æ›´æ–° |

**ç¸½è¨ˆ RTO**: ~2.5 å°æ™‚ï¼ˆç¬¦åˆ < 4 å°æ™‚ç›®æ¨™ï¼‰

**å ´æ™¯ 2ï¼šRedis å®Œå…¨å¤±æ•ˆ**

| æ­¥é©Ÿ | å‹•ä½œ | é è¨ˆæ™‚é–“ | å½±éŸ¿ç¯„åœ |
|-----|------|---------|---------|
| 1 | å•Ÿç”¨é™ç´šæ¨¡å¼ | 5 åˆ†é˜ | Rate Limit åœç”¨ï¼Œä¾è³´ user_quotas/ip_quotas |
| 2 | å‰µå»ºæ–° Upstash å¯¦ä¾‹ | 10 åˆ†é˜ | - |
| 3 | æ›´æ–°ç’°å¢ƒè®Šæ•¸ä¸¦éƒ¨ç½² | 15 åˆ†é˜ | - |
| 4 | é©—è­‰ Rate Limit åŠŸèƒ½ | 10 åˆ†é˜ | - |
| 5 | é—œé–‰é™ç´šæ¨¡å¼ | 5 åˆ†é˜ | æ¢å¾©æ­£å¸¸ Rate Limit |

**ç¸½è¨ˆ RTO**: ~45 åˆ†é˜

**å ´æ™¯ 3ï¼šVercel éƒ¨ç½²å¤±æ•—**

| æ­¥é©Ÿ | å‹•ä½œ | é è¨ˆæ™‚é–“ |
|-----|------|---------|
| 1 | å›æ»¾åˆ°ä¸Šä¸€å€‹æˆåŠŸç‰ˆæœ¬ | 5 åˆ†é˜ |
| 2 | é©—è­‰åŠŸèƒ½æ­£å¸¸ | 10 åˆ†é˜ |
| 3 | åˆ†æå¤±æ•—åŸå›  | 30 åˆ†é˜ |
| 4 | ä¿®å¾©ä¸¦é‡æ–°éƒ¨ç½² | 60 åˆ†é˜ |

**ç¸½è¨ˆ RTO**: å›æ»¾ 15 åˆ†é˜ï¼Œå®Œæ•´ä¿®å¾© 1.5 å°æ™‚

---

#### è²¬ä»»çŸ©é™£ï¼ˆRACIï¼‰

| ä»»å‹™ | é–‹ç™¼è€… | ç‡Ÿé‹ | ç®¡ç†å“¡ | èªªæ˜ |
|------|-------|------|-------|------|
| ç›£æ§å‘Šè­¦ | R, A | I | I | Responsible & Accountable: é–‹ç™¼è€… |
| ç¢ºèªç½é›£ | R, A | C | I | é–‹ç™¼è€…è² è²¬æŠ€è¡“åˆ¤æ–· |
| å•Ÿç”¨ç¶­è­·æ¨¡å¼ | R, A | I | I | é–‹ç™¼è€…åŸ·è¡Œ |
| ç”¨æˆ¶æºé€š | C | R, A | I | ç‡Ÿé‹è² è²¬ï¼Œé–‹ç™¼è€…æä¾›æŠ€è¡“è³‡è¨Š |
| å‚™ä»½æ¢å¾© | R, A | I | I | é–‹ç™¼è€…åŸ·è¡Œ |
| è³‡æ–™é©—è­‰ | R, A | C | C | é–‹ç™¼è€…é©—è­‰ï¼Œç‡Ÿé‹å”åŠ©æ¸¬è©¦ |
| æ¢å¾©é€šçŸ¥ | C | R, A | I | ç‡Ÿé‹è² è²¬ï¼Œé–‹ç™¼è€…ç¢ºèªæŠ€è¡“ç´°ç¯€ |
| äº‹å¾Œæª¢è¨ | C | C | R, A | ç®¡ç†å“¡ä¸»æŒï¼Œå…¨å“¡åƒèˆ‡ |

**åœ–ä¾‹**ï¼š
- **R (Responsible)**: åŸ·è¡Œè€…
- **A (Accountable)**: æœ€çµ‚è² è²¬äºº
- **C (Consulted)**: éœ€è«®è©¢
- **I (Informed)**: éœ€é€šçŸ¥

---

#### ç”¨æˆ¶æºé€šæ¨¡æ¿

**æ¨¡æ¿ Aï¼šç½é›£ç™¼ç”Ÿé€šçŸ¥**

```markdown
## ğŸ”§ ç³»çµ±ç¶­è­·é€šçŸ¥

å„ä½ç”¨æˆ¶æ‚¨å¥½ï¼Œ

æˆ‘å€‘ç›®å‰æ­£åœ¨é€²è¡Œç·Šæ€¥ç³»çµ±ç¶­è­·ï¼Œä»¥ä¸‹åŠŸèƒ½æš«æ™‚ç„¡æ³•ä½¿ç”¨ï¼š
- âŒ å¸‚å ´åˆ—è¡¨æŸ¥è©¢
- âŒ åˆŠç™»å»ºç«‹/æ›´æ–°
- âŒ è³¼è²·æ„å‘ç™»è¨˜

**é è¨ˆæ¢å¾©æ™‚é–“**ï¼š[å…·é«”æ™‚é–“ï¼Œå¦‚ 2025-10-25 15:00]

**æ‚¨çš„è³‡æ–™å®‰å…¨**ï¼š
- âœ… æ‰€æœ‰åˆŠç™»å’Œæ„å‘è³‡æ–™å·²å‚™ä»½
- âœ… è³‡æ–™ä¸æœƒéºå¤±
- âœ… Token ä¸æœƒå¤±æ•ˆï¼ˆéæœŸæ™‚é–“è‡ªå‹•å»¶é•·ï¼‰

æˆ‘å€‘æœƒåœ¨æ¢å¾©å¾Œç«‹å³é€šçŸ¥æ‚¨ï¼Œé€ æˆä¸ä¾¿æ•¬è«‹è¦‹è«’ã€‚

æœ‰ä»»ä½•å•é¡Œè«‹è¯çµ¡ï¼š[Discord é€£çµ / Email]

---
æ›´æ–°æ™‚é–“ï¼š[æ™‚é–“æˆ³è¨˜]
```

**æ¨¡æ¿ Bï¼šæ¢å¾©é€šçŸ¥**

```markdown
## âœ… ç³»çµ±å·²æ¢å¾©æ­£å¸¸

å„ä½ç”¨æˆ¶æ‚¨å¥½ï¼Œ

ç³»çµ±ç¶­è­·å·²å®Œæˆï¼Œæ‰€æœ‰åŠŸèƒ½å·²æ¢å¾©æ­£å¸¸ï¼

**å·²æ¢å¾©åŠŸèƒ½**ï¼š
- âœ… å¸‚å ´åˆ—è¡¨æŸ¥è©¢
- âœ… åˆŠç™»å»ºç«‹/æ›´æ–°
- âœ… è³¼è²·æ„å‘ç™»è¨˜

**è³‡æ–™å®Œæ•´æ€§ç¢ºèª**ï¼š
- âœ… æ‰€æœ‰åˆŠç™»è³‡æ–™å®Œæ•´ï¼ˆ[æ•¸é‡] ç­†ï¼‰
- âœ… æ‰€æœ‰è³¼è²·æ„å‘å®Œæ•´ï¼ˆ[æ•¸é‡] ç­†ï¼‰
- âœ… Token å¯æ­£å¸¸ä½¿ç”¨

**åœæ©Ÿæ™‚é–“**ï¼š[å¯¦éš›æ™‚é–“ï¼Œå¦‚ 2 å°æ™‚ 15 åˆ†é˜]
**å½±éŸ¿ç¯„åœ**ï¼š[æè¿°ï¼Œå¦‚ã€Œæ‰€æœ‰ç”¨æˆ¶ã€]

æ„Ÿè¬æ‚¨çš„è€å¿ƒç­‰å¾…ï¼

å¦‚æœ‰ä»»ä½•å•é¡Œæˆ–ç™¼ç¾ç•°å¸¸ï¼Œè«‹ç«‹å³è¯çµ¡æˆ‘å€‘ã€‚

---
æ¢å¾©æ™‚é–“ï¼š[æ™‚é–“æˆ³è¨˜]
```

**æ¨¡æ¿ Cï¼šè³‡æ–™éºå¤±é€šçŸ¥ï¼ˆæœ€å£æƒ…æ³ï¼‰**

```markdown
## âš ï¸ é‡è¦ï¼šéƒ¨åˆ†è³‡æ–™éºå¤±é€šçŸ¥

å„ä½ç”¨æˆ¶æ‚¨å¥½ï¼Œ

å¾ˆéºæ†¾é€šçŸ¥æ‚¨ï¼Œåœ¨ç³»çµ±æ¢å¾©éç¨‹ä¸­ï¼Œæˆ‘å€‘ç„¡æ³•å®Œå…¨æ¢å¾©æ‰€æœ‰è³‡æ–™ã€‚

**éºå¤±è³‡æ–™ç¯„åœ**ï¼š
- [å…·é«”æè¿°ï¼Œå¦‚ã€Œ2025-10-25 12:00-14:00 æœŸé–“å»ºç«‹çš„åˆŠç™»ã€]
- å½±éŸ¿ç”¨æˆ¶æ•¸ï¼š[æ•¸é‡]
- éºå¤±åˆŠç™»æ•¸ï¼š[æ•¸é‡]

**å·²æ¢å¾©è³‡æ–™**ï¼š
- âœ… [æ™‚é–“] ä¹‹å‰çš„æ‰€æœ‰åˆŠç™»
- âœ… [æ™‚é–“] ä¹‹å¾Œçš„æ‰€æœ‰åˆŠç™»
- âœ… æ‰€æœ‰ç”¨æˆ¶ Token å’Œæ„å‘è³‡æ–™

**è£œå„Ÿæªæ–½**ï¼š
- ğŸ å—å½±éŸ¿ç”¨æˆ¶åˆŠç™»é…é¡æš«æ™‚æé«˜è‡³ [æ•¸é‡]ï¼ˆ[æœŸé™]ï¼‰
- ğŸ å…è²»æŠ€è¡“æ”¯æ´å”åŠ©é‡æ–°å»ºç«‹åˆŠç™»

**å¦‚ä½•ç¢ºèªæ˜¯å¦å—å½±éŸ¿**ï¼š
1. ç™»å…¥ç³»çµ±æŸ¥çœ‹åˆŠç™»åˆ—è¡¨
2. æª¢æŸ¥æ˜¯å¦ç¼ºå°‘ [æ™‚é–“ç¯„åœ] çš„åˆŠç™»
3. å¦‚æœ‰ç–‘å•è«‹è¯çµ¡æˆ‘å€‘ï¼š[è¯çµ¡æ–¹å¼]

æˆ‘å€‘æ·±æ„ŸæŠ±æ­‰ï¼Œä¸¦æ‰¿è«¾åŠ å¼·å‚™ä»½ç­–ç•¥ä»¥é¿å…æ­¤é¡æƒ…æ³å†æ¬¡ç™¼ç”Ÿã€‚

---
é€šçŸ¥æ™‚é–“ï¼š[æ™‚é–“æˆ³è¨˜]
```

---

### 4. å¯¦éš›æµé‡åˆ†æï¼ˆåŸºæ–¼ 5 å¤©ç›£æ¸¬æ•¸æ“šï¼‰

**ç›£æ¸¬æœŸé–“**ï¼š2025-10-20 è‡³ 2025-10-25ï¼ˆ5 å¤©ï¼‰

#### åŸå§‹æ•¸æ“š

```
ç¸½è¨ªå•æ•¸ï¼š7,794 visitors
å¹³å‡è¨ªå•æ•¸ï¼š1,559 visitors/å¤©
æ•¸æ“šä¾†æºï¼šVercel Analytics
```

#### æµé‡çµ„æˆåˆ†æ

**è¨ªå®¢é¡å‹æ¨ä¼°**ï¼š

| é¡å‹ | ä¼°è¨ˆæ¯”ä¾‹ | æ•¸é‡/å¤© | è¨ˆç®—ä¾æ“š |
|------|---------|---------|---------|
| **çœŸå¯¦ç”¨æˆ¶** | 20-30% | 312-468 | æ­£å¸¸äº’å‹•è¡Œç‚ºï¼ˆç™»å…¥ã€ç€è¦½ã€ç™»è¨˜æ„å‘ï¼‰ |
| **SEO çˆ¬èŸ²** | 10-15% | 156-234 | GoogleBot, BingBotï¼ˆUser-Agent å¯è­˜åˆ¥ï¼‰ |
| **æƒ¡æ„çˆ¬èŸ²** | 30-40% | 468-624 | curl, wget, è‡ªå‹•åŒ–å·¥å…·ï¼ˆUser-Agent å¯è­˜åˆ¥ï¼‰ |
| **ç„¡æ•ˆè«‹æ±‚** | 20-30% | 312-468 | é‡è¤‡è¨ªå•ã€ç„¡ User-Agentã€API æƒæ |

**ä¼°ç®—æ–¹æ³•**ï¼š
```typescript
// åŸºæ–¼å…¸å‹ Web æ‡‰ç”¨çš„ Bot æµé‡æ¯”ä¾‹
const estimates = {
  totalVisitors: 1559,           // Vercel å ±å‘Šçš„ç¸½è¨ªå•æ•¸

  // çœŸå¯¦ç”¨æˆ¶æ¨ç®—
  realUsers: 1559 * 0.25,        // = 390 users/å¤©ï¼ˆä¿å®ˆä¼°è¨ˆ 25%ï¼‰
  dailyActiveRate: 0.3,          // 30% æ—¥æ´»ç‡ï¼ˆè¡Œæ¥­å¹³å‡ï¼‰
  monthlyActiveUsers: 390 / 0.3, // = 1,300 MAU â‰ˆ 1,200-1,600

  // Bot æµé‡æ¨ç®—
  botTraffic: 1559 * 0.75,       // = 1,169 bots/å¤©ï¼ˆ75% æ˜¯ Botï¼‰

  // ç´°åˆ†
  seoB ots: 1559 * 0.12,         // = 187ï¼ˆGoogleBot, BingBot ç´„ 10-15%ï¼‰
  maliciousBots: 1559 * 0.40,    // = 624ï¼ˆæƒ¡æ„çˆ¬èŸ² 30-40%ï¼‰
  invalidRequests: 1559 * 0.23   // = 359ï¼ˆç„¡æ•ˆè«‹æ±‚ 20-30%ï¼‰
}

// é©—è­‰
console.log(estimates.realUsers + estimates.botTraffic) // â‰ˆ 1559 âœ“
```

#### æµé‡ä¾†æºåˆ†æï¼ˆæ¨æ¸¬ï¼‰

**ç«¯é»æµé‡åˆ†å¸ƒ**ï¼ˆåŸºæ–¼ trending ç«¯é»çš„ Bot ä½”æ¯”æ¨ç®—ï¼‰ï¼š

| ç«¯é»é¡åˆ¥ | ä¼°è¨ˆè«‹æ±‚æ•¸/å¤© | Bot æ¯”ä¾‹ | Bot è«‹æ±‚/å¤© | çœŸå¯¦è«‹æ±‚/å¤© |
|---------|-------------|---------|------------|------------|
| **trendingï¼ˆå…¬é–‹ï¼‰** | 1,200 | 80-90% | 960-1,080 | 120-240 |
| **å¸‚å ´åˆ—è¡¨ï¼ˆèªè­‰ï¼‰** | 3,744 | 30-40% | 1,123-1,498 | 2,246-2,621 |
| **å»ºç«‹åˆŠç™»ï¼ˆèªè­‰ï¼‰** | 62 | 10-20% | 6-12 | 50-56 |
| **ç™»è¨˜æ„å‘ï¼ˆèªè­‰ï¼‰** | 374 | 10-20% | 37-75 | 299-337 |
| **æŸ¥çœ‹è¯çµ¡æ–¹å¼ï¼ˆèªè­‰ï¼‰** | 187 | 5-10% | 9-19 | 168-178 |
| **Token å‰µå»º** | 156 | 40-50% | 62-78 | 78-94 |
| **å…¶ä»– API** | 611 | 50-60% | 306-367 | 244-305 |
| **ç¸½è¨ˆ** | **6,334** | **~60%** | **~3,800** | **~2,500** |

**é—œéµç™¼ç¾**ï¼š
1. **trending ç«¯é»æ˜¯ Bot æµé‡é‡ç½å€**ï¼š80-90% è«‹æ±‚ä¾†è‡ª Bot
2. **èªè­‰ç«¯é» Bot æ¯”ä¾‹è¼ƒä½**ï¼šä½†ä»æœ‰ 10-40% Botï¼ˆå¸³è™Ÿè¨»å†Šæ©Ÿå™¨äººï¼‰
3. **å…¬é–‹ç«¯é»éœ€è¦åš´æ ¼é˜²è­·**ï¼šç„¡èªè­‰é–€æª»å®¹æ˜“è¢«æ¿«ç”¨

#### Redis å‘½ä»¤æ•¸æ¶ˆè€—åˆ†æ

**ç•¶å‰ç‹€æ…‹ï¼ˆç„¡ Bot éæ¿¾ï¼‰**ï¼š

```typescript
// Rate Limiting å‘½ä»¤æ•¸ï¼ˆå›ºå®šçª—å£ç®—æ³•ï¼šINCR + EXPIREï¼‰
const commands = {
  trending: 1200 * 2,           // = 2,400 å‘½ä»¤ï¼ˆ80-90% æ˜¯ Botï¼‰
  marketList: 3744 * 2,         // = 7,488 å‘½ä»¤
  createListing: 62 * 2,        // = 124 å‘½ä»¤
  registerInterest: 374 * 2,    // = 748 å‘½ä»¤
  viewContact: 187 * 2,         // = 374 å‘½ä»¤
  tokenCreate: 156 * 2,         // = 312 å‘½ä»¤
  otherAPIs: 611 * 2,           // = 1,222 å‘½ä»¤
}

const total = Object.values(commands).reduce((a, b) => a + b, 0)
// = 12,668 å‘½ä»¤/å¤©

// âš ï¸ å¯¦éš›ç›£æ¸¬ç‚º 10,668 å‘½ä»¤/å¤©ï¼ˆå¯èƒ½éƒ¨åˆ†ç«¯é»æœªå•Ÿç”¨ Rate Limitï¼‰
```

**Bot éæ¿¾å¾Œé ä¼°ï¼ˆéšæ®µæ€§ï¼‰**ï¼š

| éšæ®µ | éæ¿¾ç­–ç•¥ | Bot æ¸›å°‘ç‡ | Redis å‘½ä»¤/å¤© | ä½¿ç”¨ç‡ | ç‹€æ…‹ |
|------|---------|-----------|--------------|-------|------|
| **ç•¶å‰** | trending é™åˆ¶ | ~20% | 10,668 | 107% | âŒ å·²è¶…æ¨™ |
| **éšæ®µ 1** | trending + User-Agentï¼ˆåƒ…å…¬é–‹ç«¯é»ï¼‰ | 40-50% | 8,000-9,000 | 80-90% | âš ï¸ æ¥è¿‘ä¸Šé™ |
| **éšæ®µ 2** | User-Agent å…¨é¢æª¢æ¸¬ | 60-70% | 6,000-7,000 | 60-70% | âœ… å¯é‹è¡Œ |
| **éšæ®µ 3** | User-Agent + è¡Œç‚ºæª¢æ¸¬ | 70-80% | 4,800-6,000 | 48-60% | âœ… ç©©å®š |
| **éšæ®µ 4** | Cloudflare Bot Protection | 85-95% | 3,000-4,000 | 30-40% | âœ… ç†æƒ³ |

#### MAU ä¿®æ­£èˆ‡å®¹é‡è¦åŠƒ

**åŸä¼°ç®— vs å¯¦éš›æ•¸æ“š**ï¼š

| æŒ‡æ¨™ | åŸä¼°ç®— | å¯¦éš›æ•¸æ“š | å·®ç•° | åŸå› åˆ†æ |
|------|-------|---------|------|---------|
| Daily Visitors | ~320 | **1,559** | +387% | **é«˜ Bot æµé‡æœªé æœŸ** |
| çœŸå¯¦ DAU | 240 | 312-468 | +30-95% | Bot éæ¿¾å¾Œæ¥è¿‘åŸä¼°ç®— |
| MAU | 800 | **1,200-1,600** | +50-100% | å¯¦éš›ç”¨æˆ¶ç•¥é«˜æ–¼é æœŸ |
| Redis å‘½ä»¤ | 6,800 | **10,668** | +57% | Bot æµé‡æ¶ˆè€—å¤§é‡é…é¡ |

**ä¿®æ­£å¾Œçš„å®¹é‡è¦åŠƒ**ï¼š

```
ä¿å®ˆä¼°è¨ˆï¼ˆBot éæ¿¾ 70%ï¼‰ï¼š
- çœŸå¯¦ MAUï¼š1,200-1,400
- çœŸå¯¦ DAUï¼š360-420ï¼ˆ30% æ—¥æ´»ç‡ï¼‰
- API è«‹æ±‚ï¼š2,500-3,000/å¤©ï¼ˆéæ¿¾ Bot å¾Œï¼‰
- Redis å‘½ä»¤ï¼š5,000-6,000/å¤©ï¼ˆ50-60% ä½¿ç”¨ç‡ï¼‰
- ç‹€æ…‹ï¼šâœ… å…è²»ç‰ˆå¯ç©©å®šé‹è¡Œ

æ¨‚è§€ä¼°è¨ˆï¼ˆBot éæ¿¾ 80%ï¼‰ï¼š
- çœŸå¯¦ MAUï¼š1,000-1,200
- çœŸå¯¦ DAUï¼š300-360
- API è«‹æ±‚ï¼š2,000-2,500/å¤©
- Redis å‘½ä»¤ï¼š4,000-5,000/å¤©ï¼ˆ40-50% ä½¿ç”¨ç‡ï¼‰
- ç‹€æ…‹ï¼šâœ… å…è²»ç‰ˆé¤˜è£•å……è¶³
```

#### æµé‡ç•°å¸¸æ¨¡å¼è­˜åˆ¥

**è§€å¯Ÿåˆ°çš„ç•°å¸¸è¡Œç‚º**ï¼ˆåŸºæ–¼ trending ç«¯é»åˆ†æï¼‰ï¼š

1. **é«˜é »è¨ªå•**ï¼š
   - ç¾è±¡ï¼šå–®ä¸€ IP åœ¨ 1 å°æ™‚å…§è«‹æ±‚ > 50 æ¬¡
   - æ¯”ä¾‹ï¼šä¼°è¨ˆ 20-30% çš„ Bot æµé‡
   - ç‰¹å¾µï¼šUser-Agent ç‚º curl, wget, python-requests

2. **æƒæè¡Œç‚º**ï¼š
   - ç¾è±¡ï¼šå¿«é€Ÿè¨ªå•å¤šå€‹ä¸åŒç«¯é»ï¼ˆ1 åˆ†é˜å…§ > 20 å€‹ç«¯é»ï¼‰
   - æ¯”ä¾‹ï¼šä¼°è¨ˆ 10-15% çš„ Bot æµé‡
   - ç‰¹å¾µï¼šUser-Agent ç‚º headless, selenium, phantom

3. **ç„¡ User-Agent è«‹æ±‚**ï¼š
   - ç¾è±¡ï¼šå®Œå…¨æ²’æœ‰ User-Agent header
   - æ¯”ä¾‹ï¼šä¼°è¨ˆ 5-10% çš„æµé‡
   - åˆ¤å®šï¼š100% ç‚º Bot æˆ–æƒ¡æ„è«‹æ±‚

4. **SEO çˆ¬èŸ²**ï¼ˆåˆæ³•ï¼‰ï¼š
   - ä¾†æºï¼šGoogleBot, BingBot, BaiduSpider
   - æ¯”ä¾‹ï¼š10-15% çš„æµé‡
   - è™•ç†ï¼šç™½åå–®å…è¨±ï¼ˆæœ‰åˆ©æ–¼ SEOï¼‰

#### æ‡‰å°å»ºè­°ï¼ˆå„ªå…ˆç´šæ’åºï¼‰

**ç«‹å³åŸ·è¡Œï¼ˆP0ï¼‰**ï¼š
- âœ… trending ç«¯é»ï¼š10/å°æ™‚ + User-Agent æª¢æ¸¬ï¼ˆ**å·²å¯¦ä½œ**ï¼‰
- âœ… é™ç´šé–¾å€¼ï¼š90% â†’ 70%ï¼ˆ**å·²èª¿æ•´**ï¼‰
- âœ… ç·Šæ€¥é™ç´šæ¨¡å¼ï¼šç’°å¢ƒè®Šæ•¸æ§åˆ¶ï¼ˆ**å·²å¯¦ä½œ**ï¼‰

**1 é€±å…§ï¼ˆP1ï¼‰**ï¼š
- âœ… IP é…é¡æ¸…ç†ï¼š30 å¤©ä¿ç•™æœŸï¼ˆ**å·²å¯¦ä½œ**ï¼‰
- âœ… å†·å»æœŸå„ªåŒ–ï¼š5 åˆ†é˜ â†’ 2 åˆ†é˜ï¼ˆ**å·²èª¿æ•´**ï¼‰
- âœ… Bot Detection æ–¹æ¡ˆï¼šUser-Agent + è¡Œç‚ºæª¢æ¸¬ï¼ˆ**å·²è¨­è¨ˆ**ï¼‰

**1 å€‹æœˆå…§ï¼ˆP2ï¼‰**ï¼š
- â³ Bot Detection å…¨é¢å¯¦ä½œï¼šæ‰€æœ‰ç«¯é»æ‡‰ç”¨
- â³ æµé‡ç›£æ§å„€è¡¨æ¿ï¼šå¯¦æ™‚ Bot æµé‡æ¯”ä¾‹
- â³ è‡ªå‹•åŒ–å‘Šè­¦ï¼šBot æµé‡è¶…é 60% æ™‚é€šçŸ¥

**é•·æœŸå„ªåŒ–ï¼ˆP3ï¼‰**ï¼š
- â³ Cloudflare Bot Protectionï¼šçµ‚æ¥µè§£æ±ºæ–¹æ¡ˆï¼ˆå…è²»ç‰ˆæœ‰é™åˆ¶ï¼‰
- â³ æ©Ÿå™¨å­¸ç¿’ Bot æª¢æ¸¬ï¼šæ ¹æ“šè¡Œç‚ºæ¨¡å¼è‡ªå‹•è­˜åˆ¥
- â³ å‹•æ…‹ Rate Limitï¼šæ ¹æ“šå¯¦éš›æµé‡è‡ªå‹•èª¿æ•´

#### çµè«–èˆ‡è¡Œå‹•æ–¹æ¡ˆ

**æ ¸å¿ƒå•é¡Œ**ï¼š
> **60-80% æµé‡æ˜¯ Bot**ï¼Œå°è‡´å…è²»ç‰ˆ Redis è¶…æ¨™ 6.68%

**è§£æ±ºè·¯å¾‘**ï¼š
```
ç•¶å‰ç‹€æ…‹ï¼ˆ1,559 visitors/å¤©ï¼Œ107% Redisï¼‰
  â†“
éšæ®µ 1ï¼šç·Šæ€¥é™ç´šæ¨¡å¼ï¼ˆ**å·²å•Ÿç”¨**ï¼‰
  â†’ Redis é™è‡³ ~200 å‘½ä»¤/å¤©ï¼ˆ2% ä½¿ç”¨ç‡ï¼‰
  â†’ è‡¨æ™‚æ–¹æ¡ˆï¼ŒåŠŸèƒ½å—é™
  â†“
éšæ®µ 2ï¼šUser-Agent æª¢æ¸¬å…¨é¢å¯¦ä½œï¼ˆ**1 é€±å…§**ï¼‰
  â†’ Bot éæ¿¾ 60-70%
  â†’ Redis é™è‡³ 6,000-7,000 å‘½ä»¤/å¤©ï¼ˆ60-70% ä½¿ç”¨ç‡ï¼‰
  â†’ âœ… å¯ç©©å®šé‹è¡Œåœ¨å…è²»ç‰ˆ
  â†“
éšæ®µ 3ï¼šè¡Œç‚ºæª¢æ¸¬å¯¦ä½œï¼ˆ**1 å€‹æœˆå…§**ï¼‰
  â†’ Bot éæ¿¾ 70-80%
  â†’ Redis é™è‡³ 4,800-6,000 å‘½ä»¤/å¤©ï¼ˆ48-60% ä½¿ç”¨ç‡ï¼‰
  â†’ âœ… å…è²»ç‰ˆé•·æœŸç©©å®š
  â†“
éšæ®µ 4ï¼šCloudflare æ•´åˆï¼ˆ**å¯é¸**ï¼‰
  â†’ Bot éæ¿¾ 85-95%
  â†’ Redis é™è‡³ 3,000-4,000 å‘½ä»¤/å¤©ï¼ˆ30-40% ä½¿ç”¨ç‡ï¼‰
  â†’ âœ… ç†æƒ³ç‹€æ…‹
```

**é—œéµæŒ‡æ¨™è¿½è¹¤**ï¼ˆæ¯é€±æª¢æŸ¥ï¼‰ï¼š
- ğŸ“Š ç¸½è¨ªå•æ•¸ï¼šç›®æ¨™ < 1,000/å¤©ï¼ˆéæ¿¾ Bot å¾Œï¼‰
- ğŸ“Š Bot æµé‡æ¯”ä¾‹ï¼šç›®æ¨™ < 40%
- ğŸ“Š Redis ä½¿ç”¨ç‡ï¼šç›®æ¨™ < 70%
- ğŸ“Š çœŸå¯¦ MAUï¼šç›®æ¨™ 1,000-1,400

---

## æ¸¬è©¦ç­–ç•¥

### 1. å–®å…ƒæ¸¬è©¦

**æ¸¬è©¦ç¯„åœ**ï¼š

| æ¨¡çµ„ | æ¸¬è©¦é‡é» | å·¥å…· |
|------|---------|------|
| Token ç”Ÿæˆ | å”¯ä¸€æ€§ã€é•·åº¦ã€æ ¼å¼ | Jest |
| è¼¸å…¥é©—è­‰ | é‚Šç•Œå€¼ã€éæ³•è¼¸å…¥ | Jest |
| Rate Limiter | é™åˆ¶æ­£ç¢ºæ€§ã€çª—å£è¨ˆç®— | Jest + Redis Mock |
| æŒ‡ç´‹ç”Ÿæˆ | ä¸€è‡´æ€§ã€ç©©å®šæ€§ | Jest |

**æ¸¬è©¦è¦†è“‹ç‡ç›®æ¨™ï¼ˆèª¿æ•´å¾Œï¼Œæ›´ç¬¦åˆå¿«é€ŸåŸå‹ï¼‰**ï¼š
- æ ¸å¿ƒæ¥­å‹™é‚è¼¯ï¼š> **60%**ï¼ˆvs 80%ï¼‰- é…é¡ç³»çµ±ã€æ¬Šé™é©—è­‰
- API Routesï¼š> **40%**ï¼ˆvs 60%ï¼‰- é‡é»æ¸¬è©¦é—œéµç«¯é»
- UI çµ„ä»¶ï¼š**å¯é¸**ï¼ˆ< 30%ï¼‰- åƒ…æ¸¬è©¦è¤‡é›œäº¤äº’

**ç†ç”±**ï¼š
- âœ… é€™æ˜¯æ„å‘ç™»è¨˜å¹³å°ï¼Œ**ä¸æ¶‰åŠé‡‘æµå’Œç‰©å“è½‰ç§»**ï¼Œé¢¨éšªè¼ƒä½
- âœ… æ¡ç”¨ã€Œå®Œå…¨ä¿¡ä»»ã€æ¨¡å¼ï¼Œé‡é»åœ¨é˜²æ¿«ç”¨è€Œéé˜²æ¬ºè©
- âœ… å¿«é€Ÿè¿­ä»£å„ªå…ˆï¼Œéé«˜çš„æ¸¬è©¦è¦†è“‹ç‡æœƒæ‹–æ…¢é–‹ç™¼é€Ÿåº¦

---

### 2. æ•´åˆæ¸¬è©¦

**æ¸¬è©¦å ´æ™¯**ï¼š

```typescript
describe('Interest Registration Flow', () => {
  it('æ‡‰è©²æˆåŠŸç™»è¨˜è³¼è²·æ„å‘', async () => {
    // 1. å‰µå»ºè³£å®¶å’Œè²·å®¶ token
    const seller = await createTestToken('seller123')
    const buyer = await createTestToken('buyer456')

    // 2. è³£å®¶å»ºç«‹åˆŠç™»
    const listing = await createListing(seller, {
      itemId: 100,
      price: 1000,
      contactMethod: 'discord',
      contactInfo: 'seller#1234'
    })

    // 3. è²·å®¶ç™»è¨˜æ„å‘
    const interest = await registerInterest(buyer, listing.id)

    // 4. é©—è­‰çµæœ
    expect(interest.listing_id).toBe(listing.id)
    expect(interest.buyer_id).toBe('buyer456')

    // 5. è³£å®¶æŸ¥è©¢æ”¶åˆ°çš„æ„å‘
    const received = await getReceivedInterests(seller)
    expect(received).toHaveLength(1)
    expect(received[0].buyer_id).toBe('buyer456')
  })

  it('æ‡‰è©²é˜²æ­¢é‡è¤‡ç™»è¨˜æ„å‘', async () => {
    const listing = await createListing(seller, {
      itemId: 100,
      price: 1000,
      contactMethod: 'discord',
      contactInfo: 'seller#1234'
    })

    // ç¬¬ä¸€æ¬¡ç™»è¨˜æˆåŠŸ
    await registerInterest(buyer, listing.id)

    // ç¬¬äºŒæ¬¡ç™»è¨˜æ‡‰è©²å¤±æ•—ï¼ˆå”¯ä¸€ç´„æŸï¼‰
    await expect(
      registerInterest(buyer, listing.id)
    ).rejects.toThrow('å·²ç™»è¨˜éè³¼è²·æ„å‘')
  })

  it('åˆªé™¤åˆŠç™»æ™‚æ‡‰è‡ªå‹•æ¸…ç†ç›¸é—œæ„å‘', async () => {
    const listing = await createListing(seller, { itemId: 100, price: 1000 })
    await registerInterest(buyer1, listing.id)
    await registerInterest(buyer2, listing.id)

    // è³£å®¶åˆªé™¤åˆŠç™»
    await deleteListing(seller, listing.id)

    // æ„å‘æ‡‰è©²è¢« CASCADE åˆªé™¤
    const interests = await getInterestsByListing(listing.id)
    expect(interests).toHaveLength(0)
  })
})
```

---

### 3. å£“åŠ›æ¸¬è©¦

**æ¸¬è©¦ç›®æ¨™**ï¼š

| æŒ‡æ¨™ | ç›®æ¨™å€¼ | æ¸¬è©¦å·¥å…· |
|------|-------|---------|
| ä¸¦ç™¼ç”¨æˆ¶ | 1000 | k6 / Artillery |
| æ„å‘ç™»è¨˜ TPS | > 100 | k6 |
| API å»¶é² P95 | < 300ms | k6 |
| éŒ¯èª¤ç‡ | < 1% | k6 |

**æ¸¬è©¦è…³æœ¬ç¯„ä¾‹**ï¼ˆk6ï¼‰ï¼š

```javascript
import http from 'k6/http'
import { check, sleep } from 'k6'

export const options = {
  stages: [
    { duration: '2m', target: 100 },   // ç·©æ…¢å¢åŠ åˆ° 100 ç”¨æˆ¶
    { duration: '5m', target: 1000 },  // å¢åŠ åˆ° 1000 ç”¨æˆ¶
    { duration: '2m', target: 0 },     // æ¸›å°‘åˆ° 0
  ],
  thresholds: {
    http_req_duration: ['p(95)<500'],  // P95 < 500ms
    http_req_failed: ['rate<0.01'],    // éŒ¯èª¤ç‡ < 1%
  },
}

export default function () {
  // ç²å–å¸‚å ´åˆ—è¡¨
  const res = http.get('https://your-domain.com/api/market')

  check(res, {
    'status is 200': (r) => r.status === 200,
    'response time < 500ms': (r) => r.timings.duration < 500,
  })

  sleep(1)
}
```

---

## æ“´å±•æ€§è€ƒé‡

### 1. æ°´å¹³æ“´å±•ç­–ç•¥

**ç•¶å‰æ¶æ§‹é™åˆ¶**ï¼š
- Supabase å…è²»ç‰ˆå–®ä¸€å¯¦ä¾‹
- Vercel Edge Functions è‡ªå‹•æ“´å±•
- Upstash Redis è‡ªå‹•æ“´å±•

**æ“´å±•è·¯å¾‘ï¼ˆåŸºæ–¼å¯¦éš›æµé‡ä¿®æ­£ï¼‰**ï¼š

```
éšæ®µ 0: ç·Šæ€¥é™ç´šï¼ˆç•¶å‰ç‹€æ…‹ï¼Œ1560 MAUï¼‰
  â†’ å•Ÿç”¨ EMERGENCY_DEGRADATION=true
  â†’ åœç”¨æ‰€æœ‰ Rate Limitï¼Œä¾è³´ user_quotas/ip_quotas
  â†’ Redis å‘½ä»¤æ•¸ï¼š~200/å¤©ï¼ˆåƒ… trending ç«¯é»ï¼‰
  â†’ è‡¨æ™‚æ–¹æ¡ˆï¼Œéœ€ç›¡å¿«å¯¦ä½œ Bot Detection

éšæ®µ 1: Bot éæ¿¾å¾Œï¼ˆ< 1000 MAUï¼‰
  â†’ å¯¦ä½œ Bot Detectionï¼ˆUser-Agent + é »ç‡æª¢æ¸¬ï¼‰
  â†’ é æœŸæ¸›å°‘ 60-80% ç„¡æ•ˆæµé‡
  â†’ Redis å‘½ä»¤æ•¸ï¼š4,800-6,800/å¤©ï¼ˆ48-68% ä½¿ç”¨ç‡ï¼‰
  â†’ å…è²»ç‰ˆå¯ç©©å®šé‹è¡Œ

éšæ®µ 2: è¼•åº¦ä»˜è²»ï¼ˆ1000-15000 MAUï¼‰
  â†’ å‡ç´š Upstash Proï¼ˆ$10/æœˆï¼Œ100 è¬å‘½ä»¤ï¼‰
  â†’ ç¶­æŒ Supabase å…è²»ç‰ˆï¼ˆè³‡æ–™åº«ç©ºé–“ä»å……è¶³ï¼‰
  â†’ å¯æ”¯æ’ 15,000 MAU

éšæ®µ 3: ä¸­åº¦ä»˜è²»ï¼ˆ15000-50000 MAUï¼‰
  â†’ å‡ç´š Supabase Proï¼ˆ$25/æœˆï¼Œ25 GB è³‡æ–™åº«ï¼‰
  â†’ å•Ÿç”¨è®€å‰¯æœ¬ï¼ˆRead Replicasï¼‰

éšæ®µ 4: è³‡æ–™åº«åˆ†ç‰‡ï¼ˆ> 50000 MAUï¼‰
  â†’ æŒ‰è§’è‰² ID ç¯„åœåˆ†ç‰‡
  â†’ ä½¿ç”¨ Supabase + Prisma Migrate
```

---

### 2. è®€å¯«åˆ†é›¢

**è®€å¯«åˆ†é›¢æ¶æ§‹**ï¼ˆSupabase Pro åŠŸèƒ½ï¼‰ï¼š

```
å¯«å…¥æ“ä½œ â†’ Primary Database
  â”œâ”€ è³¼è²·ç‰©å“
  â”œâ”€ ä¸Šæ¶ç‰©å“
  â””â”€ å‰µå»º token

è®€å–æ“ä½œ â†’ Read Replica
  â”œâ”€ å¸‚å ´åˆ—è¡¨ï¼ˆä¸»è¦æµé‡ï¼‰
  â”œâ”€ æœå°‹/ç¯©é¸
  â””â”€ äº¤æ˜“æ­·å²
```

---

### 3. è³‡æ–™åˆ†ç‰‡ç­–ç•¥

**åˆ†ç‰‡éµé¸æ“‡**ï¼š`character_id` çš„é¦–å­—æ¯

```
Shard 1: character_id ä»¥ A-F é–‹é ­
Shard 2: character_id ä»¥ G-M é–‹é ­
Shard 3: character_id ä»¥ N-S é–‹é ­
Shard 4: character_id ä»¥ T-Z é–‹é ­
```

**è·¨åˆ†ç‰‡æŸ¥è©¢**ï¼ˆå¸‚å ´åˆ—è¡¨ï¼‰ï¼š
- ä½¿ç”¨ Redis å¿«å–èšåˆçµæœ
- æˆ–ä½¿ç”¨ ElasticSearch åšæœå°‹å±¤

---

## æˆæœ¬é ä¼°

### å…è²»é¡åº¦è©•ä¼°

#### Supabase å…è²»ç‰ˆ

| é …ç›® | å…è²»é¡åº¦ | å¯¦éš›ä½¿ç”¨ï¼ˆ1200-1600 MAUï¼‰ | é¤˜è£• |
|------|---------|---------------------|------|
| è³‡æ–™åº«ç©ºé–“ | 500 MB | 60-80 MB | âœ… å……è¶³ï¼ˆ6-8xï¼‰ |
| æœˆæ´»èºç”¨æˆ¶ | 50,000 | 1,200-1,600 | âœ… å……è¶³ï¼ˆ31-42xï¼‰ |
| è³‡æ–™åº«è«‹æ±‚ | ç„¡é™åˆ¶ | ~120-160 è¬/æœˆ | âœ… ç„¡é™åˆ¶ |

**ç©ºé–“ä¼°ç®—ï¼ˆå¯¦éš›æµé‡ä¿®æ­£ï¼‰**ï¼š
```
å‡è¨­ï¼š1200-1600 ç”¨æˆ¶ã€æ¯äººå¹³å‡ 10 ç­†åˆŠç™»ã€æ¯æœˆ 20 ç­†æ„å‘ç™»è¨˜
æ¡ç”¨ä¿å®ˆå€¼ï¼š1600 MAU

listings è¡¨: 1600 * 10 * 300 bytes = 4.8 MBï¼ˆæ–°å¢æ¬„ä½ï¼‰
interests è¡¨ï¼ˆ30 å¤©ï¼‰: 1600 * 20 * 150 bytes = 4.8 MBï¼ˆæ–°å¢ç‹€æ…‹æ¬„ä½ï¼‰
reports è¡¨ï¼ˆ90 å¤©ï¼‰: 160 èˆ‰å ± * 200 bytes = 0.032 MB
user_quotas è¡¨: 1600 ç”¨æˆ¶ * 100 bytes = 0.16 MB
tokens è¡¨: 1600 * 200 bytes = 0.32 MB
ip_quotas è¡¨: 3897 IP * 120 bytes = 0.47 MBï¼ˆå¯¦éš› 5 å¤©æ•¸æ“šæ¨ç®—ï¼‰
  âš ï¸ ç„¡æ¸…ç†ç­–ç•¥æ™‚ 1 å¹´å¾Œï¼š284,505 ç­† = 34 MB + ç´¢å¼• 68 MB = 102 MB âŒ
  âœ… æœ‰æ¸…ç†ç­–ç•¥ï¼ˆ30å¤©ä¿ç•™ï¼‰ï¼šç©©å®šåœ¨ 3,000-5,000 ç­† = 0.4-0.6 MB âœ…
ç´¢å¼•é–‹éŠ·: ~2x = 20 MB

ç¸½è¨ˆ: ~20 MBï¼ˆåƒ… 4% ä½¿ç”¨ç‡ï¼‰âœ… ä»å……è¶³
```

---

#### Vercel å…è²»ç‰ˆ

| é …ç›® | å…è²»é¡åº¦ | å¯¦éš›ä½¿ç”¨ï¼ˆ1200-1600 MAUï¼‰ | é¤˜è£• |
|------|---------|---------------------|------|
| æµé‡ | 100 GB/æœˆ | **69 GB/æœˆ**ï¼ˆå¯¦æ¸¬ï¼‰ | âš ï¸ æ¥è¿‘ä¸Šé™ï¼ˆ69%ï¼‰ |
| å‡½æ•¸åŸ·è¡Œæ™‚é–“ | 100 å°æ™‚/æœˆ | 6-10 å°æ™‚/æœˆ | âœ… å……è¶³ï¼ˆ10-16xï¼‰ |
| Cron Jobs | 1 å€‹ | 3 å€‹ï¼ˆæ—¥å¸¸æ¸…ç† + Redis æª¢æŸ¥ + IP é…é¡æœˆæ¸…ç†ï¼‰ | âœ… è¶³å¤  |

---

#### Upstash Redis å…è²»ç‰ˆ

| é …ç›® | å…è²»é¡åº¦ | å„ªåŒ–å‰ä½¿ç”¨ | å„ªåŒ–å¾Œä½¿ç”¨ | é¤˜è£• |
|------|---------|-----------|-----------|------|
| å‘½ä»¤æ•¸ | 10,000/å¤© | âŒ 33,000/å¤© | âœ… 8,000/å¤© | âœ… å……è¶³ï¼ˆ1.25xï¼‰ |
| å„²å­˜ç©ºé–“ | 256 MB | < 1 MB | < 1 MB | âœ… å……è¶³ï¼ˆ256xï¼‰ |

**å‘½ä»¤æ•¸ä¼°ç®—ï¼ˆå¯¦éš›æµé‡ä¿®æ­£ï¼‰**ï¼š

```typescript
// å¯¦éš›æµé‡æ•¸æ“šï¼ˆ5å¤©ç›£æ¸¬ï¼‰
const realData = {
  visitors: 7794 / 5,  // = 1559 visitors/å¤©
  estimatedDAU: 1559 * 0.3,  // = 468 DAUï¼ˆå‡è¨­ 30% çœŸå¯¦ç”¨æˆ¶ï¼‰
  estimatedMAU: 468 / 0.3,  // = 1560 MAU
}

// âš ï¸ å¯¦éš›æµé‡é è¶…åŸä¼°ç®—ï¼ˆ800 MAU vs 1560 MAU = 195%ï¼‰

å‡è¨­ï¼š1200-1600 MAUï¼Œæ¯å¤© 360-480 DAUï¼ˆ30% æ—¥æ´»ï¼‰
æ¡ç”¨å¯¦æ¸¬å€¼ï¼ˆ1560 MAU, 468 DAUï¼‰é€²è¡Œä¼°ç®—

// 1. Rate Limiting å‘½ä»¤æ•¸ï¼ˆå›ºå®šçª—å£ç®—æ³•ï¼‰
const rateLimitOps = {
  ç²å–token: 156,      // æ¯å¤© 156 æ¬¡ï¼ˆ468 * 0.333ï¼‰
  å»ºç«‹åˆŠç™»: 62,        // æ¯å¤© 62 ç­†æ–°åˆŠç™»
  ç™»è¨˜æ„å‘: 374,       // æ¯å¤© 374 æ¬¡æ„å‘ç™»è¨˜
  æŸ¥è©¢å¸‚å ´: 3744,      // 468 DAU * 8 æ¬¡æŸ¥è©¢ï¼ˆéœ€èªè­‰ï¼‰
  æŸ¥çœ‹è¯çµ¡æ–¹å¼: 187,   // æ¯å¤© 187 æ¬¡
  å…¶ä»–API: 499,        // æ›´æ–°ã€åˆªé™¤ã€èˆ‰å ±ç­‰
  trendingé è¦½: 312,   // IPé™åˆ¶ï¼Œç„¡éœ€ç™»å…¥ï¼ˆä¼°ç®— 156 IP * 2 æ¬¡ï¼‰
}
const totalAPIRequests = 5334  // ç¸½ API è«‹æ±‚æ•¸
const rateLimitCommands = totalAPIRequests * 2  // INCR + EXPIRE
// = 10,668 å‘½ä»¤/å¤© âŒ è¶…æ¨™ 6.68%

// 2. å¿«å–å‘½ä»¤æ•¸ï¼ˆå·²åœç”¨ï¼‰

// ç¸½è¨ˆï¼ˆæ­£å¸¸æ¨¡å¼ï¼‰
total = 10,668 å‘½ä»¤/å¤© âŒ ï¼ˆ107% ä½¿ç”¨ç‡ï¼Œå·²è¶…å‡ºå…è²»é¡åº¦ï¼‰

// âš ï¸ è­¦å‘Šï¼šç•¶å‰æµé‡å·²è¶…å‡ºå…è²»ç‰ˆé™åˆ¶
// å»ºè­°ï¼šå•Ÿç”¨ç·Šæ€¥é™ç´šæ¨¡å¼æˆ–å‡ç´š Upstash Pro ($10/æœˆ)
```

**é—œéµå„ªåŒ–æªæ–½**ï¼š
- âœ… æ”¹ç”¨å›ºå®šçª—å£ç®—æ³•ï¼ˆ2 å‘½ä»¤ vs æ»‘å‹•çª—å£ 4 å‘½ä»¤ï¼‰â†’ ç¯€çœ 50%
- âœ… å»¶é•· Rate Limit çª—å£ï¼ˆ24 å°æ™‚ vs 1 å°æ™‚ï¼‰â†’ æ¸›å°‘æª¢æŸ¥é »ç‡
- âœ… å¸‚å ´æŸ¥è©¢éœ€èªè­‰ï¼ˆé˜²çˆ¬èŸ²ï¼‰â†’ æ¶ˆé™¤å…¬é–‹ API æ¿«ç”¨é¢¨éšª
- âœ… ä¸ä½¿ç”¨ Redis å¿«å–ï¼ˆæ”¹ç”¨ Vercel Edge Config æˆ–è³‡æ–™åº«ï¼‰

**é¢¨éšªå ´æ™¯èˆ‡æ‡‰å°ï¼ˆåŸºæ–¼å¯¦éš›æµé‡ï¼‰**ï¼š

| å ´æ™¯ | å‘½ä»¤æ•¸/å¤© | ç‹€æ…‹ | æ‡‰å°æ–¹æ¡ˆ |
|------|----------|------|---------|
| **ç•¶å‰å¯¦éš›æµé‡ï¼ˆ1560 MAUï¼‰** | **10,668** | âŒ **å·²è¶…æ¨™ 6.68%** | **ç«‹å³å•Ÿç”¨ç·Šæ€¥é™ç´š** |
| Botéæ¿¾å¾Œï¼ˆ800-1000 MAUï¼‰ | 4,800-6,000 | âœ… å¯é‹è¡Œ | å¯¦ä½œ Bot Detection |
| æ­£å¸¸é‹è¡Œï¼ˆ800 MAUï¼‰ | 6,800 | âœ… å®‰å…¨ | ç¶­æŒå…è²»ç‰ˆ |
| å¢é•·ï¼ˆ1200-1600 MAUï¼‰| 10,200-13,600 | âŒ è¶…æ¨™ | **å‡ç´š Upstash Pro ($10/æœˆ)** |
| æƒ¡æ„çˆ¬èŸ²æ”»æ“Š | 50,000+ | ğŸ”´ å±éšª | Cloudflare Bot Protection |

**é‡è¦çµè«–ï¼ˆå¯¦éš›æµé‡ä¿®æ­£ï¼‰**ï¼š
- ğŸ”´ **ç•¶å‰æµé‡å·²è¶…æ¨™ï¼Œå…è²»ç‰ˆç„¡æ³•æ‰¿å— 1560 MAU**
- âš ï¸ **60-80% æµé‡å¯èƒ½æ˜¯çˆ¬èŸ²/Botï¼ˆ1559 visitors vs ~300 çœŸå¯¦ç”¨æˆ¶ï¼‰**
- âœ… **Bot éæ¿¾å¾Œå¯é™è‡³ 800 MAUï¼Œå›æ­¸å…è²»é¡åº¦å…§**
- ğŸ”´ **è‹¥ç„¡æ³•æœ‰æ•ˆéæ¿¾ Botï¼Œå¿…é ˆå‡ç´š Pro ç‰ˆ ($10/æœˆ)**
- âœ… **Pro ç‰ˆ 100 è¬å‘½ä»¤å¯æ”¯æ’ 15,000+ MAU**

---

### æˆæœ¬ç›£æ§èˆ‡å‘Šè­¦

**ç›£æ§æŒ‡æ¨™**ï¼š

| æŒ‡æ¨™ | è­¦å‘Šé–¾å€¼ | è™•ç†æ–¹å¼ |
|------|---------|---------|
| è³‡æ–™åº«å¤§å° | > 400 MBï¼ˆ80%ï¼‰ | æª¢æŸ¥æ¸…ç†ç­–ç•¥ã€è€ƒæ…®å‡ç´š |
| Vercel æµé‡ | > 80 GBï¼ˆ80%ï¼‰ | æª¢æŸ¥ç•°å¸¸æµé‡ã€å„ªåŒ–å¿«å– |
| Redis å‘½ä»¤ | > 8,000/å¤©ï¼ˆ80%ï¼‰ | å„ªåŒ– Rate Limitã€å¢åŠ å¿«å– TTL |
| æœˆæ´»èºç”¨æˆ¶ | > 40,000ï¼ˆ80%ï¼‰ | è¦åŠƒå‡ç´šæ–¹æ¡ˆ |

---

### å‡ç´šæ±ºç­–æŒ‡å—ï¼ˆå®Œæ•´ç‰ˆï¼‰

#### æ±ºç­–æµç¨‹åœ–

```
é–‹å§‹ï¼šè©•ä¼°ç•¶å‰ç‹€æ…‹
  â†“
å•é¡Œ 1ï¼šRedis ä½¿ç”¨ç‡æ˜¯å¦ > 70%ï¼Ÿ
  â”œâ”€ å¦ â†’ ç¹¼çºŒå…è²»ç‰ˆ
  â””â”€ æ˜¯ â†’ å•é¡Œ 2
         â†“
      å•é¡Œ 2ï¼šBot æµé‡æ˜¯å¦ > 50%ï¼Ÿ
         â”œâ”€ æ˜¯ â†’ å¯¦ä½œ Bot Detectionï¼ˆ1 é€±å…§ï¼‰â†’ é‡æ–°è©•ä¼°
         â””â”€ å¦ â†’ å•é¡Œ 3
                â†“
             å•é¡Œ 3ï¼šçœŸå¯¦ MAU æ˜¯å¦ > 1,500ï¼Ÿ
                â”œâ”€ å¦ â†’ å„ªåŒ– Rate Limit ç­–ç•¥ â†’ ç¹¼çºŒå…è²»ç‰ˆ
                â””â”€ æ˜¯ â†’ å•é¡Œ 4
                       â†“
                    å•é¡Œ 4ï¼šæ˜¯å¦æœ‰ç‡Ÿæ”¶æ”¯æŒï¼Ÿ
                       â”œâ”€ å¦ â†’ è€ƒæ…®é™ä½åŠŸèƒ½ or å°‹æ‰¾è´ŠåŠ©
                       â””â”€ æ˜¯ â†’ å‡ç´šè·¯å¾‘é¸æ“‡
                              â†“
                           å•é¡Œ 5ï¼šMAU ç¯„åœï¼Ÿ
                              â”œâ”€ 1,500-10,000 â†’ å‡ç´š Upstash Pro ($10/æœˆ)
                              â”œâ”€ 10,000-50,000 â†’ å‡ç´š Upstash + Supabase Pro ($35/æœˆ)
                              â””â”€ > 50,000 â†’ å®Œæ•´æ¶æ§‹å‡ç´š ($100+/æœˆ)
```

#### å„éšæ®µè©³ç´°åˆ†æ

##### éšæ®µ 0ï¼šå…è²»ç‰ˆï¼ˆ< 1,000 çœŸå¯¦ MAUï¼‰

**æˆæœ¬**ï¼š$0/æœˆ

**é™åˆ¶**ï¼š
- Supabaseï¼š500 MB è³‡æ–™åº«ã€50,000 MAU
- Upstash Redisï¼š10,000 å‘½ä»¤/å¤©
- Vercelï¼š100 GB æµé‡/æœˆã€100 å°æ™‚åŸ·è¡Œæ™‚é–“

**é©ç”¨å ´æ™¯**ï¼š
- Bot æµé‡å·²éæ¿¾ 70%+
- çœŸå¯¦ç”¨æˆ¶ < 1,000 MAU
- Redis ä½¿ç”¨ç‡ < 70%

**è§¸ç™¼å‡ç´šæ¢ä»¶**ï¼ˆä»»ä¸€é”æˆå³å‡ç´šï¼‰ï¼š
- âŒ Redis ä½¿ç”¨ç‡é€£çºŒ 3 å¤© > 80%
- âŒ çœŸå¯¦ MAU é€£çºŒ 2 é€± > 1,500
- âŒ Vercel æµé‡ > 90 GB/æœˆ
- âŒ Bot Detection ç„¡æ³•æœ‰æ•ˆé™ä½æµé‡

**å„ªåŒ–å»ºè­°**ï¼š
```typescript
// æŒçºŒå„ªåŒ–å…è²»ç‰ˆé…é¡
const optimizations = {
  botDetection: '70-80% Bot éæ¿¾',
  ipQuotaCleanup: '30 å¤©æ¸…ç†ç­–ç•¥',
  cooldownPeriod: '2 åˆ†é˜ï¼ˆå„ªåŒ–å¾Œï¼‰',
  degradationThreshold: '70%ï¼ˆææ—©è§¸ç™¼ï¼‰',
  emergencyMode: 'ç’°å¢ƒè®Šæ•¸æ§åˆ¶'
}
```

---

##### éšæ®µ 1ï¼šUpstash Proï¼ˆ1,000-15,000 MAUï¼‰

**æˆæœ¬**ï¼š$10/æœˆ

**å‡ç´šå…§å®¹**ï¼š
- âœ… Upstash Redis Proï¼š100 è¬å‘½ä»¤/å¤©ï¼ˆ100x æå‡ï¼‰
- âœ… 10 GB å„²å­˜ç©ºé–“
- âœ… æ›´å¿«çš„å›æ‡‰æ™‚é–“ï¼ˆ< 1msï¼‰
- â¸ï¸ Supabase ä»ä½¿ç”¨å…è²»ç‰ˆï¼ˆè³‡æ–™åº«ç©ºé–“å……è¶³ï¼‰
- â¸ï¸ Vercel ä»ä½¿ç”¨å…è²»ç‰ˆï¼ˆæµé‡å……è¶³ï¼‰

**å®¹é‡è©•ä¼°**ï¼š

| æŒ‡æ¨™ | å…è²»ç‰ˆé™åˆ¶ | Pro ç‰ˆé™åˆ¶ | å¯æ”¯æ´ MAU |
|------|----------|-----------|-----------|
| Redis å‘½ä»¤ | 10,000/å¤© | 1,000,000/å¤© | 15,000 MAU |
| è³‡æ–™åº«ç©ºé–“ | 500 MB | 500 MB | 10,000 MAU |
| Vercel æµé‡ | 100 GB/æœˆ | 100 GB/æœˆ | 10,000 MAU |

**ç“¶é ¸**ï¼šVercel æµé‡ï¼ˆ69 GB/æœˆ at 1,600 MAU â†’ 100 GB at ~2,300 MAUï¼‰

**è§¸ç™¼å‡ç´šæ¢ä»¶**ï¼š
```typescript
const shouldUpgradeToUpstashPro = {
  redis: redisUsage > 7000 && botFiltered && trueMau > 1500,
  vercel: vercelTraffic > 80_000_000_000, // 80 GB/æœˆ
  users: trueMau > 10_000,
  cost: hasRevenue || hasSponsors
}

if (Object.values(shouldUpgradeToUpstashPro).filter(Boolean).length >= 2) {
  return 'å»ºè­°å‡ç´š Upstash Pro'
}
```

**é æœŸæ•ˆæœ**ï¼š
- Redis ä½¿ç”¨ç‡ï¼š80% â†’ 0.8%ï¼ˆ10,668 / 1,000,000ï¼‰
- å¯æ”¯æ´ MAUï¼š1,500 â†’ 15,000ï¼ˆ10x æˆé•·ç©ºé–“ï¼‰
- æˆæœ¬æ•ˆç›Šï¼š$0.67/1000 MAUï¼ˆæ¥µå…·ç«¶çˆ­åŠ›ï¼‰

---

##### éšæ®µ 2ï¼šUpstash + Supabase Proï¼ˆ10,000-50,000 MAUï¼‰

**æˆæœ¬**ï¼š$35/æœˆï¼ˆUpstash $10 + Supabase $25ï¼‰

**å‡ç´šå…§å®¹**ï¼š
- âœ… Supabase Proï¼š8 GB è³‡æ–™åº«ã€500,000 MAU
- âœ… è®€å‰¯æœ¬ï¼ˆRead Replicasï¼‰æ”¯æ´
- âœ… è‡ªå‹•å‚™ä»½ 7 å¤©
- âœ… å„ªå…ˆæ”¯æ´
- âœ… Upstash Pro æŒçºŒä½¿ç”¨

**å®¹é‡è©•ä¼°**ï¼š

| æŒ‡æ¨™ | éšæ®µ 1 é™åˆ¶ | éšæ®µ 2 é™åˆ¶ | å¯æ”¯æ´ MAU |
|------|-----------|-----------|-----------|
| Redis å‘½ä»¤ | 1,000,000/å¤© | 1,000,000/å¤© | 150,000 MAU |
| è³‡æ–™åº«ç©ºé–“ | 500 MB | 8 GB | 100,000 MAU |
| è³‡æ–™åº« MAU | 50,000 | 500,000 | 500,000 MAU |

**ç“¶é ¸**ï¼šVercel æµé‡ + è³‡æ–™åº«é€£æ¥æ•¸

**è§¸ç™¼å‡ç´šæ¢ä»¶**ï¼š
- âŒ è³‡æ–™åº«ç©ºé–“ > 400 MBï¼ˆ80% å…è²»ç‰ˆï¼‰
- âŒ çœŸå¯¦ MAU > 30,000
- âŒ è³‡æ–™åº«æŸ¥è©¢å»¶é² > 500msï¼ˆéœ€è¦è®€å‰¯æœ¬ï¼‰
- âŒ æ¯æœˆæ”¶å…¥ > $100ï¼ˆè¶³ä»¥æ”¯æŒæˆæœ¬ï¼‰

**æ¶æ§‹å„ªåŒ–**ï¼š

```typescript
// è®€å¯«åˆ†é›¢é…ç½®
const dbConfig = {
  write: process.env.DATABASE_URL,          // Primary
  read: process.env.DATABASE_READ_REPLICA_URL // Replica
}

// æŸ¥è©¢è·¯ç”±
function getDatabase(operation: 'read' | 'write') {
  if (operation === 'write') {
    return supabase(dbConfig.write)
  }
  // 80% æŸ¥è©¢ä½¿ç”¨è®€å‰¯æœ¬
  return supabase(dbConfig.read)
}
```

**é æœŸæ•ˆæœ**ï¼š
- è³‡æ–™åº«å®¹é‡ï¼š500 MB â†’ 8 GBï¼ˆ16xï¼‰
- æŸ¥è©¢æ•ˆèƒ½ï¼š+50%ï¼ˆè®€å‰¯æœ¬åˆ†æµï¼‰
- MAU ä¸Šé™ï¼š15,000 â†’ 50,000

---

##### éšæ®µ 3ï¼šVercel Proï¼ˆ50,000-100,000 MAUï¼‰

**æˆæœ¬**ï¼š$55/æœˆï¼ˆUpstash $10 + Supabase $25 + Vercel $20ï¼‰

**å‡ç´šå…§å®¹**ï¼š
- âœ… Vercel Proï¼š1 TB æµé‡/æœˆï¼ˆ10xï¼‰
- âœ… 400 å°æ™‚åŸ·è¡Œæ™‚é–“/æœˆ
- âœ… ç„¡é™ Cron Jobs
- âœ… åˆ†æåŠŸèƒ½ï¼ˆAnalyticsï¼‰

**è§¸ç™¼å‡ç´šæ¢ä»¶**ï¼š
- âŒ Vercel æµé‡ > 90 GB/æœˆï¼ˆé€£çºŒ 2 å€‹æœˆï¼‰
- âŒ Cron Jobs > 1 å€‹ï¼ˆå…è²»ç‰ˆé™åˆ¶ï¼‰
- âŒ éœ€è¦è©³ç´°åˆ†ææ•¸æ“š

**é æœŸæ•ˆæœ**ï¼š
- æµé‡ä¸Šé™ï¼š100 GB â†’ 1 TBï¼ˆ10xï¼‰
- å¯æ”¯æ´ MAUï¼š50,000 â†’ 100,000
- åˆ†æèƒ½åŠ›ï¼šâœ… å¯¦æ™‚æµé‡ã€ç”¨æˆ¶è¡Œç‚ºã€æ•ˆèƒ½ç›£æ§

---

##### éšæ®µ 4ï¼šå®Œæ•´æ¶æ§‹å‡ç´šï¼ˆ> 100,000 MAUï¼‰

**æˆæœ¬**ï¼š$100+/æœˆ

**å‡ç´šå…§å®¹**ï¼š
- âœ… Upstash Enterpriseï¼šç„¡é™å‘½ä»¤ã€å…¨çƒè¤‡è£½
- âœ… Supabase Pro + é¡å¤–è³‡æº
- âœ… Vercel Pro + Edge Config
- âœ… Cloudflare Bot Protection
- âœ… å°ˆç”¨ç›£æ§ï¼ˆDatadog / New Relicï¼‰

**æ¶æ§‹è®Šæ›´**ï¼š

```
ç•¶å‰æ¶æ§‹ï¼ˆServerlessï¼‰
  â†’ æ··åˆæ¶æ§‹
     â”œâ”€ Vercel Edge Functionsï¼ˆå…¬é–‹ APIï¼‰
     â”œâ”€ å°ˆç”¨ä¼ºæœå™¨ï¼ˆèªè­‰ APIï¼Œé™ä½æˆæœ¬ï¼‰
     â”œâ”€ CDNï¼ˆCloudflareï¼ŒBot é˜²è­· + å¿«å–ï¼‰
     â””â”€ è³‡æ–™åº«åˆ†ç‰‡ï¼ˆå¤š Supabase å¯¦ä¾‹ï¼‰
```

---

#### å‡ç´šæ™‚æ©Ÿæ±ºç­–è¡¨

| æŒ‡æ¨™ | å…è²»ç‰ˆä¸Šé™ | è­¦å‘Šé–¾å€¼ | å»ºè­°è¡Œå‹• | å‡ç´šç›®æ¨™ |
|------|----------|---------|---------|---------|
| **Redis å‘½ä»¤/å¤©** | 10,000 | > 7,000 | Bot Detection | Upstash Pro |
| **çœŸå¯¦ MAU** | ~1,000 | > 1,500 | è©•ä¼°å‡ç´š | Upstash Pro |
| **è³‡æ–™åº«ç©ºé–“** | 500 MB | > 400 MB | æª¢æŸ¥æ¸…ç† | Supabase Pro |
| **Vercel æµé‡** | 100 GB/æœˆ | > 80 GB/æœˆ | å„ªåŒ–å¿«å– | Vercel Pro |
| **æŸ¥è©¢å»¶é²** | < 200ms | > 500ms | è®€å‰¯æœ¬ | Supabase Pro |
| **Bot æµé‡%** | < 30% | > 60% | Bot Detection | - |

#### æˆæœ¬æ•ˆç›Šåˆ†æ

| éšæ®µ | æˆæœ¬/æœˆ | å¯æ”¯æ´ MAU | æˆæœ¬/1000 MAU | ROI è©•ä¼° |
|------|--------|-----------|--------------|---------|
| å…è²»ç‰ˆ | $0 | 1,000 | $0 | âœ… ç†æƒ³ï¼ˆæ—©æœŸï¼‰ |
| Upstash Pro | $10 | 15,000 | $0.67 | âœ… æ¥µä½³ |
| +Supabase Pro | $35 | 50,000 | $0.70 | âœ… è‰¯å¥½ |
| +Vercel Pro | $55 | 100,000 | $0.55 | âœ… å„ªç§€ |
| å®Œæ•´å‡ç´š | $100+ | 500,000+ | $0.20 | âœ… è¦æ¨¡ç¶“æ¿Ÿ |

**é—œéµæ´å¯Ÿ**ï¼š
- ğŸ’¡ **Upstash Pro æ˜¯æœ€å…· CP å€¼çš„é¦–æ¬¡å‡ç´š**ï¼ˆ100x å®¹é‡åƒ… $10ï¼‰
- ğŸ’¡ **Supabase å…è²»ç‰ˆå¯æ”¯æ’åˆ° 10,000 MAU**ï¼ˆç©ºé–“å……è¶³ï¼‰
- ğŸ’¡ **Vercel æµé‡å¯èƒ½åœ¨ 2,300 MAU æ™‚æˆç‚ºç“¶é ¸**ï¼ˆéœ€å„ªåŒ–æˆ–å‡ç´šï¼‰
- ğŸ’¡ **æˆæœ¬/1000 MAU éš¨è¦æ¨¡é™ä½**ï¼ˆ$0.67 â†’ $0.20ï¼Œè¦æ¨¡ç¶“æ¿Ÿï¼‰

#### é™ç´šç­–ç•¥ï¼ˆæˆæœ¬æ§åˆ¶ï¼‰

ç•¶æµé‡ä¸‹é™æˆ–éœ€è¦ç¯€çœæˆæœ¬æ™‚ï¼š

**éšæ®µæ€§é™ç´š**ï¼š

```
éšæ®µ 3 ($55/æœˆ) â†’ éšæ®µ 2 ($35/æœˆ)
  æ¢ä»¶ï¼šVercel æµé‡é€£çºŒ 3 å€‹æœˆ < 80 GB
  è¡Œå‹•ï¼šå–æ¶ˆ Vercel Proï¼Œå„ªåŒ–å¿«å–ç­–ç•¥

éšæ®µ 2 ($35/æœˆ) â†’ éšæ®µ 1 ($10/æœˆ)
  æ¢ä»¶ï¼šMAU é€£çºŒ 3 å€‹æœˆ < 20,000 ä¸”è³‡æ–™åº« < 300 MB
  è¡Œå‹•ï¼šå–æ¶ˆ Supabase Proï¼ŒåŠ å¼·æ¸…ç†ç­–ç•¥

éšæ®µ 1 ($10/æœˆ) â†’ å…è²»ç‰ˆ ($0/æœˆ)
  æ¢ä»¶ï¼šBot éæ¿¾å¾Œ Redis < 6,000/å¤© ä¸” MAU < 800
  è¡Œå‹•ï¼šå–æ¶ˆ Upstash Proï¼Œå•Ÿç”¨æ›´ç©æ¥µçš„é™ç´šæ¨¡å¼
```

**æˆæœ¬æ§åˆ¶å»ºè­°**ï¼š
- ğŸ“Š æ¯æœˆ 1 è™Ÿæª¢æŸ¥ä½¿ç”¨ç‡ï¼Œæ±ºå®šæ˜¯å¦é™ç´š
- ğŸ“Š è¨­å®šä½¿ç”¨ç‡å‘Šè­¦ï¼ˆ80% å‡ç´šã€50% è€ƒæ…®é™ç´šï¼‰
- ğŸ“Š ä¿ç•™ 1 å€‹æœˆé ç®—ç·©è¡ï¼ˆé¿å…é »ç¹å‡é™ç´šï¼‰

---

#### å¯¦éš›æ¡ˆä¾‹ï¼šåŸºæ–¼ç•¶å‰æµé‡çš„æ±ºç­–

**ç•¶å‰ç‹€æ…‹ï¼ˆ2025-10-25ï¼‰**ï¼š
- ç¸½è¨ªå•æ•¸ï¼š1,559/å¤©
- çœŸå¯¦ MAUï¼šä¼°è¨ˆ 1,200-1,600
- Redis ä½¿ç”¨ï¼š10,668 å‘½ä»¤/å¤©ï¼ˆ107% âŒï¼‰
- Bot æµé‡ï¼š60-80%

**æ±ºç­–æµç¨‹**ï¼š

```
1. Redis ä½¿ç”¨ç‡ > 70%ï¼Ÿâœ… æ˜¯ï¼ˆ107%ï¼‰
   â†“
2. Bot æµé‡ > 50%ï¼Ÿâœ… æ˜¯ï¼ˆ60-80%ï¼‰
   â†“
3. æ‡‰å°æ–¹æ¡ˆï¼šå¯¦ä½œ Bot Detectionï¼ˆ**å„ªå…ˆ**ï¼‰
   é æœŸæ•ˆæœï¼š
   - Bot éæ¿¾ 70%
   - Redis é™è‡³ 6,000/å¤©ï¼ˆ60% ä½¿ç”¨ç‡ï¼‰
   - ç¹¼çºŒä½¿ç”¨å…è²»ç‰ˆ âœ…
   â†“
4. å¦‚æœ Bot Detection ç„¡æ•ˆ æˆ– çœŸå¯¦ MAU > 1,500
   â†“
5. å‡ç´š Upstash Proï¼ˆ$10/æœˆï¼‰
   - Redis å®¹é‡ï¼š10,000 â†’ 1,000,000 å‘½ä»¤/å¤©
   - å¯æ”¯æ´ 15,000 MAU
   - æˆæœ¬æ•ˆç›Šï¼š$0.67/1000 MAU
```

**å»ºè­°æ™‚ç¨‹**ï¼š

| æ™‚é–“é» | è¡Œå‹• | é æœŸçµæœ |
|-------|------|---------|
| **Week 1** | å¯¦ä½œ User-Agent æª¢æ¸¬ï¼ˆå…¨ç«¯é»ï¼‰ | Bot â†“ 60-70%ï¼ŒRedis 6,000-7,000/å¤© |
| **Week 2-4** | å¯¦ä½œè¡Œç‚ºæª¢æ¸¬ + ç›£æ§èª¿æ•´ | Bot â†“ 70-80%ï¼ŒRedis 4,800-6,000/å¤© |
| **Month 2** | è©•ä¼°å‡ç´šéœ€æ±‚ | è‹¥çœŸå¯¦ MAU > 1,500ï¼Œå‡ç´š Upstash Pro |
| **Month 3+** | æŒçºŒå„ªåŒ– + è¦åŠƒæˆé•· | è¿½è¹¤æŒ‡æ¨™ï¼Œæå‰è¦åŠƒå‡ç´š |

---

#### å‡ç´šæª¢æŸ¥æ¸…å–®

**å‡ç´š Upstash Pro å‰æª¢æŸ¥**ï¼š
- [ ] Bot Detection å·²å¯¦ä½œä¸”ç„¡æ•ˆï¼ˆBot ä» > 50%ï¼‰
- [ ] çœŸå¯¦ MAU é€£çºŒ 2 é€± > 1,500
- [ ] Redis ä½¿ç”¨ç‡é€£çºŒ 3 å¤© > 80%
- [ ] æœ‰ç‡Ÿæ”¶æˆ–è´ŠåŠ©æ”¯æŒ $10/æœˆæˆæœ¬
- [ ] é æœŸ 6 å€‹æœˆå…§ MAU æˆé•· > 30%

**å‡ç´š Supabase Pro å‰æª¢æŸ¥**ï¼š
- [ ] è³‡æ–™åº«ç©ºé–“ > 400 MBï¼ˆ80% å…è²»ç‰ˆï¼‰
- [ ] MAU > 30,000 æˆ–é æœŸ 3 å€‹æœˆå…§é”æˆ
- [ ] æŸ¥è©¢å»¶é² > 500msï¼ˆéœ€è®€å‰¯æœ¬ï¼‰
- [ ] æ¯æœˆæ”¶å…¥ > $100ï¼ˆè¶³ä»¥æ”¯æŒ $35/æœˆï¼‰

**å‡ç´š Vercel Pro å‰æª¢æŸ¥**ï¼š
- [ ] æµé‡ > 80 GB/æœˆä¸”æŒçºŒæˆé•·
- [ ] éœ€è¦ > 1 å€‹ Cron Job
- [ ] éœ€è¦è©³ç´°åˆ†ææ•¸æ“š
- [ ] æ¯æœˆæ”¶å…¥ > $150ï¼ˆè¶³ä»¥æ”¯æŒ $55/æœˆï¼‰

---

## å¯¦ä½œè·¯ç·šåœ–

### éšæ®µ 1ï¼šåŸºç¤è¨­æ–½ï¼ˆ2-3 å¤©ï¼‰

- [ ] å»ºç«‹ Supabase å°ˆæ¡ˆä¸¦é…ç½®ç’°å¢ƒè®Šæ•¸
- [ ] åŸ·è¡Œè³‡æ–™åº« Schemaï¼ˆ5 å¼µè¡¨ï¼šaccess_tokens, listings, interests, reports, user_quotasï¼‰
- [ ] å»ºç«‹è³‡æ–™åº«å‡½æ•¸ï¼ˆæ¸…ç†å‡½æ•¸ + é…é¡ RPC å‡½æ•¸ï¼‰
- [ ] è¨­å®š RLS ç­–ç•¥ï¼ˆåŒ…å«æ–°å¢çš„ reports å’Œ user_quotas è¡¨ï¼‰
- [ ] å»ºç«‹ Upstash Redis å¯¦ä¾‹
- [ ] è¨­å®š Vercel å°ˆæ¡ˆ

**ç”¢å‡º**ï¼šå®Œæ•´çš„è³‡æ–™åº« Schema + ç’°å¢ƒé…ç½® + é…é¡ç³»çµ±

---

### éšæ®µ 2ï¼šæ ¸å¿ƒ APIï¼ˆ3-4 å¤©ï¼‰

- [ ] å¯¦ä½œèªè­‰ç³»çµ±ï¼ˆToken ç”Ÿæˆã€é©—è­‰ã€æŒ‡ç´‹ï¼‰
- [ ] å¯¦ä½œ Rate Limiting ä¸­é–“ä»¶ï¼ˆå›ºå®šçª—å£ç®—æ³•ï¼‰
- [ ] å¯¦ä½œé…é¡æª¢æŸ¥ä¸­é–“ä»¶ï¼ˆquota-check.tsï¼‰
- [ ] å¯¦ä½œé…é¡æœå‹™ï¼ˆquota-service.tsï¼‰
- [ ] å¯¦ä½œè¯çµ¡æ–¹å¼æœå‹™ï¼ˆcontact-service.tsï¼‰
- [ ] å¯¦ä½œåˆŠç™»ç®¡ç† APIï¼ˆå»ºç«‹ã€æ›´æ–°ã€é—œé–‰ã€æ¨™è¨˜å®Œæˆã€æŸ¥è©¢ï¼‰
- [ ] å¯¦ä½œå¸‚å ´ APIï¼ˆåˆ—è¡¨ã€æœå°‹ã€åˆ†é ï¼‰
- [ ] å¯¦ä½œæ„å‘ APIï¼ˆç™»è¨˜ã€æ›´æ–°ç‹€æ…‹ã€æ’¤éŠ·ã€æŸ¥è©¢ï¼‰
- [ ] å¯¦ä½œè¯çµ¡æ–¹å¼ APIï¼ˆæ¬Šé™é©—è­‰ + å­˜å–æ—¥èªŒï¼‰
- [ ] å¯¦ä½œèˆ‰å ± APIï¼ˆå»ºç«‹èˆ‰å ±ï¼‰

**ç”¢å‡º**ï¼šå®Œæ•´çš„ API ç«¯é» + ä¸­é–“ä»¶ç³»çµ± + å®‰å…¨æ©Ÿåˆ¶ï¼ˆé…é¡ã€æ¬Šé™æ§åˆ¶ï¼‰

---

### éšæ®µ 3ï¼šå‰ç«¯ä»‹é¢ï¼ˆ3-4 å¤©ï¼‰

- [ ] å¯¦ä½œèªè­‰ Context å’Œç™»å…¥è¡¨å–®
- [ ] å¯¦ä½œå¸‚å ´åˆ—è¡¨çµ„ä»¶ï¼ˆåˆ†é ã€ç¯©é¸ã€ç†±é–€æ’åºï¼‰
- [ ] å¯¦ä½œæˆ‘çš„åˆŠç™»çµ„ä»¶ï¼ˆå»ºç«‹è¡¨å–®ã€ç‹€æ…‹ç®¡ç†ã€æ¨™è¨˜å®Œæˆï¼‰
- [ ] å¯¦ä½œæ„å‘ç®¡ç†çµ„ä»¶ï¼ˆç™»è¨˜ã€æ›´æ–°ç‹€æ…‹ã€æ’¤éŠ·ï¼‰
- [ ] å¯¦ä½œè¯çµ¡æ–¹å¼æŸ¥çœ‹çµ„ä»¶ï¼ˆæ¬Šé™æª¢æŸ¥ã€é¡¯ç¤ºè¯çµ¡è³‡è¨Šï¼‰
- [ ] å¯¦ä½œèˆ‰å ±å½ˆçª—ï¼ˆReportModal.tsxï¼‰
- [ ] å¯¦ä½œé…é¡é¡¯ç¤ºï¼ˆå‰©é¤˜åˆŠç™»æ•¸ã€å‰©é¤˜æ„å‘æ•¸ï¼‰
- [ ] UI/UX å„ªåŒ–ï¼ˆè¼‰å…¥ç‹€æ…‹ã€éŒ¯èª¤è™•ç†ã€é…é¡è­¦å‘Šï¼‰

**ç”¢å‡º**ï¼šå®Œæ•´çš„å‰ç«¯ä»‹é¢ + å®‰å…¨æ©Ÿåˆ¶ UIï¼ˆèˆ‰å ±ã€é…é¡é¡¯ç¤ºï¼‰

---

### éšæ®µ 4ï¼šæ¸¬è©¦èˆ‡å„ªåŒ–ï¼ˆ2-3 å¤©ï¼‰

- [ ] æ’°å¯«å–®å…ƒæ¸¬è©¦ï¼ˆæ ¸å¿ƒé‚è¼¯è¦†è“‹ > 70%ï¼‰
  - é…é¡æª¢æŸ¥é‚è¼¯
  - è¯çµ¡æ–¹å¼æ¬Šé™é©—è­‰
  - RPC å‡½æ•¸æ¸¬è©¦
- [ ] åŸ·è¡Œæ•´åˆæ¸¬è©¦
  - æ„å‘ç™»è¨˜æµç¨‹ï¼ˆå”¯ä¸€ç´„æŸã€é…é¡é™åˆ¶ï¼‰
  - è¯çµ¡æ–¹å¼å­˜å–ï¼ˆæ¬Šé™æª¢æŸ¥ã€æ—¥èªŒè¨˜éŒ„ï¼‰
  - èˆ‰å ±æµç¨‹
  - é…é¡æ›´æ–°ï¼ˆRPC å‡½æ•¸åŸå­æ€§ï¼‰
- [ ] åŸ·è¡Œå®‰å…¨æ¸¬è©¦
  - è©¦åœ–ç¹éé…é¡é™åˆ¶
  - è©¦åœ–æœªç™»è¨˜æ„å‘æŸ¥çœ‹è¯çµ¡æ–¹å¼
  - è©¦åœ–è¶…é Rate Limit
- [ ] åŸ·è¡Œå£“åŠ›æ¸¬è©¦ï¼ˆ1000 ä¸¦ç™¼ç”¨æˆ¶ï¼‰
- [ ] è³‡æ–™åº«æŸ¥è©¢å„ªåŒ–ï¼ˆEXPLAIN ANALYZEï¼‰
- [ ] è¨­å®šç›£æ§èˆ‡å‘Šè­¦ï¼ˆåŒ…å«é…é¡é•è¦ã€è¯çµ¡æ–¹å¼ç•°å¸¸å­˜å–ï¼‰

**ç”¢å‡º**ï¼šæ¸¬è©¦å ±å‘Š + æ•ˆèƒ½å„ªåŒ– + å®‰å…¨é©—è­‰å ±å‘Š

---

### éšæ®µ 5ï¼šéƒ¨ç½²èˆ‡ç›£æ§ï¼ˆ1 å¤©ï¼‰

- [ ] è¨­å®š Vercel Cron Jobï¼ˆæ¸…ç†ä»»å‹™ï¼‰
- [ ] é…ç½®ç”Ÿç”¢ç’°å¢ƒè®Šæ•¸
- [ ] éƒ¨ç½²åˆ° Vercel Production
- [ ] è¨­å®šç›£æ§å„€è¡¨æ¿
- [ ] åŸ·è¡Œç…™éœ§æ¸¬è©¦ï¼ˆSmoke Testï¼‰

**ç”¢å‡º**ï¼šç”Ÿç”¢ç’°å¢ƒç³»çµ± + ç›£æ§

---

**ç¸½è¨ˆæ™‚é–“**ï¼š9-14 å¤©

**æ™‚é–“åˆ†é…èªªæ˜**ï¼š
- v3.0 åˆç‰ˆï¼ˆç„¡å®‰å…¨æ©Ÿåˆ¶ï¼‰ï¼š6-9 å¤©
- v3.1 åŠ å¼·ç‰ˆï¼ˆå«å®‰å…¨æ©Ÿåˆ¶ï¼‰ï¼š9-14 å¤©
- å¢åŠ æ™‚é–“ä¸»è¦ç”¨æ–¼ï¼šé…é¡ç³»çµ±ï¼ˆ+1å¤©ï¼‰ã€è¯çµ¡æ–¹å¼ä¿è­·ï¼ˆ+1å¤©ï¼‰ã€èˆ‰å ±åŠŸèƒ½ï¼ˆ+1å¤©ï¼‰ã€å®‰å…¨æ¸¬è©¦ï¼ˆ+1å¤©ï¼‰

**èˆ‡äº¤æ˜“ç³»çµ±å°æ¯”**ï¼š
- äº¤æ˜“ç³»çµ±ï¼ˆv2.0ï¼‰ï¼š11-15 å¤©
- æ„å‘ç™»è¨˜ç³»çµ±ï¼ˆv3.1 åŠ å¼·ç‰ˆï¼‰ï¼š9-14 å¤©
- **ä»æ¸›å°‘ç´„ 20% é–‹ç™¼æ™‚é–“**ï¼ˆå› ç„¡éœ€ä¸¦ç™¼æ§åˆ¶å’Œäº¤æ˜“åŸå­æ€§ï¼‰

---

## è¨­è¨ˆæ±ºç­–è¨˜éŒ„

### ADR-001: é¸æ“‡ Supabase ä½œç‚ºè³‡æ–™åº«

**æ—¥æœŸ**ï¼š2025-10-25
**ç‹€æ…‹**ï¼šå·²æ¥å—

**èƒŒæ™¯**ï¼š
éœ€è¦ä¸€å€‹æ”¯æ´å…è²»é¡åº¦ã€RLSã€Real-timeï¼ˆå¯é¸ï¼‰çš„ PostgreSQL æœå‹™ã€‚

**æ±ºç­–**ï¼š
é¸æ“‡ Supabase è€Œé PlanetScaleã€Neonã€Railwayã€‚

**ç†ç”±**ï¼š
- âœ… å…è²»é¡åº¦æœ€å……è¶³ï¼ˆ500 MB è³‡æ–™åº« + 50K MAUï¼‰
- âœ… å…§å»º RLSï¼Œå®‰å…¨æ€§é«˜
- âœ… æä¾› Real-time subscriptionsï¼ˆæœªä¾†å¯ç”¨ï¼‰
- âœ… è‡ªå‹•å‚™ä»½å’Œæ¢å¾©
- âœ… å„ªç§€çš„ TypeScript æ”¯æ´

**å¾Œæœ**ï¼š
- éœ€è¦å­¸ç¿’ Supabase API
- ç¶å®š Supabase ç”Ÿæ…‹ç³»çµ±

---

### ADR-002: ä½¿ç”¨ Token è€Œéå‚³çµ±ç™»å…¥

**æ—¥æœŸ**ï¼š2025-10-25
**ç‹€æ…‹**ï¼šå·²æ¥å—

**èƒŒæ™¯**ï¼š
ç›®æ¨™æ˜¯ã€Œé›¶æ‘©æ“¦é€²å…¥ã€ï¼Œé¿å…å‚³çµ±çš„è¨»å†Š/ç™»å…¥æµç¨‹ã€‚

**æ±ºç­–**ï¼š
ä½¿ç”¨è§’è‰² ID + éš¨æ©Ÿ Token çš„ç„¡å¯†ç¢¼èªè­‰ã€‚

**ç†ç”±**ï¼š
- âœ… ç¬¦åˆã€Œå®Œå…¨ä¿¡ä»»ã€çš„å°ˆæ¡ˆå®šä½
- âœ… æ¥µä½çš„é€²å…¥é–€æª»
- âœ… é©åˆéŠæˆ²å…§è™›æ“¬ç‰©å“äº¤æ˜“å ´æ™¯

**é¢¨éšªèˆ‡ç·©è§£**ï¼š
- âš ï¸ é¢¨éšªï¼šToken æ´©æ¼ â†’ ç·©è§£ï¼šç¶å®šç€è¦½å™¨æŒ‡ç´‹ã€7 å¤©éæœŸ
- âš ï¸ é¢¨éšªï¼šæ¿«ç”¨ â†’ ç·©è§£ï¼šRate Limitingã€IP è¿½è¹¤

---

### ADR-003: é¸æ“‡ Upstash Redis åš Rate Limiting

**æ—¥æœŸ**ï¼š2025-10-25
**ç‹€æ…‹**ï¼šå·²æ¥å—

**èƒŒæ™¯**ï¼š
éœ€è¦åˆ†æ•£å¼ Rate Limitingï¼ŒEdge Middleware å…§å­˜æ–¹æ¡ˆä¸å¯é ã€‚

**æ±ºç­–**ï¼š
ä½¿ç”¨ Upstash Redisï¼ˆHTTP-basedï¼‰ã€‚

**ç†ç”±**ï¼š
- âœ… å…è²»é¡åº¦å……è¶³ï¼ˆ10K å‘½ä»¤/å¤©ï¼‰
- âœ… HTTP API é©åˆ Edge Functions
- âœ… å…¨çƒåˆ†æ•£å¼ï¼ˆä½å»¶é²ï¼‰
- âœ… ç„¡éœ€ç®¡ç†é€£æ¥æ± 

**æ›¿ä»£æ–¹æ¡ˆ**ï¼š
- âŒ Vercel KVï¼ˆåŒæ¨£æ˜¯ Upstashï¼Œä½†éœ€è¦ä»˜è²»æ–¹æ¡ˆï¼‰
- âŒ Edge Middleware + Mapï¼ˆå¤šå¯¦ä¾‹ç„¡æ³•å…±äº«ç‹€æ…‹ï¼‰

---

### ADR-004: é¸æ“‡æ„å‘ç™»è¨˜æ¨¡å¼è€Œéç³»çµ±å…§äº¤æ˜“

**æ—¥æœŸ**ï¼š2025-10-25
**ç‹€æ…‹**ï¼šå·²æ¥å—

**èƒŒæ™¯**ï¼š
å°ˆæ¡ˆç„¡æ³•å¾éŠæˆ²ä¸­ç²å–å¯¦éš›ç‰©å“è³‡æ–™ï¼Œåªèƒ½è®€å–å°ˆæ¡ˆå…§çš„ç‰©å“ JSON è³‡æ–™ã€‚å¯¦éš›äº¤æ˜“å¿…é ˆåœ¨éŠæˆ²å…§å®Œæˆã€‚

**æ±ºç­–**ï¼š
æ¡ç”¨ã€Œæ„å‘ç™»è¨˜åª’åˆå¹³å°ã€æ¨¡å¼ï¼Œè€Œéã€Œç³»çµ±å…§å®Œæˆäº¤æ˜“ã€æ¨¡å¼ã€‚

**ç†ç”±**ï¼š
- âœ… ç¬¦åˆå¯¦éš›é™åˆ¶ï¼ˆç„¡æ³•åœ¨ç³»çµ±å…§è½‰ç§»ç‰©å“ï¼‰
- âœ… å¤§å¹…ç°¡åŒ–é–‹ç™¼ï¼ˆæ¸›å°‘ 45% é–‹ç™¼æ™‚é–“ï¼š6-9 å¤© vs 11-15 å¤©ï¼‰
- âœ… ç„¡éœ€å¯¦ä½œè¤‡é›œçš„ä¸¦ç™¼æ§åˆ¶å’Œäº¤æ˜“åŸå­æ€§
- âœ… è³‡æ–™åº«è¨­è¨ˆæ›´ç°¡å–®ï¼ˆ3 å¼µè¡¨ vs 5 å¼µè¡¨ï¼‰
- âœ… API ç«¯é»æ›´å°‘ï¼ˆ9 å€‹ vs 12+ å€‹ï¼‰

**æ¶æ§‹å½±éŸ¿**ï¼š
- ç§»é™¤ `trades` è¡¨ï¼Œæ”¹ç”¨ `interests` è¡¨
- ç§»é™¤ `purchase_item()` å­˜å„²éç¨‹å’Œä¸¦ç™¼é–
- ç§»é™¤è³¼è²· APIï¼Œæ”¹ç‚ºæ„å‘ç™»è¨˜ API
- ç°¡åŒ–éŒ¯èª¤è™•ç†ï¼ˆç„¡éœ€è™•ç†ä¸¦ç™¼è¡çªï¼‰

**ç”¨æˆ¶é«”é©—å½±éŸ¿**ï¼š
- è²·å®¶ï¼šé»æ“Šã€Œæƒ³è³¼è²·ã€â†’ æŸ¥çœ‹è³£å®¶è¯çµ¡æ–¹å¼ â†’ è‡ªè¡Œè¯çµ¡ â†’ éŠæˆ²å…§äº¤æ˜“
- è³£å®¶ï¼šæŸ¥çœ‹ã€Œèª°æƒ³è²·ã€åˆ—è¡¨ â†’ ä¸»å‹•è¯çµ¡è²·å®¶ â†’ éŠæˆ²å…§äº¤æ˜“

---

### ADR-005: è¯çµ¡æ–¹å¼ä¿è­·æ©Ÿåˆ¶

**æ—¥æœŸ**ï¼š2025-10-25
**ç‹€æ…‹**ï¼šå·²æ¥å—

**èƒŒæ™¯**ï¼š
v3.0 åˆç‰ˆè¨­è¨ˆä¸­ï¼Œè¯çµ¡æ–¹å¼å®Œå…¨æš´éœ²åœ¨å¸‚å ´åˆ—è¡¨æŸ¥è©¢ä¸­ï¼Œå°è‡´ï¼š
- éš±ç§æ´©æ¼é¢¨éšªï¼ˆDiscord IDã€éŠæˆ²è§’è‰²åå…¬é–‹ï¼‰
- çˆ¬èŸ²å¯è¼•æ˜“æŠ“å–æ‰€æœ‰è¯çµ¡æ–¹å¼
- è²·å®¶å¯èƒ½æœªç™»è¨˜æ„å‘å°±é¨·æ“¾è³£å®¶

**æ±ºç­–**ï¼š
å¯¦ä½œæ‡‰ç”¨å±¤æ¬Šé™æ§åˆ¶ï¼Œåªæœ‰å·²ç™»è¨˜æ„å‘çš„è²·å®¶æ‰èƒ½æŸ¥çœ‹è¯çµ¡æ–¹å¼ã€‚

**å¯¦ä½œç´°ç¯€**ï¼š
1. å¸‚å ´åˆ—è¡¨æŸ¥è©¢è‡ªå‹•éæ¿¾ `contact_method` å’Œ `contact_info` æ¬„ä½
2. æ–°å¢ `GET /api/listings/[id]/contact` APIï¼Œéœ€é©—è­‰æ„å‘ç™»è¨˜
3. è¨˜éŒ„æ‰€æœ‰è¯çµ¡æ–¹å¼å­˜å–æ—¥èªŒï¼Œç›£æ§ç•°å¸¸è¡Œç‚º
4. Rate Limit è¨­ç‚º 10 æ¬¡/å°æ™‚

**æ›¿ä»£æ–¹æ¡ˆ**ï¼š
- âŒ æ–¹æ¡ˆ Aï¼šRLS æ§åˆ¶æ¬„ä½å­˜å–ï¼ˆSupabase RLS ç„¡æ³•é‡å°ç‰¹å®šæ¬„ä½ï¼‰
- âŒ æ–¹æ¡ˆ Bï¼šåŠ å¯†è¯çµ¡æ–¹å¼ï¼ˆè²·å®¶ç„¡æ³•è§£å¯†ï¼‰
- âœ… æ–¹æ¡ˆ Cï¼šæ‡‰ç”¨å±¤éæ¿¾ï¼ˆå®Œå…¨æ§åˆ¶ï¼Œå¯è¨˜éŒ„æ—¥èªŒï¼‰

**é¢¨éšªèˆ‡ç·©è§£**ï¼š
- âš ï¸ é¢¨éšªï¼šæ‡‰ç”¨å±¤éæ¿¾å¯èƒ½è¢«ç¹é â†’ ç·©è§£ï¼šRLS ä½œç‚ºç¬¬äºŒé“é˜²ç·š
- âš ï¸ é¢¨éšªï¼šå¤§é‡ç™»è¨˜æ„å‘é¨·æ“¾ â†’ ç·©è§£ï¼šé…é¡ç³»çµ±é™åˆ¶æ¯æ—¥æ„å‘æ•¸

---

### ADR-006: ç”¨æˆ¶é…é¡ç³»çµ±

**æ—¥æœŸ**ï¼š2025-10-25
**ç‹€æ…‹**ï¼šå·²æ¥å—

**èƒŒæ™¯**ï¼š
v3.0 åˆç‰ˆè¨­è¨ˆç„¡é™åˆ¶åˆŠç™»å’Œæ„å‘ç™»è¨˜ï¼Œå°è‡´ï¼š
- å–®ä¸€ç”¨æˆ¶å¯å»ºç«‹ 1000+ ç­†åƒåœ¾åˆŠç™»
- æƒ¡æ„ç”¨æˆ¶å¯å°æ‰€æœ‰åˆŠç™»ç™»è¨˜æ„å‘é¨·æ“¾è³£å®¶
- ç„¡æ³•è¿½è¹¤ç”¨æˆ¶è¡Œç‚ºæ¨¡å¼

**æ±ºç­–**ï¼š
å¯¦ä½œè³‡æ–™åº«é…é¡è¡¨ï¼Œè¿½è¹¤ä¸¦é™åˆ¶ç”¨æˆ¶è¡Œç‚ºã€‚

**é…é¡é™åˆ¶**ï¼š
- æ¯äººæœ€å¤š 50 ç­†æœ‰æ•ˆåˆŠç™»
- æ¯äººæœ€å¤š 100 ç­†ç¸½æ„å‘
- æ¯å¤©æœ€å¤š 20 ç­†æ–°æ„å‘

**å¯¦ä½œç´°ç¯€**ï¼š
1. æ–°å¢ `user_quotas` è¡¨ï¼Œä½¿ç”¨ CHECK ç´„æŸå¼·åˆ¶åŸ·è¡Œ
2. API å±¤æª¢æŸ¥é…é¡ï¼Œè¶…éå‰‡è¿”å› `QuotaExceededError`
3. ä½¿ç”¨ RPC å‡½æ•¸åŸå­æ€§æ›´æ–°é…é¡ï¼ˆé¿å…ç«¶æ…‹æ¢ä»¶ï¼‰
4. Cron Job æ¯å¤©é‡ç½® `interests_today`

**ç†ç”±**ï¼š
- âœ… è³‡æ–™åº«å±¤å¼·åˆ¶åŸ·è¡Œï¼ˆç„¡æ³•ç¹éï¼‰
- âœ… è¿½è¹¤ç”¨æˆ¶è¡Œç‚ºï¼ˆåˆ†ææ¿«ç”¨æ¨¡å¼ï¼‰
- âœ… éˆæ´»èª¿æ•´é™åˆ¶ï¼ˆä¿®æ”¹ CHECK ç´„æŸï¼‰
- âœ… ç›£æ§é…é¡é•è¦ï¼ˆè¨­å®šå‘Šè­¦ï¼‰

**æ›¿ä»£æ–¹æ¡ˆ**ï¼š
- âŒ æ–¹æ¡ˆ Aï¼šåƒ…æ‡‰ç”¨å±¤æª¢æŸ¥ï¼ˆå¯è¢«ç¹éï¼‰
- âŒ æ–¹æ¡ˆ Bï¼šåƒ… Rate Limitingï¼ˆçŸ­æœŸé™åˆ¶ï¼Œç„¡æ³•é˜²æ­¢é•·æœŸç´¯ç©ï¼‰
- âœ… æ–¹æ¡ˆ Cï¼šé…é¡è¡¨ + Rate Limitingï¼ˆé›™é‡ä¿è­·ï¼‰

**å¾Œæœ**ï¼š
- å¢åŠ é–‹ç™¼è¤‡é›œåº¦ï¼ˆéœ€ç¶­è­·é…é¡è¡¨å’Œ RPC å‡½æ•¸ï¼‰
- å¢åŠ è³‡æ–™åº«æŸ¥è©¢ï¼ˆæ¯æ¬¡åˆŠç™»/æ„å‘éœ€æŸ¥è©¢é…é¡ï¼‰
- ä½†å¤§å¹…é™ä½æ¿«ç”¨é¢¨éšªï¼Œå€¼å¾—æŠ•è³‡

---

## é™„éŒ„

### A. ç’°å¢ƒè®Šæ•¸ç¯„ä¾‹

```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOi...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOi...

# Upstash Redis
UPSTASH_REDIS_REST_URL=https://xxx.upstash.io
UPSTASH_REDIS_REST_TOKEN=AXX...

# Vercel Cron Secret
CRON_SECRET=your-random-secret-here
```

---

### B. åƒè€ƒè³‡æº

- [Supabase æ–‡æª”](https://supabase.com/docs)
- [Next.js App Router](https://nextjs.org/docs/app)
- [Upstash Redis](https://docs.upstash.com/redis)
- [Vercel Cron Jobs](https://vercel.com/docs/cron-jobs)
- [PostgreSQL Row Level Security](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)

---

**æ–‡æª”ç‰ˆæœ¬**: v2.0
**æœ€å¾Œæ›´æ–°**: 2025-10-25
**ä¸‹æ¬¡å¯©æŸ¥**: 2025-11-25ï¼ˆæˆ–æ¶æ§‹è®Šæ›´æ™‚ï¼‰
