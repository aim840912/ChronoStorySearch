# Discord 登入物品意向登記系統架構設計

> **專案需求**：Discord 認證、中型規模（1200-1600 MAU）、純資訊媒合、免費額度
>
> **最後更新**：2025-10-26 | **版本**：v4.0（Discord 完整版）
>
> ⚠️ **重要**：本文件為完整版設計，包含 Discord OAuth 2.0、Webhook 通知、Bot 整合、信譽系統

---

## 📚 導航

[🏠 返回目錄](./README.md) | [下一篇：認證與資料庫 →](./02-認證與資料庫.md)

---

## 目錄

1. [系統概述](#系統概述)
2. [系統架構](#系統架構)

---

## 系統概述

### 業務目標

建立一個**基於 Discord 認證**的虛擬物品意向媒合平台，允許用戶：
- 使用 Discord 帳號登入並綁定身份
- 發布物品販售資訊（含價格和聯絡方式）
- 瀏覽市場並登記購買意向
- 透過 Discord Webhook 接收購買意向通知
- 透過平台外聯絡方式完成實際交易（遊戲內交易）

### 核心特性

- **Discord 登入**：使用 Discord OAuth 2.0 認證，確保真實身份
- **真實身份驗證**：每個用戶綁定唯一 Discord ID，防止多帳號濫用
- **信譽系統**：基於 Discord 帳號年齡和伺服器成員身份評分（0-100 分）
- **即時通知**：購買意向自動發送到賣家的 Discord 頻道（Webhook）
- **Bot 整合**：Discord Bot 提供指令查詢刊登、綁定角色、查看統計
- **資訊媒合平台**：系統僅負責配對買賣雙方，交易在遊戲內完成
- **簡化流程**：賣家發布物品→買家登記意向→自動 Webhook 通知→遊戲內交易
- **完全信任模式**：假設用戶誠實，重點在防濫用而非防欺詐
- **免費運營**：完全依賴免費服務額度（Vercel + Supabase + Upstash + Discord）

### Discord 生態系統整合

```
┌──────────────────────────────────────────────────────────┐
│                      Discord 生態系統                       │
├──────────────────────────────────────────────────────────┤
│                                                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ OAuth 2.0   │  │  Webhook    │  │   Bot API   │     │
│  │  登入認證    │  │  即時通知    │  │  指令查詢    │     │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘     │
│         │                 │                 │            │
└─────────┼─────────────────┼─────────────────┼────────────┘
          │                 │                 │
          ▼                 ▼                 ▼
┌─────────────────────────────────────────────────────────┐
│              MapleStory 交易系統（本系統）                 │
│                                                           │
│  • 用戶身份綁定 Discord ID                                │
│  • 信譽評分基於 Discord 帳號年齡                           │
│  • 購買意向通知到 Discord 頻道                             │
│  • Bot 指令操作刊登與查詢                                  │
└─────────────────────────────────────────────────────────┘
```

### 非目標

- ❌ 系統內完成交易（無物品轉移邏輯）
- ❌ 真實貨幣交易
- ❌ 複雜的權限系統
- ❌ 跨伺服器/跨區域同步
- ❌ 即時通訊功能（使用 Discord 替代）
- ❌ 議價功能（固定價格）

---

## 系統架構

### 整體架構

```
┌─────────────────────────────────────────────────────────┐
│                      Discord Platform                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ OAuth Server │  │   Webhooks   │  │   Bot API    │  │
│  └──────┬───────┘  └───────┬──────┘  └──────┬───────┘  │
└─────────┼──────────────────┼─────────────────┼──────────┘
          │                  │                 │
          │ 1. OAuth流程      │ 3. 意向通知      │ 2. Bot指令
          │                  │                 │
┌─────────▼──────────────────▼─────────────────▼──────────┐
│                        用戶端                              │
│              (Next.js App Router + React)                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ Discord登入   │  │   市場列表    │  │  我的刊登     │  │
│  │   按鈕        │  │   瀏覽        │  │   管理        │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────┬─────────────────────────────────────────────────┘
          │ HTTPS
          │
┌─────────▼─────────────────────────────────────────────────┐
│                   Vercel Edge Functions                     │
│  ┌───────────────────────────────────────────────────────┐│
│  │              Middleware (App Router)                   ││
│  │  • Rate Limiting (Redis)                              ││
│  │  • Session Validation                                 ││
│  │  • Bot Detection (User-Agent)                         ││
│  └───────────────────────────────────────────────────────┘│
│                                                             │
│  ┌──────────────────────  API Routes  ────────────────────┐│
│  │  /api/auth/discord         → OAuth 啟動                ││
│  │  /api/auth/discord/callback → OAuth 回調               ││
│  │  /api/listings              → 刊登 CRUD                ││
│  │  /api/interests             → 意向登記                 ││
│  └────────┬────────────────────────────────┬──────────────┘│
└───────────┼────────────────────────────────┼───────────────┘
            │                                │
   ┌────────▼─────────┐          ┌──────────▼──────────┐
   │   Supabase       │          │   Upstash Redis     │
   │   PostgreSQL     │          │                     │
   │                  │          │  • Rate Limiting    │
   │ • users          │          │  • Session Cache    │
   │ • sessions       │          │                     │
   │ • listings       │          └─────────────────────┘
   │ • interests      │
   │ • discord_profiles│
   └──────────────────┘
```

### 技術棧選擇

| 層級 | 技術 | 選擇理由 |
|------|------|----------|
| **前端** | Next.js 15 + App Router | SSR/SSG 支援、優秀的 DX、Vercel 原生整合 |
| **認證** | Discord OAuth 2.0 | 免費、無使用限制、用戶基礎龐大、信任度高 |
| **資料庫** | Supabase PostgreSQL | RLS 內建、免費額度充足、Real-time 可選 |
| **Rate Limiting** | Upstash Redis | 分散式可靠、免費 10K 命令/天、邊緣優化 |
| **Webhook** | Discord Webhooks | 免費、無速率限制（30 req/sec）、豐富的 Embed 格式 |
| **Bot** | discord.js v14 | 成熟穩定、文檔完善、TypeScript 支援 |
| **狀態管理** | React Context | 輕量、夠用、無需額外依賴 |
| **部署** | Vercel + Railway/Render | Vercel: Web App, Railway/Render: Discord Bot |

---

## 📚 導航

[🏠 返回目錄](./README.md) | [下一篇：認證與資料庫 →](./02-認證與資料庫.md)
