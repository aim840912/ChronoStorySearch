# 實作路線圖

> **最後更新**：2025-10-27（完成度：75%）

---

## 📚 導航

[← 上一篇:Bot防護與監控](./07-Bot防護與監控.md) | [🏠 返回目錄](./README.md) | [下一篇:設計決策記錄 →](./09-設計決策記錄.md)

---

## 實作路線圖

### 📘 使用指南：選擇正確的實作路線

本路線圖包含兩種情境，請根據您的實際狀況選擇：

#### 情境 A：從零開始建立系統（推薦大多數專案）

**適用情況**：
- ✅ 目前沒有任何後端 API
- ✅ 沒有安裝 Supabase/Redis
- ✅ 交易系統尚未實作
- ✅ 想要按部就班建立完整系統

**實作順序**：
1. 基礎架構（資料庫、Redis、環境配置）
2. Discord OAuth 認證
3. 核心功能（刊登、市場、意向）
4. 上線觀察
5. 優化（Bot Detection，如果需要）

**時程**：12-17 週

**👉 請跳到：[情境 A 實作路線圖](#情境-a從零開始建立系統)** ⬅️ **大多數人從這裡開始**

---

#### 情境 B：優化現有系統（假設已上線）

**適用情況**：
- ✅ 交易系統已上線運行
- ✅ Redis 已安裝並啟用
- ❌ Redis 超標（> 90% 使用率）
- ❌ Bot 流量過高（> 60%）
- ❌ 實際遇到限流問題

**實作順序**：
1. 緊急修復（Bot Detection 階段 1）
2. 穩定基礎（Bot Detection 階段 2）
3. 完整防護（Bot Detection 階段 3+4）
4. 功能增強（Webhook、信譽系統）

**時程**：9-17 週

**👉 請跳到：[情境 B 實作路線圖](#情境-b優化現有系統已上線)** ⬅️ 僅適用於已上線的系統

---

#### 🤔 如何判斷我應該選哪個？

**快速檢查清單**：

| 檢查項目 | 是 | 否 |
|---------|----|----|
| `src/app/api/` 目錄下有 API routes | ⬜ | ⬜ |
| package.json 有 `@supabase/supabase-js` | ⬜ | ⬜ |
| package.json 有 `@upstash/redis` | ⬜ | ⬜ |
| Vercel Dashboard 顯示 Redis 使用率 > 90% | ⬜ | ⬜ |
| 實際遇到 Redis 超標限流問題 | ⬜ | ⬜ |

**結果判斷**：
- **5 個「否」** → 情境 A（從零開始）👈 **您在這裡！**
- **5 個「是」** → 情境 B（優化現有）
- **混合情況** → 優先選擇情境 A

---

## 情境 A：從零開始建立系統

> **目標受眾**：尚未實作任何交易系統功能的專案
>
> **核心理念**：按部就班建立穩固基礎，避免過早優化

### 總覽 (情境 A)

| 階段 | 時程 | 核心任務 | 狀態 |
|------|------|---------|------|
| **階段 0** | 第 1-4 週 | 基礎架構（Supabase + Redis + 環境） | 🔴 必要 |
| **階段 1** | 第 5-8 週 | Discord OAuth 認證系統 | 🔴 必要 |
| **階段 2** | 第 9-12 週 | 核心功能（刊登、市場、意向） | 🔴 必要 |
| **階段 3** | 第 13-14 週 | 上線觀察與監控 | 🟢 重要 |
| **階段 4** | 第 15-17 週 | Webhook & 信譽系統 | 🟡 增強 |
| **階段 5** | 第 18+ 週 | Bot Detection（按需實作）| ⚪ 可選 |

**時程摘要**：
- **MVP（最小可行版本）**：12 週（階段 0+1+2，核心功能完整）
- **生產就緒版本**：14 週（階段 0+1+2+3，含監控）
- **完整功能版本**：17 週（所有核心功能 + Webhook）

---

### 階段 0：基礎架構（第 1-4 週）

**目標**：建立專案的技術基礎，安裝必要服務

**優先級**：🔴 **必要**

#### 任務清單

> **📝 注意**：詳細的「情境 A」實作內容規劃中。以下提供簡要指引，完整文件將包含：
> - Supabase 專案設定與資料庫 Schema
> - Discord OAuth 2.0 完整實作步驟
> - 核心 API 開發（刊登、市場、意向）
> - 上線觀察與監控設定
>
> 目前您可以參考：
> - [Discord OAuth 2.0 認證](#discord-oauth-20-認證) 章節（完整設計）
> - [資料庫設計](#資料庫設計) 章節（Schema 定義）
> - [API 設計](#api-設計) 章節（端點規格）

**Week 1-2：Supabase 環境設定**
- [x] 建立 Supabase 專案（Free tier）
- [x] 安裝依賴：`npm install @supabase/supabase-js`
- [x] 建立資料庫表：`users`, `sessions`, `listings`, `interests`（共 9 個表）
- [x] 設定 RLS 策略（002_row_level_security.sql 已完整實作）

**Week 3-4：環境配置與基礎工具**
- [x] 安裝 Redis：`npm install @upstash/redis`
- [x] 建立 Supabase 客戶端工具
- [x] 設定環境變數（`.env.local`）
- [x] 建立基本的 API route 測試連線

---

### 階段 1：Discord OAuth 認證（第 5-8 週）

**目標**：實作完整的 Discord OAuth 2.0 認證流程

**優先級**：🔴 **必要**

#### 任務清單

**Week 5-6：OAuth 核心流程**
- [x] 建立 Discord Application（Developer Portal）
- [x] 實作 OAuth 啟動：`GET /api/auth/discord`
- [x] 實作 OAuth 回調：`GET /api/auth/discord/callback`
- [x] State token CSRF 防護

**Week 7-8：Session 管理**
- [x] JWT Token 生成與驗證
- [x] Cookie 安全配置（HttpOnly, Secure, SameSite）
- [x] Session 刷新機制
- [x] 登入/登出功能

---

### 階段 2：核心功能（第 9-12 週）

**目標**：實作交易系統核心業務功能

**優先級**：🔴 **必要**

#### 任務清單

**Week 9-10：刊登系統**
- [x] 實作刊登 CRUD API（/api/listings, /api/listings/[id]）
- [x] 實作認證中間件（`withAuthAndError`, `withAdminAndError`）
- [x] 建立刊登 Modal 元件（`CreateListingModal`）
  - 重用 `BaseModal` 基礎元件
  - 表單驗證與錯誤處理
  - 整合 API 呼叫（POST `/api/listings`）
  - 整合 ItemSearchInput 和 ItemStatsInput

**Week 11-12：市場與意向**
- [x] 實作市場列表 API（/api/market, /api/market/search, /api/market/exchange-matches）
- [x] 實作購買意向 API（/api/interests, /api/interests/received）
- [x] 建立市場瀏覽 Modal（`MarketBrowserModal`）
  - 商品列表展示（含分頁/篩選）
  - 刊登詳情子 Modal（嵌套顯示）
  - 購買意向登記功能
- [x] 實作聯絡方式查看（/api/listings/[id]/contact，含 IP 配額）

---

### 階段 3：上線觀察（第 13-14 週）

**目標**：上線到生產環境，監控實際流量

**優先級**：🟢 **重要**

#### 任務清單

**Week 13：上線準備**
- [ ] Production 環境變數設定
- [ ] 效能測試（API 回應時間 < 200ms）
- [ ] 安全檢查（RLS, XSS, CSRF）

**Week 14：監控與觀察**
- [ ] 設定 Vercel Analytics
- [ ] 監控 Redis 使用率
- [ ] 收集用戶反饋

**🎯 關鍵決策點**：

```
觀察 2 週後的 Redis 使用率：

├─ < 70% 使用率（正常）
│  └─ 繼續階段 4：實作 Webhook & 信譽系統
│
├─ 70-80% 使用率（接近上限）
│  └─ 繼續觀察 1 週，考慮簡單的 Rate Limiting
│
└─ > 80% 使用率（警告）
   └─ 跳到情境 B：實作 Bot Detection
```

---

### 階段 4-5：增強功能（第 15+ 週）

**目標**：Webhook 通知、信譽系統等增強功能

**優先級**：🟡 **增強**（可選）

詳細內容請參考原「階段 4-5」章節。

---

## 情境 B：優化現有系統（已上線）

> **⚠️ 前提條件**：此路線圖假設您的交易系統已經上線，且遇到以下問題：
> - ✅ 交易系統已實作並上線運行
> - ✅ Redis 已安裝並啟用 Rate Limiting
> - ❌ Redis 使用率 > 90%（實際超標）
> - ❌ Bot 流量比例 > 60%（實際觀察到）
> - ❌ 實際遇到限流問題
>
> **如果您的系統尚未上線**，請回到 [情境 A](#情境-a從零開始建立系統)

### 總覽 (情境 B)

> **基於實際流量分析**：7,794 訪客/5天，60-80% Bot 流量，Redis 已超標 107%

| 階段 | 時程 | 核心任務 | Redis 使用率 | 狀態 |
|------|------|---------|-------------|------|
| **階段 0** | 第 1 週 | Bot Detection 階段 1（緊急修復） | 70-80% | 🔴 Critical |
| **階段 1** | 第 2-5 週 | Bot Detection 階段 2（穩定基礎） | 50-60% | 🔴 Critical |
| **階段 2** | 第 6-9 週 | Bot Detection 階段 3+4（完整防護） | 20-30% | 🟢 Recommended |
| **階段 3** | 第 10-13 週 | Discord OAuth 強化 | - | 🟢 High Priority |
| **階段 4** | 第 14-17 週 | Webhook & 信譽系統 | - | 🟡 Medium |

---

### 階段 0（情境 B）：緊急修復 - Bot Detection 階段 1（第 1 週）

**目標**：臨時緩解 Redis 超標問題，降至 70-80% 使用率

**優先級**：🔴 **Critical**（僅適用於 Redis 當前已超標的情況）

#### 任務清單

**Week 2：高頻訪問檢測**
- [ ] 實作 Rate Limiter 服務
  - 檔案：`src/lib/services/rate-limiter.ts`
  - 功能：固定窗口算法（INCR + EXPIRE）
- [ ] 設定端點級別限流
  - trending：10 次/分鐘
  - 市場列表：30 次/分鐘
  - 其他 API：50 次/小時
- [ ] 整合到 Middleware
  - 檢測並阻擋高頻請求
  - 返回 429 Too Many Requests

**Week 3：掃描行為檢測**
- [ ] 實作路徑多樣性檢測
  - 檔案：`src/lib/services/scan-detector.ts`
  - 功能：追蹤 IP 訪問的端點數量
- [ ] 設定掃描閾值
  - 1 分鐘內訪問 > 20 個不同端點 → 標記為掃描
- [ ] Redis Set 資料結構優化
  - 使用 SADD + EXPIRE 儲存訪問記錄
  - 自動過期機制（60 秒）

**Week 4：整合與測試**
- [ ] 綜合 Bot 檢測邏輯
  - User-Agent 過濾 + 高頻檢測 + 掃描檢測
  - 多重條件判斷（任一條件觸發即阻擋）
- [ ] 撰寫整合測試
  - 模擬正常用戶行為（通過）
  - 模擬 Bot 行為（阻擋）
- [ ] 壓力測試
  - 1000 併發請求
  - 確認 Redis 使用量在預期範圍

**Week 5：上線與監控**
- [ ] Staging 環境驗證
  - 7 天測試期
  - 監控誤判率（< 1%）
- [ ] Production 部署
  - 灰度發布（10% → 50% → 100%）
  - 即時監控 Redis 使用率
- [ ] 建立告警機制
  - Redis 使用率 > 70% 發送警報
  - 誤判案例自動記錄

#### 驗收標準

✅ **功能驗收**：
- 高頻訪問正確檢測並阻擋（> 50 次/小時）
- 掃描行為正確識別（1 分鐘 > 20 端點）
- 誤判率 < 1%（真實用戶不受影響）

✅ **效能驗收**：
- Redis 命令數降至 5,000-6,000/天（50-60% 使用率）
- Middleware 處理時間 < 10ms
- 系統回應時間無明顯增加

⚠️ **風險提示**：
- 複雜邏輯可能增加 Middleware 延遲（需優化）
- Redis 命令數本身會增加（需平衡過濾效益 vs 檢測成本）

---

### 階段 2：完整防護 - Bot Detection 階段 3+4（第 6-9 週）

**目標**：實作 IP 信譽系統 + Cloudflare 整合，降至 20-30% Redis 使用率

**優先級**：🟢 **Recommended**（非緊急，但可顯著提升系統穩定性）

#### 任務清單

**Week 6-7：IP 信譽系統（階段 3）**
- [ ] 設計 IP 信譽資料庫
  - 表：`ip_reputation`
  - 欄位：ip_address, reputation_score, total_requests, bot_requests 等
- [ ] 實作信譽計算邏輯
  - Bot 比例：> 80% → 扣 30 分
  - 阻擋次數：每次 → 扣 2 分
  - 活躍時間：> 90 天 → 加 10 分
- [ ] 整合到 Bot Detection
  - 信譽 < 30 分 → 自動阻擋
  - 信譽 30-50 分 → 加強監控
- [ ] 實作自動學習
  - 根據實際 Bot 行為動態調整評分
  - 每日批次更新信譽分數

**Week 8：Cloudflare Bot Protection（階段 4，可選）**
- [ ] 評估 Cloudflare 免費版功能
  - Bot Fight Mode（免費）
  - Super Bot Fight Mode（Pro，$20/月）
- [ ] 整合 Cloudflare Worker
  - 前置過濾（在到達 Vercel 前阻擋）
  - 降低 Vercel 流量消耗
- [ ] 配置 Challenge 規則
  - 可疑請求顯示 CAPTCHA
  - 已知 Bot IP 直接阻擋

**Week 9：監控儀表板開發**
- [ ] 建立 Admin Dashboard 頁面
  - 路徑：`/admin/dashboard`（檔案：`src/app/admin/dashboard/page.tsx`）
  - 功能：即時監控 Bot 流量、阻擋統計、系統指標
- [ ] 實作圖表視覺化
  - Redis 使用率趨勢圖
  - Bot 類型分布圓餅圖
  - 每小時請求量折線圖
- [ ] 實作手動控制
  - IP 白名單/黑名單管理
  - Bot Detection 規則開關

#### 驗收標準

✅ **功能驗收**：
- IP 信譽系統正確評分（準確率 > 90%）
- Cloudflare 整合正常工作（可選）
- 監控儀表板數據準確

✅ **效能驗收**：
- Redis 命令數降至 2,000-3,000/天（20-30% 使用率）
- 系統穩定性 > 99.9%
- Bot 過濾率 85-95%

⚠️ **風險提示**：
- IP 信譽資料庫會增加 Supabase 儲存使用
- Cloudflare 可能需要額外費用（Pro 方案 $20/月）

---

### 階段 3：Discord OAuth 實作（第 10-13 週）

**目標**：實作 Discord OAuth 2.0 認證，提供真實身份驗證

**優先級**：🟢 **High Priority**（核心功能，但非緊急）

#### 任務清單

**Week 10：Discord Application 設置**
- [ ] 建立 Discord Application
  - 前往 [Discord Developer Portal](https://discord.com/developers/applications)
  - 設定 OAuth2 Redirect URIs
- [ ] 配置環境變數
  - `DISCORD_CLIENT_ID`
  - `DISCORD_CLIENT_SECRET`
  - `DISCORD_REDIRECT_URI`
- [ ] 設定 OAuth2 Scopes
  - 僅使用 `identify`（最小化權限）

**Week 11-12：OAuth 流程實作**
- [ ] 實作 OAuth 啟動端點
  - 路徑：`/api/auth/discord`
  - 功能：生成 state token，重導向至 Discord
- [ ] 實作 OAuth 回調端點
  - 路徑：`/api/auth/discord/callback`
  - 功能：驗證 state，交換 access_token
- [ ] 實作 Session 管理
  - JWT token 生成與驗證
  - Cookie 安全配置（HttpOnly, Secure, SameSite）
- [ ] 實作 Token 刷新機制
  - 剩餘時間 < 25% 自動刷新
  - 客戶端每 5 分鐘檢查

**Week 13：資料庫與前端整合**
- [ ] 建立資料庫 Schema
  - 表：`users`, `sessions`, `user_sessions`
  - RLS 策略配置
- [ ] 開發登入 Modal（見 DDR-003）
  - 元件位置：`src/components/auth/LoginModal.tsx`
  - 重用 BaseModal 基礎元件
  - 實作觸發機制：CustomEvent `show-login-modal`
  - 「使用 Discord 登入」按鈕（Discord 品牌色 #5865F2）
  - 載入狀態處理（spinner + 「跳轉中...」）
  - 錯誤訊息顯示（在 Modal 內顯示）
- [ ] 整合到現有功能
  - API 401 錯誤自動觸發 LoginModal
  - Session 過期自動顯示 LoginModal
  - 刊登功能需要登入
  - 購買意向需要登入
  - 個人中心顯示 Discord 資訊

#### 驗收標準

✅ **功能驗收**：
- OAuth 流程完整運作（啟動 → 授權 → 回調 → Session）
- State token CSRF 防護正確
- Session 自動刷新正常
- 多裝置登入支援

✅ **安全驗收**：
- Token 加密存儲（AES-256-GCM）
- Cookie 安全 flags 正確（HttpOnly, Secure, SameSite）
- CSRF 攻擊防護有效

---

### 階段 4：Webhook & 信譽系統（第 14-17 週）

**目標**：實作 Discord Webhook 通知與簡化版信譽系統

**優先級**：🟡 **Medium**（增強功能，非核心）

#### 任務清單

**Week 14-15：Discord Webhook 通知**
- [ ] 實作 Webhook 配置 API
  - POST `/api/webhooks`：建立 Webhook
  - GET `/api/webhooks`：查詢用戶 Webhook
  - DELETE `/api/webhooks/[id]`：刪除 Webhook
- [ ] 實作 Webhook 安全機制
  - URL 驗證（僅允許 Discord 官方格式）
  - 測試發送（儲存前驗證）
  - 速率限制（30 條/小時/Webhook）
- [ ] 實作購買意向通知
  - 自動發送到賣家 Webhook
  - 包含買家資訊、物品、價格、備註
- [ ] 實作失敗處理
  - 連續 5 次失敗自動停用
  - 通知用戶 Webhook 失效

**Week 16：簡化版信譽系統**
- [ ] 實作信譽計算邏輯（v1.0 簡化版）
  - 僅使用 Discord 帳號年齡
  - 公式：3 年+ → 70 分，官方驗證 +30 分
- [ ] 建立信譽資料表
  - 表：`user_reputation`
  - 每日批次更新（Cron Job）
- [ ] 顯示信譽徽章
  - 刊登列表顯示賣家信譽
  - 購買意向顯示買家信譽
  - 個人中心顯示自己信譽

**Week 17：監控與優化**
- [ ] 實作監控 Cron Jobs
  - 每日指標收集（`/api/cron/daily-metrics`）
  - 每小時健康檢查（`/api/cron/hourly-check`）
  - Session 清理（`/api/cron/cleanup-sessions`）
- [ ] 配置 Vercel Cron Jobs
  - vercel.json 設定
  - Cron Secret 環境變數
- [ ] 建立 Discord Webhook 警報
  - Redis 使用率 > 80% 發送警報
  - 系統錯誤即時通知

#### 驗收標準

✅ **Webhook 驗收**：
- Webhook 配置流程完整
- 購買意向通知即時發送
- 速率限制正確運作
- 失敗處理機制有效

✅ **信譽系統驗收**：
- 信譽計算準確
- 徽章顯示正確
- 每日批次更新正常

---

### 階段 5：Discord Bot & 增強功能（第 18+ 週，可選）

**目標**：開發 Discord Bot 與進階功能

**優先級**：⚪ **Optional**（非必要，視用戶需求決定）

#### 任務清單（可選）

**Discord Bot 開發**
- [ ] Bot 基礎架構（discord.js）
- [ ] 實作 Bot 指令
  - `/listings` - 查詢個人刊登
  - `/market` - 搜尋市場物品
  - `/stats` - 查看交易統計
- [ ] Bot 部署（Render 免費版）

**信譽系統增強（可選）**
- [ ] 整合交易歷史評分
- [ ] 社群評價系統
- [ ] 外部信譽來源整合

**其他增強功能**
- [ ] 多語言支援（i18n）
- [ ] 深色模式
- [ ] 圖片上傳（物品圖片）

---

### 總結與建議

本實作路線圖提供兩種情境，請根據您的實際狀況選擇：

#### 情境 A：從零開始（推薦大多數專案）

**12 週 MVP**（最小可行版本）：
```
Week 1-4：   基礎架構（Supabase + Redis）
Week 5-8：   Discord OAuth 認證
Week 9-12：  核心功能（刊登、市場、意向）
→ 結果：完整的交易系統，可上線運行
```

**14 週生產就緒版本**：
```
Week 1-12：  MVP（同上）
Week 13-14： 上線觀察與監控
→ 結果：含監控的穩定系統，根據實際流量決定是否需要優化
```

**17 週完整版本**：
```
Week 1-14：  生產就緒版本（同上）
Week 15-17： Webhook & 信譽系統
→ 結果：包含所有增強功能的完整交易平台
```

**關鍵決策點**：
- Week 13-14：觀察 Redis 使用率
  - 如果 < 70%：繼續 Webhook 實作 ✅
  - 如果 > 80%：切換到情境 B（Bot Detection）⚠️

---

#### 情境 B：優化現有系統（僅適用於已上線且遇到問題）

**⚠️ 前提**：系統已上線，Redis 使用率 > 90%，Bot 流量 > 60%

**5 週緊急修復**：
```
Week 1：     Bot Detection 階段 1（基礎過濾）
Week 2-5：   Bot Detection 階段 2（行為檢測）
→ 結果：Redis 使用率降至 50-60%，系統穩定
```

**9 週完整防護**：
```
Week 1-5：   緊急修復（同上）
Week 6-9：   Bot Detection 階段 3+4（IP 信譽 + Cloudflare）
→ 結果：Redis 使用率降至 20-30%，理想狀態
```

**17 週全功能**：
```
Week 1-9：   完整防護（同上）
Week 10-13： Discord OAuth 強化
Week 14-17： Webhook & 信譽系統
→ 結果：優化完成的生產級平台
```

---

#### 快速選擇指南

| 您的情況 | 建議路線 | 起點 |
|---------|---------|------|
| 🆕 還沒開始開發 | 情境 A | [階段 0：基礎架構](#階段-0基礎架構第-1-4-週) |
| 🚧 正在開發中 | 情境 A | 根據進度選擇對應階段 |
| ✅ 已上線但正常 | 繼續觀察 | [階段 3：上線觀察](#階段-3上線觀察第-13-14-週) |
| ⚠️ 已上線 + Redis 超標 | 情境 B | [階段 0（情境 B）](#階段-0情境-b緊急修復---bot-detection-階段-1第-1-週) |

#### 關鍵里程碑對照

**情境 A（從零開始）**：
| 里程碑 | 時間點 | 成果 |
|--------|--------|------|
| 🎯 **基礎就緒** | Week 4 | Supabase + Redis 環境完成 |
| 🔐 **認證完成** | Week 8 | Discord OAuth 上線 |
| ✅ **MVP 上線** | Week 12 | 核心功能完整 |
| 📊 **監控決策** | Week 14 | 根據數據決定是否需要 Bot Detection |
| 🚀 **完整功能** | Week 17 | 包含 Webhook 的完整系統 |

**情境 B（優化現有）**：
| 里程碑 | 時間點 | 成果 |
|--------|--------|------|
| 🔴 **緊急修復** | Week 1 | Redis 降至 70-80% |
| 🟢 **穩定運行** | Week 5 | Redis 降至 50-60% |
| 🎯 **理想狀態** | Week 9 | Redis 降至 20-30% |
| ✅ **功能強化** | Week 13 | Discord OAuth 強化 |
| 🚀 **完整功能** | Week 17 | 所有優化完成 |

---


---

## 📚 導航

[← 上一篇:Bot防護與監控](./07-Bot防護與監控.md) | [🏠 返回目錄](./README.md) | [下一篇:設計決策記錄 →](./09-設計決策記錄.md)
