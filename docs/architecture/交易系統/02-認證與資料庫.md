# èªè­‰èˆ‡è³‡æ–™åº«è¨­è¨ˆ

> **æœ€å¾Œæ›´æ–°**ï¼š2025-10-26

---

## ğŸ“š å°èˆª

[â† ä¸Šä¸€ç¯‡:ç³»çµ±ç¸½è¦½èˆ‡æ¶æ§‹](./01-ç³»çµ±ç¸½è¦½èˆ‡æ¶æ§‹.md) | [ğŸ  è¿”å›ç›®éŒ„](./README.md) | [ä¸‹ä¸€ç¯‡:APIè¨­è¨ˆ â†’](./03-APIè¨­è¨ˆ.md)

---

## ç›®éŒ„

1. [Discord OAuth 2.0 èªè­‰](#discord-oauth-20-èªè­‰)
2. [è³‡æ–™åº«è¨­è¨ˆ](#è³‡æ–™åº«è¨­è¨ˆ)

---

## Discord OAuth 2.0 èªè­‰

### OAuth æµç¨‹æ¦‚è¦½

Discord OAuth 2.0 ä½¿ç”¨æ¨™æº–çš„ Authorization Code Grant æµç¨‹,æä¾›å®‰å…¨çš„ç¬¬ä¸‰æ–¹ç™»å…¥æ©Ÿåˆ¶ã€‚

**æµç¨‹æ­¥é©Ÿ**:
1. ç”¨æˆ¶é»æ“Šã€Œä½¿ç”¨ Discord ç™»å…¥ã€
2. é‡å°å‘è‡³ Discord æˆæ¬Šé é¢(å¸¶ state åƒæ•¸é˜² CSRF)
3. ç”¨æˆ¶åœ¨ Discord æˆæ¬Šæ‡‰ç”¨
4. Discord é‡å°å‘å›æ‡‰ç”¨(å¸¶ code å’Œ state)
5. å¾Œç«¯ç”¨ code äº¤æ› access_token å’Œ refresh_token
6. ç”¨ access_token ç²å– Discord ç”¨æˆ¶è³‡æ–™
7. å‰µå»º/æ›´æ–°è³‡æ–™åº«ç”¨æˆ¶è¨˜éŒ„
8. è¨­ç½® session cookie

### Discord Application è¨­ç½®

å‰å¾€ [Discord Developer Portal](https://discord.com/developers/applications) å‰µå»ºæ‡‰ç”¨:

```yaml
Application Name: MapleStory Trading System
Description: è™›æ“¬ç‰©å“äº¤æ˜“æ„å‘åª’åˆå¹³å°

OAuth2 é…ç½®:
  Client ID: <å¾ Discord ç²å–>
  Client Secret: <å¾ Discord ç²å–,å­˜å…¥ç’°å¢ƒè®Šæ•¸>

  Redirect URIs:
    - https://your-domain.vercel.app/api/auth/discord/callback
    - http://localhost:3000/api/auth/discord/callback

  OAuth2 Scopes:
    - identify        # ç²å–ç”¨æˆ¶åŸºæœ¬è³‡è¨Š(ID, username, avatar)
    # email å¯é¸,è‹¥éœ€è¦éƒµä»¶é€šçŸ¥åŠŸèƒ½å¯å•Ÿç”¨
```

**âš ï¸ Scopes èªªæ˜**:
- âœ… **identify**:**å¿…é ˆ**ã€‚ç²å– Discord IDã€ç”¨æˆ¶åã€é ­åƒç­‰åŸºæœ¬è³‡è¨Š
- âš ï¸ **email**:**å¯é¸**ã€‚è‹¥éœ€è¦éƒµä»¶é€šçŸ¥å¯å•Ÿç”¨,ä½†å¢åŠ ç”¨æˆ¶æˆæ¬Šæ‘©æ“¦
- âŒ **guilds.members.read**:**ä¸æ¨è–¦**ã€‚æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦åœ¨ç‰¹å®šä¼ºæœå™¨,å¯¦ä½œè¤‡é›œä¸”ä¸å¿…è¦

**å»ºè­°é…ç½®**:
- **æœ€å°åŒ–æ¬Šé™**:åƒ…ä½¿ç”¨ `identify`(æ¨è–¦èµ·æ­¥éšæ®µ)
- **ç°¡åŒ–æˆæ¬Šæµç¨‹**:æ¸›å°‘ç”¨æˆ¶ç–‘æ…®,æé«˜è½‰æ›ç‡
- **å¾ŒçºŒæ“´å±•**:å¾…æœ‰æ˜ç¢ºéœ€æ±‚æ™‚å†å¢åŠ  scopes

```

### ç’°å¢ƒè®Šæ•¸é…ç½®

```bash
# .env.local

# Discord OAuth
DISCORD_CLIENT_ID=your_client_id_here
DISCORD_CLIENT_SECRET=your_client_secret_here
DISCORD_REDIRECT_URI=https://your-domain.vercel.app/api/auth/discord/callback

# Discord Bot(å¯é¸)
DISCORD_BOT_TOKEN=your_bot_token_here
DISCORD_GUILD_ID=your_server_id_here

# Session åŠ å¯†
SESSION_SECRET=your_random_secret_key_min_32_chars

# Database
DATABASE_URL=your_supabase_postgres_url
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key

# Redis
UPSTASH_REDIS_REST_URL=your_upstash_rest_url
UPSTASH_REDIS_REST_TOKEN=your_upstash_rest_token
```

### OAuth å®‰å…¨æ©Ÿåˆ¶

1. **State åƒæ•¸é©—è­‰**:é˜²æ­¢ CSRF æ”»æ“Š
   - ç”¢ç”Ÿéš¨æ©Ÿ state ä¸¦å­˜å…¥ JWT
   - JWT è¨­ç½® 10 åˆ†é˜éæœŸæ™‚é–“
   - å›èª¿æ™‚é©—è­‰ state ä¸€è‡´æ€§å’ŒæœªéæœŸ

2. **Token åŠ å¯†å­˜å„²**:
   - Discord access_token å’Œ refresh_token ä½¿ç”¨ AES-256-GCM åŠ å¯†
   - åŠ å¯†å¯†é‘°ä¾†è‡ªç’°å¢ƒè®Šæ•¸ SESSION_SECRET

3. **Session Cookie å®‰å…¨**:
   - HttpOnly:é˜²æ­¢ XSS æ”»æ“Š
   - Secure:ç”Ÿç”¢ç’°å¢ƒåƒ… HTTPS
   - SameSite=Lax:é˜²æ­¢ CSRF
   - 30 å¤©æœ‰æ•ˆæœŸ

---

## è³‡æ–™åº«è¨­è¨ˆ

### ER åœ–

```
users (ç”¨æˆ¶è¡¨)
  â”œâ”€â”€ 1:N â†’ sessions (Session è¡¨)
  â”œâ”€â”€ 1:1 â†’ discord_profiles (Discord è©³ç´°è³‡æ–™)
  â”œâ”€â”€ 1:N â†’ reputation_history (ä¿¡è­½æ­·å²)
  â”œâ”€â”€ 1:N â†’ listings (åˆŠç™»è¡¨)
  â”œâ”€â”€ 1:N â†’ interests (è³¼è²·æ„å‘è¡¨ - ä½œç‚ºè²·å®¶)
  â”œâ”€â”€ 1:N â†’ reports (èˆ‰å ±è¡¨ - ä½œç‚ºèˆ‰å ±è€…)
  â””â”€â”€ 1:1 â†’ user_quotas (é…é¡è¡¨)

listings (åˆŠç™»è¡¨)
  â”œâ”€â”€ N:1 â†’ users (è³£å®¶)
  â”œâ”€â”€ 1:N â†’ interests (è³¼è²·æ„å‘)
  â””â”€â”€ 1:N â†’ reports (èˆ‰å ±)

interests (è³¼è²·æ„å‘è¡¨)
  â”œâ”€â”€ N:1 â†’ users (è²·å®¶)
  â””â”€â”€ N:1 â†’ listings (åˆŠç™»)

ip_quotas (IP é…é¡è¡¨) - ç¨ç«‹è¡¨,ç„¡å¤–éµé—œè¯
```

### æ ¸å¿ƒè¡¨çµæ§‹

#### 1. ç”¨æˆ¶è¡¨ (users)

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  discord_id VARCHAR(20) UNIQUE NOT NULL,
  discord_username VARCHAR(100) NOT NULL,
  discord_discriminator VARCHAR(4),
  discord_avatar VARCHAR(200),
  email VARCHAR(255),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  last_login_at TIMESTAMPTZ,
  banned BOOLEAN DEFAULT FALSE,
  ban_reason TEXT,

  CONSTRAINT valid_discord_id CHECK (discord_id ~ '^[0-9]{17,20}$')
);

CREATE INDEX idx_discord_id ON users(discord_id);
CREATE INDEX idx_banned_users ON users(banned) WHERE banned = TRUE;
```

#### 2. Session è¡¨ (sessions)

```sql
CREATE TABLE sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  access_token TEXT NOT NULL,
  refresh_token TEXT NOT NULL,
  expires_at TIMESTAMPTZ NOT NULL,
  created_ip INET NOT NULL,
  user_agent TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  last_active_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_user_sessions ON sessions(user_id, created_at DESC);
CREATE INDEX idx_expires ON sessions(expires_at) WHERE expires_at > NOW();
```

#### 3. Discord è©³ç´°è³‡æ–™è¡¨ (discord_profiles)

```sql
CREATE TABLE discord_profiles (
  user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  account_created_at TIMESTAMPTZ NOT NULL,
  server_member_since TIMESTAMPTZ,
  server_roles TEXT[],
  verified BOOLEAN DEFAULT FALSE,
  reputation_score INTEGER DEFAULT 0 CHECK (reputation_score >= 0 AND reputation_score <= 100),
  reputation_last_updated TIMESTAMPTZ,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_reputation ON discord_profiles(reputation_score DESC);
```

#### 4. ä¿¡è­½æ­·å²è¡¨ (reputation_history)

```sql
CREATE TABLE reputation_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  score_change INTEGER NOT NULL,
  reason VARCHAR(200) NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_user_reputation_history ON reputation_history(user_id, created_at DESC);
```

#### 5. ç‰©å“åˆŠç™»è¡¨ (listings)

```sql
CREATE TABLE listings (
  id BIGSERIAL PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

  -- äº¤æ˜“é¡å‹ï¼šsell(å‡ºå”®), buy(æ”¶è³¼), exchange(äº¤æ›)
  trade_type TEXT DEFAULT 'sell' NOT NULL,

  -- å‡ºå”®/æ”¶è³¼/äº¤æ›çš„ç‰©å“
  item_id INT NOT NULL,
  quantity INT DEFAULT 1 CHECK (quantity > 0),

  -- åƒ¹æ ¼ (sell/buy ä½¿ç”¨, exchange ä¸ä½¿ç”¨)
  price BIGINT CHECK (price > 0),

  -- æƒ³è¦çš„ç‰©å“ (åƒ… exchange ä½¿ç”¨)
  wanted_item_id INT,
  wanted_quantity INT DEFAULT 1 CHECK (wanted_quantity > 0),

  -- è¯çµ¡æ–¹å¼
  contact_method TEXT NOT NULL,
  contact_info TEXT,
  webhook_url TEXT,

  -- ç‹€æ…‹èˆ‡çµ±è¨ˆ
  status TEXT DEFAULT 'active',
  view_count INT DEFAULT 0,
  interest_count INT DEFAULT 0,

  -- æ™‚é–“æˆ³
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  completed_at TIMESTAMPTZ,
  deleted_at TIMESTAMPTZ,

  -- ç´„æŸæ¢ä»¶
  CONSTRAINT valid_trade_type CHECK (
    trade_type IN ('sell', 'buy', 'exchange')
  ),
  CONSTRAINT valid_contact_method CHECK (
    contact_method IN ('discord', 'ingame')
  ),
  CONSTRAINT valid_status CHECK (
    status IN ('active', 'sold', 'cancelled', 'expired', 'suspended')
  ),
  -- äº¤æ›é¡å‹å¿…é ˆæä¾› wanted_item_id
  CONSTRAINT exchange_requires_wanted_item CHECK (
    (trade_type = 'exchange' AND wanted_item_id IS NOT NULL) OR
    (trade_type != 'exchange')
  ),
  -- è²·è³£é¡å‹å¿…é ˆæä¾› price
  CONSTRAINT trade_requires_price CHECK (
    (trade_type IN ('sell', 'buy') AND price IS NOT NULL) OR
    (trade_type = 'exchange')
  )
);

CREATE INDEX idx_active_listings ON listings(status, created_at DESC)
  WHERE status = 'active' AND deleted_at IS NULL;
CREATE INDEX idx_item_search ON listings(item_id, price)
  WHERE status = 'active' AND deleted_at IS NULL;
CREATE INDEX idx_trade_type ON listings(trade_type, created_at DESC)
  WHERE status = 'active' AND deleted_at IS NULL;
CREATE INDEX idx_wanted_item ON listings(wanted_item_id)
  WHERE wanted_item_id IS NOT NULL AND status = 'active';
CREATE INDEX idx_user_listings ON listings(user_id, created_at DESC)
  WHERE deleted_at IS NULL;
```

**äº¤æ˜“é¡å‹èªªæ˜**:

| é¡å‹ | trade_type | å¿…å¡«æ¬„ä½ | èªªæ˜ | ç¯„ä¾‹ |
|------|-----------|---------|------|------|
| **å‡ºå”®** | `sell` | item_id, price | æˆ‘æœ‰ç‰©å“è¦è³£ | è²©å”® 10 æ¥“å¹£,åƒ¹æ ¼ 1000 è¬ |
| **æ”¶è³¼** | `buy` | item_id, price | æˆ‘è¦æ”¶è³¼ç‰©å“ | æ”¶è³¼é»‘é¾å¥—è£,å‡ºåƒ¹ 5000 è¬ |
| **äº¤æ›** | `exchange` | item_id, wanted_item_id | ç‰©æ›ç‰© | ç”¨æš—å½±é›™åˆ€ äº¤æ› å± é¾åˆ€ |

**ç¯„ä¾‹è³‡æ–™**:

```sql
-- å‡ºå”®ç¯„ä¾‹
INSERT INTO listings (user_id, trade_type, item_id, quantity, price, contact_method, contact_info)
VALUES ('user-uuid', 'sell', 1002000, 1, 10000000, 'discord', 'seller#1234');

-- æ”¶è³¼ç¯„ä¾‹
INSERT INTO listings (user_id, trade_type, item_id, quantity, price, contact_method, contact_info)
VALUES ('user-uuid', 'buy', 1003000, 1, 50000000, 'discord', 'buyer#5678');

-- äº¤æ›ç¯„ä¾‹
INSERT INTO listings (user_id, trade_type, item_id, quantity, wanted_item_id, wanted_quantity, contact_method, contact_info)
VALUES ('user-uuid', 'exchange', 1002000, 1, 1003000, 1, 'discord', 'trader#9999');
```

#### 6. è³¼è²·æ„å‘è¡¨ (interests)

```sql
CREATE TABLE interests (
  id BIGSERIAL PRIMARY KEY,
  listing_id BIGINT REFERENCES listings(id) ON DELETE CASCADE,
  buyer_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  status TEXT DEFAULT 'pending',
  contacted_at TIMESTAMPTZ,
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT unique_interest UNIQUE (listing_id, buyer_id),
  CONSTRAINT valid_status CHECK (
    status IN ('pending', 'contacted', 'completed', 'cancelled')
  )
);

CREATE INDEX idx_listing_interests ON interests(listing_id, status, created_at DESC);
CREATE INDEX idx_buyer_interests ON interests(buyer_id, status, created_at DESC);
```

#### 7. èˆ‰å ±è¡¨ (reports)

```sql
CREATE TABLE reports (
  id BIGSERIAL PRIMARY KEY,
  listing_id BIGINT REFERENCES listings(id) ON DELETE CASCADE,
  reporter_id UUID NOT NULL REFERENCES users(id) ON DELETE SET NULL,
  reason TEXT NOT NULL,
  status TEXT DEFAULT 'pending',
  admin_notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  resolved_at TIMESTAMPTZ,

  CONSTRAINT valid_status CHECK (
    status IN ('pending', 'reviewing', 'resolved', 'dismissed')
  )
);

CREATE INDEX idx_pending_reports ON reports(status, created_at DESC)
  WHERE status IN ('pending', 'reviewing');
```

#### 8. ç”¨æˆ¶é…é¡è¡¨ (user_quotas)

```sql
CREATE TABLE user_quotas (
  user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  active_listings_count INT DEFAULT 0 CHECK (active_listings_count >= 0),
  total_interests_count INT DEFAULT 0 CHECK (total_interests_count >= 0),
  interests_today INT DEFAULT 0 CHECK (interests_today >= 0),
  last_interest_date DATE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT quota_listings CHECK (active_listings_count <= 50),
  CONSTRAINT quota_interests CHECK (total_interests_count <= 100),
  CONSTRAINT quota_interests_daily CHECK (interests_today <= 20)
);
```

#### 9. IP é…é¡è¡¨ (ip_quotas)

```sql
CREATE TABLE ip_quotas (
  ip_address INET PRIMARY KEY,
  contact_views_today INT DEFAULT 0 CHECK (contact_views_today >= 0),
  last_contact_view_date DATE,
  total_contact_views INT DEFAULT 0 CHECK (total_contact_views >= 0),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT quota_contact_views_daily CHECK (contact_views_today <= 30)
);

CREATE INDEX idx_ip_contact_views ON ip_quotas(contact_views_today DESC)
  WHERE contact_views_today > 20;
```

---

## ğŸ“š å°èˆª

[â† ä¸Šä¸€ç¯‡:ç³»çµ±ç¸½è¦½èˆ‡æ¶æ§‹](./01-ç³»çµ±ç¸½è¦½èˆ‡æ¶æ§‹.md) | [ğŸ  è¿”å›ç›®éŒ„](./README.md) | [ä¸‹ä¸€ç¯‡:APIè¨­è¨ˆ â†’](./03-APIè¨­è¨ˆ.md)
