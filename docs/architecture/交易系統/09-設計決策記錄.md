# è¨­è¨ˆæ±ºç­–è¨˜éŒ„ (ADR/DDR)

> **æœ€å¾Œæ›´æ–°**ï¼š2025-10-26

---

## ğŸ“š å°èˆª

[â† ä¸Šä¸€ç¯‡:å¯¦ä½œè·¯ç·šåœ–](./08-å¯¦ä½œè·¯ç·šåœ–.md) | [ğŸ  è¿”å›ç›®éŒ„](./README.md)

---

## è¨­è¨ˆæ±ºç­–è¨˜éŒ„

### DDR-001ï¼šé¸æ“‡ Discord OAuth è€Œéè§’è‰² ID ç³»çµ±

**æ—¥æœŸ**ï¼š2025-10-25

**èƒŒæ™¯**ï¼šåŸç³»çµ±ä½¿ç”¨è§’è‰² ID + Token çš„ç„¡å¯†ç¢¼èªè­‰ï¼Œä½†å­˜åœ¨ä»¥ä¸‹å•é¡Œï¼š
- ç„¡æ³•é©—è­‰ç”¨æˆ¶çœŸå¯¦èº«ä»½
- å®¹æ˜“è¢«æ¿«ç”¨ï¼ˆå¤šå¸³è™Ÿè¨»å†Šï¼‰
- ç¼ºä¹ä¿¡ä»»æ©Ÿåˆ¶

**æ±ºç­–**ï¼šæ”¹ç”¨ Discord OAuth 2.0 èªè­‰

**ç†ç”±**ï¼š
- âœ… çœŸå¯¦èº«ä»½é©—è­‰ï¼ˆç¶å®š Discord IDï¼‰
- âœ… é˜²æ­¢å¤šå¸³è™Ÿæ¿«ç”¨ï¼ˆä¸€å€‹ Discord ID åªèƒ½ç¶å®šä¸€å€‹å¸³è™Ÿï¼‰
- âœ… ä¿¡è­½ç³»çµ±åŸºç¤ï¼ˆDiscord å¸³è™Ÿå¹´é½¡å¯é©—è­‰ï¼‰
- âœ… å…è²»ä¸”ç„¡ä½¿ç”¨é™åˆ¶
- âœ… ç”¨æˆ¶åŸºç¤é¾å¤§ï¼ˆDiscord åœ¨éŠæˆ²ç¤¾ç¾¤æ™®åŠï¼‰

**æ¬Šè¡¡**ï¼š
- âŒ éœ€è¦ç”¨æˆ¶æœ‰ Discord å¸³è™Ÿï¼ˆä½†ç›®æ¨™ç”¨æˆ¶ç¾¤é«”å·²å»£æ³›ä½¿ç”¨ Discordï¼‰
- âŒ OAuth æµç¨‹è¼ƒè¤‡é›œï¼ˆä½†æä¾›æ›´å¥½çš„å®‰å…¨æ€§ï¼‰

**çµæœ**ï¼š
- æå‡ç³»çµ±å®‰å…¨æ€§
- å»ºç«‹ä¿¡è­½ç³»çµ±åŸºç¤
- æ•´åˆ Discord ç”Ÿæ…‹ç³»çµ±ï¼ˆWebhookã€Botï¼‰

---

### DDR-002ï¼šé¸æ“‡ Modal æ¨¡å¼è€Œéç¨ç«‹é é¢

**æ—¥æœŸ**ï¼š2025-10-26

**èƒŒæ™¯**ï¼šäº¤æ˜“ç³»çµ± UI æœ‰å…©ç¨®å¯¦ä½œæ–¹å¼å¯é¸ï¼š
1. **Modal æ¨¡å¼**ï¼šä½¿ç”¨ `BaseModal` åœ¨ä¸»é ä¸Šç–ŠåŠ é¡¯ç¤º
2. **ç¨ç«‹é é¢**ï¼šå»ºç«‹ `/market`ã€`/listings/[id]` ç­‰è·¯ç”±

**æ±ºç­–**ï¼šæ¡ç”¨ Modal æ¨¡å¼å¯¦ä½œäº¤æ˜“ç³»çµ± UI

**ç†ç”±**ï¼š

1. **ç¬¦åˆå°ˆæ¡ˆç¾æœ‰æ¶æ§‹** âœ…
   - å°ˆæ¡ˆå·²å¯¦ä½œå®Œæ•´çš„ Modal åŸºç¤å»ºè¨­ï¼ˆ`BaseModal`ã€`ModalManager`ï¼‰
   - ç¾æœ‰æ‰€æœ‰åŠŸèƒ½å‡æ¡ç”¨ Modal æ¨¡å¼ï¼ˆItemModalã€MonsterModalã€GachaMachineModal ç­‰ï¼‰
   - ä¿æŒ UI ä¸€è‡´æ€§ï¼Œé™ä½ç”¨æˆ¶å­¸ç¿’æˆæœ¬

2. **ç¯€çœ Vercel è³‡æºæ¶ˆè€—** âœ…
   - æ¸›å°‘ Serverless Functions åŸ·è¡Œæ™‚é–“ï¼š~2 å°æ™‚/æœˆï¼ˆç¯€çœ 2% é¡åº¦ï¼‰
   - é™ä½ Bandwidth æ¶ˆè€—ï¼š~0.3 GB/æœˆï¼ˆç¯€çœ 0.3% é¡åº¦ï¼‰
   - ç¸½é«”ç¯€çœç´„ 3% Vercel å…è²»é¡åº¦

3. **é–‹ç™¼æ•ˆç‡æ›´é«˜** âœ…
   - é‡ç”¨ç¾æœ‰ `BaseModal` å…ƒä»¶ï¼ˆç„¡éœ€å»ºç«‹è·¯ç”±æ¶æ§‹ï¼‰
   - é‡ç”¨ç¾æœ‰ç‹€æ…‹ç®¡ç†é‚è¼¯ï¼ˆ`useModalManager`ï¼‰
   - é–‹ç™¼æ™‚é–“é ä¼°ç¯€çœ 30-40%

4. **ä½¿ç”¨è€…é«”é©—æµæš¢** âœ…
   - ç„¡éœ€é›¢é–‹ä¸»é ï¼Œä¿æŒæœå°‹ä¸Šä¸‹æ–‡
   - Modal åˆ‡æ›å³æ™‚ï¼ˆç„¡é é¢å°èˆªå»¶é²ï¼‰
   - é©åˆå¿«é€Ÿç€è¦½å’Œæ¯”åƒ¹çš„ä½¿ç”¨æƒ…å¢ƒ

**æ¬Šè¡¡**ï¼š

1. âŒ **ç©ºé–“é™åˆ¶**
   - Modal å¯è¦–ç¯„åœå—é™ï¼ˆmax-w-6xlï¼‰ï¼Œä¸é©åˆè¤‡é›œä»‹é¢
   - è§£æ±ºæ–¹æ¡ˆï¼šMVP éšæ®µä¿æŒåŠŸèƒ½ç°¡æ½”ï¼Œå¿…è¦æ™‚å¯æ“´å±•ç‚ºç¨ç«‹é é¢

2. âŒ **å·¢ç‹€ Modal è¤‡é›œåº¦**
   - ã€Œå¸‚å ´åˆ—è¡¨ â†’ åˆŠç™»è©³æƒ… â†’ ç™»è¨˜æ„å‘ã€å¯èƒ½éœ€è¦å¤šå±¤ Modal
   - è§£æ±ºæ–¹æ¡ˆï¼šä½¿ç”¨ `hasPreviousModal` å’Œ `onGoBack` å¯¦ä½œå°èˆªé‚è¼¯

3. âŒ **ç„¡ç¨ç«‹ URL**
   - ç„¡æ³•ç›´æ¥åˆ†äº«ç‰¹å®šåˆŠç™»é€£çµ
   - è§£æ±ºæ–¹æ¡ˆï¼šæœªä¾†å¯é€é URL hash åƒæ•¸å¯¦ä½œï¼ˆå¦‚ `/#listing-12345`ï¼‰

**æ“´å±•æ€§è€ƒé‡**ï¼š

ä¿ç•™æ··åˆæ¶æ§‹çš„å½ˆæ€§ï¼š
- **MVP éšæ®µ**ï¼ˆWeek 9-12ï¼‰ï¼šå®Œå…¨ä½¿ç”¨ Modal æ¨¡å¼
- **å„ªåŒ–éšæ®µ**ï¼ˆå¯é¸ï¼‰ï¼šè‹¥ç™¼ç¾ä»¥ä¸‹æƒ…æ³ï¼Œå¯æ“´å±•ç‚ºç¨ç«‹é é¢
  - è³£å®¶éœ€è¦ç®¡ç†å¤§é‡åˆŠç™»ï¼ˆ> 10 å€‹ï¼‰
  - éœ€è¦è¤‡é›œçš„å¸‚å ´åˆ†æä»‹é¢
  - éœ€è¦ SEO å‹å–„çš„å¸‚å ´é é¢

**å¯¦ä½œæŒ‡å—**ï¼š

```typescript
// src/components/trade/CreateListingModal.tsx
import { BaseModal } from '@/components/common/BaseModal'

export function CreateListingModal({ isOpen, onClose }: Props) {
  return (
    <BaseModal isOpen={isOpen} onClose={onClose} maxWidth="max-w-2xl">
      {/* åˆŠç™»è¡¨å–® */}
    </BaseModal>
  )
}

// src/components/trade/MarketBrowserModal.tsx
export function MarketBrowserModal({ isOpen, onClose }: Props) {
  const [selectedListing, setSelectedListing] = useState<string | null>(null)

  return (
    <>
      <BaseModal isOpen={isOpen} onClose={onClose} maxWidth="max-w-6xl">
        {/* å¸‚å ´åˆ—è¡¨ */}
      </BaseModal>

      {/* åˆŠç™»è©³æƒ…å­ Modal */}
      {selectedListing && (
        <ListingDetailModal
          isOpen={!!selectedListing}
          onClose={() => setSelectedListing(null)}
          onGoBack={() => setSelectedListing(null)}
          hasPreviousModal
        />
      )}
    </>
  )
}
```

**çµæœ**ï¼š
- ç¬¦åˆå°ˆæ¡ˆä¸€è‡´æ€§åŸå‰‡ï¼ˆé‡ç”¨ç¾æœ‰æ¶æ§‹ï¼‰
- ç¯€çœ Vercel æˆæœ¬ï¼ˆFunction Time -67%ï¼ŒBandwidth -5%ï¼‰
- åŠ å¿« MVP é–‹ç™¼é€Ÿåº¦ï¼ˆé ä¼°ç¯€çœ 1-2 é€±ï¼‰
- ä¿ç•™æœªä¾†æ“´å±•ç‚ºç¨ç«‹é é¢çš„é¸é …

**åƒè€ƒè³‡æ–™**ï¼š
- [æˆæœ¬é ä¼° - Vercel Functions åŸ·è¡Œæ™‚é–“åˆ†æ](#vercel-functions-åŸ·è¡Œæ™‚é–“åˆ†æ)
- [å¯¦ä½œè·¯ç·šåœ– - éšæ®µ 2ï¼šæ ¸å¿ƒåŠŸèƒ½](#éšæ®µ-2æ ¸å¿ƒåŠŸèƒ½ç¬¬-9-12-é€±)

---

### DDR-003ï¼šé¸æ“‡ LoginModal è€Œéç™»å…¥é é¢

**æ—¥æœŸ**ï¼š2025-10-26

**èƒŒæ™¯**ï¼šç”¨æˆ¶éœ€è¦ç™»å…¥æ‰èƒ½ä½¿ç”¨åˆŠç™»å’Œè³¼è²·æ„å‘åŠŸèƒ½ã€‚ç•¶ API è¿”å› 401 Unauthorized æ™‚ï¼Œéœ€è¦å¼•å°ç”¨æˆ¶ç™»å…¥ã€‚

æœ‰å…©ç¨®å¯¦ä½œé¸æ“‡ï¼š
1. **LoginModal**ï¼šåœ¨ä¸»é ä¸Šç–ŠåŠ  Modal é¡¯ç¤ºç™»å…¥æŒ‰éˆ•
2. **ç™»å…¥é é¢**ï¼šç¨ç«‹çš„ `/auth/login` è·¯ç”±é é¢

**æ±ºç­–**ï¼šæ¡ç”¨ LoginModal

**ç†ç”±**ï¼š

1. **ç¬¦åˆ DDR-002 Modal å„ªå…ˆåŸå‰‡** âœ…
   - èˆ‡äº¤æ˜“ç³»çµ± UIï¼ˆCreateListingModalã€MarketBrowserModalï¼‰ä¿æŒä¸€è‡´
   - æ•´å€‹æ‡‰ç”¨çµ±ä¸€ä½¿ç”¨ Modal æ¨¡å¼
   - é™ä½ç”¨æˆ¶å­¸ç¿’æˆæœ¬

2. **æ›´å¥½çš„ç”¨æˆ¶é«”é©—** âœ…
   - ç”¨æˆ¶åœç•™åœ¨ä¸»é ä¸Šä¸‹æ–‡ï¼ˆä¸ä¸­æ–·ç€è¦½æµç¨‹ï¼‰
   - æ¸…æ™°çš„ç™»å…¥èªªæ˜å’Œ Discord OAuth æµç¨‹æç¤º
   - è¦–è¦ºåŒ–çš„è¼‰å…¥ç‹€æ…‹ï¼ˆé˜²æ­¢ç”¨æˆ¶å›°æƒ‘æ–¼è·³è½‰éç¨‹ï¼‰
   - å³æ™‚å›é¥‹ï¼ˆéŒ¯èª¤è¨Šæ¯å¯ä»¥åœ¨ Modal å…§é¡¯ç¤ºï¼‰

3. **ç¬¦åˆæ¶æ§‹è¦æ±‚** âœ…
   - æ»¿è¶³ã€Œè¼‰å…¥ç‹€æ…‹è™•ç†ã€éœ€æ±‚ï¼ˆLine 4213ï¼‰
   - æ»¿è¶³ã€ŒéŒ¯èª¤è¨Šæ¯é¡¯ç¤ºã€éœ€æ±‚ï¼ˆLine 4214ï¼‰
   - æ»¿è¶³ã€Œä½¿ç”¨ Discord ç™»å…¥æŒ‰éˆ•ã€éœ€æ±‚ï¼ˆLine 4212ï¼‰
   - é‡ç”¨ BaseModal åŸºç¤å»ºè¨­

4. **é–‹ç™¼æ•ˆç‡** âœ…
   - ç„¡éœ€å»ºç«‹é¡å¤–è·¯ç”±ï¼ˆç¯€çœé–‹ç™¼æ™‚é–“ï¼‰
   - é‡ç”¨ç¾æœ‰ Modal ç®¡ç†é‚è¼¯
   - èˆ‡å…¶ä»– Modal ä¸€è‡´çš„ç‹€æ…‹ç®¡ç†æ–¹å¼

**æ¬Šè¡¡**ï¼š

1. âŒ **éœ€è¦å…¨å±€ç‹€æ…‹ç®¡ç†**
   - Modal éœ€è¦åœ¨ä»»ä½•åœ°æ–¹éƒ½èƒ½è§¸ç™¼ï¼ˆç•¶ API è¿”å› 401 æ™‚ï¼‰
   - è§£æ±ºæ–¹æ¡ˆï¼šä½¿ç”¨ CustomEvent å¯¦ä½œå…¨å±€è§¸ç™¼æ©Ÿåˆ¶

2. âŒ **ç„¡ç¨ç«‹ URL**
   - ç„¡æ³•ç›´æ¥åˆ†äº«ã€Œç™»å…¥é é¢ã€é€£çµ
   - è§£æ±ºæ–¹æ¡ˆï¼šç”¨æˆ¶éœ€è¦ç™»å…¥æ™‚è‡ªå‹•é¡¯ç¤º Modalï¼ˆé«”é©—æ›´æµæš¢ï¼‰

**å¯¦ä½œè¨­è¨ˆ**ï¼š

```typescript
// src/components/auth/LoginModal.tsx
import { BaseModal } from '@/components/common/BaseModal'
import { useState } from 'react'

interface LoginModalProps {
  isOpen: boolean
  onClose: () => void
}

export function LoginModal({ isOpen, onClose }: LoginModalProps) {
  const [isLoading, setIsLoading] = useState(false)

  const handleDiscordLogin = () => {
    setIsLoading(true)
    // è·³è½‰åˆ° Discord OAuth å•Ÿå‹•ç«¯é»
    window.location.href = '/api/auth/discord'
  }

  return (
    <BaseModal
      isOpen={isOpen}
      onClose={onClose}
      maxWidth="max-w-md"
      preventBackdropClose={isLoading}  // è¼‰å…¥æ™‚é˜²æ­¢é—œé–‰
    >
      <div className="p-8 text-center">
        {/* Discord Logo */}
        <div className="mb-6 flex justify-center">
          <svg className="w-16 h-16 text-[#5865F2]" viewBox="0 0 24 24">
            {/* Discord icon SVG path */}
          </svg>
        </div>

        <h2 className="text-2xl font-bold mb-3 text-gray-900 dark:text-white">
          ç™»å…¥
        </h2>

        <p className="text-gray-600 dark:text-gray-400 mb-6">
          ä½¿ç”¨ Discord å¸³è™Ÿç™»å…¥ä»¥ä½¿ç”¨åˆŠç™»å’Œè³¼è²·æ„å‘åŠŸèƒ½
        </p>

        <button
          onClick={handleDiscordLogin}
          disabled={isLoading}
          className="w-full bg-[#5865F2] hover:bg-[#4752C4]
                     text-white font-semibold rounded-lg py-3 px-4
                     transition-colors duration-200
                     disabled:opacity-50 disabled:cursor-not-allowed
                     flex items-center justify-center gap-2"
        >
          {isLoading ? (
            <>
              <svg className="animate-spin h-5 w-5" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10"
                        stroke="currentColor" strokeWidth="4" fill="none"/>
                <path className="opacity-75" fill="currentColor"
                      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
              </svg>
              <span>è·³è½‰ä¸­...</span>
            </>
          ) : (
            <>
              <svg className="w-5 h-5" viewBox="0 0 24 24">
                {/* Discord icon */}
              </svg>
              <span>ä½¿ç”¨ Discord ç™»å…¥</span>
            </>
          )}
        </button>

        <p className="mt-4 text-xs text-gray-500 dark:text-gray-400">
          ç™»å…¥å³è¡¨ç¤ºæ‚¨åŒæ„æˆ‘å€‘çš„æœå‹™æ¢æ¬¾
        </p>
      </div>
    </BaseModal>
  )
}
```

**è§¸ç™¼æ©Ÿåˆ¶**ï¼š

```typescript
// src/lib/api-client.ts
export async function apiClient(endpoint: string, options = {}) {
  const response = await fetch(endpoint, {
    ...options,
    credentials: 'include'
  })

  if (response.status === 401) {
    // è§¸ç™¼ç™»å…¥ Modal
    const event = new CustomEvent('show-login-modal')
    window.dispatchEvent(event)
    throw new Error('éœ€è¦ç™»å…¥')
  }

  return response.json()
}

// src/app/page.tsx
export default function HomePage() {
  const [isLoginModalOpen, setIsLoginModalOpen] = useState(false)

  useEffect(() => {
    // ç›£è½å…¨å±€ç™»å…¥ Modal è§¸ç™¼äº‹ä»¶
    const handleShowLogin = () => setIsLoginModalOpen(true)
    window.addEventListener('show-login-modal', handleShowLogin)

    return () => {
      window.removeEventListener('show-login-modal', handleShowLogin)
    }
  }, [])

  return (
    <>
      {/* ä¸»é å…§å®¹ */}

      {/* ç™»å…¥ Modal */}
      <LoginModal
        isOpen={isLoginModalOpen}
        onClose={() => setIsLoginModalOpen(false)}
      />
    </>
  )
}
```

**è¦–è¦ºè¨­è¨ˆ**ï¼š
- ä½¿ç”¨ Discord å“ç‰Œè‰² `#5865F2`ï¼ˆä¸»è¦æŒ‰éˆ•ï¼‰
- Hover ç‹€æ…‹ï¼š`#4752C4`ï¼ˆç¨æ·±ï¼‰
- è¼‰å…¥ç‹€æ…‹ï¼šé¡¯ç¤º spinner + ã€Œè·³è½‰ä¸­...ã€æ–‡å­—
- ç¦ç”¨ç‹€æ…‹ï¼š50% é€æ˜åº¦ + ç¦ç”¨æŒ‡æ¨™

**çµæœ**ï¼š
- ç¬¦åˆ Modal å„ªå…ˆè¨­è¨ˆåŸå‰‡ï¼ˆèˆ‡ DDR-002 ä¸€è‡´ï¼‰
- æä¾›å®Œæ•´çš„ç™»å…¥ UXï¼ˆèªªæ˜ã€è¼‰å…¥ã€éŒ¯èª¤è™•ç†ï¼‰
- ä¿æŒæ‡‰ç”¨ UI ä¸€è‡´æ€§ï¼ˆæ‰€æœ‰åŠŸèƒ½å‡ä½¿ç”¨ Modalï¼‰
- ç¯€çœé–‹ç™¼æ™‚é–“ï¼ˆé‡ç”¨ BaseModal åŸºç¤å»ºè¨­ï¼‰

**åƒè€ƒè³‡æ–™**ï¼š
- [DDR-002ï¼šé¸æ“‡ Modal æ¨¡å¼è€Œéç¨ç«‹é é¢](#ddr-002é¸æ“‡-modal-æ¨¡å¼è€Œéç¨ç«‹é é¢)
- [å¯¦ä½œè·¯ç·šåœ– - éšæ®µ 1ï¼šDiscord OAuth èªè­‰](#éšæ®µ-1discord-oauth-èªè­‰ç¬¬-5-8-é€±)

---

### DDR-004ï¼šé¸æ“‡æ”¯æ´ç‰©å“äº¤æ›åŠŸèƒ½

**æ—¥æœŸ**ï¼š2025-10-26

**èƒŒæ™¯**ï¼šç”¨æˆ¶éœ€æ±‚åŒ…å«ä¸‰ç¨®äº¤æ˜“æ–¹å¼ï¼šè²·ã€è³£ã€**äº¤æ›**

**æ±ºç­–**ï¼šåœ¨ MVP éšæ®µå³æ”¯æ´ç‰©å“äº¤æ›åŠŸèƒ½

**ç†ç”±**ï¼š

1. **ç¬¦åˆç”¨æˆ¶éœ€æ±‚** âœ…
   - éŠæˆ²å…§äº¤æ˜“å¸¸è¦‹ã€Œç‰©æ›ç‰©ã€å ´æ™¯
   - é¿å…ç¾é‡‘äº¤æ˜“é¢¨éšª
   - å¢åŠ å¹³å°å¸å¼•åŠ›

2. **æŠ€è¡“å¯è¡Œæ€§é«˜** âœ…
   - è³‡æ–™åº«è¨­è¨ˆç°¡å–®æ“´å±• (trade_type, wanted_item_id)
   - UI è¤‡é›œåº¦å¯æ§ (Tab åˆ‡æ› + ItemSearchInput)
   - æ™ºèƒ½åŒ¹é…ç®—æ³•ç°¡å–® (SQL JOIN å³å¯å¯¦ä½œ)

3. **æˆæœ¬å½±éŸ¿å¯æ§** âœ…
   - Vercel Functions: +10% â†’ ä»åœ¨ 4-5% ä½¿ç”¨ç‡
   - Supabase: +20% â†’ ä»åœ¨ 16-20% ä½¿ç”¨ç‡
   - ç„¡é¡å¤–ä¾è³´å¥—ä»¶

4. **é¿å…å¾ŒçºŒé‡æ§‹** âœ…
   - ä¸€æ¬¡åšåˆ°ä½,é¿å…è³‡æ–™åº« Schema è®Šæ›´
   - é¿å… API ç ´å£æ€§æ›´æ–°
   - é™ä½æŠ€è¡“å‚µ

**å¯¦ä½œè¨­è¨ˆ**ï¼š

**è³‡æ–™åº« Schema**:
```sql
ALTER TABLE listings
  ADD COLUMN trade_type TEXT DEFAULT 'sell' NOT NULL,
  ADD COLUMN wanted_item_id INT,
  ADD COLUMN wanted_quantity INT DEFAULT 1,
  ADD CONSTRAINT valid_trade_type CHECK (
    trade_type IN ('sell', 'buy', 'exchange')
  ),
  ADD CONSTRAINT exchange_requires_wanted_item CHECK (
    (trade_type = 'exchange' AND wanted_item_id IS NOT NULL) OR
    (trade_type != 'exchange')
  );
```

**æ™ºèƒ½åŒ¹é…ç®—æ³•**:
```sql
-- æˆ‘æœ‰ A æƒ³è¦ B,æ‰¾å‡ºæœ‰ B æƒ³è¦ A çš„åˆŠç™»
SELECT l2.*
FROM listings l1
JOIN listings l2 ON
  l1.item_id = l2.wanted_item_id AND
  l1.wanted_item_id = l2.item_id
WHERE
  l1.id = $listing_id AND
  l1.trade_type = 'exchange' AND
  l2.trade_type = 'exchange' AND
  l1.status = 'active' AND
  l2.status = 'active' AND
  l1.user_id != l2.user_id
```

**UI è¨­è¨ˆ**:
```typescript
// CreateListingModal - ä¸‰ç¨®æ¨¡å¼åˆ‡æ›
<button onClick={() => setTradeType('sell')}>æˆ‘è¦è²©å”®</button>
<button onClick={() => setTradeType('buy')}>æˆ‘è¦æ”¶è³¼</button>
<button onClick={() => setTradeType('exchange')}>æˆ‘è¦äº¤æ›</button>

// äº¤æ›æ¨¡å¼éœ€é¸æ“‡å…©å€‹ç‰©å“
{tradeType === 'exchange' && (
  <>
    <ItemSearchInput label="æˆ‘æœ‰çš„ç‰©å“" onSelect={setItem} />
    <ItemSearchInput label="æˆ‘æƒ³è¦çš„ç‰©å“" onSelect={setWantedItem}
                     excludeItemId={item?.itemId} />
  </>
)}
```

**çµæœ**ï¼š
- âœ… æä¾›å®Œæ•´çš„äº¤æ˜“é«”é©— (è²·/è³£/äº¤æ›)
- âœ… ç¬¦åˆéŠæˆ²ç¤¾ç¾¤ç¿’æ…£
- âœ… æŠ€è¡“å¯¦ä½œç°¡å–®
- âœ… æˆæœ¬å¯æ§ (å…è²»é¡åº¦å…§)
- âœ… é¿å…å¾ŒçºŒæŠ€è¡“å‚µ

**åƒè€ƒè³‡æ–™**ï¼š
- [02-èªè­‰èˆ‡è³‡æ–™åº« - listings è¡¨è¨­è¨ˆ](./02-èªè­‰èˆ‡è³‡æ–™åº«.md#5-ç‰©å“åˆŠç™»è¡¨-listings)
- [03-APIè¨­è¨ˆ - äº¤æ›åŒ¹é… API](./03-APIè¨­è¨ˆ.md#get-apimarketexchange-matches---å°‹æ‰¾äº¤æ›åŒ¹é…-new)
- [10-ç‰©å“æ•´åˆè¨­è¨ˆ - ItemSearchInput](./10-ç‰©å“æ•´åˆè¨­è¨ˆ.md#itemsearchinput-å…ƒä»¶è¨­è¨ˆ)

---

*ï¼ˆæ¶æ§‹æ–‡ä»¶å®Œæˆï¼‰*

---

## ğŸ“š å°èˆª

[â† ä¸Šä¸€ç¯‡:å¯¦ä½œè·¯ç·šåœ–](./08-å¯¦ä½œè·¯ç·šåœ–.md) | [ğŸ  è¿”å›ç›®éŒ„](./README.md) | [ä¸‹ä¸€ç¯‡:ç‰©å“æ•´åˆè¨­è¨ˆ â†’](./10-ç‰©å“æ•´åˆè¨­è¨ˆ.md)
