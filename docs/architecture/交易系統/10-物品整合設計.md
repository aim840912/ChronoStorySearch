# ç‰©å“æ•´åˆè¨­è¨ˆ

> **æœ€å¾Œæ›´æ–°**ï¼š2025-10-26

---

## ğŸ“š å°èˆª

[â† ä¸Šä¸€ç¯‡:è¨­è¨ˆæ±ºç­–è¨˜éŒ„](./09-è¨­è¨ˆæ±ºç­–è¨˜éŒ„.md) | [ğŸ  è¿”å›ç›®éŒ„](./README.md)

---

## ç›®éŒ„

1. [ç‰©å“è³‡æ–™ä¾†æº](#ç‰©å“è³‡æ–™ä¾†æº)
2. [ItemSearchInput å…ƒä»¶è¨­è¨ˆ](#itemsearchinput-å…ƒä»¶è¨­è¨ˆ)
3. [ç‰©å“é¸æ“‡æµç¨‹](#ç‰©å“é¸æ“‡æµç¨‹)
4. [ç‰©å“è³‡æ–™å¿«å–ç­–ç•¥](#ç‰©å“è³‡æ–™å¿«å–ç­–ç•¥)
5. [åœ–ç‰‡é¡¯ç¤ºæ•´åˆ](#åœ–ç‰‡é¡¯ç¤ºæ•´åˆ)

---

## ç‰©å“è³‡æ–™ä¾†æº

### ç¾æœ‰è³‡æ–™çµæ§‹

å°ˆæ¡ˆå·²æœ‰å®Œæ•´çš„ç‰©å“è³‡æ–™çµæ§‹ï¼š

```typescript
// src/types/index.ts

export interface ExtendedUniqueItem {
  itemId: number
  itemName: string
  chineseItemName?: string | null
  monsterCount: number
  source: ItemSource
}

export interface ItemSource {
  fromDrops: boolean
  fromGacha: boolean
  gachaMachines?: Array<{
    machineId: number
    machineName: string
    chineseMachineName?: string
    probability: string
  }>
}
```

### è³‡æ–™å–å¾—æ–¹å¼

ç‰©å“è³‡æ–™å·²è¼‰å…¥è‡³å‰ç«¯ï¼Œå¯é€éä»¥ä¸‹æ–¹å¼å­˜å–ï¼š

```typescript
// å…¨åŸŸç‰©å“åˆ—è¡¨ï¼ˆå‡è¨­å·²å¾ JSON è¼‰å…¥ï¼‰
const allItems: ExtendedUniqueItem[] = [...]

// æ ¹æ“š ID æŸ¥è©¢ç‰©å“
export function getItemById(itemId: number): ExtendedUniqueItem | undefined {
  return allItems.find(item => item.itemId === itemId)
}

// æ ¹æ“šåç¨±æœå°‹ç‰©å“
export function searchItems(query: string): ExtendedUniqueItem[] {
  const lowerQuery = query.toLowerCase()
  return allItems.filter(item =>
    item.itemName.toLowerCase().includes(lowerQuery) ||
    item.chineseItemName?.toLowerCase().includes(lowerQuery)
  )
}
```

---

## ItemSearchInput å…ƒä»¶è¨­è¨ˆ

### åŠŸèƒ½éœ€æ±‚

1. **å³æ™‚æœå°‹**: è¼¸å…¥æ™‚å³æ™‚é¡¯ç¤ºå»ºè­°
2. **æ”¯æ´ä¸­è‹±æ–‡**: åŒæ™‚æœå°‹ itemName å’Œ chineseItemName
3. **é¡¯ç¤ºç‰©å“åœ–ç‰‡**: æ•´åˆ Cloudflare R2 åœ–ç‰‡
4. **é¸æ“‡ç¢ºèª**: é»é¸ç‰©å“å¾Œå¡«å…¥è¡¨å–®

### å…ƒä»¶ä»‹é¢

```typescript
// src/components/trade/ItemSearchInput.tsx

interface ItemSearchInputProps {
  value?: ExtendedUniqueItem | null
  onSelect: (item: ExtendedUniqueItem) => void
  placeholder?: string
  disabled?: boolean
  excludeItemId?: number  // æ’é™¤ç‰¹å®šç‰©å“ï¼ˆäº¤æ›åŠŸèƒ½ç”¨ï¼‰
}

export function ItemSearchInput({
  value,
  onSelect,
  placeholder = 'æœå°‹ç‰©å“...',
  disabled = false,
  excludeItemId
}: ItemSearchInputProps) {
  // å¯¦ä½œç´°ç¯€è¦‹ä¸‹æ–¹
}
```

### å¯¦ä½œç¯„ä¾‹

```typescript
'use client'

import { useState, useEffect, useRef } from 'react'
import { ExtendedUniqueItem } from '@/types'
import { searchItems, getItemById } from '@/lib/items'
import { getItemImageUrl } from '@/lib/cloudflare-r2'

export function ItemSearchInput({
  value,
  onSelect,
  placeholder = 'æœå°‹ç‰©å“...',
  disabled = false,
  excludeItemId
}: ItemSearchInputProps) {
  const [query, setQuery] = useState('')
  const [suggestions, setSuggestions] = useState<ExtendedUniqueItem[]>([])
  const [isOpen, setIsOpen] = useState(false)
  const inputRef = useRef<HTMLInputElement>(null)

  // å³æ™‚æœå°‹
  useEffect(() => {
    if (query.length >= 2) {
      const results = searchItems(query)
        .filter(item => item.itemId !== excludeItemId)
        .slice(0, 10)  // æœ€å¤šé¡¯ç¤º 10 å€‹å»ºè­°
      setSuggestions(results)
      setIsOpen(true)
    } else {
      setSuggestions([])
      setIsOpen(false)
    }
  }, [query, excludeItemId])

  const handleSelect = (item: ExtendedUniqueItem) => {
    onSelect(item)
    setQuery('')
    setIsOpen(false)
  }

  return (
    <div className="relative">
      {/* å·²é¸æ“‡çš„ç‰©å“é¡¯ç¤º */}
      {value && (
        <div className="flex items-center gap-3 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg mb-2">
          <img
            src={getItemImageUrl(value.itemId)}
            alt={value.itemName}
            className="w-10 h-10"
          />
          <div className="flex-1">
            <p className="font-semibold">
              {value.chineseItemName || value.itemName}
            </p>
            <p className="text-sm text-gray-500">ID: {value.itemId}</p>
          </div>
          <button
            onClick={() => onSelect(null)}
            className="text-red-600 hover:text-red-800"
          >
            ç§»é™¤
          </button>
        </div>
      )}

      {/* æœå°‹è¼¸å…¥æ¡† */}
      {!value && (
        <>
          <input
            ref={inputRef}
            type="text"
            value={query}
            onChange={(e) => setQuery(e.target.value)}
            placeholder={placeholder}
            disabled={disabled}
            className="w-full px-4 py-2 border rounded-lg
                       focus:ring-2 focus:ring-blue-500
                       dark:bg-gray-800 dark:border-gray-600"
          />

          {/* å»ºè­°åˆ—è¡¨ */}
          {isOpen && suggestions.length > 0 && (
            <div className="absolute z-10 w-full mt-1 bg-white dark:bg-gray-800
                            border rounded-lg shadow-lg max-h-60 overflow-y-auto">
              {suggestions.map((item) => (
                <button
                  key={item.itemId}
                  onClick={() => handleSelect(item)}
                  className="w-full flex items-center gap-3 p-3 hover:bg-gray-100
                             dark:hover:bg-gray-700 text-left"
                >
                  <img
                    src={getItemImageUrl(item.itemId)}
                    alt={item.itemName}
                    className="w-8 h-8"
                  />
                  <div>
                    <p className="font-medium">
                      {item.chineseItemName || item.itemName}
                    </p>
                    <p className="text-xs text-gray-500">
                      {item.itemName} (ID: {item.itemId})
                    </p>
                  </div>
                </button>
              ))}
            </div>
          )}
        </>
      )}
    </div>
  )
}
```

---

## ç‰©å“é¸æ“‡æµç¨‹

### CreateListingModal æ•´åˆ

```typescript
// src/components/trade/CreateListingModal.tsx

export function CreateListingModal({ isOpen, onClose }: Props) {
  const [tradeType, setTradeType] = useState<'sell' | 'buy' | 'exchange'>('sell')
  const [selectedItem, setSelectedItem] = useState<ExtendedUniqueItem | null>(null)
  const [wantedItem, setWantedItem] = useState<ExtendedUniqueItem | null>(null)

  return (
    <BaseModal isOpen={isOpen} onClose={onClose} maxWidth="max-w-2xl">
      <div className="p-6">
        <h2 className="text-2xl font-bold mb-4">å»ºç«‹åˆŠç™»</h2>

        {/* äº¤æ˜“é¡å‹é¸æ“‡ */}
        <div className="flex gap-2 mb-6">
          {/* ... é¡å‹æŒ‰éˆ• ... */}
        </div>

        {/* æ­¥é©Ÿ 1: é¸æ“‡ç‰©å“ */}
        <div className="mb-6">
          <label className="block mb-2 font-semibold">
            {tradeType === 'sell' && 'æˆ‘è¦è²©å”®çš„ç‰©å“'}
            {tradeType === 'buy' && 'æˆ‘è¦æ”¶è³¼çš„ç‰©å“'}
            {tradeType === 'exchange' && 'æˆ‘æœ‰çš„ç‰©å“'}
          </label>
          <ItemSearchInput
            value={selectedItem}
            onSelect={setSelectedItem}
            placeholder="æœå°‹ç‰©å“åç¨±..."
          />
        </div>

        {/* æ­¥é©Ÿ 2: äº¤æ›æ¨¡å¼é¡å¤–é¸æ“‡æƒ³è¦çš„ç‰©å“ */}
        {tradeType === 'exchange' && (
          <div className="mb-6">
            <label className="block mb-2 font-semibold">
              æˆ‘æƒ³è¦çš„ç‰©å“
            </label>
            <ItemSearchInput
              value={wantedItem}
              onSelect={setWantedItem}
              placeholder="æœå°‹æƒ³äº¤æ›çš„ç‰©å“..."
              excludeItemId={selectedItem?.itemId}  // æ’é™¤å·²é¸çš„ç‰©å“
            />
          </div>
        )}

        {/* æ­¥é©Ÿ 3: å…¶ä»–è³‡è¨Šï¼ˆåƒ¹æ ¼/æ•¸é‡/è¯çµ¡æ–¹å¼ï¼‰ */}
        {/* ... */}
      </div>
    </BaseModal>
  )
}
```

---

## ç‰©å“è³‡æ–™å¿«å–ç­–ç•¥

### å®¢æˆ¶ç«¯å¿«å–

ç‰©å“è³‡æ–™å·²åœ¨å‰ç«¯è¼‰å…¥ï¼Œç„¡éœ€é¡å¤– API è«‹æ±‚ï¼š

```typescript
// src/lib/items.ts

// å‡è¨­ç‰©å“è³‡æ–™å·²å¾ public/data/items.json è¼‰å…¥
let cachedItems: ExtendedUniqueItem[] | null = null

export async function loadItems(): Promise<ExtendedUniqueItem[]> {
  if (cachedItems) {
    return cachedItems
  }

  const response = await fetch('/data/items.json')
  cachedItems = await response.json()
  return cachedItems
}

export function getItemById(itemId: number): ExtendedUniqueItem | undefined {
  if (!cachedItems) {
    throw new Error('Items not loaded. Call loadItems() first.')
  }
  return cachedItems.find(item => item.itemId === itemId)
}
```

### æ•ˆèƒ½å„ªåŒ–

1. **é è¼‰å…¥**: åœ¨æ‡‰ç”¨å•Ÿå‹•æ™‚è¼‰å…¥ç‰©å“è³‡æ–™
2. **è¨˜æ†¶é«”å¿«å–**: ç‰©å“è³‡æ–™å¸¸é§è¨˜æ†¶é«”
3. **ç´¢å¼•å„ªåŒ–**: å»ºç«‹ itemId â†’ Item çš„ Map åŠ é€ŸæŸ¥è©¢

```typescript
// å»ºç«‹ç´¢å¼•åŠ é€ŸæŸ¥è©¢
const itemsMap = new Map<number, ExtendedUniqueItem>()
cachedItems.forEach(item => itemsMap.set(item.itemId, item))

export function getItemById(itemId: number): ExtendedUniqueItem | undefined {
  return itemsMap.get(itemId)
}
```

---

## åœ–ç‰‡é¡¯ç¤ºæ•´åˆ

### Cloudflare R2 æ•´åˆ

å°ˆæ¡ˆå·²æ•´åˆ Cloudflare R2 å„²å­˜åœ–ç‰‡ï¼š

```typescript
// src/lib/cloudflare-r2.ts

const R2_PUBLIC_URL = 'https://pub-xxxxx.r2.dev'

export function getItemImageUrl(itemId: number): string {
  return `${R2_PUBLIC_URL}/images/items/${itemId}.png`
}

export function getItemIconUrl(itemId: number): string {
  return `${R2_PUBLIC_URL}/images/items/icons/${itemId}.png`
}
```

### åœ–ç‰‡è¼‰å…¥æœ€ä½³åŒ–

```typescript
// ä½¿ç”¨ Next.js Image å…ƒä»¶
import Image from 'next/image'

export function ItemImage({ itemId, size = 'medium' }: Props) {
  const sizeMap = {
    small: 32,
    medium: 64,
    large: 128
  }

  return (
    <Image
      src={getItemImageUrl(itemId)}
      alt={`Item ${itemId}`}
      width={sizeMap[size]}
      height={sizeMap[size]}
      loading="lazy"
      placeholder="blur"
      blurDataURL="/images/item-placeholder.png"
    />
  )
}
```

---

## MarketBrowserModal ç‰©å“é¡¯ç¤º

### åˆŠç™»åˆ—è¡¨æ•´åˆ

```typescript
// src/components/trade/MarketBrowserModal.tsx

export function MarketBrowserModal({ isOpen, onClose }: Props) {
  const [listings, setListings] = useState<Listing[]>([])

  // å®¢æˆ¶ç«¯åˆä½µç‰©å“è³‡è¨Š
  const enrichedListings = listings.map(listing => ({
    ...listing,
    itemInfo: getItemById(listing.item_id),
    wantedItemInfo: listing.wanted_item_id
      ? getItemById(listing.wanted_item_id)
      : null
  }))

  return (
    <BaseModal isOpen={isOpen} onClose={onClose} maxWidth="max-w-6xl">
      <div className="p-6">
        <h2 className="text-2xl font-bold mb-4">å¸‚å ´</h2>

        {/* Tab åˆ‡æ› */}
        <div className="flex gap-2 mb-4">
          <button>å…¨éƒ¨</button>
          <button>è²©å”®</button>
          <button>æ”¶è³¼</button>
          <button>äº¤æ›</button>
        </div>

        {/* åˆŠç™»åˆ—è¡¨ */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {enrichedListings.map((listing) => (
            <div key={listing.id} className="border rounded-lg p-4">
              {/* ç‰©å“åœ–ç‰‡ */}
              <img
                src={getItemImageUrl(listing.itemInfo?.itemId)}
                alt={listing.itemInfo?.itemName}
                className="w-16 h-16 mx-auto mb-2"
              />

              {/* ç‰©å“åç¨± */}
              <h3 className="text-center font-semibold">
                {listing.itemInfo?.chineseItemName || listing.itemInfo?.itemName}
              </h3>

              {/* äº¤æ›é¡¯ç¤º */}
              {listing.trade_type === 'exchange' && listing.wantedItemInfo && (
                <div className="flex items-center justify-center gap-2 mt-2">
                  <span>â‡„</span>
                  <img
                    src={getItemImageUrl(listing.wantedItemInfo.itemId)}
                    alt={listing.wantedItemInfo.itemName}
                    className="w-12 h-12"
                  />
                </div>
              )}

              {/* åƒ¹æ ¼/æ•¸é‡ */}
              {listing.price && (
                <p className="text-center text-lg font-bold text-blue-600">
                  {listing.price.toLocaleString()} æ¥“å¹£
                </p>
              )}
            </div>
          ))}
        </div>
      </div>
    </BaseModal>
  )
}
```

---

## ç‰©å“ ID é©—è­‰

### å¾Œç«¯é©—è­‰é‚è¼¯

```typescript
// src/lib/items/validate.ts

export function validateItemId(itemId: number): boolean {
  // æª¢æŸ¥ itemId æ˜¯å¦å­˜åœ¨æ–¼éŠæˆ²è³‡æ–™ä¸­
  const item = getItemById(itemId)
  return item !== undefined
}

// API ä½¿ç”¨ç¯„ä¾‹
export async function createListing(data: CreateListingInput) {
  // é©—è­‰ item_id
  if (!validateItemId(data.item_id)) {
    throw new ValidationError('ç‰©å“ ID ä¸å­˜åœ¨')
  }

  // é©—è­‰ wanted_item_idï¼ˆäº¤æ›æ¨¡å¼ï¼‰
  if (data.trade_type === 'exchange' && data.wanted_item_id) {
    if (!validateItemId(data.wanted_item_id)) {
      throw new ValidationError('æƒ³è¦çš„ç‰©å“ ID ä¸å­˜åœ¨')
    }
  }

  // å»ºç«‹åˆŠç™»...
}
```

---

## ç¸½çµ

### æ•´åˆè¦é»

1. âœ… **é‡ç”¨ç¾æœ‰è³‡æ–™**: ä½¿ç”¨ ExtendedUniqueItem
2. âœ… **å®¢æˆ¶ç«¯å¿«å–**: ç‰©å“è³‡æ–™å·²è¼‰å…¥,ç„¡éœ€é¡å¤– API
3. âœ… **Cloudflare R2**: æ•´åˆç¾æœ‰åœ–ç‰‡å„²å­˜
4. âœ… **ItemSearchInput**: é€šç”¨ç‰©å“æœå°‹å…ƒä»¶
5. âœ… **ID é©—è­‰**: å¾Œç«¯é©—è­‰ç‰©å“ ID åˆæ³•æ€§

### é–‹ç™¼æª¢æŸ¥æ¸…å–®

- [ ] å»ºç«‹ ItemSearchInput å…ƒä»¶
- [ ] å»ºç«‹ getItemById, searchItems å·¥å…·å‡½æ•¸
- [ ] åœ¨ CreateListingModal æ•´åˆç‰©å“é¸æ“‡
- [ ] åœ¨ MarketBrowserModal é¡¯ç¤ºç‰©å“åœ–ç‰‡
- [ ] å¯¦ä½œå¾Œç«¯ validateItemId å‡½æ•¸
- [ ] æ¸¬è©¦ä¸­è‹±æ–‡æœå°‹
- [ ] æ¸¬è©¦äº¤æ›æ¨¡å¼æ’é™¤å·²é¸ç‰©å“

---

## ğŸ“š å°èˆª

[â† ä¸Šä¸€ç¯‡:è¨­è¨ˆæ±ºç­–è¨˜éŒ„](./09-è¨­è¨ˆæ±ºç­–è¨˜éŒ„.md) | [ğŸ  è¿”å›ç›®éŒ„](./README.md)
