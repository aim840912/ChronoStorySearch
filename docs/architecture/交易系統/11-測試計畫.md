# æ¸¬è©¦è¨ˆç•«

> **å»ºç«‹æ—¥æœŸ**ï¼š2025-10-27
> **ç›®æ¨™**ï¼šç¢ºä¿äº¤æ˜“ç³»çµ±çš„ç©©å®šæ€§ã€å®‰å…¨æ€§èˆ‡æ•ˆèƒ½

---

## ğŸ“š å°èˆª

[â† ä¸Šä¸€ç¯‡:ç‰©å“æ•´åˆè¨­è¨ˆ](./10-ç‰©å“æ•´åˆè¨­è¨ˆ.md) | [ğŸ  è¿”å›ç›®éŒ„](./README.md)

---

## æ¸¬è©¦æ¦‚è¦½

### æ¸¬è©¦å±¤ç´š

| å±¤ç´š | ç¯„åœ | å·¥å…· | ç‹€æ…‹ |
|------|------|------|------|
| **å–®å…ƒæ¸¬è©¦** | ç¨ç«‹å‡½æ•¸èˆ‡å·¥å…· | Jest / Vitest | â³ å¾…å¯¦ä½œ |
| **æ•´åˆæ¸¬è©¦** | API ç«¯é»èˆ‡è³‡æ–™åº« | Postman / æ‰‹å‹•æ¸¬è©¦ | âœ… é€²è¡Œä¸­ |
| **ç«¯åˆ°ç«¯æ¸¬è©¦** | å®Œæ•´ä½¿ç”¨è€…æµç¨‹ | Playwright | â³ å¾…è¦åŠƒ |
| **æ•ˆèƒ½æ¸¬è©¦** | API å›æ‡‰æ™‚é–“èˆ‡è² è¼‰ | Apache Bench | â³ å¾…åŸ·è¡Œ |
| **å®‰å…¨æ¸¬è©¦** | èªè­‰ã€æˆæ¬Šã€RLS | æ‰‹å‹•æª¢æŸ¥ | âœ… é€²è¡Œä¸­ |

### æ¸¬è©¦å„ªå…ˆç´š

ğŸ”´ **Critical**ï¼ˆå¿…é ˆå®Œæˆï¼‰ï¼š
- Discord OAuth ç™»å…¥æµç¨‹
- åˆŠç™»ç³»çµ± CRUD
- å¸‚å ´ç€è¦½èˆ‡æœå°‹
- è³¼è²·æ„å‘èˆ‡è¯çµ¡

ğŸŸ¡ **Important**ï¼ˆé‡è¦ä½†éç·Šæ€¥ï¼‰ï¼š
- æ•ˆèƒ½åŸºæº–æ¸¬è©¦
- RLS ç­–ç•¥é©—è­‰
- é…é¡é™åˆ¶æ¸¬è©¦

ğŸŸ¢ **Nice to Have**ï¼ˆæ”¹å–„é …ç›®ï¼‰ï¼š
- è‡ªå‹•åŒ–æ¸¬è©¦å¥—ä»¶
- å£“åŠ›æ¸¬è©¦
- å®‰å…¨æ»²é€æ¸¬è©¦

---

## 1ï¸âƒ£ ä½¿ç”¨è€…æ—…ç¨‹æ¸¬è©¦

### æ¸¬è©¦æƒ…å¢ƒ 1ï¼šDiscord OAuth ç™»å…¥æµç¨‹

#### æ¸¬è©¦æ­¥é©Ÿ

```markdown
1. è¨ªå•é¦–é ï¼ˆhttp://localhost:3000ï¼‰
2. é»æ“Šã€Œç™»å…¥ã€æŒ‰éˆ•
3. é©—è­‰é‡å°å‘è‡³ Discord OAuth æˆæ¬Šé é¢
   - æª¢æŸ¥ URL åŒ…å«æ­£ç¢ºçš„ client_id
   - æª¢æŸ¥ URL åŒ…å« state åƒæ•¸
4. åœ¨ Discord é é¢é»æ“Šã€Œæˆæ¬Šã€
5. é©—è­‰å›èª¿è‡³ /api/auth/discord/callback
6. é©—è­‰é‡å°å‘å›é¦–é 
7. é©—è­‰ä½¿ç”¨è€…è³‡è¨Šé¡¯ç¤ºæ­£ç¢ºï¼ˆDiscord é ­åƒèˆ‡åç¨±ï¼‰
```

#### é æœŸçµæœ

âœ… **Cookie è¨­å®š**ï¼š
- åç¨±ï¼š`maplestory_session`
- å±¬æ€§ï¼šHttpOnly, Secure (production), SameSite=Lax
- æœ‰æ•ˆæœŸï¼š30 å¤©

âœ… **Redis ç‹€æ…‹**ï¼š
- State token å·²åˆªé™¤ï¼ˆä¸€æ¬¡æ€§ä½¿ç”¨ï¼‰
- Session è³‡æ–™å·²å„²å­˜

âœ… **è³‡æ–™åº«ç‹€æ…‹**ï¼š
- `users` è¡¨ï¼šæ–°å¢/æ›´æ–°ä½¿ç”¨è€…è¨˜éŒ„
- `discord_profiles` è¡¨ï¼šæ–°å¢/æ›´æ–° Discord è³‡æ–™
- `sessions` è¡¨ï¼šæ–°å¢ Session è¨˜éŒ„ï¼ˆåŠ å¯†çš„ access_token å’Œ refresh_tokenï¼‰

#### éŒ¯èª¤æƒ…å¢ƒæ¸¬è©¦

âŒ **ç„¡æ•ˆ state**ï¼š
- æ‰‹å‹•ä¿®æ”¹ state åƒæ•¸
- é æœŸï¼šè¿”å› 400 ValidationError "Invalid state"

âŒ **éæœŸ stateï¼ˆ> 10 åˆ†é˜ï¼‰**ï¼š
- ç­‰å¾… 11 åˆ†é˜å¾Œå®Œæˆæˆæ¬Š
- é æœŸï¼šè¿”å› 400 ValidationError "Invalid state"

âŒ **é‡è¤‡ä½¿ç”¨ state**ï¼š
- è¤‡è£½å›èª¿ URL ä¸¦å†æ¬¡è¨ªå•
- é æœŸï¼šè¿”å› 400 ValidationError "Invalid state"

âŒ **è¢«å°é–ä½¿ç”¨è€…**ï¼š
- ä½¿ç”¨è¢«å°é–çš„å¸³è™Ÿç™»å…¥
- é æœŸï¼šè¿”å› 403 ä¸¦é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯

#### æ¸¬è©¦æª¢æŸ¥æ¸…å–®

- [ ] OAuth æµç¨‹å®Œæ•´é‹ä½œ
- [ ] State token CSRF é˜²è­·æœ‰æ•ˆ
- [ ] Cookie å®‰å…¨ flags æ­£ç¢º
- [ ] Session è³‡æ–™æ­£ç¢ºå„²å­˜
- [ ] éŒ¯èª¤æƒ…å¢ƒæ­£ç¢ºè™•ç†

---

### æ¸¬è©¦æƒ…å¢ƒ 2ï¼šå»ºç«‹åˆŠç™»æµç¨‹

#### æ¸¬è©¦æ­¥é©Ÿ

```markdown
1. ç™»å…¥å¾Œé»æ“Šã€Œå»ºç«‹åˆŠç™»ã€æŒ‰éˆ•
2. é¸æ“‡äº¤æ˜“é¡å‹ï¼ˆsell / buy / exchangeï¼‰
3. åœ¨ç‰©å“æœå°‹æ¡†è¼¸å…¥ã€Œå± é¾åˆ€ã€
4. å¾å»ºè­°åˆ—è¡¨é¸æ“‡ç‰©å“
5. å¡«å¯«æ•¸é‡ï¼š1
6. å¡«å¯«åƒ¹æ ¼ï¼š50,000,000
7. ï¼ˆå¯é¸ï¼‰å±•é–‹ç‰©å“å±¬æ€§å€å¡Š
8. ï¼ˆå¯é¸ï¼‰å¡«å¯«ç‰©æ”»ï¼š95ï¼ŒåŠ›é‡ï¼š10
9. é¸æ“‡è¯çµ¡æ–¹å¼ï¼šDiscordï¼ˆæ‡‰è‡ªå‹•å¡«å……ï¼‰
10. é»æ“Šã€Œå»ºç«‹ã€æŒ‰éˆ•
```

#### é æœŸçµæœ

âœ… **API è«‹æ±‚**ï¼š
```json
POST /api/listings
Content-Type: application/json

{
  "trade_type": "sell",
  "item_id": 1302081,
  "quantity": 1,
  "price": 50000000,
  "contact_method": "discord",
  "contact_info": "TestUser#1234",
  "item_stats": {
    "watk": 95,
    "str": 10
  }
}
```

âœ… **API å›æ‡‰ï¼ˆ201 Createdï¼‰**ï¼š
```json
{
  "success": true,
  "data": {
    "id": 123,
    "user_id": "uuid...",
    "trade_type": "sell",
    "item_id": 1302081,
    "quantity": 1,
    "price": 50000000,
    "status": "active",
    "item_stats": {
      "watk": 95,
      "str": 10
    },
    "stats_grade": "A",
    "stats_score": 85,
    "created_at": "2025-10-27T..."
  },
  "message": "å»ºç«‹æˆåŠŸ"
}
```

âœ… **å‰ç«¯è¡Œç‚º**ï¼š
- Modal é—œé–‰
- é¡¯ç¤ºæˆåŠŸè¨Šæ¯
- åˆ·æ–°åˆŠç™»åˆ—è¡¨ï¼ˆå¦‚æœåœ¨ã€Œæˆ‘çš„åˆŠç™»ã€é é¢ï¼‰

#### é‚Šç•Œæ¸¬è©¦

âŒ **è¶…éé…é¡ï¼ˆ50 å€‹æ´»èºåˆŠç™»ï¼‰**ï¼š
- å»ºç«‹ 50 å€‹åˆŠç™»å¾Œå˜—è©¦å»ºç«‹ç¬¬ 51 å€‹
- é æœŸï¼š400 ValidationError "é…é¡å·²æ»¿ï¼ˆ50/50ï¼‰"

âŒ **åƒ¹æ ¼ â‰¤ 0**ï¼š
- è¼¸å…¥ price: -1000
- é æœŸï¼š400 ValidationError "åƒ¹æ ¼å¿…é ˆå¤§æ–¼ 0"

âŒ **æ•¸é‡ â‰¤ 0**ï¼š
- è¼¸å…¥ quantity: 0
- é æœŸï¼š400 ValidationError "æ•¸é‡å¿…é ˆå¤§æ–¼ 0"

âŒ **Exchange æ¨¡å¼ç¼ºå°‘ wanted_item_id**ï¼š
- é¸æ“‡ exchange ä½†æœªé¸æ“‡æƒ³è¦çš„ç‰©å“
- é æœŸï¼š400 ValidationError "äº¤æ›æ¨¡å¼éœ€è¦é¸æ“‡æƒ³è¦çš„ç‰©å“"

âŒ **ç„¡æ•ˆçš„ item_stats**ï¼š
- è¼¸å…¥ watk: "abc"
- é æœŸï¼š400 ValidationError "ç‰©æ”»å¿…é ˆæ˜¯æ•¸å­—"

#### æ¸¬è©¦æª¢æŸ¥æ¸…å–®

- [ ] è¡¨å–®é©—è­‰æ­£ç¢º
- [ ] API è«‹æ±‚æ ¼å¼æ­£ç¢º
- [ ] é…é¡é™åˆ¶ç”Ÿæ•ˆ
- [ ] ç‰©å“å±¬æ€§è¨ˆç®—æ­£ç¢ºï¼ˆgrade, scoreï¼‰
- [ ] éŒ¯èª¤è¨Šæ¯å‹å–„ä¸”æº–ç¢º

---

### æ¸¬è©¦æƒ…å¢ƒ 3ï¼šç€è¦½å¸‚å ´èˆ‡ç¯©é¸

#### æ¸¬è©¦æ­¥é©Ÿ

```markdown
1. é€²å…¥å¸‚å ´ç€è¦½é é¢
2. æ¸¬è©¦äº¤æ˜“é¡å‹ç¯©é¸ï¼š
   - é»æ“Šã€Œå‡ºå”®ã€Tab â†’ åƒ…é¡¯ç¤º sell é¡å‹
   - é»æ“Šã€Œæ”¶è³¼ã€Tab â†’ åƒ…é¡¯ç¤º buy é¡å‹
   - é»æ“Šã€Œäº¤æ›ã€Tab â†’ åƒ…é¡¯ç¤º exchange é¡å‹
3. æ¸¬è©¦ç‰©å“æœå°‹ï¼š
   - è¼¸å…¥ã€Œå± é¾åˆ€ã€
   - é¸æ“‡ç‰©å“
   - é©—è­‰åªé¡¯ç¤ºè©²ç‰©å“çš„åˆŠç™»
4. æ¸¬è©¦åƒ¹æ ¼ç¯„åœç¯©é¸ï¼š
   - è¼¸å…¥æœ€ä½åƒ¹æ ¼ï¼š10,000,000
   - è¼¸å…¥æœ€é«˜åƒ¹æ ¼ï¼š50,000,000
   - é©—è­‰åƒ¹æ ¼åœ¨ç¯„åœå…§
5. æ¸¬è©¦ç‰©å“å±¬æ€§ç¯©é¸ï¼š
   - è¼¸å…¥æœ€ä½ç‰©æ”»ï¼š80
   - é©—è­‰é¡¯ç¤ºçš„åˆŠç™» watk >= 80
6. æ¸¬è©¦æ’åºåŠŸèƒ½ï¼š
   - é¸æ“‡ã€Œåƒ¹æ ¼ç”±ä½åˆ°é«˜ã€
   - é©—è­‰æ’åºæ­£ç¢º
7. æ¸¬è©¦åˆ†é åŠŸèƒ½ï¼š
   - é»æ“Šã€Œä¸‹ä¸€é ã€
   - é©—è­‰é¡¯ç¤ºç¬¬ 2 é å…§å®¹
```

#### é æœŸçµæœ

âœ… **API è«‹æ±‚**ï¼š
```http
GET /api/market/search?trade_type=sell&item_id=1302081&min_price=10000000&max_price=50000000&min_watk=80&sort_by=price&order=asc&page=1&limit=20
```

âœ… **API å›æ‡‰ï¼ˆ200 OKï¼‰**ï¼š
```json
{
  "success": true,
  "data": [
    {
      "id": 123,
      "item_id": 1302081,
      "price": 30000000,
      "quantity": 1,
      "item_stats": {
        "watk": 95,
        "str": 10
      },
      "stats_grade": "A",
      "seller": {
        "discord_username": "TestUser",
        "reputation_score": 85
      },
      "created_at": "2025-10-27T..."
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 45,
    "total_pages": 3
  },
  "message": "æŸ¥è©¢æˆåŠŸ"
}
```

âœ… **æ•ˆèƒ½è¦æ±‚**ï¼š
- API å›æ‡‰æ™‚é–“ < 200ms
- ä½¿ç”¨æ­£ç¢ºçš„è³‡æ–™åº«ç´¢å¼•ï¼ˆ`idx_listings_high_watk`, `idx_listings_grade_score`ï¼‰

#### æ¸¬è©¦æª¢æŸ¥æ¸…å–®

- [ ] æ‰€æœ‰ç¯©é¸æ¢ä»¶æ­£å¸¸å·¥ä½œ
- [ ] æ’åºåŠŸèƒ½æ­£ç¢º
- [ ] åˆ†é åŠŸèƒ½æ­£ç¢º
- [ ] API å›æ‡‰æ™‚é–“ç¬¦åˆæ¨™æº–
- [ ] è³‡æ–™é¡¯ç¤ºæ ¼å¼æ­£ç¢º

---

### æ¸¬è©¦æƒ…å¢ƒ 4ï¼šç™»è¨˜è³¼è²·æ„å‘èˆ‡æŸ¥çœ‹è¯çµ¡æ–¹å¼

#### æ¸¬è©¦æ­¥é©Ÿ

```markdown
1. åœ¨å¸‚å ´ç€è¦½é é¢æ‰¾åˆ°ç›®æ¨™åˆŠç™»
2. é»æ“Šã€ŒæŸ¥çœ‹è¯çµ¡æ–¹å¼ã€æŒ‰éˆ•
3. é©—è­‰é¡¯ç¤ºè¯çµ¡è³‡è¨Š
4. é©—è­‰ IP é…é¡æ¸›å°‘ï¼ˆå‰©é¤˜ 29/30ï¼‰
5. é»æ“Šã€Œç™»è¨˜è³¼è²·æ„å‘ã€æŒ‰éˆ•
6. å¡«å¯«ç•™è¨€ï¼šã€Œæˆ‘æƒ³è³¼è²·é€™ä»¶è£å‚™ï¼Œè«‹å•é‚„æœ‰å—ï¼Ÿã€
7. é»æ“Šã€Œæäº¤ã€
8. é©—è­‰æˆåŠŸè¨Šæ¯
```

#### é æœŸçµæœ

âœ… **API è«‹æ±‚ 1ï¼ˆæŸ¥çœ‹è¯çµ¡æ–¹å¼ï¼‰**ï¼š
```http
GET /api/listings/123/contact
Headers:
  x-forwarded-for: 192.168.1.100
```

âœ… **API å›æ‡‰ 1ï¼ˆ200 OKï¼‰**ï¼š
```json
{
  "success": true,
  "data": {
    "contact_method": "discord",
    "contact_info": "SellerUser#5678",
    "quota_remaining": 29,
    "is_own_listing": false
  },
  "message": "æŸ¥è©¢æˆåŠŸ"
}
```

âœ… **Redis é…é¡ç‹€æ…‹**ï¼š
- Key: `ip_quota:192.168.1.100:contact_view`
- Value: 1
- TTL: åˆ°åˆå¤œçš„ç§’æ•¸

âœ… **API è«‹æ±‚ 2ï¼ˆç™»è¨˜è³¼è²·æ„å‘ï¼‰**ï¼š
```json
POST /api/interests
Content-Type: application/json

{
  "listing_id": 123,
  "message": "æˆ‘æƒ³è³¼è²·é€™ä»¶è£å‚™,è«‹å•é‚„æœ‰å—ï¼Ÿ"
}
```

âœ… **API å›æ‡‰ 2ï¼ˆ201 Createdï¼‰**ï¼š
```json
{
  "success": true,
  "data": {
    "id": 456,
    "listing_id": 123,
    "buyer_id": "uuid...",
    "message": "æˆ‘æƒ³è³¼è²·é€™ä»¶è£å‚™,è«‹å•é‚„æœ‰å—ï¼Ÿ",
    "status": "pending",
    "created_at": "2025-10-27T..."
  },
  "message": "ç™»è¨˜æˆåŠŸ"
}
```

#### é…é¡æ¸¬è©¦

âœ… **ç¬¬ 1 æ¬¡æŸ¥çœ‹** â†’ quota_remaining: 29
âœ… **ç¬¬ 30 æ¬¡æŸ¥çœ‹** â†’ quota_remaining: 0
âŒ **ç¬¬ 31 æ¬¡æŸ¥çœ‹** â†’ 400 ValidationError "ä»Šæ—¥æŸ¥çœ‹æ¬¡æ•¸å·²é”ä¸Šé™ï¼ˆ30 æ¬¡ï¼‰"
âœ… **è‡ªå·±çš„åˆŠç™»** â†’ ä¸æ¶ˆè€—é…é¡

#### é‚Šç•Œæ¸¬è©¦

âŒ **é‡è¤‡ç™»è¨˜**ï¼š
- å°åŒä¸€åˆŠç™»ç™»è¨˜å…©æ¬¡
- é æœŸï¼š409 Conflictï¼ˆUNIQUE constraintï¼‰

âŒ **ç™»è¨˜è‡ªå·±çš„åˆŠç™»**ï¼š
- å˜—è©¦ç™»è¨˜è‡ªå·±çš„åˆŠç™»
- é æœŸï¼š400 ValidationError "ä¸èƒ½ç™»è¨˜è‡ªå·±çš„åˆŠç™»"

âŒ **ç™»è¨˜å·²çµæŸçš„åˆŠç™»**ï¼š
- å˜—è©¦ç™»è¨˜ status = 'sold' çš„åˆŠç™»
- é æœŸï¼š400 ValidationError "åˆŠç™»å·²çµæŸ"

#### æ¸¬è©¦æª¢æŸ¥æ¸…å–®

- [ ] è¯çµ¡æ–¹å¼æ­£ç¢ºé¡¯ç¤º
- [ ] IP é…é¡æ­£ç¢ºè¿½è¹¤
- [ ] è³¼è²·æ„å‘ç™»è¨˜æˆåŠŸ
- [ ] é…é¡é™åˆ¶ç”Ÿæ•ˆ
- [ ] é‡è¤‡ç™»è¨˜é˜²è­·æœ‰æ•ˆ

---

### æ¸¬è©¦æƒ…å¢ƒ 5ï¼šäº¤æ›é…å°æ¼”ç®—æ³•

#### æ¸¬è©¦æ­¥é©Ÿ

```markdown
1. å»ºç«‹ exchange åˆŠç™»ï¼š
   - æˆ‘æœ‰ï¼šå± é¾åˆ€ï¼ˆitem_id: 1302081ï¼‰
   - æƒ³è¦ï¼šå¤©åŠï¼ˆitem_id: 1402037ï¼‰
   - æ•¸é‡ï¼š1:1
2. é»æ“Šã€Œå°‹æ‰¾é…å°ã€æŒ‰éˆ•
3. é©—è­‰é…å°çµæœé¡¯ç¤º
4. æª¢æŸ¥é…å°è©•åˆ†è¨ˆç®—
```

#### é æœŸçµæœ

âœ… **API è«‹æ±‚**ï¼š
```http
GET /api/market/exchange-matches?listing_id=123
```

âœ… **æˆ‘çš„åˆŠç™»**ï¼š
```json
{
  "id": 123,
  "item_id": 1302081,        // æˆ‘æœ‰çš„ç‰©å“ï¼ˆå± é¾åˆ€ï¼‰
  "wanted_item_id": 1402037, // æˆ‘æƒ³è¦çš„ç‰©å“ï¼ˆå¤©åŠï¼‰
  "quantity": 1,
  "wanted_quantity": 1
}
```

âœ… **API å›æ‡‰ï¼ˆ200 OKï¼‰**ï¼š
```json
{
  "success": true,
  "data": {
    "my_listing": { ... },
    "matches": [
      {
        "id": 456,
        "item_id": 1402037,        // ä»–æœ‰æˆ‘æƒ³è¦çš„ï¼ˆå¤©åŠï¼‰
        "wanted_item_id": 1302081, // ä»–æƒ³è¦æˆ‘æœ‰çš„ï¼ˆå± é¾åˆ€ï¼‰
        "quantity": 1,
        "wanted_quantity": 1,
        "match_score": 95,         // é…å°è©•åˆ†
        "seller": {
          "discord_username": "MatchUser",
          "reputation_score": 90
        }
      }
    ]
  },
  "message": "æŸ¥è©¢æˆåŠŸ"
}
```

#### è©•åˆ†æ¼”ç®—æ³•é©—è­‰

**è¨ˆç®—å…¬å¼**ï¼š
```typescript
åŸºç¤åˆ†ï¼š50ï¼ˆé›™å‘é…å°ï¼‰
+ æ•¸é‡åŒ¹é…åˆ†ï¼šmax 30 åˆ†ï¼ˆå®Œå…¨åŒ¹é… 1:1 = 30 åˆ†ï¼‰
+ ä¿¡è­½åŠ åˆ†ï¼šmax 20 åˆ†ï¼ˆreputation_score / 5ï¼‰
= ç¸½åˆ†ï¼ˆ0-100ï¼‰
```

**ç¯„ä¾‹è¨ˆç®—**ï¼š
```
åŸºç¤åˆ†ï¼š50
+ æ•¸é‡åŒ¹é…ï¼š30ï¼ˆå®Œå…¨åŒ¹é… 1:1ï¼‰
+ ä¿¡è­½åŠ åˆ†ï¼š18ï¼ˆreputation_score: 90 â†’ 90/5 = 18ï¼Œmin(18, 20) = 18ï¼‰
= ç¸½åˆ†ï¼š98
```

#### é‚Šç•Œæ¸¬è©¦

âŒ **é exchange é¡å‹**ï¼š
- sell/buy åˆŠç™»å˜—è©¦æŸ¥è©¢é…å°
- é æœŸï¼š400 ValidationError "åªæœ‰äº¤æ›é¡å‹æ‰èƒ½æŸ¥è©¢åŒ¹é…"

âŒ **ç¼ºå°‘ wanted_item_id**ï¼š
- exchange åˆŠç™»ä½† wanted_item_id ç‚º null
- é æœŸï¼š400 ValidationError "äº¤æ›åˆŠç™»ç¼ºå°‘æƒ³è¦çš„ç‰©å“"

#### æ¸¬è©¦æª¢æŸ¥æ¸…å–®

- [ ] é…å°æŸ¥è©¢æ­£å¸¸é‹ä½œ
- [ ] é…å°è©•åˆ†è¨ˆç®—æ­£ç¢º
- [ ] é…å°çµæœæŒ‰è©•åˆ†æ’åº
- [ ] æ•¸é‡æ¯”ä¾‹æ­£ç¢ºå½±éŸ¿è©•åˆ†
- [ ] ä¿¡è­½ç³»çµ±æ­£ç¢ºå½±éŸ¿è©•åˆ†

---

## 2ï¸âƒ£ å®‰å…¨æ€§æ¸¬è©¦

### èªè­‰èˆ‡æˆæ¬Šæ¸¬è©¦

#### æ¸¬è©¦æƒ…å¢ƒï¼šæœªç™»å…¥å­˜å–ä¿è­·è³‡æº

```markdown
æ¸¬è©¦æ¡ˆä¾‹ï¼š
1. POST /api/listings â†’ 401 Unauthorized
2. GET /api/listings â†’ 401 Unauthorized
3. POST /api/interests â†’ 401 Unauthorized
4. GET /api/interests/received â†’ 401 Unauthorized

é æœŸå›æ‡‰ï¼š
{
  "success": false,
  "error": "è«‹å…ˆç™»å…¥",
  "code": "UNAUTHORIZED"
}
```

#### æ¸¬è©¦æƒ…å¢ƒï¼šè·¨ä½¿ç”¨è€…æ¬Šé™

```markdown
æ¸¬è©¦æ¡ˆä¾‹ï¼š
1. User A å˜—è©¦æ›´æ–° User B çš„åˆŠç™»
   PATCH /api/listings/123 (owned by User B)
   â†’ 404 Not Foundï¼ˆé¿å…è³‡è¨Šæ´©éœ²ï¼‰

2. User A å˜—è©¦åˆªé™¤ User B çš„åˆŠç™»
   DELETE /api/listings/123 (owned by User B)
   â†’ 404 Not Found

3. User A æŸ¥çœ‹è‡ªå·±åˆŠç™»çš„è³¼è²·æ„å‘
   GET /api/interests/received
   â†’ åªè¿”å› listing.user_id = User A çš„æ„å‘
```

#### æ¸¬è©¦æƒ…å¢ƒï¼šç®¡ç†å“¡æ¬Šé™

```markdown
æ¸¬è©¦æ¡ˆä¾‹ï¼š
1. ä¸€èˆ¬ä½¿ç”¨è€…å­˜å–ç®¡ç†å“¡ API
   GET /api/admin/users â†’ 403 Forbidden

2. ç®¡ç†å“¡å­˜å–ç®¡ç†å“¡ API
   GET /api/admin/users â†’ 200 OK
   é©—è­‰ï¼šdiscord_profiles.server_roles åŒ…å« Admin æˆ– Moderator
```

#### æ¸¬è©¦æª¢æŸ¥æ¸…å–®

- [ ] æœªç™»å…¥ç„¡æ³•å­˜å–ä¿è­·è³‡æº
- [ ] è·¨ä½¿ç”¨è€…æ¬Šé™éš”é›¢æ­£ç¢º
- [ ] ç®¡ç†å“¡æ¬Šé™æª¢æŸ¥æ­£ç¢º
- [ ] éŒ¯èª¤è¨Šæ¯ä¸æ´©éœ²æ•æ„Ÿè³‡è¨Š

---

### RLS ç­–ç•¥é©—è­‰

#### æ¸¬è©¦æ–¹æ³•

ä½¿ç”¨ Supabase SQL Editor æˆ– psql åŸ·è¡Œé©—è­‰è…³æœ¬ï¼š

```bash
psql -h db.xxx.supabase.co -U postgres -d postgres -f docs/sql/verify-rls.sql
```

#### é©—è­‰é …ç›®

```sql
-- 1. æŸ¥è©¢ listings è¡¨ï¼ˆanon roleï¼‰
SELECT * FROM listings WHERE status = 'active';
-- âœ… å¯æŸ¥è©¢æ‰€æœ‰ active åˆŠç™»

-- 2. æ›´æ–°å…¶ä»–äººçš„ listingsï¼ˆanon roleï¼‰
UPDATE listings SET price = 1 WHERE id = 123 AND user_id != current_user;
-- âŒ 0 rows affectedï¼ˆUPDATE æ”¿ç­–é™åˆ¶ï¼‰

-- 3. æŸ¥è©¢ sessions è¡¨ï¼ˆanon roleï¼‰
SELECT * FROM sessions;
-- âŒ 0 rowsï¼ˆSELECT æ”¿ç­–é™åˆ¶ï¼Œåªèƒ½æŸ¥è©¢è‡ªå·±çš„ï¼‰

-- 4. æŸ¥è©¢ interests è¡¨ï¼ˆseller roleï¼‰
SELECT * FROM interests WHERE listing_id = 123 (owned by seller);
-- âœ… å¯æŸ¥è©¢ï¼ˆEXISTS subquery é©—è­‰åˆŠç™»æ‰€æœ‰æ¬Šï¼‰
```

#### æ¸¬è©¦æª¢æŸ¥æ¸…å–®

- [ ] RLS åœ¨æ‰€æœ‰ 9 å€‹è¡¨å•Ÿç”¨
- [ ] anon role åªèƒ½æŸ¥è©¢å…¬é–‹è³‡æ–™
- [ ] ä½¿ç”¨è€…åªèƒ½ä¿®æ”¹è‡ªå·±çš„è³‡æ–™
- [ ] è³£å®¶å¯ä»¥æŸ¥çœ‹è‡ªå·±åˆŠç™»çš„æ„å‘

---

### CSRF èˆ‡ SQL Injection æ¸¬è©¦

#### CSRF ä¿è­·æ¸¬è©¦

```markdown
æ¸¬è©¦æƒ…å¢ƒï¼šOAuth State Token

1. æ­£å¸¸æµç¨‹ï¼š
   GET /api/auth/discord â†’ ç”¢ç”Ÿ state UUID
   â†’ Redis å„²å­˜ state (10 min expiry)
   â†’ Discord callback with state
   â†’ é©—è­‰ state ä¸¦åˆªé™¤
   âœ… Success

2. é‡è¤‡ä½¿ç”¨ stateï¼š
   â†’ Redis å·²åˆªé™¤ state
   âŒ 400 ValidationError "Invalid state"

3. éæœŸ state (> 10 åˆ†é˜)ï¼š
   â†’ Redis TTL éæœŸ
   âŒ 400 ValidationError "Invalid state"

4. å½é€  stateï¼š
   â†’ Redis æ‰¾ä¸åˆ°è¨˜éŒ„
   âŒ 400 ValidationError "Invalid state"
```

#### SQL Injection é˜²è­·æ¸¬è©¦

```markdown
æ¸¬è©¦æ¡ˆä¾‹ï¼š

1. æƒ¡æ„è¼¸å…¥ item_id
   GET /api/market/search?item_id=1302081' OR '1'='1
   âœ… Supabase è‡ªå‹•åƒæ•¸åŒ–ï¼Œä¸æœƒåŸ·è¡Œæ³¨å…¥

2. æƒ¡æ„è¼¸å…¥ message
   POST /api/interests
   { "message": "'; DROP TABLE listings; --" }
   âœ… åƒæ•¸åŒ–æ’å…¥ï¼Œå®‰å…¨å„²å­˜

3. æƒ¡æ„è¼¸å…¥ contact_info
   POST /api/listings
   { "contact_info": "<script>alert('XSS')</script>" }
   âœ… React è‡ªå‹•è·³è„«ï¼Œå¾Œç«¯å„²å­˜åŸå§‹å­—ä¸²
```

#### æ¸¬è©¦æª¢æŸ¥æ¸…å–®

- [ ] State token CSRF é˜²è­·æœ‰æ•ˆ
- [ ] SQL Injection é˜²è­·æœ‰æ•ˆ
- [ ] XSS é˜²è­·æœ‰æ•ˆï¼ˆReact è‡ªå‹•è·³è„«ï¼‰
- [ ] Cookie å®‰å…¨ flags æ­£ç¢º

---

## 3ï¸âƒ£ æ•ˆèƒ½æ¸¬è©¦

### API å›æ‡‰æ™‚é–“åŸºæº–

#### æ¸¬è©¦ç›®æ¨™

æ‰€æœ‰ API å›æ‡‰æ™‚é–“ < 200msï¼ˆç¬¬ 95 ç™¾åˆ†ä½æ•¸ï¼‰

#### æ¸¬è©¦æ–¹æ³•

ä½¿ç”¨ç€è¦½å™¨é–‹ç™¼è€…å·¥å…·ï¼ˆNetwork Tabï¼‰æˆ– Postman æ¸¬é‡ï¼š

```markdown
1. GET /api/market/searchï¼ˆåŒ…å« JOINï¼‰
   ç›®æ¨™ï¼š< 150ms
   æ¸¬è©¦ï¼šåŸ·è¡Œ 10 æ¬¡è«‹æ±‚ï¼Œè¨˜éŒ„å¹³å‡å€¼

2. POST /api/listingsï¼ˆåŒ…å«é…é¡æŸ¥è©¢ï¼‰
   ç›®æ¨™ï¼š< 200ms
   æ¸¬è©¦ï¼šåŸ·è¡Œ 10 æ¬¡è«‹æ±‚ï¼Œè¨˜éŒ„å¹³å‡å€¼

3. GET /api/market/exchange-matchesï¼ˆåŒ…å«è©•åˆ†è¨ˆç®—ï¼‰
   ç›®æ¨™ï¼š< 300msï¼ˆè¤‡é›œæ¼”ç®—æ³•ï¼‰
   æ¸¬è©¦ï¼šæº–å‚™ 50 å€‹ exchange åˆŠç™»ï¼Œæ¸¬è©¦é…å°æŸ¥è©¢

4. GET /api/listings/[id]/contactï¼ˆåŒ…å« Redis æŸ¥è©¢ï¼‰
   ç›®æ¨™ï¼š< 100msï¼ˆRedis é€Ÿåº¦å¿«ï¼‰
   æ¸¬è©¦ï¼šåŸ·è¡Œ 10 æ¬¡è«‹æ±‚ï¼Œè¨˜éŒ„å¹³å‡å€¼
```

#### ç´¢å¼•é©—è­‰

åœ¨ Supabase SQL Editor åŸ·è¡Œï¼š

```sql
EXPLAIN ANALYZE
SELECT * FROM listings
WHERE item_id = 1302081 AND status = 'active'
ORDER BY created_at DESC;

-- é æœŸï¼šä½¿ç”¨ idx_listings_item_id ç´¢å¼•
-- åŸ·è¡Œæ™‚é–“ < 50ms
```

#### æ¸¬è©¦æª¢æŸ¥æ¸…å–®

- [ ] æ‰€æœ‰ API < 200msï¼ˆ95th percentileï¼‰
- [ ] ä½¿ç”¨æ­£ç¢ºçš„è³‡æ–™åº«ç´¢å¼•
- [ ] ç„¡ N+1 æŸ¥è©¢å•é¡Œ
- [ ] Redis æŸ¥è©¢ < 50ms

---

### è³‡æ–™åº«æŸ¥è©¢å„ªåŒ–é©—è­‰

#### N+1 æŸ¥è©¢æª¢æŸ¥

```typescript
// âŒ Bad: N+1 æŸ¥è©¢
const listings = await supabase.from('listings').select('*')
for (const listing of listings) {
  const seller = await supabase.from('users').select('*').eq('id', listing.user_id)
}

// âœ… Good: ä½¿ç”¨ JOINï¼ˆç›®å‰å¯¦ä½œï¼‰
const listings = await supabase
  .from('listings')
  .select(`*, users!inner (discord_username, discord_profiles (reputation_score))`)
```

#### æ¸¬è©¦æª¢æŸ¥æ¸…å–®

- [ ] æ‰€æœ‰åˆ—è¡¨ API ä½¿ç”¨ JOIN æŸ¥è©¢
- [ ] ç„¡å¤šé¤˜çš„ SELECT æŸ¥è©¢
- [ ] æŸ¥è©¢è¨ˆç•«ä½¿ç”¨æ­£ç¢ºç´¢å¼•
- [ ] é¿å… SELECT * ï¼ˆåªé¸æ“‡éœ€è¦çš„æ¬„ä½ï¼‰

---

## 4ï¸âƒ£ æ¸¬è©¦åŸ·è¡Œè¨˜éŒ„

### æ¸¬è©¦æœƒè©±è¨˜éŒ„æ¨¡æ¿

```markdown
## æ¸¬è©¦æœƒè©± #1

**æ—¥æœŸ**ï¼š2025-10-27
**æ¸¬è©¦è€…**ï¼š[å§“å]
**ç’°å¢ƒ**ï¼šDevelopment (http://localhost:3000)

### å·²å®Œæˆæ¸¬è©¦

- [x] Discord OAuth ç™»å…¥æµç¨‹
  - çµæœï¼šâœ… é€šé
  - å‚™è¨»ï¼šç„¡

- [x] å»ºç«‹åˆŠç™»ï¼ˆsell é¡å‹ï¼‰
  - çµæœï¼šâœ… é€šé
  - å‚™è¨»ï¼šç‰©å“å±¬æ€§è¨ˆç®—æ­£ç¢ºï¼ˆgrade: A, score: 85ï¼‰

- [x] å¸‚å ´ç€è¦½èˆ‡ç¯©é¸
  - çµæœï¼šâœ… é€šé
  - å‚™è¨»ï¼šAPI å›æ‡‰æ™‚é–“ 145msï¼ˆç¬¦åˆ < 150ms æ¨™æº–ï¼‰

### ç™¼ç¾çš„å•é¡Œ

1. **[Bug] åƒ¹æ ¼ç¯©é¸ç„¡æ•ˆ**
   - åš´é‡ç¨‹åº¦ï¼šğŸ”´ Critical
   - æè¿°ï¼šè¼¸å…¥åƒ¹æ ¼ç¯„åœå¾Œï¼Œç¯©é¸çµæœä¸æ­£ç¢º
   - é‡ç¾æ­¥é©Ÿï¼šé€²å…¥å¸‚å ´ â†’ è¼¸å…¥æœ€ä½åƒ¹æ ¼ 10,000,000 â†’ çµæœé¡¯ç¤ºä½æ–¼è©²åƒ¹æ ¼çš„åˆŠç™»
   - é æœŸè¡Œç‚ºï¼šåªé¡¯ç¤º price >= 10,000,000 çš„åˆŠç™»
   - ç‹€æ…‹ï¼šâ³ å¾…ä¿®å¾©

2. **[UI] Loading ç‹€æ…‹ç¼ºå¤±**
   - åš´é‡ç¨‹åº¦ï¼šğŸŸ¡ Minor
   - æè¿°ï¼šAPI è«‹æ±‚æœŸé–“ç„¡ Loading æŒ‡ç¤º
   - å»ºè­°ï¼šåŠ å…¥ Loading spinner
   - ç‹€æ…‹ï¼šâ³ å¾…ä¿®å¾©

### æ•ˆèƒ½æŒ‡æ¨™

| API ç«¯é» | å¹³å‡å›æ‡‰æ™‚é–“ | æ¨™æº– | çµæœ |
|---------|-------------|------|------|
| GET /api/market/search | 145ms | < 150ms | âœ… |
| POST /api/listings | 178ms | < 200ms | âœ… |
| GET /api/interests | 92ms | < 200ms | âœ… |

### ä¸‹æ¬¡æ¸¬è©¦é‡é»

- [ ] ä¿®å¾©åƒ¹æ ¼ç¯©é¸ Bug
- [ ] æ¸¬è©¦äº¤æ›é…å°æ¼”ç®—æ³•
- [ ] æ¸¬è©¦ IP é…é¡é™åˆ¶
```

---

## 5ï¸âƒ£ æ¸¬è©¦å·¥å…·èˆ‡è…³æœ¬

### æ¨è–¦å·¥å…·

| å·¥å…· | ç”¨é€” | å®‰è£ |
|------|------|------|
| **Postman** | API æ¸¬è©¦èˆ‡è‡ªå‹•åŒ– | https://www.postman.com |
| **psql** | è³‡æ–™åº«æŸ¥è©¢èˆ‡é©—è­‰ | `brew install postgresql` |
| **Chrome DevTools** | Network æ€§èƒ½åˆ†æ | å…§å»º |
| **React DevTools** | å…ƒä»¶æ¸²æŸ“åˆ†æ | Chrome Extension |

### å¿«é€Ÿæ¸¬è©¦è…³æœ¬

#### è³‡æ–™åº«é©—è­‰

```bash
# åŸ·è¡Œ RLS é©—è­‰è…³æœ¬
psql -h db.xxx.supabase.co -U postgres -d postgres -f docs/sql/verify-rls.sql

# åŸ·è¡Œè³‡æ–™åº«ç‹€æ…‹æª¢æŸ¥
psql -f docs/sql/05-verify-current-state.sql
```

#### æ•ˆèƒ½æ¸¬è©¦

```bash
# æª¢æŸ¥ Bundle å¤§å°
npm run build
npm run analyze

# æª¢æŸ¥ä¾è³´
npm audit
npm outdated
npx depcheck
```

---

## 6ï¸âƒ£ æ¸¬è©¦å®Œæˆæ¨™æº–

### éšæ®µæ€§é©—æ”¶

#### âœ… éšæ®µ 2ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰é©—æ”¶æ¨™æº–

**åŠŸèƒ½é©—æ”¶**ï¼š
- [x] Discord OAuth ç™»å…¥æµç¨‹å®Œæ•´
- [x] å»ºç«‹åˆŠç™»ï¼ˆsell/buy/exchangeï¼‰æ­£å¸¸
- [x] å¸‚å ´ç€è¦½èˆ‡ç¯©é¸æ­£å¸¸
- [x] è³¼è²·æ„å‘ç™»è¨˜æ­£å¸¸
- [x] è¯çµ¡æ–¹å¼æŸ¥çœ‹èˆ‡é…é¡æ­£å¸¸

**å®‰å…¨é©—æ”¶**ï¼š
- [ ] æœªç™»å…¥ç„¡æ³•å­˜å–ä¿è­·è³‡æº
- [ ] è·¨ä½¿ç”¨è€…æ¬Šé™éš”é›¢æ­£ç¢º
- [ ] CSRF ä¿è­·æœ‰æ•ˆ
- [ ] RLS ç­–ç•¥ç”Ÿæ•ˆ

**æ•ˆèƒ½é©—æ”¶**ï¼š
- [ ] API å›æ‡‰æ™‚é–“ < 200ms
- [ ] ä½¿ç”¨æ­£ç¢ºçš„è³‡æ–™åº«ç´¢å¼•
- [ ] ç„¡ N+1 æŸ¥è©¢å•é¡Œ

### ä¸Šç·šå‰æª¢æŸ¥æ¸…å–®

#### å¿…é ˆå®Œæˆï¼ˆCriticalï¼‰

- [ ] æ‰€æœ‰åŠŸèƒ½æ¸¬è©¦é€šé
- [ ] æ‰€æœ‰å®‰å…¨æ¸¬è©¦é€šé
- [ ] API æ•ˆèƒ½ç¬¦åˆæ¨™æº–
- [ ] RLS ç­–ç•¥é©—è­‰é€šé
- [ ] ç’°å¢ƒè®Šæ•¸æ­£ç¢ºè¨­å®š

#### å»ºè­°å®Œæˆï¼ˆRecommendedï¼‰

- [ ] åŸ·è¡Œå£“åŠ›æ¸¬è©¦ï¼ˆ100 ä¸¦ç™¼ä½¿ç”¨è€…ï¼‰
- [ ] å»ºç«‹ç›£æ§å„€è¡¨æ¿
- [ ] è¨­å®šéŒ¯èª¤è¿½è¹¤ï¼ˆSentryï¼‰
- [ ] æº–å‚™ Rollback è¨ˆç•«

---

## ğŸ“š å°èˆª

[â† ä¸Šä¸€ç¯‡:ç‰©å“æ•´åˆè¨­è¨ˆ](./10-ç‰©å“æ•´åˆè¨­è¨ˆ.md) | [ğŸ  è¿”å›ç›®éŒ„](./README.md)
