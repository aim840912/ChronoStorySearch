# Discord ç™»å…¥ç‰©å“æ„å‘ç™»è¨˜ç³»çµ±æ¶æ§‹è¨­è¨ˆ

> **å°ˆæ¡ˆéœ€æ±‚**ï¼šDiscord èªè­‰ã€ä¸­å‹è¦æ¨¡ï¼ˆ1200-1600 MAUï¼‰ã€ç´”è³‡è¨Šåª’åˆã€å…è²»é¡åº¦
>
> **æœ€å¾Œæ›´æ–°**ï¼š2025-10-25 | **ç‰ˆæœ¬**ï¼šv4.0ï¼ˆDiscord å®Œæ•´ç‰ˆï¼‰
>
> âš ï¸ **é‡è¦**ï¼šæœ¬æ–‡ä»¶ç‚ºå®Œæ•´ç‰ˆè¨­è¨ˆï¼ŒåŒ…å« Discord OAuth 2.0ã€Webhook é€šçŸ¥ã€Bot æ•´åˆã€ä¿¡è­½ç³»çµ±

---

## ç›®éŒ„

1. [ç³»çµ±æ¦‚è¿°](#ç³»çµ±æ¦‚è¿°)
2. [ç³»çµ±æ¶æ§‹](#ç³»çµ±æ¶æ§‹)
3. [Discord OAuth 2.0 èªè­‰](#discord-oauth-20-èªè­‰)
4. [è³‡æ–™åº«è¨­è¨ˆ](#è³‡æ–™åº«è¨­è¨ˆ)
5. [API è¨­è¨ˆ](#api-è¨­è¨ˆ)
6. [Discord Webhook é€šçŸ¥](#discord-webhook-é€šçŸ¥)
7. [Discord Bot ä¼ºæœå™¨æ•´åˆ](#discord-bot-ä¼ºæœå™¨æ•´åˆ)
8. [ä¿¡è­½ç³»çµ±](#ä¿¡è­½ç³»çµ±)
9. [å®‰å…¨æ€§è¨­è¨ˆ](#å®‰å…¨æ€§è¨­è¨ˆ)
10. [å¯é æ€§è¨­è¨ˆ](#å¯é æ€§è¨­è¨ˆ)
11. [æ•ˆèƒ½å„ªåŒ–](#æ•ˆèƒ½å„ªåŒ–)
12. [ç›£æ§èˆ‡ç¶­è­·](#ç›£æ§èˆ‡ç¶­è­·)
13. [æ¸¬è©¦ç­–ç•¥](#æ¸¬è©¦ç­–ç•¥)
14. [æ“´å±•æ€§è€ƒé‡](#æ“´å±•æ€§è€ƒé‡)
15. [æˆæœ¬é ä¼°](#æˆæœ¬é ä¼°)
16. [å¯¦ä½œè·¯ç·šåœ–](#å¯¦ä½œè·¯ç·šåœ–)
17. [è¨­è¨ˆæ±ºç­–è¨˜éŒ„](#è¨­è¨ˆæ±ºç­–è¨˜éŒ„)

---

## ç³»çµ±æ¦‚è¿°

### æ¥­å‹™ç›®æ¨™

å»ºç«‹ä¸€å€‹**åŸºæ–¼ Discord èªè­‰**çš„è™›æ“¬ç‰©å“æ„å‘åª’åˆå¹³å°ï¼Œå…è¨±ç”¨æˆ¶ï¼š
- ä½¿ç”¨ Discord å¸³è™Ÿç™»å…¥ä¸¦ç¶å®šèº«ä»½
- ç™¼å¸ƒç‰©å“è²©å”®è³‡è¨Šï¼ˆå«åƒ¹æ ¼å’Œè¯çµ¡æ–¹å¼ï¼‰
- ç€è¦½å¸‚å ´ä¸¦ç™»è¨˜è³¼è²·æ„å‘
- é€é Discord Webhook æ¥æ”¶è³¼è²·æ„å‘é€šçŸ¥
- é€éå¹³å°å¤–è¯çµ¡æ–¹å¼å®Œæˆå¯¦éš›äº¤æ˜“ï¼ˆéŠæˆ²å…§äº¤æ˜“ï¼‰

### æ ¸å¿ƒç‰¹æ€§

- **Discord ç™»å…¥**ï¼šä½¿ç”¨ Discord OAuth 2.0 èªè­‰ï¼Œç¢ºä¿çœŸå¯¦èº«ä»½
- **çœŸå¯¦èº«ä»½é©—è­‰**ï¼šæ¯å€‹ç”¨æˆ¶ç¶å®šå”¯ä¸€ Discord IDï¼Œé˜²æ­¢å¤šå¸³è™Ÿæ¿«ç”¨
- **ä¿¡è­½ç³»çµ±**ï¼šåŸºæ–¼ Discord å¸³è™Ÿå¹´é½¡å’Œä¼ºæœå™¨æˆå“¡èº«ä»½è©•åˆ†ï¼ˆ0-100 åˆ†ï¼‰
- **å³æ™‚é€šçŸ¥**ï¼šè³¼è²·æ„å‘è‡ªå‹•ç™¼é€åˆ°è³£å®¶çš„ Discord é »é“ï¼ˆWebhookï¼‰
- **Bot æ•´åˆ**ï¼šDiscord Bot æä¾›æŒ‡ä»¤æŸ¥è©¢åˆŠç™»ã€ç¶å®šè§’è‰²ã€æŸ¥çœ‹çµ±è¨ˆ
- **è³‡è¨Šåª’åˆå¹³å°**ï¼šç³»çµ±åƒ…è² è²¬é…å°è²·è³£é›™æ–¹ï¼Œäº¤æ˜“åœ¨éŠæˆ²å…§å®Œæˆ
- **ç°¡åŒ–æµç¨‹**ï¼šè³£å®¶ç™¼å¸ƒç‰©å“â†’è²·å®¶ç™»è¨˜æ„å‘â†’è‡ªå‹• Webhook é€šçŸ¥â†’éŠæˆ²å…§äº¤æ˜“
- **å®Œå…¨ä¿¡ä»»æ¨¡å¼**ï¼šå‡è¨­ç”¨æˆ¶èª å¯¦ï¼Œé‡é»åœ¨é˜²æ¿«ç”¨è€Œéé˜²æ¬ºè©
- **å…è²»é‹ç‡Ÿ**ï¼šå®Œå…¨ä¾è³´å…è²»æœå‹™é¡åº¦ï¼ˆVercel + Supabase + Upstash + Discordï¼‰

### Discord ç”Ÿæ…‹ç³»çµ±æ•´åˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Discord ç”Ÿæ…‹ç³»çµ±                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ OAuth 2.0   â”‚  â”‚  Webhook    â”‚  â”‚   Bot API   â”‚     â”‚
â”‚  â”‚  ç™»å…¥èªè­‰    â”‚  â”‚  å³æ™‚é€šçŸ¥    â”‚  â”‚  æŒ‡ä»¤æŸ¥è©¢    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â”‚                 â”‚                 â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                 â”‚                 â”‚
          â–¼                 â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MapleStory äº¤æ˜“ç³»çµ±ï¼ˆæœ¬ç³»çµ±ï¼‰                 â”‚
â”‚                                                           â”‚
â”‚  â€¢ ç”¨æˆ¶èº«ä»½ç¶å®š Discord ID                                â”‚
â”‚  â€¢ ä¿¡è­½è©•åˆ†åŸºæ–¼ Discord å¸³è™Ÿå¹´é½¡                           â”‚
â”‚  â€¢ è³¼è²·æ„å‘é€šçŸ¥åˆ° Discord é »é“                             â”‚
â”‚  â€¢ Bot æŒ‡ä»¤æ“ä½œåˆŠç™»èˆ‡æŸ¥è©¢                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### éç›®æ¨™

- âŒ ç³»çµ±å…§å®Œæˆäº¤æ˜“ï¼ˆç„¡ç‰©å“è½‰ç§»é‚è¼¯ï¼‰
- âŒ çœŸå¯¦è²¨å¹£äº¤æ˜“
- âŒ è¤‡é›œçš„æ¬Šé™ç³»çµ±
- âŒ è·¨ä¼ºæœå™¨/è·¨å€åŸŸåŒæ­¥
- âŒ å³æ™‚é€šè¨ŠåŠŸèƒ½ï¼ˆä½¿ç”¨ Discord æ›¿ä»£ï¼‰
- âŒ è­°åƒ¹åŠŸèƒ½ï¼ˆå›ºå®šåƒ¹æ ¼ï¼‰

---

## ç³»çµ±æ¶æ§‹

### æ•´é«”æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Discord Platform                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ OAuth Server â”‚  â”‚   Webhooks   â”‚  â”‚   Bot API    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                 â”‚
          â”‚ 1. OAuthæµç¨‹      â”‚ 3. æ„å‘é€šçŸ¥      â”‚ 2. BotæŒ‡ä»¤
          â”‚                  â”‚                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ¶ç«¯                              â”‚
â”‚              (Next.js App Router + React)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Discordç™»å…¥   â”‚  â”‚   å¸‚å ´åˆ—è¡¨    â”‚  â”‚  æˆ‘çš„åˆŠç™»     â”‚  â”‚
â”‚  â”‚   æŒ‰éˆ•        â”‚  â”‚   ç€è¦½        â”‚  â”‚   ç®¡ç†        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ HTTPS
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Vercel Edge Functions                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚              Middleware (App Router)                   â”‚â”‚
â”‚  â”‚  â€¢ Rate Limiting (Redis)                              â”‚â”‚
â”‚  â”‚  â€¢ Session Validation                                 â”‚â”‚
â”‚  â”‚  â€¢ Bot Detection (User-Agent)                         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  API Routes  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  /api/auth/discord         â†’ OAuth å•Ÿå‹•                â”‚â”‚
â”‚  â”‚  /api/auth/discord/callback â†’ OAuth å›èª¿               â”‚â”‚
â”‚  â”‚  /api/listings              â†’ åˆŠç™» CRUD                â”‚â”‚
â”‚  â”‚  /api/interests             â†’ æ„å‘ç™»è¨˜                 â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   Supabase       â”‚          â”‚   Upstash Redis     â”‚
   â”‚   PostgreSQL     â”‚          â”‚                     â”‚
   â”‚                  â”‚          â”‚  â€¢ Rate Limiting    â”‚
   â”‚ â€¢ users          â”‚          â”‚  â€¢ Session Cache    â”‚
   â”‚ â€¢ sessions       â”‚          â”‚                     â”‚
   â”‚ â€¢ listings       â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚ â€¢ interests      â”‚
   â”‚ â€¢ discord_profilesâ”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€è¡“æ£§é¸æ“‡

| å±¤ç´š | æŠ€è¡“ | é¸æ“‡ç†ç”± |
|------|------|----------|
| **å‰ç«¯** | Next.js 15 + App Router | SSR/SSG æ”¯æ´ã€å„ªç§€çš„ DXã€Vercel åŸç”Ÿæ•´åˆ |
| **èªè­‰** | Discord OAuth 2.0 | å…è²»ã€ç„¡ä½¿ç”¨é™åˆ¶ã€ç”¨æˆ¶åŸºç¤é¾å¤§ã€ä¿¡ä»»åº¦é«˜ |
| **è³‡æ–™åº«** | Supabase PostgreSQL | RLS å…§å»ºã€å…è²»é¡åº¦å……è¶³ã€Real-time å¯é¸ |
| **Rate Limiting** | Upstash Redis | åˆ†æ•£å¼å¯é ã€å…è²» 10K å‘½ä»¤/å¤©ã€é‚Šç·£å„ªåŒ– |
| **Webhook** | Discord Webhooks | å…è²»ã€ç„¡é€Ÿç‡é™åˆ¶ï¼ˆ30 req/secï¼‰ã€è±å¯Œçš„ Embed æ ¼å¼ |
| **Bot** | discord.js v14 | æˆç†Ÿç©©å®šã€æ–‡æª”å®Œå–„ã€TypeScript æ”¯æ´ |
| **ç‹€æ…‹ç®¡ç†** | React Context | è¼•é‡ã€å¤ ç”¨ã€ç„¡éœ€é¡å¤–ä¾è³´ |
| **éƒ¨ç½²** | Vercel + Railway/Render | Vercel: Web App, Railway/Render: Discord Bot |

---

## Discord OAuth 2.0 èªè­‰

### OAuth æµç¨‹æ¦‚è¦½

Discord OAuth 2.0 ä½¿ç”¨æ¨™æº–çš„ Authorization Code Grant æµç¨‹ï¼Œæä¾›å®‰å…¨çš„ç¬¬ä¸‰æ–¹ç™»å…¥æ©Ÿåˆ¶ã€‚

**æµç¨‹æ­¥é©Ÿ**ï¼š
1. ç”¨æˆ¶é»æ“Šã€Œä½¿ç”¨ Discord ç™»å…¥ã€
2. é‡å°å‘è‡³ Discord æˆæ¬Šé é¢ï¼ˆå¸¶ state åƒæ•¸é˜² CSRFï¼‰
3. ç”¨æˆ¶åœ¨ Discord æˆæ¬Šæ‡‰ç”¨
4. Discord é‡å°å‘å›æ‡‰ç”¨ï¼ˆå¸¶ code å’Œ stateï¼‰
5. å¾Œç«¯ç”¨ code äº¤æ› access_token å’Œ refresh_token
6. ç”¨ access_token ç²å– Discord ç”¨æˆ¶è³‡æ–™
7. å‰µå»º/æ›´æ–°è³‡æ–™åº«ç”¨æˆ¶è¨˜éŒ„
8. è¨­ç½® session cookie

### Discord Application è¨­ç½®

å‰å¾€ [Discord Developer Portal](https://discord.com/developers/applications) å‰µå»ºæ‡‰ç”¨ï¼š

```yaml
Application Name: MapleStory Trading System
Description: è™›æ“¬ç‰©å“äº¤æ˜“æ„å‘åª’åˆå¹³å°

OAuth2 é…ç½®:
  Client ID: <å¾ Discord ç²å–>
  Client Secret: <å¾ Discord ç²å–ï¼Œå­˜å…¥ç’°å¢ƒè®Šæ•¸>

  Redirect URIs:
    - https://your-domain.vercel.app/api/auth/discord/callback
    - http://localhost:3000/api/auth/discord/callback

  OAuth2 Scopes:
    - identify        # ç²å–ç”¨æˆ¶åŸºæœ¬è³‡è¨Šï¼ˆID, username, avatarï¼‰
    # email å¯é¸ï¼Œè‹¥éœ€è¦éƒµä»¶é€šçŸ¥åŠŸèƒ½å¯å•Ÿç”¨
```

**âš ï¸ Scopes èªªæ˜**ï¼š
- âœ… **identify**ï¼š**å¿…é ˆ**ã€‚ç²å– Discord IDã€ç”¨æˆ¶åã€é ­åƒç­‰åŸºæœ¬è³‡è¨Š
- âš ï¸ **email**ï¼š**å¯é¸**ã€‚è‹¥éœ€è¦éƒµä»¶é€šçŸ¥å¯å•Ÿç”¨ï¼Œä½†å¢åŠ ç”¨æˆ¶æˆæ¬Šæ‘©æ“¦
- âŒ **guilds.members.read**ï¼š**ä¸æ¨è–¦**ã€‚æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦åœ¨ç‰¹å®šä¼ºæœå™¨ï¼Œå¯¦ä½œè¤‡é›œä¸”ä¸å¿…è¦

**å»ºè­°é…ç½®**ï¼š
- **æœ€å°åŒ–æ¬Šé™**ï¼šåƒ…ä½¿ç”¨ `identify`ï¼ˆæ¨è–¦èµ·æ­¥éšæ®µï¼‰
- **ç°¡åŒ–æˆæ¬Šæµç¨‹**ï¼šæ¸›å°‘ç”¨æˆ¶ç–‘æ…®ï¼Œæé«˜è½‰æ›ç‡
- **å¾ŒçºŒæ“´å±•**ï¼šå¾…æœ‰æ˜ç¢ºéœ€æ±‚æ™‚å†å¢åŠ  scopes

```

### ç’°å¢ƒè®Šæ•¸é…ç½®

```bash
# .env.local

# Discord OAuth
DISCORD_CLIENT_ID=your_client_id_here
DISCORD_CLIENT_SECRET=your_client_secret_here
DISCORD_REDIRECT_URI=https://your-domain.vercel.app/api/auth/discord/callback

# Discord Botï¼ˆå¯é¸ï¼‰
DISCORD_BOT_TOKEN=your_bot_token_here
DISCORD_GUILD_ID=your_server_id_here

# Session åŠ å¯†
SESSION_SECRET=your_random_secret_key_min_32_chars

# Database
DATABASE_URL=your_supabase_postgres_url
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key

# Redis
UPSTASH_REDIS_REST_URL=your_upstash_rest_url
UPSTASH_REDIS_REST_TOKEN=your_upstash_rest_token
```

### OAuth å®‰å…¨æ©Ÿåˆ¶

1. **State åƒæ•¸é©—è­‰**ï¼šé˜²æ­¢ CSRF æ”»æ“Š
   - ç”¢ç”Ÿéš¨æ©Ÿ state ä¸¦å­˜å…¥ JWT
   - JWT è¨­ç½® 10 åˆ†é˜éæœŸæ™‚é–“
   - å›èª¿æ™‚é©—è­‰ state ä¸€è‡´æ€§å’ŒæœªéæœŸ

2. **Token åŠ å¯†å­˜å„²**ï¼š
   - Discord access_token å’Œ refresh_token ä½¿ç”¨ AES-256-GCM åŠ å¯†
   - åŠ å¯†å¯†é‘°ä¾†è‡ªç’°å¢ƒè®Šæ•¸ SESSION_SECRET

3. **Session Cookie å®‰å…¨**ï¼š
   - HttpOnlyï¼šé˜²æ­¢ XSS æ”»æ“Š
   - Secureï¼šç”Ÿç”¢ç’°å¢ƒåƒ… HTTPS
   - SameSite=Laxï¼šé˜²æ­¢ CSRF
   - 30 å¤©æœ‰æ•ˆæœŸ

---

## è³‡æ–™åº«è¨­è¨ˆ

### ER åœ–

```
users (ç”¨æˆ¶è¡¨)
  â”œâ”€â”€ 1:N â†’ sessions (Session è¡¨)
  â”œâ”€â”€ 1:1 â†’ discord_profiles (Discord è©³ç´°è³‡æ–™)
  â”œâ”€â”€ 1:N â†’ reputation_history (ä¿¡è­½æ­·å²)
  â”œâ”€â”€ 1:N â†’ listings (åˆŠç™»è¡¨)
  â”œâ”€â”€ 1:N â†’ interests (è³¼è²·æ„å‘è¡¨ - ä½œç‚ºè²·å®¶)
  â”œâ”€â”€ 1:N â†’ reports (èˆ‰å ±è¡¨ - ä½œç‚ºèˆ‰å ±è€…)
  â””â”€â”€ 1:1 â†’ user_quotas (é…é¡è¡¨)

listings (åˆŠç™»è¡¨)
  â”œâ”€â”€ N:1 â†’ users (è³£å®¶)
  â”œâ”€â”€ 1:N â†’ interests (è³¼è²·æ„å‘)
  â””â”€â”€ 1:N â†’ reports (èˆ‰å ±)

interests (è³¼è²·æ„å‘è¡¨)
  â”œâ”€â”€ N:1 â†’ users (è²·å®¶)
  â””â”€â”€ N:1 â†’ listings (åˆŠç™»)

ip_quotas (IP é…é¡è¡¨) - ç¨ç«‹è¡¨ï¼Œç„¡å¤–éµé—œè¯
```

### æ ¸å¿ƒè¡¨çµæ§‹

#### 1. ç”¨æˆ¶è¡¨ (users)

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  discord_id VARCHAR(20) UNIQUE NOT NULL,
  discord_username VARCHAR(100) NOT NULL,
  discord_discriminator VARCHAR(4),
  discord_avatar VARCHAR(200),
  email VARCHAR(255),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  last_login_at TIMESTAMPTZ,
  banned BOOLEAN DEFAULT FALSE,
  ban_reason TEXT,

  CONSTRAINT valid_discord_id CHECK (discord_id ~ '^[0-9]{17,20}$')
);

CREATE INDEX idx_discord_id ON users(discord_id);
CREATE INDEX idx_banned_users ON users(banned) WHERE banned = TRUE;
```

#### 2. Session è¡¨ (sessions)

```sql
CREATE TABLE sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  access_token TEXT NOT NULL,
  refresh_token TEXT NOT NULL,
  expires_at TIMESTAMPTZ NOT NULL,
  created_ip INET NOT NULL,
  user_agent TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  last_active_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_user_sessions ON sessions(user_id, created_at DESC);
CREATE INDEX idx_expires ON sessions(expires_at) WHERE expires_at > NOW();
```

#### 3. Discord è©³ç´°è³‡æ–™è¡¨ (discord_profiles)

```sql
CREATE TABLE discord_profiles (
  user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  account_created_at TIMESTAMPTZ NOT NULL,
  server_member_since TIMESTAMPTZ,
  server_roles TEXT[],
  verified BOOLEAN DEFAULT FALSE,
  reputation_score INTEGER DEFAULT 0 CHECK (reputation_score >= 0 AND reputation_score <= 100),
  reputation_last_updated TIMESTAMPTZ,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_reputation ON discord_profiles(reputation_score DESC);
```

#### 4. ä¿¡è­½æ­·å²è¡¨ (reputation_history)

```sql
CREATE TABLE reputation_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  score_change INTEGER NOT NULL,
  reason VARCHAR(200) NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_user_reputation_history ON reputation_history(user_id, created_at DESC);
```

#### 5. ç‰©å“åˆŠç™»è¡¨ (listings)

```sql
CREATE TABLE listings (
  id BIGSERIAL PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  item_id INT NOT NULL,
  quantity INT DEFAULT 1 CHECK (quantity > 0),
  price BIGINT NOT NULL CHECK (price > 0),
  contact_method TEXT NOT NULL,
  contact_info TEXT,
  webhook_url TEXT,
  status TEXT DEFAULT 'active',
  view_count INT DEFAULT 0,
  interest_count INT DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  completed_at TIMESTAMPTZ,
  deleted_at TIMESTAMPTZ,

  CONSTRAINT valid_contact_method CHECK (
    contact_method IN ('discord', 'ingame')
  ),
  CONSTRAINT valid_status CHECK (
    status IN ('active', 'sold', 'cancelled', 'expired', 'suspended')
  )
);

CREATE INDEX idx_active_listings ON listings(status, created_at DESC)
  WHERE status = 'active' AND deleted_at IS NULL;
CREATE INDEX idx_item_search ON listings(item_id, price)
  WHERE status = 'active' AND deleted_at IS NULL;
CREATE INDEX idx_user_listings ON listings(user_id, created_at DESC)
  WHERE deleted_at IS NULL;
```

#### 6. è³¼è²·æ„å‘è¡¨ (interests)

```sql
CREATE TABLE interests (
  id BIGSERIAL PRIMARY KEY,
  listing_id BIGINT REFERENCES listings(id) ON DELETE CASCADE,
  buyer_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  status TEXT DEFAULT 'pending',
  contacted_at TIMESTAMPTZ,
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT unique_interest UNIQUE (listing_id, buyer_id),
  CONSTRAINT valid_status CHECK (
    status IN ('pending', 'contacted', 'completed', 'cancelled')
  )
);

CREATE INDEX idx_listing_interests ON interests(listing_id, status, created_at DESC);
CREATE INDEX idx_buyer_interests ON interests(buyer_id, status, created_at DESC);
```

#### 7. èˆ‰å ±è¡¨ (reports)

```sql
CREATE TABLE reports (
  id BIGSERIAL PRIMARY KEY,
  listing_id BIGINT REFERENCES listings(id) ON DELETE CASCADE,
  reporter_id UUID NOT NULL REFERENCES users(id) ON DELETE SET NULL,
  reason TEXT NOT NULL,
  status TEXT DEFAULT 'pending',
  admin_notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  resolved_at TIMESTAMPTZ,

  CONSTRAINT valid_status CHECK (
    status IN ('pending', 'reviewing', 'resolved', 'dismissed')
  )
);

CREATE INDEX idx_pending_reports ON reports(status, created_at DESC)
  WHERE status IN ('pending', 'reviewing');
```

#### 8. ç”¨æˆ¶é…é¡è¡¨ (user_quotas)

```sql
CREATE TABLE user_quotas (
  user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  active_listings_count INT DEFAULT 0 CHECK (active_listings_count >= 0),
  total_interests_count INT DEFAULT 0 CHECK (total_interests_count >= 0),
  interests_today INT DEFAULT 0 CHECK (interests_today >= 0),
  last_interest_date DATE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT quota_listings CHECK (active_listings_count <= 50),
  CONSTRAINT quota_interests CHECK (total_interests_count <= 100),
  CONSTRAINT quota_interests_daily CHECK (interests_today <= 20)
);
```

#### 9. IP é…é¡è¡¨ (ip_quotas)

```sql
CREATE TABLE ip_quotas (
  ip_address INET PRIMARY KEY,
  contact_views_today INT DEFAULT 0 CHECK (contact_views_today >= 0),
  last_contact_view_date DATE,
  total_contact_views INT DEFAULT 0 CHECK (total_contact_views >= 0),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT quota_contact_views_daily CHECK (contact_views_today <= 30)
);

CREATE INDEX idx_ip_contact_views ON ip_quotas(contact_views_today DESC)
  WHERE contact_views_today > 20;
```

---

## API è¨­è¨ˆ

### API ç«¯é»ç¸½è¦½

**èªè­‰ç›¸é—œ**ï¼š
- `GET /api/auth/discord` - Discord OAuth å•Ÿå‹•
- `GET /api/auth/discord/callback` - Discord OAuth å›èª¿
- `POST /api/auth/refresh` - åˆ·æ–° access_token
- `POST /api/auth/logout` - ç™»å‡º
- `GET /api/auth/me` - ç²å–ç•¶å‰ç”¨æˆ¶è³‡è¨Š

**åˆŠç™»ç›¸é—œ**ï¼š
- `GET /api/listings` - æŸ¥è©¢æˆ‘çš„åˆŠç™»
- `POST /api/listings` - å»ºç«‹åˆŠç™»
- `PATCH /api/listings/[id]` - æ›´æ–°åˆŠç™»
- `DELETE /api/listings/[id]` - åˆªé™¤åˆŠç™»
- `GET /api/listings/[id]/contact` - æŸ¥çœ‹è¯çµ¡æ–¹å¼

**å¸‚å ´ç›¸é—œ**ï¼š
- `GET /api/market` - å¸‚å ´åˆ—è¡¨ï¼ˆåˆ†é ï¼‰
- `GET /api/market/search` - æœå°‹/ç¯©é¸

**æ„å‘ç›¸é—œ**ï¼š
- `POST /api/interests` - ç™»è¨˜è³¼è²·æ„å‘
- `GET /api/interests` - æˆ‘çš„è³¼è²·æ„å‘
- `GET /api/interests/received` - æ”¶åˆ°çš„è³¼è²·æ„å‘

**ä¿¡è­½ç›¸é—œ**ï¼š
- `GET /api/reputation/[userId]` - ç²å–ç”¨æˆ¶ä¿¡è­½
- `POST /api/reputation/calculate` - é‡æ–°è¨ˆç®—ä¿¡è­½

### API èªè­‰è¦æ±‚

**âš ï¸ å®‰å…¨åŸå‰‡**ï¼šæœ¬ç³»çµ±æ¡ç”¨ **Discord OAuth å”¯ä¸€ç™»å…¥**ï¼Œæ‰€æœ‰æ•æ„Ÿæ“ä½œçš†éœ€èªè­‰ã€‚

#### ç«¯é»èªè­‰åˆ†é¡

| ç«¯é» | èªè­‰è¦æ±‚ | èªªæ˜ | RLS ç­–ç•¥ |
|------|---------|------|---------|
| **èªè­‰ç›¸é—œ** | | | |
| `GET /api/auth/discord` | ğŸ”“ å…¬é–‹ | OAuth å•Ÿå‹•æµç¨‹ | - |
| `GET /api/auth/discord/callback` | ğŸ”“ å…¬é–‹ | OAuth å›èª¿è™•ç† | - |
| `POST /api/auth/refresh` | ğŸ”’ éœ€è¦èªè­‰ | Token åˆ·æ–°ï¼ˆéœ€æœ‰æ•ˆ Sessionï¼‰ | `user_sessions` |
| `POST /api/auth/logout` | ğŸ”’ éœ€è¦èªè­‰ | ç™»å‡ºç•¶å‰ Session | `user_sessions` |
| `GET /api/auth/me` | ğŸ”’ éœ€è¦èªè­‰ | ç²å–ç•¶å‰ç”¨æˆ¶è³‡è¨Š | `users` |
| **åˆŠç™»ç›¸é—œ** | | | |
| `GET /api/listings` | ğŸ”’ éœ€è¦èªè­‰ | æŸ¥è©¢ã€Œæˆ‘çš„ã€åˆŠç™» | `listings` WHERE `user_id = auth.uid()` |
| `POST /api/listings` | ğŸ”’ éœ€è¦èªè­‰ | å»ºç«‹åˆŠç™» | `listings` INSERT CHECK `user_id = auth.uid()` |
| `PATCH /api/listings/[id]` | ğŸ”’ éœ€è¦èªè­‰ | æ›´æ–°ã€Œæˆ‘çš„ã€åˆŠç™» | `listings` UPDATE WHERE `user_id = auth.uid()` |
| `DELETE /api/listings/[id]` | ğŸ”’ éœ€è¦èªè­‰ | åˆªé™¤ã€Œæˆ‘çš„ã€åˆŠç™» | `listings` DELETE WHERE `user_id = auth.uid()` |
| `GET /api/listings/[id]/contact` | ğŸ”’ éœ€è¦èªè­‰ | æŸ¥çœ‹è³£å®¶è¯çµ¡æ–¹å¼ | - |
| **å¸‚å ´ç›¸é—œ** | | | |
| `GET /api/market` | ğŸ”’ éœ€è¦èªè­‰ | å¸‚å ´åˆ—è¡¨ï¼ˆé˜²æ­¢ Bot çˆ¬å–ï¼‰ | `listings` WHERE `status = 'active'` |
| `GET /api/market/search` | ğŸ”’ éœ€è¦èªè­‰ | æœå°‹/ç¯©é¸ï¼ˆé˜²æ­¢ Bot çˆ¬å–ï¼‰ | `listings` WHERE `status = 'active'` |
| `GET /api/market/trending` | ğŸ”“ å…¬é–‹ | ç†±é–€å•†å“ï¼ˆSEO å‹å–„ï¼‰ | `listings` WHERE `status = 'active'` |
| **æ„å‘ç›¸é—œ** | | | |
| `POST /api/interests` | ğŸ”’ éœ€è¦èªè­‰ | ç™»è¨˜è³¼è²·æ„å‘ | `interests` INSERT CHECK `buyer_id = auth.uid()` |
| `GET /api/interests` | ğŸ”’ éœ€è¦èªè­‰ | æˆ‘çš„è³¼è²·æ„å‘ | `interests` WHERE `buyer_id = auth.uid()` |
| `GET /api/interests/received` | ğŸ”’ éœ€è¦èªè­‰ | æ”¶åˆ°çš„è³¼è²·æ„å‘ | `interests` JOIN `listings` WHERE `seller_id = auth.uid()` |
| **ä¿¡è­½ç›¸é—œ** | | | |
| `GET /api/reputation/[userId]` | ğŸ”’ éœ€è¦èªè­‰ | ç²å–ç”¨æˆ¶ä¿¡è­½ï¼ˆé˜²æ­¢çˆ¬èŸ²ï¼‰ | `users` SELECT reputation fields |
| `POST /api/reputation/calculate` | ğŸ”’ éœ€è¦èªè­‰ | é‡æ–°è¨ˆç®—ä¿¡è­½ï¼ˆåƒ…é™æœ¬äººï¼‰ | `users` WHERE `id = auth.uid()` |

#### èªè­‰å¯¦ä½œæ–¹å¼

**Middleware èªè­‰æª¢æŸ¥**ï¼š

```typescript
// src/lib/middleware/api-middleware.ts

import { NextRequest } from 'next/server'
import { validateSession } from '@/lib/auth/session-validator'
import { withErrorHandler } from '@/lib/middleware/error-handler'

/**
 * éœ€è¦èªè­‰çš„ API ä¸­é–“ä»¶
 * ä½¿ç”¨æ–¹å¼ï¼šexport const POST = withAuthAndError(handlePOST, { module: 'ListingAPI' })
 */
export function withAuthAndError(
  handler: (request: NextRequest, user: User) => Promise<Response>,
  options: { module: string; enableAuditLog?: boolean }
) {
  return withErrorHandler(
    async (request: NextRequest) => {
      // 1. é©—è­‰ Session Cookie
      const session = await validateSession(request)

      if (!session.valid || !session.user) {
        return new Response(
          JSON.stringify({
            success: false,
            error: 'éœ€è¦ç™»å…¥æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½',
            code: 'UNAUTHORIZED'
          }),
          { status: 401, headers: { 'Content-Type': 'application/json' } }
        )
      }

      // 2. åŸ·è¡Œ Handlerï¼ˆuser å·²ç¢ºä¿å­˜åœ¨ï¼‰
      return handler(request, session.user)
    },
    options
  )
}
```

**ä½¿ç”¨ç¯„ä¾‹**ï¼š

```typescript
// src/app/api/listings/route.ts
import { withAuthAndError, User } from '@/lib/middleware/api-middleware'
import { success, created } from '@/lib/api-response'

async function handleGET(request: NextRequest, user: User) {
  // user å·²ç¶“éèªè­‰ï¼Œå¯ç›´æ¥ä½¿ç”¨ user.id
  const listings = await db.listings
    .select('*')
    .eq('user_id', user.id)  // RLS è‡ªå‹•éæ¿¾
    .eq('status', 'active')

  return success(listings, 'æŸ¥è©¢æˆåŠŸ')
}

async function handlePOST(request: NextRequest, user: User) {
  const data = await request.json()

  // RLS è‡ªå‹•æª¢æŸ¥ user_id = auth.uid()
  const listing = await db.listings.insert({
    ...data,
    user_id: user.id  // å¼·åˆ¶ä½¿ç”¨èªè­‰ç”¨æˆ¶ ID
  })

  return created(listing, 'åˆŠç™»å»ºç«‹æˆåŠŸ')
}

// ğŸ”’ éœ€è¦èªè­‰ï¼šä½¿ç”¨ withAuthAndError
export const GET = withAuthAndError(handleGET, { module: 'ListingAPI' })
export const POST = withAuthAndError(handlePOST, { module: 'ListingAPI' })
```

**å…¬é–‹ç«¯é»ç¯„ä¾‹**ï¼š

```typescript
// src/app/api/market/trending/route.ts
import { withErrorHandler } from '@/lib/middleware/error-handler'
import { success } from '@/lib/api-response'

async function handleGET(request: NextRequest) {
  // ğŸ”“ å…¬é–‹ç«¯é»ï¼šç„¡éœ€ user åƒæ•¸
  const trending = await db.listings
    .select('*')
    .eq('status', 'active')
    .order('view_count', { ascending: false })
    .limit(10)

  return success(trending, 'ç†±é–€å•†å“')
}

// ğŸ”“ å…¬é–‹ç«¯é»ï¼šåƒ…ä½¿ç”¨ withErrorHandlerï¼ˆä¸ä½¿ç”¨ withAuthAndErrorï¼‰
export const GET = withErrorHandler(handleGET, { module: 'TrendingAPI' })
```

#### èªè­‰å¤±æ•—è™•ç†

**401 Unauthorized å›æ‡‰æ ¼å¼**ï¼š

```json
{
  "success": false,
  "error": "éœ€è¦ç™»å…¥æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½",
  "code": "UNAUTHORIZED",
  "trace_id": "req_abc123xyz"
}
```

**å‰ç«¯è™•ç†é‚è¼¯**ï¼š

```typescript
// src/lib/api-client.ts
async function apiRequest(endpoint: string, options?: RequestInit) {
  const response = await fetch(endpoint, {
    ...options,
    credentials: 'include'  // è‡ªå‹•å¸¶ä¸Š Session Cookie
  })

  if (response.status === 401) {
    // è§¸ç™¼ç™»å…¥ Modalï¼ˆè¦‹ DDR-003ï¼šLoginModal è¨­è¨ˆæ±ºç­–ï¼‰
    const event = new CustomEvent('show-login-modal')
    window.dispatchEvent(event)
    throw new Error('éœ€è¦ç™»å…¥')
  }

  return response.json()
}
```

#### å®‰å…¨æ€§èªªæ˜

1. **Discord OAuth å”¯ä¸€èªè­‰**ï¼š
   - âœ… ç„¡å¯†ç¢¼/ä¿¡ç®±ç™»å…¥
   - âœ… ç„¡å…¶ä»–ç¤¾äº¤ç™»å…¥ï¼ˆGoogle/Facebook/GitHubï¼‰
   - âœ… Email æ¬„ä½åƒ…ä¾†è‡ª Discord OAuthï¼ˆå¯é¸ï¼Œç”¨æ–¼é€šçŸ¥ï¼‰

2. **Session å®‰å…¨**ï¼š
   - Cookie flags: `HttpOnly=true; Secure=true; SameSite=Strict`
   - Token åŠ å¯†: AES-256-GCM
   - éæœŸæ™‚é–“: 7 å¤©ï¼ˆå¯é…ç½®ï¼‰

3. **RLS é›™é‡ä¿è­·**ï¼š
   - Middleware æª¢æŸ¥ï¼šAPI å±¤ç´šèªè­‰
   - RLS Policyï¼šè³‡æ–™åº«å±¤ç´šæ¬Šé™æ§åˆ¶
   - å³ä½¿ç¹é Middlewareï¼ŒRLS ä»æœƒé˜»æ“‹æœªæˆæ¬Šå­˜å–

4. **å…¬é–‹ç«¯é»é™åˆ¶**ï¼š
   - åƒ… **trending** ç«¯é»å…¬é–‹ï¼ˆSEO éœ€æ±‚ï¼‰
   - æ‰€æœ‰ CRUD æ“ä½œçš†éœ€èªè­‰
   - å¸‚å ´åˆ—è¡¨éœ€èªè­‰ï¼ˆé˜²æ­¢ Bot å¤§é‡çˆ¬å–ï¼‰

---

## Discord Webhook é€šçŸ¥

### Webhook è¨­è¨ˆç›®æ¨™

ç•¶è²·å®¶ç™»è¨˜è³¼è²·æ„å‘æ™‚ï¼Œè‡ªå‹•ç™¼é€é€šçŸ¥åˆ°è³£å®¶çš„ Discord é »é“ï¼Œè³£å®¶å¯ä»¥å³æ™‚æ”¶åˆ°è¨Šæ¯ã€‚

### Webhook é…ç½®

**è³£å®¶è¨­ç½®æµç¨‹**ï¼š
1. åœ¨ Discord å‰µå»º Webhook URLï¼ˆä¼ºæœå™¨è¨­ç½® â†’ æ•´åˆ â†’ Webhookï¼‰
2. åœ¨äº¤æ˜“å¹³å°ã€Œå€‹äººè¨­ç½®ã€ä¸­å¡«å…¥ Webhook URL
3. ç³»çµ±é©—è­‰ Webhook URL æœ‰æ•ˆæ€§
4. å„²å­˜åˆ°è³‡æ–™åº«ï¼ˆå¯é‡å°æ¯å€‹åˆŠç™»è¨­ç½®ä¸åŒ Webhookï¼‰

### Webhook Payload æ ¼å¼

```typescript
// Discord Webhook Embed æ ¼å¼
interface WebhookPayload {
  username: string
  avatar_url: string
  embeds: [
    {
      title: string
      description: string
      color: number
      fields: Array<{
        name: string
        value: string
        inline: boolean
      }>
      thumbnail: {
        url: string
      }
      footer: {
        text: string
      }
      timestamp: string
    }
  ]
}

// ç¯„ä¾‹
const payload: WebhookPayload = {
  username: "MapleStory äº¤æ˜“ç³»çµ±",
  avatar_url: "https://your-domain.com/logo.png",
  embeds: [
    {
      title: "ğŸ”” æ–°çš„è³¼è²·æ„å‘",
      description: "æœ‰è²·å®¶å°æ‚¨çš„åˆŠç™»æ„Ÿèˆˆè¶£ï¼",
      color: 0x5865F2, // Discord Blurple
      fields: [
        {
          name: "ç‰©å“",
          value: "æ··æ²Œå·è»¸ x 10",
          inline: true
        },
        {
          name: "åƒ¹æ ¼",
          value: "500,000,000 æ¥“å¹£",
          inline: true
        },
        {
          name: "è²·å®¶",
          value: "User#1234",
          inline: false
        },
        {
          name: "è²·å®¶å‚™è¨»",
          value: "ä»Šæ™š 8 é»å¯ä»¥äº¤æ˜“",
          inline: false
        }
      ],
      thumbnail: {
        url: "https://maplestory.io/api/item/2049100/icon"
      },
      footer: {
        text: "é»æ“ŠæŸ¥çœ‹è©³æƒ…",
      },
      timestamp: new Date().toISOString()
    }
  ]
}
```

### Webhook ç™¼é€é‚è¼¯

```typescript
// src/lib/services/webhook-service.ts
export async function sendInterestNotification(
  webhookUrl: string,
  interest: Interest,
  listing: Listing,
  buyer: User
) {
  const payload: WebhookPayload = {
    username: "MapleStory äº¤æ˜“ç³»çµ±",
    avatar_url: "https://your-domain.com/logo.png",
    embeds: [
      {
        title: "ğŸ”” æ–°çš„è³¼è²·æ„å‘",
        description: `**${buyer.discord_username}** å°æ‚¨çš„åˆŠç™»æ„Ÿèˆˆè¶£ï¼`,
        color: 0x5865F2,
        fields: [
          {
            name: "ç‰©å“",
            value: `${listing.item_name} x ${listing.quantity}`,
            inline: true
          },
          {
            name: "åƒ¹æ ¼",
            value: `${listing.price.toLocaleString()} æ¥“å¹£`,
            inline: true
          },
          {
            name: "è²·å®¶",
            value: `${buyer.discord_username}`,
            inline: false
          },
          {
            name: "è²·å®¶ä¿¡è­½",
            value: getReputationBadge(buyer.reputation_score),
            inline: false
          },
          ...(interest.notes
            ? [
                {
                  name: "è²·å®¶å‚™è¨»",
                  value: interest.notes,
                  inline: false
                }
              ]
            : [])
        ],
        footer: {
          text: "å‰å¾€äº¤æ˜“ç³»çµ±æŸ¥çœ‹è©³æƒ…",
        },
        timestamp: new Date().toISOString()
      }
    ]
  }

  try {
    const response = await fetch(webhookUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload),
    })

    if (!response.ok) {
      throw new Error(`Webhook failed: ${response.statusText}`)
    }

    return { success: true }
  } catch (error) {
    console.error('Failed to send webhook:', error)
    return { success: false, error }
  }
}

function getReputationBadge(score: number): string {
  if (score >= 80) return 'âœ… è³‡æ·±ç”¨æˆ¶ (80+)'
  if (score >= 50) return 'ğŸŸ¢ å¯ä¿¡ç”¨æˆ¶ (50-79)'
  if (score >= 20) return 'ğŸŸ¡ æ™®é€šç”¨æˆ¶ (20-49)'
  return 'ğŸ”´ æ–°æ‰‹ç”¨æˆ¶ (0-19)'
}
```

### Webhook å®‰å…¨æ©Ÿåˆ¶

#### å®‰å…¨è¨­è¨ˆæ¦‚è¦½

**æ ¸å¿ƒå®‰å…¨åŸå‰‡**ï¼š
- âœ… **åš´æ ¼ URL é©—è­‰** - åªå…è¨± Discord å®˜æ–¹ Webhook URL
- âœ… **æ¸¬è©¦ç™¼é€æ©Ÿåˆ¶** - å„²å­˜å‰é©—è­‰ Webhook æœ‰æ•ˆæ€§
- âœ… **é€Ÿç‡é™åˆ¶** - æ¯å€‹ Webhook æ¯å°æ™‚æœ€å¤š 30 æ¢é€šçŸ¥
- âœ… **å¤±æ•—è™•ç†** - é€£çºŒå¤±æ•— 5 æ¬¡è‡ªå‹•åœç”¨
- âœ… **ç”¨æˆ¶é…é¡** - æ¯å€‹ç”¨æˆ¶æœ€å¤š 5 å€‹ Webhook

#### Webhook URL é©—è­‰

**åªå…è¨± Discord å®˜æ–¹æ ¼å¼**ï¼š

```typescript
// src/lib/validators/webhook-validator.ts
const DISCORD_WEBHOOK_REGEX = /^https:\/\/discord\.com\/api\/webhooks\/\d+\/[\w-]+$/
const DISCORDAPP_WEBHOOK_REGEX = /^https:\/\/discordapp\.com\/api\/webhooks\/\d+\/[\w-]+$/

export function isValidDiscordWebhookUrl(url: string): boolean {
  if (!url || typeof url !== 'string') {
    return false
  }

  // åªå…è¨± Discord å®˜æ–¹åŸŸå
  return DISCORD_WEBHOOK_REGEX.test(url) || DISCORDAPP_WEBHOOK_REGEX.test(url)
}

export function validateWebhookUrl(url: string): { valid: boolean; error?: string } {
  // 1. åŸºæœ¬æ ¼å¼é©—è­‰
  if (!isValidDiscordWebhookUrl(url)) {
    return {
      valid: false,
      error: 'ç„¡æ•ˆçš„ Discord Webhook URL æ ¼å¼ã€‚è«‹ä½¿ç”¨ Discord å®˜æ–¹ Webhook URLã€‚'
    }
  }

  // 2. é•·åº¦é™åˆ¶
  if (url.length > 500) {
    return {
      valid: false,
      error: 'Webhook URL é•·åº¦éé•·ã€‚'
    }
  }

  return { valid: true }
}
```

#### æ¸¬è©¦ç™¼é€æ©Ÿåˆ¶

**å„²å­˜å‰é©—è­‰ Webhook æœ‰æ•ˆæ€§**ï¼š

```typescript
// src/lib/services/webhook-service.ts
export async function testWebhook(
  webhookUrl: string
): Promise<{ success: boolean; error?: string }> {
  // 1. æ ¼å¼é©—è­‰
  const validation = validateWebhookUrl(webhookUrl)
  if (!validation.valid) {
    return { success: false, error: validation.error }
  }

  // 2. ç™¼é€æ¸¬è©¦è¨Šæ¯
  const testPayload = {
    username: "MapleStory äº¤æ˜“ç³»çµ±",
    content: "âœ… Webhook æ¸¬è©¦æˆåŠŸï¼æ‚¨å·²æˆåŠŸè¨­å®šé€šçŸ¥ã€‚",
    embeds: [
      {
        title: "ğŸ”” Webhook æ¸¬è©¦",
        description: "é€™æ˜¯ä¸€æ¢æ¸¬è©¦è¨Šæ¯ï¼Œç”¨æ–¼é©—è­‰ Webhook è¨­å®šã€‚",
        color: 0x57F287, // Green
        footer: {
          text: "MapleStory äº¤æ˜“ç³»çµ±"
        },
        timestamp: new Date().toISOString()
      }
    ]
  }

  try {
    const response = await fetch(webhookUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(testPayload),
      signal: AbortSignal.timeout(5000) // 5 ç§’è¶…æ™‚
    })

    if (!response.ok) {
      const errorText = await response.text()

      // æ ¹æ“š Discord éŒ¯èª¤ç¢¼è¿”å›å‹å¥½è¨Šæ¯
      if (response.status === 404) {
        return { success: false, error: 'Webhook ä¸å­˜åœ¨æˆ–å·²è¢«åˆªé™¤ã€‚' }
      }
      if (response.status === 401) {
        return { success: false, error: 'Webhook URL ç„¡æ•ˆæˆ–æ¬Šé™ä¸è¶³ã€‚' }
      }
      if (response.status === 429) {
        return { success: false, error: 'Discord API é€Ÿç‡é™åˆ¶ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚' }
      }

      return {
        success: false,
        error: `Webhook æ¸¬è©¦å¤±æ•—ï¼š${response.statusText}`
      }
    }

    return { success: true }
  } catch (error) {
    if (error instanceof Error) {
      if (error.name === 'AbortError') {
        return { success: false, error: 'Webhook æ¸¬è©¦è¶…æ™‚ï¼ˆ5 ç§’ï¼‰ã€‚' }
      }
      return { success: false, error: `ç¶²è·¯éŒ¯èª¤ï¼š${error.message}` }
    }
    return { success: false, error: 'æœªçŸ¥éŒ¯èª¤ã€‚' }
  }
}
```

#### é€Ÿç‡é™åˆ¶å¯¦ä½œ

**æ¯å€‹ Webhook æ¯å°æ™‚æœ€å¤š 30 æ¢é€šçŸ¥**ï¼š

```typescript
// src/lib/services/webhook-rate-limiter.ts
import { redis } from '@/lib/redis'

const WEBHOOK_RATE_LIMIT = 30 // æ¯å°æ™‚ 30 æ¢
const WEBHOOK_RATE_WINDOW = 3600 // 1 å°æ™‚

export async function checkWebhookRateLimit(
  webhookId: string
): Promise<{ allowed: boolean; remaining: number; resetAt: Date }> {
  const key = `webhook:ratelimit:${webhookId}`

  const count = await redis.incr(key)

  if (count === 1) {
    // ç¬¬ä¸€æ¬¡è«‹æ±‚ï¼Œè¨­ç½®éæœŸæ™‚é–“
    await redis.expire(key, WEBHOOK_RATE_WINDOW)
  }

  const ttl = await redis.ttl(key)
  const resetAt = new Date(Date.now() + ttl * 1000)
  const remaining = Math.max(0, WEBHOOK_RATE_LIMIT - count)

  return {
    allowed: count <= WEBHOOK_RATE_LIMIT,
    remaining,
    resetAt
  }
}

// ä½¿ç”¨ç¯„ä¾‹
export async function sendInterestNotificationWithRateLimit(
  webhookId: string,
  webhookUrl: string,
  interest: Interest,
  listing: Listing,
  buyer: User
): Promise<{ success: boolean; error?: string }> {
  // 1. æª¢æŸ¥é€Ÿç‡é™åˆ¶
  const rateLimit = await checkWebhookRateLimit(webhookId)

  if (!rateLimit.allowed) {
    return {
      success: false,
      error: `Webhook é€Ÿç‡é™åˆ¶å·²é”ä¸Šé™ï¼ˆ${WEBHOOK_RATE_LIMIT} æ¢/å°æ™‚ï¼‰ã€‚å°‡æ–¼ ${rateLimit.resetAt.toLocaleString('zh-TW')} é‡ç½®ã€‚`
    }
  }

  // 2. ç™¼é€é€šçŸ¥
  const result = await sendInterestNotification(webhookUrl, interest, listing, buyer)

  return result
}
```

#### å¤±æ•—è™•ç†èˆ‡è‡ªå‹•åœç”¨

**é€£çºŒå¤±æ•— 5 æ¬¡è‡ªå‹•åœç”¨ Webhook**ï¼š

```typescript
// Database Schema
interface WebhookStatus {
  webhook_id: string
  user_id: string
  webhook_url: string
  is_active: boolean
  consecutive_failures: number
  last_failure_at: Date | null
  last_success_at: Date | null
  total_sent: number
  total_failed: number
  created_at: Date
  updated_at: Date
}

// src/lib/services/webhook-failure-handler.ts
const MAX_CONSECUTIVE_FAILURES = 5

export async function handleWebhookFailure(
  webhookId: string
): Promise<{ disabled: boolean }> {
  const webhook = await supabase
    .from('webhooks')
    .select('*')
    .eq('id', webhookId)
    .single()

  if (!webhook.data) {
    throw new Error('Webhook not found')
  }

  const consecutiveFailures = (webhook.data.consecutive_failures || 0) + 1

  // æ›´æ–°å¤±æ•—æ¬¡æ•¸
  const updates: Partial<WebhookStatus> = {
    consecutive_failures: consecutiveFailures,
    last_failure_at: new Date(),
    total_failed: (webhook.data.total_failed || 0) + 1,
    updated_at: new Date()
  }

  // é”åˆ°å¤±æ•—ä¸Šé™ï¼Œè‡ªå‹•åœç”¨
  if (consecutiveFailures >= MAX_CONSECUTIVE_FAILURES) {
    updates.is_active = false
  }

  await supabase
    .from('webhooks')
    .update(updates)
    .eq('id', webhookId)

  // ç™¼é€é€šçŸ¥çµ¦ç”¨æˆ¶
  if (consecutiveFailures >= MAX_CONSECUTIVE_FAILURES) {
    await notifyUserWebhookDisabled(webhook.data.user_id, webhook.data.webhook_url)
  }

  return { disabled: consecutiveFailures >= MAX_CONSECUTIVE_FAILURES }
}

export async function handleWebhookSuccess(webhookId: string): Promise<void> {
  await supabase
    .from('webhooks')
    .update({
      consecutive_failures: 0, // é‡ç½®å¤±æ•—è¨ˆæ•¸
      last_success_at: new Date(),
      total_sent: supabase.sql`total_sent + 1`,
      updated_at: new Date()
    })
    .eq('id', webhookId)
}

async function notifyUserWebhookDisabled(userId: string, webhookUrl: string): Promise<void> {
  // å¯¦ä½œï¼šç™¼é€é›»å­éƒµä»¶æˆ–åœ¨ç³»çµ±å…§é¡¯ç¤ºé€šçŸ¥
  // å‘ŠçŸ¥ç”¨æˆ¶ Webhook å·²è¢«åœç”¨ï¼Œéœ€è¦é‡æ–°æ¸¬è©¦ä¸¦å•Ÿç”¨
  console.log(`Webhook disabled for user ${userId}: ${webhookUrl}`)
}
```

#### ç”¨æˆ¶é…é¡ç®¡ç†

**æ¯å€‹ç”¨æˆ¶æœ€å¤š 5 å€‹ Webhook**ï¼š

```typescript
// src/lib/services/webhook-quota.ts
const MAX_WEBHOOKS_PER_USER = 5

export async function checkUserWebhookQuota(
  userId: string
): Promise<{ allowed: boolean; current: number; limit: number }> {
  const { count } = await supabase
    .from('webhooks')
    .select('*', { count: 'exact', head: true })
    .eq('user_id', userId)
    .eq('is_active', true)

  const current = count || 0

  return {
    allowed: current < MAX_WEBHOOKS_PER_USER,
    current,
    limit: MAX_WEBHOOKS_PER_USER
  }
}

// API ç«¯é»ä½¿ç”¨ç¯„ä¾‹
export async function createWebhook(
  userId: string,
  webhookUrl: string
): Promise<{ success: boolean; webhookId?: string; error?: string }> {
  // 1. æª¢æŸ¥ç”¨æˆ¶é…é¡
  const quota = await checkUserWebhookQuota(userId)
  if (!quota.allowed) {
    return {
      success: false,
      error: `æ‚¨å·²é”åˆ° Webhook æ•¸é‡ä¸Šé™ï¼ˆ${quota.limit} å€‹ï¼‰ã€‚è«‹åˆªé™¤èˆŠçš„ Webhook å¾Œå†æ–°å¢ã€‚`
    }
  }

  // 2. é©—è­‰ URL æ ¼å¼
  const validation = validateWebhookUrl(webhookUrl)
  if (!validation.valid) {
    return { success: false, error: validation.error }
  }

  // 3. æ¸¬è©¦ Webhook
  const testResult = await testWebhook(webhookUrl)
  if (!testResult.success) {
    return { success: false, error: testResult.error }
  }

  // 4. å„²å­˜åˆ°è³‡æ–™åº«
  const { data, error } = await supabase
    .from('webhooks')
    .insert({
      user_id: userId,
      webhook_url: webhookUrl,
      is_active: true,
      consecutive_failures: 0,
      total_sent: 0,
      total_failed: 0,
      created_at: new Date(),
      updated_at: new Date()
    })
    .select()
    .single()

  if (error) {
    return { success: false, error: 'å„²å­˜ Webhook å¤±æ•—ã€‚' }
  }

  return { success: true, webhookId: data.id }
}
```

#### Webhook è³‡æ–™åº« Schema

```sql
-- Webhook é…ç½®è¡¨
CREATE TABLE webhooks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  webhook_url TEXT NOT NULL CHECK (char_length(webhook_url) <= 500),

  -- ç‹€æ…‹ç®¡ç†
  is_active BOOLEAN DEFAULT true,
  consecutive_failures INT DEFAULT 0 CHECK (consecutive_failures >= 0),

  -- æ™‚é–“æˆ³è¨˜
  last_failure_at TIMESTAMPTZ,
  last_success_at TIMESTAMPTZ,

  -- çµ±è¨ˆæ•¸æ“š
  total_sent INT DEFAULT 0 CHECK (total_sent >= 0),
  total_failed INT DEFAULT 0 CHECK (total_failed >= 0),

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  CONSTRAINT webhooks_user_quota CHECK (
    (SELECT COUNT(*) FROM webhooks WHERE user_id = webhooks.user_id AND is_active = true) <= 5
  )
);

-- ç´¢å¼•
CREATE INDEX idx_webhooks_user ON webhooks(user_id) WHERE is_active = true;
CREATE INDEX idx_webhooks_failures ON webhooks(consecutive_failures) WHERE consecutive_failures >= 3;

-- RLS ç­–ç•¥
ALTER TABLE webhooks ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own webhooks"
  ON webhooks FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own webhooks"
  ON webhooks FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own webhooks"
  ON webhooks FOR UPDATE
  USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own webhooks"
  ON webhooks FOR DELETE
  USING (auth.uid() = user_id);
```

---

## Discord Bot ä¼ºæœå™¨æ•´åˆ

### Bot åŠŸèƒ½æ¦‚è¦½

Discord Bot æä¾›ä»¥ä¸‹æŒ‡ä»¤ï¼š
- `/verify` - ç¶å®šéŠæˆ²è§’è‰²åˆ° Discord å¸³è™Ÿ
- `/listings` - æŸ¥è©¢å€‹äººåˆŠç™»
- `/market` - æœå°‹å¸‚å ´ç‰©å“
- `/stats` - æŸ¥çœ‹äº¤æ˜“çµ±è¨ˆ
- `/reputation` - æŸ¥çœ‹ä¿¡è­½åˆ†æ•¸

### Bot æ¶æ§‹

```typescript
// src/bot/index.ts
import { Client, GatewayIntentBits } from 'discord.js'

const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMembers,
  ]
})

client.on('ready', () => {
  console.log(`Bot logged in as ${client.user?.tag}`)
})

client.on('interactionCreate', async (interaction) => {
  if (!interaction.isChatInputCommand()) return

  const { commandName } = interaction

  switch (commandName) {
    case 'verify':
      await handleVerify(interaction)
      break
    case 'listings':
      await handleListings(interaction)
      break
    case 'market':
      await handleMarket(interaction)
      break
    case 'stats':
      await handleStats(interaction)
      break
    case 'reputation':
      await handleReputation(interaction)
      break
  }
})

client.login(process.env.DISCORD_BOT_TOKEN)
```

### Bot éƒ¨ç½²

**âš ï¸ é‡è¦æé†’ï¼šDiscord Bot ç‚ºå¯é¸åŠŸèƒ½**

Discord Bot æä¾›ä¾¿åˆ©çš„ Discord å…§æŸ¥è©¢åŠŸèƒ½ï¼Œä½†**ä¸æ˜¯å¿…è¦å…ƒä»¶**ã€‚è‹¥é ç®—æœ‰é™ï¼Œå¯æš«æ™‚ä¸éƒ¨ç½² Botï¼Œåƒ…ä¿ç•™ Web ä»‹é¢å’Œ Webhook é€šçŸ¥åŠŸèƒ½ã€‚

**é¸é … 1ï¼šRenderï¼ˆæ¨è–¦å…è²»æ–¹æ¡ˆï¼‰**
- **å…è²»å±¤**ï¼š750 å°æ™‚/æœˆï¼ˆå¯æŒçºŒé‹è¡Œ ~31 å¤©ï¼‰
- è‡ªå‹•å¾ GitHub éƒ¨ç½²
- æ”¯æ´ç’°å¢ƒè®Šæ•¸ç®¡ç†
- **é©åˆ**ï¼šå€‹äººå°ˆæ¡ˆã€ä½æµé‡æ‡‰ç”¨

**é¸é … 2ï¼šRailwayï¼ˆä»˜è²»ç‚ºä¸»ï¼‰**
- âŒ **å…è²»å±¤é™åˆ¶**ï¼š$5 å…è²»é¡åº¦ â‰ˆ 20.8 å¤©ï¼ˆéæŒçºŒæœˆè²»ï¼‰
- âš ï¸ **ä¸æ¨è–¦å…è²»ç‰ˆ**ï¼šæ¯æœˆæœƒç”¨å®Œé¡åº¦ï¼Œéœ€å‡ç´šä»˜è²»æ–¹æ¡ˆ
- **ä»˜è²»ç‰ˆ**ï¼š$5/æœˆèµ·ï¼ˆé©åˆå•†æ¥­ç”¨é€”ï¼‰

**é¸é … 3ï¼šä¸éƒ¨ç½² Botï¼ˆæ¨è–¦èµ·æ­¥éšæ®µï¼‰**
- ğŸ’¡ **æœ€ç¶“æ¿Ÿæ–¹æ¡ˆ**ï¼šå®Œå…¨å…è²»
- ç”¨æˆ¶é€é Web ä»‹é¢å®Œæˆæ‰€æœ‰æ“ä½œ
- ä¿ç•™ Webhook é€šçŸ¥åŠŸèƒ½ï¼ˆä»å¯æ¥æ”¶å³æ™‚é€šçŸ¥ï¼‰
- **å¾ŒçºŒæ“´å±•**ï¼šå¾…ç”¨æˆ¶å¢é•·å¾Œå†è€ƒæ…®éƒ¨ç½² Bot

**éƒ¨ç½²å»ºè­°**ï¼š
- ğŸ¯ **èµ·æ­¥éšæ®µ**ï¼šä¸éƒ¨ç½² Botï¼Œå°ˆæ³¨ Web åŠŸèƒ½
- ğŸ“ˆ **æˆé•·æœŸ**ï¼ˆ100+ æ´»èºç”¨æˆ¶ï¼‰ï¼šéƒ¨ç½²åˆ° Render å…è²»ç‰ˆ
- ğŸ’° **æˆç†ŸæœŸ**ï¼ˆ500+ æ´»èºç”¨æˆ¶ï¼‰ï¼šå‡ç´š Railway ä»˜è²»ç‰ˆæˆ–è‡ªæ¶ä¼ºæœå™¨

---

## ä¿¡è­½ç³»çµ±

### ä¿¡è­½è©•åˆ†æ©Ÿåˆ¶

**è©•åˆ†ç¯„åœ**ï¼š0-100 åˆ†

**è©•åˆ†è¨ˆç®—**ï¼š

```typescript
function calculateReputationScore(profile: DiscordProfile): number {
  let score = 0

  // 1. Discord å¸³è™Ÿå¹´é½¡ï¼ˆæœ€é«˜ 50 åˆ†ï¼‰
  const accountAge = calculateAccountAge(profile.account_created_at)
  if (accountAge >= 365 * 3) score += 50        // 3å¹´+ â†’ 50åˆ†
  else if (accountAge >= 365 * 2) score += 40   // 2å¹´+ â†’ 40åˆ†
  else if (accountAge >= 365) score += 30       // 1å¹´+ â†’ 30åˆ†
  else if (accountAge >= 180) score += 20       // åŠå¹´+ â†’ 20åˆ†
  else if (accountAge >= 90) score += 10        // 3å€‹æœˆ+ â†’ 10åˆ†
  else score += 5                               // < 3å€‹æœˆ â†’ 5åˆ†

  // 2. Discord å®˜æ–¹é©—è­‰ï¼ˆ+15 åˆ†ï¼‰
  if (profile.verified) score += 15

  // 3. ä¼ºæœå™¨æˆå“¡ï¼ˆ+20 åˆ†ï¼‰
  if (profile.server_member_since) {
    const memberAge = calculateMemberAge(profile.server_member_since)
    if (memberAge >= 180) score += 20           // åŠå¹´+ â†’ 20åˆ†
    else if (memberAge >= 90) score += 15       // 3å€‹æœˆ+ â†’ 15åˆ†
    else if (memberAge >= 30) score += 10       // 1å€‹æœˆ+ â†’ 10åˆ†
    else score += 5                             // < 1å€‹æœˆ â†’ 5åˆ†
  }

  // 4. ä¼ºæœå™¨è§’è‰²ï¼ˆ+15 åˆ†ï¼‰
  if (profile.server_roles && profile.server_roles.length > 0) {
    score += 15
  }

  return Math.min(score, 100) // ä¸Šé™ 100 åˆ†
}

function calculateAccountAge(createdAt: Date): number {
  const now = new Date()
  const created = new Date(createdAt)
  return Math.floor((now.getTime() - created.getTime()) / (1000 * 60 * 60 * 24))
}
```

### ä¿¡è­½ç­‰ç´š

| åˆ†æ•¸ç¯„åœ | ç­‰ç´š | åœ–ç¤º | èªªæ˜ |
|---------|-----|-----|------|
| 80-100 | è³‡æ·±ç”¨æˆ¶ | âœ… | Discord å¸³è™Ÿ 2 å¹´ä»¥ä¸Š + ä¼ºæœå™¨æˆå“¡ + é©—è­‰ |
| 50-79 | å¯ä¿¡ç”¨æˆ¶ | ğŸŸ¢ | Discord å¸³è™Ÿ 1 å¹´ä»¥ä¸Šæˆ–ä¼ºæœå™¨æˆå“¡ |
| 20-49 | æ™®é€šç”¨æˆ¶ | ğŸŸ¡ | Discord å¸³è™Ÿ 3 å€‹æœˆä»¥ä¸Š |
| 0-19 | æ–°æ‰‹ç”¨æˆ¶ | ğŸ”´ | Discord å¸³è™Ÿè¼ƒæ–° |

### ç³»çµ±é™åˆ¶èˆ‡èªªæ˜

**âš ï¸ é‡è¦é™åˆ¶**ï¼š

1. **ç„¡æ³•é˜²æ­¢å¸³è™Ÿè½‰è®“**
   - Discord å¸³è™Ÿå¯è¢«è²·è³£æˆ–è½‰è®“
   - è€å¸³è™Ÿä¸ç­‰æ–¼å¯ä¿¡ç”¨æˆ¶
   - **ç·©è§£æ–¹æ¡ˆ**ï¼šçµåˆäº¤æ˜“æ­·å²ã€èˆ‰å ±ç³»çµ±ç¶œåˆè©•ä¼°

2. **ä¼ºæœå™¨æˆå“¡åŠŸèƒ½éœ€ guilds.members.read**
   - éœ€è¦é¡å¤– OAuth scopeï¼Œå¢åŠ ç”¨æˆ¶æˆæ¬Šæ‘©æ“¦
   - å¯¦ä½œè¼ƒè¤‡é›œï¼ˆéœ€ Discord Bot + Guild æ¬Šé™ï¼‰
   - **å»ºè­°**ï¼šv1.0 ç‰ˆæœ¬æš«ä¸å¯¦ä½œï¼Œåƒ…ä½¿ç”¨å¸³è™Ÿå¹´é½¡è©•åˆ†

3. **ç„¡æ³•æª¢æ¸¬è™›å‡ä¿¡è­½**
   - æƒ¡æ„ç”¨æˆ¶å¯ç”¨è€å¸³è™Ÿé€²è¡Œè©é¨™
   - ä¿¡è­½ç³»çµ±åªæ˜¯åƒè€ƒæŒ‡æ¨™ï¼Œéçµ•å°ä¿è­‰
   - **ç·©è§£æ–¹æ¡ˆ**ï¼šæé†’ç”¨æˆ¶è¬¹æ…äº¤æ˜“ã€ä¿ç•™è­‰æ“š

**ç•¶å‰å¯¦ä½œå»ºè­°**ï¼ˆv1.0 ç°¡åŒ–ç‰ˆæœ¬ï¼‰ï¼š

```typescript
// ç°¡åŒ–ç‰ˆä¿¡è­½è¨ˆç®—ï¼ˆåƒ…ä½¿ç”¨ identify scope å¯ç²å–çš„è³‡æ–™ï¼‰
function calculateReputationScore(profile: DiscordProfile): number {
  let score = 0

  // 1. Discord å¸³è™Ÿå¹´é½¡ï¼ˆæœ€é«˜ 70 åˆ†ï¼‰
  const accountAge = calculateAccountAge(profile.account_created_at)
  if (accountAge >= 365 * 3) score += 70        // 3å¹´+ â†’ 70åˆ†
  else if (accountAge >= 365 * 2) score += 55   // 2å¹´+ â†’ 55åˆ†
  else if (accountAge >= 365) score += 40       // 1å¹´+ â†’ 40åˆ†
  else if (accountAge >= 180) score += 25       // åŠå¹´+ â†’ 25åˆ†
  else if (accountAge >= 90) score += 15        // 3å€‹æœˆ+ â†’ 15åˆ†
  else score += 5                               // < 3å€‹æœˆ â†’ 5åˆ†

  // 2. Discord å®˜æ–¹é©—è­‰ï¼ˆ+30 åˆ†ï¼‰
  if (profile.verified) score += 30

  return Math.min(score, 100) // ä¸Šé™ 100 åˆ†
}
```

**ç°¡åŒ–ç‰ˆä¿¡è­½ç­‰ç´š**ï¼š

| åˆ†æ•¸ç¯„åœ | ç­‰ç´š | èªªæ˜ |
|---------|-----|------|
| 70-100 | è³‡æ·±ç”¨æˆ¶ | Discord å¸³è™Ÿ 2+ å¹´ä¸”å®˜æ–¹é©—è­‰ |
| 40-69 | å¯ä¿¡ç”¨æˆ¶ | Discord å¸³è™Ÿ 1+ å¹´ |
| 15-39 | æ™®é€šç”¨æˆ¶ | Discord å¸³è™Ÿ 3+ å€‹æœˆ |
| 0-14 | æ–°æ‰‹ç”¨æˆ¶ | Discord å¸³è™Ÿè¼ƒæ–° |

### æœªä¾†å¢å¼·å»ºè­°

**éšæ®µ 2ï¼šäº¤æ˜“æ­·å²æ•´åˆ**ï¼ˆå¾…ç³»çµ±é‹è¡Œå¾Œå¯¦ä½œï¼‰

```typescript
// æ•´åˆå¹³å°å…§äº¤æ˜“æ­·å²
function calculateEnhancedReputation(userId: string): number {
  const baseScore = calculateReputationScore(profile)

  // åŠ å…¥äº¤æ˜“æ­·å²è©•åˆ†ï¼ˆæœ€é«˜ +20 åˆ†ï¼‰
  const completedTrades = getCompletedTrades(userId)
  const tradeScore = Math.min(completedTrades.length * 2, 20)

  // æ‰£é™¤è² è©•åˆ†æ•¸
  const reports = getUserReports(userId)
  const penaltyScore = reports.length * 10

  return Math.max(0, Math.min(baseScore + tradeScore - penaltyScore, 100))
}
```

**éšæ®µ 3ï¼šç¤¾ç¾¤è©•åƒ¹ç³»çµ±**ï¼ˆé•·æœŸè¦åŠƒï¼‰

- å…è¨±äº¤æ˜“é›™æ–¹äº’ç›¸è©•åƒ¹
- è¨ˆç®—ã€Œå¥½è©•ç‡ã€ä½œç‚ºä¿¡è­½æŒ‡æ¨™
- é˜²ä½œå¼Šæ©Ÿåˆ¶ï¼šåªæœ‰å®Œæˆäº¤æ˜“çš„é›™æ–¹å¯è©•åƒ¹

**éšæ®µ 4ï¼šå¤–éƒ¨ä¿¡è­½ä¾†æº**ï¼ˆå¯é¸ï¼‰

- æ•´åˆå…¶ä»–äº¤æ˜“å¹³å°ä¿¡è­½ï¼ˆå¦‚ Reddit karmaï¼‰
- é€£çµ Steamã€PSN ç­‰éŠæˆ²å¸³è™Ÿ
- æä¾›å¤šå…ƒåŒ–ä¿¡è­½é©—è­‰

---

## å®‰å…¨æ€§è¨­è¨ˆ

### 1. Discord OAuth å®‰å…¨

- **State åƒæ•¸é©—è­‰**ï¼šé˜²æ­¢ CSRF æ”»æ“Š
- **Token åŠ å¯†å­˜å„²**ï¼šAES-256-GCM åŠ å¯†
- **Session Cookie å®‰å…¨**ï¼šHttpOnly + Secure + SameSite

### 2. API å®‰å…¨

- **Rate Limiting**ï¼šé˜²æ­¢æ¿«ç”¨ï¼ˆ10K è«‹æ±‚/å¤©ï¼‰
- **Bot Detection**ï¼šUser-Agent éæ¿¾
- **IP é…é¡**ï¼šé˜²æ­¢å¤šå¸³è™Ÿç¹é

### 3. è³‡æ–™åº«å®‰å…¨

- **Row Level Security**ï¼šSupabase RLS Policies
- **è¼¸å…¥é©—è­‰**ï¼šCHECK ç´„æŸ
- **SQL Injection é˜²è­·**ï¼šåƒæ•¸åŒ–æŸ¥è©¢

### 4. å®‰å…¨æ€§é¢¨éšªèˆ‡é˜²è­·è©³è§£

#### Token æ´©æ¼é¢¨éšªèˆ‡é˜²è­·

**é¢¨éšªå ´æ™¯**ï¼š
- ğŸ”´ **XSS æ”»æ“Šç«Šå– Cookie**ï¼šé›–ç„¶ä½¿ç”¨ HttpOnlyï¼Œä½†ä»éœ€é˜²ç¯„ XSS
- ğŸ”´ **CSRF æ”»æ“Š**ï¼šå½é€ è«‹æ±‚åˆ©ç”¨å·²ç™»å…¥çš„ session
- ğŸ”´ **ä¸­é–“äººæ”»æ“Š**ï¼šHTTP é€£æ¥è¢«ç«Šè½

**é˜²è­·æªæ–½**ï¼š

```typescript
// src/lib/security/xss-prevention.ts
import DOMPurify from 'isomorphic-dompurify'

// 1. è¼¸å…¥æ¸…ç†ï¼ˆé˜²æ­¢ XSSï¼‰
export function sanitizeUserInput(input: string): string {
  return DOMPurify.sanitize(input, {
    ALLOWED_TAGS: [], // ä¸å…è¨±ä»»ä½• HTML æ¨™ç±¤
    ALLOWED_ATTR: []
  })
}

// 2. è¼¸å‡ºç·¨ç¢¼
export function encodeHTML(str: string): string {
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#x27;')
}

// ä½¿ç”¨ç¯„ä¾‹
export async function createListing(data: ListingInput): Promise<Listing> {
  const sanitized = {
    ...data,
    item_name: sanitizeUserInput(data.item_name),
    description: sanitizeUserInput(data.description),
    discord_contact: sanitizeUserInput(data.discord_contact)
  }

  return await db.listings.create(sanitized)
}
```

#### CSRF é˜²è­·å®Œæ•´æ–¹æ¡ˆ

**State åƒæ•¸ç”Ÿæˆèˆ‡é©—è­‰**ï¼š

```typescript
// src/lib/security/csrf.ts
import crypto from 'crypto'
import { redis } from '@/lib/redis'

export function generateStateToken(): string {
  return crypto.randomBytes(32).toString('hex')
}

export async function storeStateToken(state: string): Promise<void> {
  // å„²å­˜åˆ° Redisï¼Œ5 åˆ†é˜éæœŸ
  await redis.setex(`oauth:state:${state}`, 300, '1')
}

export async function validateStateToken(state: string): Promise<boolean> {
  const exists = await redis.get(`oauth:state:${state}`)
  if (exists) {
    // é©—è­‰å¾Œç«‹å³åˆªé™¤ï¼ˆä¸€æ¬¡æ€§ä½¿ç”¨ï¼‰
    await redis.del(`oauth:state:${state}`)
    return true
  }
  return false
}

// Discord OAuth å•Ÿå‹•
export async function GET(request: NextRequest) {
  const state = generateStateToken()
  await storeStateToken(state)

  const params = new URLSearchParams({
    client_id: process.env.DISCORD_CLIENT_ID!,
    redirect_uri: process.env.DISCORD_REDIRECT_URI!,
    response_type: 'code',
    scope: 'identify',
    state
  })

  return NextResponse.redirect(`https://discord.com/api/oauth2/authorize?${params}`)
}

// Discord OAuth å›èª¿
export async function GET(request: NextRequest) {
  const { searchParams } = request.nextUrl
  const state = searchParams.get('state')
  const code = searchParams.get('code')

  if (!state || !code) {
    return new NextResponse('Missing parameters', { status: 400 })
  }

  // é©—è­‰ state token
  const isValid = await validateStateToken(state)
  if (!isValid) {
    return new NextResponse('Invalid state token', { status: 403 })
  }

  // ç¹¼çºŒ OAuth æµç¨‹...
}
```

#### SQL Injection é˜²è­·ç¯„ä¾‹

**éŒ¯èª¤åšæ³•**ï¼ˆæ˜“å—æ”»æ“Šï¼‰ï¼š

```typescript
// âŒ éŒ¯èª¤ï¼šå­—ä¸²æ‹¼æ¥æŸ¥è©¢
async function getUser(username: string) {
  const query = `SELECT * FROM users WHERE username = '${username}'`
  // è‹¥ username = "admin' OR '1'='1"ï¼Œå‰‡æœƒè¿”å›æ‰€æœ‰ç”¨æˆ¶ï¼
  return await db.query(query)
}
```

**æ­£ç¢ºåšæ³•**ï¼ˆä½¿ç”¨åƒæ•¸åŒ–æŸ¥è©¢ï¼‰ï¼š

```typescript
// âœ… æ­£ç¢ºï¼šSupabase è‡ªå‹•åƒæ•¸åŒ–
async function getUser(username: string) {
  const { data } = await supabase
    .from('users')
    .select('*')
    .eq('username', username) // è‡ªå‹•åƒæ•¸åŒ–ï¼Œé˜²æ­¢ SQL Injection
    .single()

  return data
}

// âœ… æ­£ç¢ºï¼šä½¿ç”¨åŸå§‹ SQL æ™‚çš„åƒæ•¸åŒ–
async function getUserWithRawSQL(username: string) {
  const { data } = await supabase.rpc('get_user_by_username', {
    p_username: username // åƒæ•¸å‚³éï¼Œè€Œéå­—ä¸²æ‹¼æ¥
  })

  return data
}
```

**è³‡æ–™åº«å‡½æ•¸å®šç¾©**ï¼ˆSupabaseï¼‰ï¼š

```sql
-- å®‰å…¨çš„è³‡æ–™åº«å‡½æ•¸ï¼ˆåƒæ•¸åŒ–ï¼‰
CREATE OR REPLACE FUNCTION get_user_by_username(p_username TEXT)
RETURNS TABLE (
  id UUID,
  discord_id TEXT,
  discord_username TEXT
) AS $$
BEGIN
  RETURN QUERY
  SELECT u.id, u.discord_id, u.discord_username
  FROM users u
  WHERE u.discord_username = p_username; -- åƒæ•¸åŒ–ï¼Œå®‰å…¨
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

#### Content Security Policy (CSP)

```typescript
// src/middleware.ts
export function middleware(request: NextRequest) {
  const response = NextResponse.next()

  // è¨­ç½® CSP header
  response.headers.set(
    'Content-Security-Policy',
    [
      "default-src 'self'",
      "script-src 'self' 'unsafe-inline' 'unsafe-eval'", // Next.js éœ€è¦
      "style-src 'self' 'unsafe-inline'",
      "img-src 'self' data: https:",
      "font-src 'self' data:",
      "connect-src 'self' https://discord.com https://*.supabase.co",
      "frame-ancestors 'none'"
    ].join('; ')
  )

  // å…¶ä»–å®‰å…¨ headers
  response.headers.set('X-Frame-Options', 'DENY')
  response.headers.set('X-Content-Type-Options', 'nosniff')
  response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin')
  response.headers.set('Permissions-Policy', 'geolocation=(), microphone=(), camera=()')

  return response
}
```

---

## å¯é æ€§è¨­è¨ˆ

### Session ç®¡ç†ç­–ç•¥

#### Session ç”Ÿå‘½é€±æœŸ

**Session å„²å­˜æ–¹å¼**ï¼š
- ä½¿ç”¨ **HTTP-only Cookie** å„²å­˜åŠ å¯†çš„ JWT token
- Token åŒ…å«ï¼šuser_idã€discord_idã€éæœŸæ™‚é–“ã€ç°½ç™¼æ™‚é–“

**Session æœ‰æ•ˆæœŸ**ï¼š
```typescript
// src/lib/auth/session.ts
const SESSION_CONFIG = {
  ACCESS_TOKEN_EXPIRES_IN: 7 * 24 * 60 * 60, // 7 å¤©
  REFRESH_TOKEN_EXPIRES_IN: 30 * 24 * 60 * 60, // 30 å¤©
  COOKIE_MAX_AGE: 30 * 24 * 60 * 60, // 30 å¤©
  REMEMBER_ME_EXPIRES_IN: 90 * 24 * 60 * 60, // 90 å¤©ï¼ˆå¯é¸åŠŸèƒ½ï¼‰
}

interface SessionToken {
  user_id: string
  discord_id: string
  discord_username: string
  issued_at: number
  expires_at: number
  refresh_token?: string
}

export function createSessionToken(user: User, rememberMe: boolean = false): string {
  const expiresIn = rememberMe
    ? SESSION_CONFIG.REMEMBER_ME_EXPIRES_IN
    : SESSION_CONFIG.ACCESS_TOKEN_EXPIRES_IN

  const payload: SessionToken = {
    user_id: user.id,
    discord_id: user.discord_id,
    discord_username: user.discord_username,
    issued_at: Date.now(),
    expires_at: Date.now() + expiresIn * 1000,
  }

  return jwt.sign(payload, process.env.JWT_SECRET!)
}
```

#### Session é©—è­‰æµç¨‹

```typescript
// src/lib/middleware/session-validator.ts
export async function validateSession(
  request: NextRequest
): Promise<{ valid: boolean; user?: User; shouldRefresh?: boolean }> {
  const token = request.cookies.get('session')?.value

  if (!token) {
    return { valid: false }
  }

  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET!) as SessionToken

    // 1. æª¢æŸ¥éæœŸæ™‚é–“
    if (Date.now() > decoded.expires_at) {
      return { valid: false, shouldRefresh: true }
    }

    // 2. æª¢æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°ï¼ˆå‰©é¤˜æ™‚é–“ < 25%ï¼‰
    const timeLeft = decoded.expires_at - Date.now()
    const totalTime = decoded.expires_at - decoded.issued_at
    const shouldRefresh = timeLeft < totalTime * 0.25

    // 3. å¾è³‡æ–™åº«é©—è­‰ç”¨æˆ¶æ˜¯å¦ä»ç„¶å­˜åœ¨
    const user = await supabase
      .from('users')
      .select('*')
      .eq('id', decoded.user_id)
      .single()

    if (!user.data) {
      return { valid: false }
    }

    return {
      valid: true,
      user: user.data,
      shouldRefresh
    }
  } catch (error) {
    return { valid: false }
  }
}
```

### Token è‡ªå‹•åˆ·æ–°æ©Ÿåˆ¶

#### åˆ·æ–°ç­–ç•¥

**è‡ªå‹•åˆ·æ–°æ™‚æ©Ÿ**ï¼š
- Token å‰©é¤˜æœ‰æ•ˆæœŸ < 25%ï¼ˆä¾‹å¦‚ï¼š7 å¤© tokenï¼Œå‰©é¤˜ < 1.75 å¤©ï¼‰
- ç”¨æˆ¶æ´»èºæ™‚æ‰åˆ·æ–°ï¼ˆé¿å…ç„¡æ•ˆåˆ·æ–°ï¼‰

**å¯¦ä½œç¯„ä¾‹**ï¼š

```typescript
// src/lib/auth/token-refresh.ts
export async function refreshSessionIfNeeded(
  request: NextRequest,
  response: NextResponse,
  user: User,
  shouldRefresh: boolean
): Promise<NextResponse> {
  if (!shouldRefresh) {
    return response
  }

  // ç”Ÿæˆæ–° token
  const newToken = createSessionToken(user)

  // æ›´æ–° cookie
  response.cookies.set('session', newToken, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: 'lax',
    maxAge: SESSION_CONFIG.COOKIE_MAX_AGE,
    path: '/',
  })

  // è¨˜éŒ„åˆ·æ–°äº‹ä»¶ï¼ˆå¯é¸ï¼Œç”¨æ–¼ç›£æ§ï¼‰
  await logTokenRefresh(user.id)

  return response
}

async function logTokenRefresh(userId: string): Promise<void> {
  // è¨˜éŒ„åˆ°è³‡æ–™åº«æˆ–æ—¥èªŒç³»çµ±
  console.log(`[Token Refresh] User ${userId} token refreshed`)
}
```

#### å®¢æˆ¶ç«¯åˆ·æ–°é‚è¼¯

```typescript
// src/lib/hooks/useSession.ts
import { useEffect } from 'react'
import { useRouter } from 'next/navigation'

export function useSession() {
  const router = useRouter()

  useEffect(() => {
    // æ¯ 5 åˆ†é˜æª¢æŸ¥ä¸€æ¬¡ session ç‹€æ…‹
    const interval = setInterval(async () => {
      const response = await fetch('/api/auth/session', {
        method: 'GET',
        credentials: 'include',
      })

      if (!response.ok) {
        // Session éæœŸï¼Œè§¸ç™¼ç™»å…¥ Modalï¼ˆè¦‹ DDR-003ï¼‰
        const event = new CustomEvent('show-login-modal')
        window.dispatchEvent(event)
      }

      // å¦‚æœ response åŒ…å«æ–°çš„ Set-Cookie headerï¼Œç€è¦½å™¨æœƒè‡ªå‹•æ›´æ–°
    }, 5 * 60 * 1000) // 5 åˆ†é˜

    return () => clearInterval(interval)
  }, [router])
}
```

### Token æ’¤éŠ·æ©Ÿåˆ¶

#### æ’¤éŠ·å ´æ™¯

1. **ç”¨æˆ¶ä¸»å‹•ç™»å‡º**
2. **å¯†ç¢¼ä¿®æ”¹**ï¼ˆå¦‚æœæœªä¾†æ”¯æ´å¯†ç¢¼ç™»å…¥ï¼‰
3. **å¸³è™Ÿå®‰å…¨äº‹ä»¶**ï¼ˆå¦‚ï¼šå¯ç–‘æ´»å‹•ï¼‰
4. **ç®¡ç†å“¡æ“ä½œ**ï¼ˆå¦‚ï¼šå°ç¦ç”¨æˆ¶ï¼‰

#### Token é»‘åå–®å¯¦ä½œ

**ä½¿ç”¨ Redis å„²å­˜è¢«æ’¤éŠ·çš„ Token**ï¼š

```typescript
// src/lib/auth/token-revocation.ts
import { redis } from '@/lib/redis'

export async function revokeToken(token: string): Promise<void> {
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET!) as SessionToken

    // è¨ˆç®—å‰©é¤˜æœ‰æ•ˆæ™‚é–“
    const ttl = Math.max(0, Math.floor((decoded.expires_at - Date.now()) / 1000))

    // åŠ å…¥é»‘åå–®ï¼ˆåªéœ€ä¿ç•™åˆ°åŸæœ¬çš„éæœŸæ™‚é–“ï¼‰
    await redis.setex(`revoked:${token}`, ttl, '1')
  } catch (error) {
    // Token ç„¡æ•ˆæˆ–å·²éæœŸï¼Œç„¡éœ€è™•ç†
  }
}

export async function isTokenRevoked(token: string): Promise<boolean> {
  const result = await redis.get(`revoked:${token}`)
  return result === '1'
}

// åœ¨ session é©—è­‰æ™‚æª¢æŸ¥
export async function validateSessionWithRevocation(
  request: NextRequest
): Promise<{ valid: boolean; user?: User }> {
  const token = request.cookies.get('session')?.value

  if (!token) {
    return { valid: false }
  }

  // 1. æª¢æŸ¥æ˜¯å¦è¢«æ’¤éŠ·
  if (await isTokenRevoked(token)) {
    return { valid: false }
  }

  // 2. åŸ·è¡Œæ­£å¸¸é©—è­‰
  const result = await validateSession(request)
  return result
}
```

#### å…¨å±€ç™»å‡ºåŠŸèƒ½

```typescript
// src/lib/auth/global-logout.ts
export async function revokeAllUserSessions(userId: string): Promise<void> {
  // 1. æ¨™è¨˜ç”¨æˆ¶éœ€è¦é‡æ–°ç™»å…¥
  await supabase
    .from('users')
    .update({ force_relogin: true, force_relogin_at: new Date() })
    .eq('id', userId)

  // 2. åœ¨ session é©—è­‰æ™‚æª¢æŸ¥æ­¤æ¨™è¨˜
}

// ä¿®æ”¹ validateSession å‡½æ•¸
export async function validateSession(
  request: NextRequest
): Promise<{ valid: boolean; user?: User }> {
  // ... åŸæœ‰é‚è¼¯ ...

  // æª¢æŸ¥æ˜¯å¦éœ€è¦å¼·åˆ¶é‡æ–°ç™»å…¥
  if (user.data.force_relogin) {
    const tokenIssuedAt = decoded.issued_at
    const forceReloginAt = new Date(user.data.force_relogin_at).getTime()

    // Token ç°½ç™¼æ™‚é–“æ—©æ–¼å¼·åˆ¶ç™»å‡ºæ™‚é–“ â†’ ç„¡æ•ˆ
    if (tokenIssuedAt < forceReloginAt) {
      return { valid: false }
    }
  }

  return { valid: true, user: user.data }
}
```

### å¤šè£ç½®åŒæ­¥

#### åŒæ­¥ç­–ç•¥

**è¨­è¨ˆç›®æ¨™**ï¼š
- å…è¨±åŒä¸€ç”¨æˆ¶åœ¨å¤šå€‹è£ç½®åŒæ™‚ç™»å…¥
- æ¯å€‹è£ç½®ç¨ç«‹ session
- æä¾›æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰ session çš„åŠŸèƒ½

#### Session è£ç½®è¿½è¹¤

```sql
-- Session è£ç½®è¡¨
CREATE TABLE user_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

  -- è£ç½®è³‡è¨Š
  device_name TEXT,  -- å¾ User-Agent è§£æ
  device_type TEXT,  -- 'mobile' | 'desktop' | 'tablet'
  browser TEXT,      -- 'Chrome' | 'Firefox' | 'Safari'
  os TEXT,           -- 'Windows' | 'macOS' | 'Linux' | 'iOS' | 'Android'

  -- Session è³‡è¨Š
  session_token_hash TEXT NOT NULL UNIQUE,  -- Token çš„ SHA-256 hash
  ip_address INET,
  last_active_at TIMESTAMPTZ DEFAULT NOW(),
  expires_at TIMESTAMPTZ NOT NULL,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_user_sessions_user ON user_sessions(user_id);
CREATE INDEX idx_user_sessions_expires ON user_sessions(expires_at);
```

#### Session ç®¡ç† API

```typescript
// src/app/api/auth/sessions/route.ts
export async function GET(request: NextRequest) {
  const user = await getCurrentUser(request)
  if (!user) {
    return new NextResponse('Unauthorized', { status: 401 })
  }

  // ç²å–ç”¨æˆ¶æ‰€æœ‰æ´»èº session
  const sessions = await supabase
    .from('user_sessions')
    .select('*')
    .eq('user_id', user.id)
    .gt('expires_at', new Date().toISOString())
    .order('last_active_at', { ascending: false })

  return NextResponse.json(sessions.data)
}

export async function DELETE(request: NextRequest) {
  const user = await getCurrentUser(request)
  if (!user) {
    return new NextResponse('Unauthorized', { status: 401 })
  }

  const { sessionId } = await request.json()

  // æ’¤éŠ·ç‰¹å®š session
  const session = await supabase
    .from('user_sessions')
    .select('session_token_hash')
    .eq('id', sessionId)
    .eq('user_id', user.id)
    .single()

  if (session.data) {
    // åŠ å…¥é»‘åå–®
    await revokeToken(session.data.session_token_hash)

    // åˆªé™¤è¨˜éŒ„
    await supabase
      .from('user_sessions')
      .delete()
      .eq('id', sessionId)
  }

  return NextResponse.json({ success: true })
}
```

#### è‡ªå‹•æ¸…ç†éæœŸ Session

```typescript
// src/lib/cron/cleanup-sessions.ts
export async function cleanupExpiredSessions(): Promise<void> {
  // åˆªé™¤å·²éæœŸçš„ session è¨˜éŒ„
  const { count } = await supabase
    .from('user_sessions')
    .delete()
    .lt('expires_at', new Date().toISOString())

  console.log(`[Session Cleanup] Removed ${count} expired sessions`)
}

// ä½¿ç”¨ Vercel Cron Jobs æ¯å¤©åŸ·è¡Œä¸€æ¬¡
// vercel.json:
// {
//   "crons": [{
//     "path": "/api/cron/cleanup-sessions",
//     "schedule": "0 0 * * *"
//   }]
// }
```

---

## å¯¦éš›æµé‡åˆ†æ

### ç›£æ¸¬æ•¸æ“šæ¦‚è¦½

**ç›£æ¸¬æœŸé–“**ï¼š2025-10-20 è‡³ 2025-10-25ï¼ˆ5 å¤©ï¼‰

```
ç¸½è¨ªå•æ•¸ï¼š7,794 visitors
å¹³å‡è¨ªå•æ•¸ï¼š1,559 visitors/å¤©
æ•¸æ“šä¾†æºï¼šVercel Analytics
```

### æµé‡çµ„æˆåˆ†æ

#### è¨ªå®¢é¡å‹æ¨ä¼°

| é¡å‹ | ä¼°è¨ˆæ¯”ä¾‹ | æ•¸é‡/å¤© | è¨ˆç®—ä¾æ“š |
|------|---------|---------|---------|
| **çœŸå¯¦ç”¨æˆ¶** | 20-30% | 312-468 | æ­£å¸¸äº’å‹•è¡Œç‚ºï¼ˆç™»å…¥ã€ç€è¦½ã€ç™»è¨˜æ„å‘ï¼‰ |
| **SEO çˆ¬èŸ²** | 10-15% | 156-234 | GoogleBot, BingBotï¼ˆUser-Agent å¯è­˜åˆ¥ï¼‰ |
| **æƒ¡æ„çˆ¬èŸ²** | 30-40% | 468-624 | curl, wget, è‡ªå‹•åŒ–å·¥å…·ï¼ˆUser-Agent å¯è­˜åˆ¥ï¼‰ |
| **ç„¡æ•ˆè«‹æ±‚** | 20-30% | 312-468 | é‡è¤‡è¨ªå•ã€ç„¡ User-Agentã€API æƒæ |

**é—œéµç™¼ç¾**ï¼š
- ğŸ”´ **60-80% æµé‡æ˜¯ Bot**ï¼ˆ1,169 bots/å¤©ï¼Œåƒ… 390 çœŸå¯¦ç”¨æˆ¶/å¤©ï¼‰
- ğŸ”´ **MAU æ¨ç®—**ï¼š390 DAU / 0.3 æ—¥æ´»ç‡ = **1,300 MAU**
- ğŸ”´ **å¯¦éš›æµé‡é è¶…åŸä¼°ç®—**ï¼ˆåŸä¼°ç®— 800 MAUï¼Œå¯¦éš› 1,300 MAU = 163%ï¼‰

#### ç«¯é»æµé‡åˆ†å¸ƒ

| ç«¯é»é¡åˆ¥ | ä¼°è¨ˆè«‹æ±‚æ•¸/å¤© | Bot æ¯”ä¾‹ | Bot è«‹æ±‚/å¤© | çœŸå¯¦è«‹æ±‚/å¤© |
|---------|-------------|---------|------------|------------|
| **trendingï¼ˆå…¬é–‹ï¼‰** | 1,200 | 80-90% | 960-1,080 | 120-240 |
| **å¸‚å ´åˆ—è¡¨ï¼ˆèªè­‰ï¼‰** | 3,744 | 30-40% | 1,123-1,498 | 2,246-2,621 |
| **å»ºç«‹åˆŠç™»ï¼ˆèªè­‰ï¼‰** | 62 | 10-20% | 6-12 | 50-56 |
| **ç™»è¨˜æ„å‘ï¼ˆèªè­‰ï¼‰** | 374 | 10-20% | 37-75 | 299-337 |
| **æŸ¥çœ‹è¯çµ¡æ–¹å¼ï¼ˆèªè­‰ï¼‰** | 187 | 5-10% | 9-19 | 168-178 |
| **OAuth ç™»å…¥** | 156 | 40-50% | 62-78 | 78-94 |
| **å…¶ä»– API** | 611 | 50-60% | 306-367 | 244-305 |
| **ç¸½è¨ˆ** | **6,334** | **~60%** | **~3,800** | **~2,500** |

**é—œéµç™¼ç¾**ï¼š
1. **trending ç«¯é»æ˜¯ Bot æµé‡é‡ç½å€**ï¼š80-90% è«‹æ±‚ä¾†è‡ª Bot
2. **èªè­‰ç«¯é» Bot æ¯”ä¾‹è¼ƒä½**ï¼šä½†ä»æœ‰ 10-40% Botï¼ˆå¸³è™Ÿè¨»å†Šæ©Ÿå™¨äººï¼‰
3. **OAuth ç™»å…¥ç«¯é»ä¹Ÿæœ‰ 40-50% Bot**ï¼šèªªæ˜ Discord ç™»å…¥ç„¡æ³•å®Œå…¨é˜»æ­¢ Bot

### Redis å‘½ä»¤æ•¸æ¶ˆè€—åˆ†æ

#### ç•¶å‰ç‹€æ…‹ï¼ˆç„¡ Bot éæ¿¾ï¼‰

```typescript
// Rate Limiting å‘½ä»¤æ•¸ï¼ˆå›ºå®šçª—å£ç®—æ³•ï¼šINCR + EXPIREï¼‰
const rateLimitOps = {
  trending: 1200 * 2,           // = 2,400 å‘½ä»¤ï¼ˆ80-90% æ˜¯ Botï¼‰
  marketList: 3744 * 2,         // = 7,488 å‘½ä»¤
  createListing: 62 * 2,        // = 124 å‘½ä»¤
  registerInterest: 374 * 2,    // = 748 å‘½ä»¤
  viewContact: 187 * 2,         // = 374 å‘½ä»¤
  oauthLogin: 156 * 2,          // = 312 å‘½ä»¤
  otherAPIs: 611 * 2,           // = 1,222 å‘½ä»¤
}

const total = Object.values(rateLimitOps).reduce((a, b) => a + b, 0)
// = 12,668 å‘½ä»¤/å¤©

// âš ï¸ å¯¦éš›ç›£æ¸¬ç‚º 10,668 å‘½ä»¤/å¤©ï¼ˆå¯èƒ½éƒ¨åˆ†ç«¯é»æœªå•Ÿç”¨ Rate Limitï¼‰
```

**çµè«–**ï¼šç•¶å‰ Redis ä½¿ç”¨é‡ 10,668 å‘½ä»¤/å¤© = **107% ä½¿ç”¨ç‡**ï¼ˆå·²è¶…æ¨™ï¼‰

#### Bot éæ¿¾å¾Œé ä¼°ï¼ˆéšæ®µæ€§ï¼‰

| éšæ®µ | éæ¿¾ç­–ç•¥ | Bot æ¸›å°‘ç‡ | Redis å‘½ä»¤/å¤© | ä½¿ç”¨ç‡ | ç‹€æ…‹ |
|------|---------|-----------|--------------|-------|------|
| **ç•¶å‰** | ç„¡éæ¿¾ | 0% | 10,668 | 107% | âŒ å·²è¶…æ¨™ |
| **Discord å–®ç¨** | OAuth èªè­‰é–€æª» | 3-5% | 10,350 | 103% | âŒ ä»è¶…æ¨™ |
| **éšæ®µ 1** | User-Agent åŸºç¤éæ¿¾ | 40-50% | 7,000-8,000 | 70-80% | âš ï¸ æ¥è¿‘ä¸Šé™ |
| **éšæ®µ 2** | User-Agent å…¨é¢æª¢æ¸¬ | 60-70% | 5,000-6,000 | 50-60% | âœ… å¯é‹è¡Œ |
| **éšæ®µ 3** | User-Agent + è¡Œç‚ºæª¢æ¸¬ | 70-80% | 4,000-5,000 | 40-50% | âœ… ç©©å®š |
| **éšæ®µ 4** | Cloudflare Bot Protection | 85-95% | 2,000-3,000 | 20-30% | âœ… ç†æƒ³ |

**é—œéµçµè«–**ï¼š
- ğŸ”´ **Discord ç™»å…¥å–®ç¨ç„¡æ³•è§£æ±º Redis è¶…æ¨™å•é¡Œ**ï¼ˆåƒ…æ¸›å°‘ 3-5%ï¼‰
- âœ… **å¿…é ˆæ­é… Bot Detection**ï¼ˆè‡³å°‘å¯¦ä½œéšæ®µ 2ï¼Œæ¸›å°‘ 60-70% Botï¼‰
- âœ… **å»ºè­°æ–¹æ¡ˆ**ï¼šDiscord ç™»å…¥ + User-Agent å…¨é¢æª¢æ¸¬ â†’ 5,000-6,000 å‘½ä»¤/å¤©

### æµé‡ç•°å¸¸æ¨¡å¼è­˜åˆ¥

**è§€å¯Ÿåˆ°çš„ç•°å¸¸è¡Œç‚º**ï¼ˆåŸºæ–¼ç«¯é»åˆ†æï¼‰ï¼š

1. **é«˜é »è¨ªå•**ï¼š
   - ç¾è±¡ï¼šå–®ä¸€ IP åœ¨ 1 å°æ™‚å…§è«‹æ±‚ > 50 æ¬¡
   - æ¯”ä¾‹ï¼šä¼°è¨ˆ 20-30% çš„ Bot æµé‡
   - ç‰¹å¾µï¼šUser-Agent ç‚º curl, wget, python-requests

2. **æƒæè¡Œç‚º**ï¼š
   - ç¾è±¡ï¼šå¿«é€Ÿè¨ªå•å¤šå€‹ä¸åŒç«¯é»ï¼ˆ1 åˆ†é˜å…§ > 20 å€‹ç«¯é»ï¼‰
   - æ¯”ä¾‹ï¼šä¼°è¨ˆ 10-15% çš„ Bot æµé‡
   - ç‰¹å¾µï¼šUser-Agent ç‚º headless, selenium, phantom

3. **ç„¡ User-Agent è«‹æ±‚**ï¼š
   - ç¾è±¡ï¼šå®Œå…¨æ²’æœ‰ User-Agent header
   - æ¯”ä¾‹ï¼šä¼°è¨ˆ 5-10% çš„æµé‡
   - åˆ¤å®šï¼š100% ç‚º Bot æˆ–æƒ¡æ„è«‹æ±‚

4. **SEO çˆ¬èŸ²**ï¼ˆåˆæ³•ï¼‰ï¼š
   - ä¾†æºï¼šGoogleBot, BingBot, BaiduSpider
   - æ¯”ä¾‹ï¼š10-15% çš„æµé‡
   - è™•ç†ï¼šç™½åå–®å…è¨±ï¼ˆæœ‰åˆ©æ–¼ SEOï¼‰

5. **OAuth Bot**ï¼ˆæ–°ç™¼ç¾ï¼‰ï¼š
   - ç¾è±¡ï¼šè‡ªå‹•åŒ– Discord å¸³è™Ÿé€šé OAuth ç™»å…¥
   - æ¯”ä¾‹ï¼šOAuth ç™»å…¥ç«¯é» 40-50% æ˜¯ Bot
   - ç‰¹å¾µï¼šçŸ­æ™‚é–“å…§å¤§é‡æ–°å¸³è™Ÿè¨»å†Š
   - **èªªæ˜ï¼šDiscord ç™»å…¥ç„¡æ³•å®Œå…¨é˜»æ­¢ Bot**

### MAU ä¿®æ­£èˆ‡å®¹é‡è¦åŠƒ

#### åŸä¼°ç®— vs å¯¦éš›æ•¸æ“š

| æŒ‡æ¨™ | åŸä¼°ç®— | å¯¦éš›æ•¸æ“š | å·®ç•° | åŸå› åˆ†æ |
|------|-------|---------|------|---------|
| Daily Visitors | ~320 | **1,559** | +387% | **é«˜ Bot æµé‡æœªé æœŸ** |
| çœŸå¯¦ DAU | 240 | 312-468 | +30-95% | Bot éæ¿¾å¾Œæ¥è¿‘åŸä¼°ç®— |
| MAU | 800 | **1,200-1,600** | +50-100% | å¯¦éš›ç”¨æˆ¶ç•¥é«˜æ–¼é æœŸ |
| Redis å‘½ä»¤ | 6,800 | **10,668** | +57% | Bot æµé‡æ¶ˆè€—å¤§é‡é…é¡ |

#### ä¿®æ­£å¾Œçš„å®¹é‡è¦åŠƒ

**ä¿å®ˆä¼°è¨ˆï¼ˆBot éæ¿¾ 70%ï¼‰**ï¼š
```
çœŸå¯¦ MAUï¼š1,200-1,400
çœŸå¯¦ DAUï¼š360-420ï¼ˆ30% æ—¥æ´»ç‡ï¼‰
API è«‹æ±‚ï¼š2,500-3,000/å¤©ï¼ˆéæ¿¾ Bot å¾Œï¼‰
Redis å‘½ä»¤ï¼š5,000-6,000/å¤©ï¼ˆ50-60% ä½¿ç”¨ç‡ï¼‰
ç‹€æ…‹ï¼šâœ… å…è²»ç‰ˆå¯ç©©å®šé‹è¡Œ
```

**æ¨‚è§€ä¼°è¨ˆï¼ˆBot éæ¿¾ 80%ï¼‰**ï¼š
```
çœŸå¯¦ MAUï¼š1,000-1,200
çœŸå¯¦ DAUï¼š300-360
API è«‹æ±‚ï¼š2,000-2,500/å¤©
Redis å‘½ä»¤ï¼š4,000-5,000/å¤©ï¼ˆ40-50% ä½¿ç”¨ç‡ï¼‰
ç‹€æ…‹ï¼šâœ… å…è²»ç‰ˆé¤˜è£•å……è¶³
```

### æ‡‰å°å»ºè­°ï¼ˆå„ªå…ˆç´šæ’åºï¼‰

#### ğŸ”´ ç«‹å³åŸ·è¡Œï¼ˆP0 - 0-1 é€±ï¼‰

1. **å¯¦ä½œåŸºç¤ Bot Detectionï¼ˆUser-Agent éæ¿¾ï¼‰**
   - é»‘åå–®ï¼šcurl, wget, python-requests, headless
   - ç™½åå–®ï¼šGoogleBot, BingBotï¼ˆSEO çˆ¬èŸ²ï¼‰
   - ç„¡ User-Agent ç›´æ¥æ‹’çµ•
   - é æœŸæ•ˆæœï¼šæ¸›å°‘ 40-50% Bot â†’ Redis é™è‡³ 7,000-8,000 å‘½ä»¤/å¤©

2. **é™ç´šé–¾å€¼èª¿æ•´**
   - å¾ 90% â†’ 70%ï¼ˆææ—©è§¸ç™¼é™ç´šï¼‰
   - ç¢ºä¿ Redis ä¸æœƒè¶…æ¨™

#### ğŸŸ¡ çŸ­æœŸåŸ·è¡Œï¼ˆP1 - 2-4 é€±ï¼‰

3. **Discord OAuth å¯¦ä½œ**
   - å®Œæ•´ OAuth 2.0 æµç¨‹
   - Session ç®¡ç†èˆ‡ Token åˆ·æ–°
   - é æœŸæ•ˆæœï¼šæ¸›å°‘ 3-5% Bot â†’ é…åˆ P0 å¯é” 50-60% ä½¿ç”¨ç‡

4. **User-Agent å…¨é¢æª¢æ¸¬**
   - æ‰€æœ‰ç«¯é»æ‡‰ç”¨ Bot Detection
   - è¡Œç‚ºæ¨¡å¼åˆ†æï¼ˆé«˜é »è¨ªå•ã€æƒæè¡Œç‚ºï¼‰
   - é æœŸæ•ˆæœï¼šæ¸›å°‘ 60-70% Bot â†’ Redis é™è‡³ 5,000-6,000 å‘½ä»¤/å¤©

#### ğŸŸ¢ ä¸­æœŸåŸ·è¡Œï¼ˆP2 - 1-2 å€‹æœˆï¼‰

5. **IP ä¿¡è­½è©•åˆ†ç³»çµ±**
   - è¨˜éŒ„ IP æ­·å²è¡Œç‚º
   - è¨ˆç®— IP ä¿¡è­½åˆ†æ•¸ï¼ˆ0-100ï¼‰
   - ä½ä¿¡è­½ IP è‡ªå‹•é™æµ
   - é æœŸæ•ˆæœï¼šæ¸›å°‘ 70-80% Bot â†’ Redis é™è‡³ 4,000-5,000 å‘½ä»¤/å¤©

6. **æµé‡ç›£æ§å„€è¡¨æ¿**
   - å¯¦æ™‚ Bot æµé‡æ¯”ä¾‹
   - Redis ä½¿ç”¨ç‡è¶¨å‹¢
   - è‡ªå‹•åŒ–å‘Šè­¦

#### âšª é•·æœŸå„ªåŒ–ï¼ˆP3 - å¯é¸ï¼‰

7. **Cloudflare Bot Protection**
   - çµ‚æ¥µè§£æ±ºæ–¹æ¡ˆï¼ˆå…è²»ç‰ˆæœ‰é™åˆ¶ï¼‰
   - é æœŸæ•ˆæœï¼šæ¸›å°‘ 85-95% Bot â†’ Redis é™è‡³ 2,000-3,000 å‘½ä»¤/å¤©

### æ ¸å¿ƒçµè«–

**å•é¡Œè¨ºæ–·**ï¼š
> **60-80% æµé‡æ˜¯ Bot**ï¼Œå°è‡´å…è²»ç‰ˆ Redis è¶…æ¨™ 6.68%

**è§£æ±ºè·¯å¾‘**ï¼š
```
ç•¶å‰ç‹€æ…‹ï¼ˆ1,559 visitors/å¤©ï¼Œ107% Redisï¼‰
  â†“
éšæ®µ 1ï¼šåŸºç¤ Bot Detectionï¼ˆ1 é€±å…§ï¼‰
  â†’ User-Agent éæ¿¾
  â†’ Redis é™è‡³ 7,000-8,000 å‘½ä»¤/å¤©ï¼ˆ70-80% ä½¿ç”¨ç‡ï¼‰
  â†’ âš ï¸ è‡¨æ™‚ç·©è§£ï¼Œä»éœ€å¾ŒçºŒå„ªåŒ–
  â†“
éšæ®µ 2ï¼šDiscord ç™»å…¥ + å…¨é¢æª¢æ¸¬ï¼ˆ2-4 é€±ï¼‰
  â†’ OAuth èªè­‰ + User-Agent å…¨é¢æª¢æ¸¬
  â†’ Redis é™è‡³ 5,000-6,000 å‘½ä»¤/å¤©ï¼ˆ50-60% ä½¿ç”¨ç‡ï¼‰
  â†’ âœ… å¯ç©©å®šé‹è¡Œåœ¨å…è²»ç‰ˆ
  â†“
éšæ®µ 3ï¼šIP ä¿¡è­½è©•åˆ†ï¼ˆ1-2 å€‹æœˆï¼‰
  â†’ è¡Œç‚ºæª¢æ¸¬ + IP ä¿¡è­½
  â†’ Redis é™è‡³ 4,000-5,000 å‘½ä»¤/å¤©ï¼ˆ40-50% ä½¿ç”¨ç‡ï¼‰
  â†’ âœ… å…è²»ç‰ˆé•·æœŸç©©å®š
```

**é‡è¦æé†’**ï¼š
- ğŸ”´ **Discord ç™»å…¥ä¸æ˜¯éŠ€å½ˆ**ï¼šåƒ…æ¸›å°‘ 3-5% Botï¼Œç„¡æ³•å–®ç¨è§£æ±º Redis è¶…æ¨™å•é¡Œ
- âœ… **Bot Detection æ˜¯å¿…è¦æ¢ä»¶**ï¼šè‡³å°‘éœ€è¦å¯¦ä½œéšæ®µ 2ï¼ˆUser-Agent å…¨é¢æª¢æ¸¬ï¼‰
- âœ… **å…è²»ç‰ˆå¯è¡Œ**ï¼šDiscord + Bot Detection çµ„åˆå¯é™è‡³ 50-60% Redis ä½¿ç”¨ç‡

---

## æˆæœ¬é ä¼°

### å…è²»é¡åº¦è©•ä¼°

#### Supabase å…è²»ç‰ˆ
- è³‡æ–™åº«ç©ºé–“ï¼š500 MBï¼ˆç•¶å‰ä½¿ç”¨ < 50 MBï¼‰âœ…
- æœˆæ´»èºç”¨æˆ¶ï¼š50,000ï¼ˆç•¶å‰ 1,200-1,600ï¼‰âœ…

#### Vercel å…è²»ç‰ˆ
- æµé‡ï¼š100 GB/æœˆï¼ˆç•¶å‰ 69 GB/æœˆï¼‰âš ï¸
- å‡½æ•¸åŸ·è¡Œæ™‚é–“ï¼š100 å°æ™‚/æœˆ âœ…

#### Upstash Redis å…è²»ç‰ˆ
- å‘½ä»¤æ•¸ï¼š10,000/å¤©
- **ç•¶å‰ä½¿ç”¨**ï¼š10,668/å¤©ï¼ˆ107%ï¼‰âŒ
- **å„²å­˜ç©ºé–“**ï¼š256 MBï¼ˆç•¶å‰ä½¿ç”¨ < 1 MBï¼‰âœ…

**é—œéµè©•ä¼°**ï¼š

```typescript
// Discord ç™»å…¥æ•ˆæœï¼ˆä¿®æ­£è©•ä¼°ï¼‰
ç•¶å‰ï¼š10,668 å‘½ä»¤/å¤©ï¼ˆ107% è¶…æ¨™ï¼‰
Discord å–®ç¨ï¼š10,350 å‘½ä»¤/å¤©ï¼ˆ103% ä»è¶…æ¨™ï¼‰âŒ
  â†’ åƒ…æ¸›å°‘ 3-5% Bot
  â†’ ç„¡æ³•å–®ç¨è§£æ±º Redis è¶…æ¨™å•é¡Œ

// Bot Detection æ•ˆæœ
Bot Detection (éšæ®µ 2)ï¼š5,000-6,000 å‘½ä»¤/å¤©ï¼ˆ50-60%ï¼‰âœ…
  â†’ æ¸›å°‘ 60-70% Bot
  â†’ å¯ç©©å®šé‹è¡Œåœ¨å…è²»ç‰ˆ

// çµ„åˆæ–¹æ¡ˆï¼ˆæ¨è–¦ï¼‰
Discord + Bot Detectionï¼š5,000-6,000 å‘½ä»¤/å¤©ï¼ˆ50-60%ï¼‰âœ…
  â†’ Discord ç™»å…¥æä¾›èº«ä»½é©—è­‰
  â†’ Bot Detection è§£æ±º Redis è¶…æ¨™
  â†’ å…©è€…ç¼ºä¸€ä¸å¯
```

**é‡è¦çµè«–**ï¼š
- ğŸ”´ **Discord ç™»å…¥ä¸æ˜¯éŠ€å½ˆ**ï¼šåƒ…æ¸›å°‘ 3-5% Botï¼Œç„¡æ³•å–®ç¨è§£æ±º Redis è¶…æ¨™å•é¡Œ
- ğŸ”´ **Bot Detection æ˜¯å¿…è¦æ¢ä»¶**ï¼šå¿…é ˆå¯¦ä½œ User-Agent å…¨é¢æª¢æ¸¬ï¼ˆéšæ®µ 2ï¼‰
- âœ… **å…è²»ç‰ˆå¯è¡Œ**ï¼šDiscord + Bot Detection çµ„åˆå¯é™è‡³ 50-60% Redis ä½¿ç”¨ç‡
- âš ï¸ **å¯¦ä½œé †åº**ï¼šå»ºè­°å…ˆå¯¦ä½œ Bot Detectionï¼ˆ1 é€±ï¼‰ï¼Œå†å¯¦ä½œ Discord ç™»å…¥ï¼ˆ2-3 é€±ï¼‰

### å‡ç´šæ±ºç­–æµç¨‹åœ–

#### ç›£æ§æŒ‡æ¨™èˆ‡è­¦å ±é–¾å€¼

**æ ¸å¿ƒç›£æ§æŒ‡æ¨™**ï¼š

| æœå‹™ | æŒ‡æ¨™ | å…è²»é¡åº¦ | è­¦å ±é–¾å€¼ | å±éšªé–¾å€¼ | è¡Œå‹• |
|------|------|---------|---------|---------|------|
| **Upstash Redis** | å‘½ä»¤æ•¸/å¤© | 10,000 | 8,000 (80%) | 9,500 (95%) | å¯¦ä½œ Bot Detection |
| **Vercel** | æµé‡/æœˆ | 100 GB | 80 GB (80%) | 95 GB (95%) | å„ªåŒ–åœ–ç‰‡/å•Ÿç”¨ CDN |
| **Supabase** | MAU | 50,000 | 40,000 (80%) | 47,500 (95%) | è€ƒæ…®å‡ç´š |
| **Supabase** | å„²å­˜ç©ºé–“ | 500 MB | 400 MB (80%) | 475 MB (95%) | æ¸…ç†èˆŠè³‡æ–™ |
| **Vercel** | å‡½æ•¸åŸ·è¡Œæ™‚é–“ | 100 å°æ™‚ | 80 å°æ™‚ (80%) | 95 å°æ™‚ (95%) | å„ªåŒ–æŸ¥è©¢ |

**ç›£æ§å¯¦ä½œç¯„ä¾‹**ï¼š

```typescript
// src/lib/monitoring/quota-monitor.ts
import { redis } from '@/lib/redis'

interface QuotaStatus {
  service: string
  metric: string
  current: number
  limit: number
  usage_percentage: number
  status: 'safe' | 'warning' | 'danger' | 'exceeded'
  alert_required: boolean
}

export async function checkRedisQuota(): Promise<QuotaStatus> {
  const key = 'quota:redis:daily_commands'
  const count = await redis.get<number>(key) || 0
  const limit = 10000
  const percentage = (count / limit) * 100

  let status: QuotaStatus['status']
  if (percentage >= 100) status = 'exceeded'
  else if (percentage >= 95) status = 'danger'
  else if (percentage >= 80) status = 'warning'
  else status = 'safe'

  return {
    service: 'Upstash Redis',
    metric: 'Daily Commands',
    current: count,
    limit,
    usage_percentage: percentage,
    status,
    alert_required: status !== 'safe'
  }
}

export async function checkVercelBandwidth(): Promise<QuotaStatus> {
  // éœ€è¦å¾ Vercel API æˆ–æ—¥èªŒä¸­ç²å–
  // é€™è£¡ä½¿ç”¨ä¼°ç®—å€¼ä½œç‚ºç¯„ä¾‹
  const currentGB = 69  // å¾å¯¦éš›ç›£æ§æ•¸æ“šç²å–
  const limitGB = 100
  const percentage = (currentGB / limitGB) * 100

  let status: QuotaStatus['status']
  if (percentage >= 100) status = 'exceeded'
  else if (percentage >= 95) status = 'danger'
  else if (percentage >= 80) status = 'warning'
  else status = 'safe'

  return {
    service: 'Vercel',
    metric: 'Bandwidth',
    current: currentGB,
    limit: limitGB,
    usage_percentage: percentage,
    status,
    alert_required: status !== 'safe'
  }
}

export async function checkAllQuotas(): Promise<QuotaStatus[]> {
  const results = await Promise.all([
    checkRedisQuota(),
    checkVercelBandwidth(),
    // å¯æ“´å±•ï¼šcheckSupabaseMAU(), checkSupabaseStorage()
  ])

  return results
}

// æ¯æ—¥å®šæ™‚æª¢æŸ¥ï¼ˆä½¿ç”¨ Vercel Cron Jobsï¼‰
export async function dailyQuotaCheck(): Promise<void> {
  const quotas = await checkAllQuotas()
  const alerts = quotas.filter(q => q.alert_required)

  if (alerts.length > 0) {
    await sendQuotaAlerts(alerts)
  }
}

async function sendQuotaAlerts(alerts: QuotaStatus[]): Promise<void> {
  // ç™¼é€åˆ° Discord Webhook æˆ–é›»å­éƒµä»¶
  const message = alerts.map(alert => {
    const emoji = alert.status === 'exceeded' ? 'ğŸ”´' : alert.status === 'danger' ? 'âš ï¸' : 'ğŸŸ¡'
    return `${emoji} ${alert.service} - ${alert.metric}: ${alert.usage_percentage.toFixed(1)}% (${alert.current}/${alert.limit})`
  }).join('\n')

  console.log('[Quota Alert]', message)
  // å¯¦ä½œå¯¦éš›çš„è­¦å ±ç™¼é€é‚è¼¯
}
```

#### å‡ç´šæ±ºç­–æ¨¹

```typescript
// è‡ªå‹•å‡ç´šå»ºè­°ç³»çµ±
interface UpgradeRecommendation {
  service: string
  should_upgrade: boolean
  reason: string
  estimated_cost: number  // USD/æœˆ
  priority: 'low' | 'medium' | 'high' | 'critical'
}

export async function generateUpgradeRecommendations(): Promise<UpgradeRecommendation[]> {
  const quotas = await checkAllQuotas()
  const recommendations: UpgradeRecommendation[] = []

  // Redis æ±ºç­–
  const redis = quotas.find(q => q.service === 'Upstash Redis')
  if (redis) {
    if (redis.status === 'exceeded') {
      recommendations.push({
        service: 'Upstash Redis',
        should_upgrade: true,
        reason: 'å‘½ä»¤æ•¸å·²è¶…æ¨™ï¼Œç³»çµ±å¯èƒ½å—é™ã€‚å»ºè­°å…ˆå¯¦ä½œ Bot Detectionï¼ˆå…è²»ï¼‰ï¼Œè‹¥ä»è¶…æ¨™å‰‡å‡ç´šã€‚',
        estimated_cost: 10,  // Pro 200K æ–¹æ¡ˆ
        priority: 'critical'
      })
    } else if (redis.status === 'danger' && redis.usage_percentage >= 95) {
      recommendations.push({
        service: 'Upstash Redis',
        should_upgrade: false,
        reason: 'æ¥è¿‘ä¸Šé™ï¼Œå„ªå…ˆå¯¦ä½œ Bot Detection é™ä½ 40-50% ä½¿ç”¨é‡ã€‚',
        estimated_cost: 0,
        priority: 'high'
      })
    }
  }

  // Vercel æ±ºç­–
  const vercel = quotas.find(q => q.service === 'Vercel')
  if (vercel && vercel.status === 'exceeded') {
    recommendations.push({
      service: 'Vercel',
      should_upgrade: true,
      reason: 'æµé‡å·²è¶…æ¨™ã€‚æª¢æŸ¥é …ç›®ï¼š1) å•Ÿç”¨åœ–ç‰‡å„ªåŒ– 2) æ¸›å°‘ API è«‹æ±‚ 3) è€ƒæ…®å‡ç´š Proã€‚',
      estimated_cost: 20,  // Pro æ–¹æ¡ˆ
      priority: 'high'
    })
  }

  return recommendations
}
```

#### æˆæœ¬æ¯”è¼ƒè¡¨

**Upstash Redis æ–¹æ¡ˆå°æ¯”**ï¼š

| æ–¹æ¡ˆ | å‘½ä»¤æ•¸/å¤© | å„²å­˜ç©ºé–“ | æœˆè²» | é©ç”¨å ´æ™¯ |
|------|----------|---------|------|---------|
| **Free** | 10,000 | 256 MB | $0 | ç•¶å‰æµé‡ + Bot Detection |
| **Pay as you go** | 100,000+ | 1 GB+ | $0.2/10K å‘½ä»¤ | æµé‡æ³¢å‹•å¤§ |
| **Pro 200K** | 200,000 | 2 GB | $10 | ç©©å®šä¸­ç­‰æµé‡ |
| **Pro 3M** | 3,000,000 | 10 GB | $60 | é«˜æµé‡ |

**å¯¦éš›æˆæœ¬ä¼°ç®—**ï¼š

```typescript
// åŸºæ–¼ç•¶å‰æµé‡ 10,668 å‘½ä»¤/å¤©ï¼ˆå¯¦ä½œ Bot Detection å¾Œé™è‡³ 5,000-6,000ï¼‰
å…è²»ç‰ˆï¼š$0
  â†’ å¯¦ä½œ Bot Detection å¾Œï¼š5,000-6,000 å‘½ä»¤/å¤©ï¼ˆ50-60% ä½¿ç”¨ç‡ï¼‰
  â†’ å¯ç©©å®šé‹è¡Œ âœ…

// è‹¥ä¸å¯¦ä½œ Bot Detectionï¼Œç›´æ¥å‡ç´š
Pay as you goï¼š$0.2/10K å‘½ä»¤ Ã— 10,668 å‘½ä»¤/å¤© Ã— 30 å¤© = $6.4/æœˆ
Pro 200Kï¼š$10/æœˆï¼ˆå›ºå®šæˆæœ¬ï¼Œæ›´åˆ’ç®—ï¼‰

// è‹¥æµé‡æˆé•·è‡³ 20,000 å‘½ä»¤/å¤©
Pay as you goï¼š$0.2/10K Ã— 20,000 Ã— 30 = $12/æœˆ
Pro 200Kï¼š$10/æœˆï¼ˆæ›´åˆ’ç®—ï¼‰âœ…
```

**Vercel æ–¹æ¡ˆå°æ¯”**ï¼š

| æ–¹æ¡ˆ | æµé‡ | å‡½æ•¸åŸ·è¡Œæ™‚é–“ | æœˆè²» | é©ç”¨å ´æ™¯ |
|------|------|------------|------|---------|
| **Hobby** | 100 GB | 100 å°æ™‚ | $0 | ç•¶å‰æµé‡ï¼ˆ69 GB/æœˆï¼‰|
| **Pro** | 1 TB | 1000 å°æ™‚ | $20 | é«˜æµé‡æˆ–å•†æ¥­ç”¨é€” |
| **Enterprise** | è‡ªè¨‚ | è‡ªè¨‚ | è¯ç¹«å ±åƒ¹ | ä¼æ¥­ç´š |

#### Vercel Functions åŸ·è¡Œæ™‚é–“åˆ†æ

**äº¤æ˜“ç³»çµ± UI æ¶æ§‹å°æˆæœ¬çš„å½±éŸ¿**ï¼š

äº¤æ˜“ç³»çµ±çš„ UI å¯¦ä½œæ–¹å¼ï¼ˆModal vs ç¨ç«‹é é¢ï¼‰æœƒç›´æ¥å½±éŸ¿ Vercel Serverless Functions çš„åŸ·è¡Œæ™‚é–“ã€‚

**æ–¹æ¡ˆ Aï¼šModal æ¨¡å¼ï¼ˆæ¨è–¦ï¼‰**

```typescript
// ç”¨æˆ¶å®Œæ•´æµç¨‹çš„ Function èª¿ç”¨

// 1. è¨ªå•ä¸»é 
GET / â†’ SSR æ¸²æŸ“ä¸»é  â†’ 100ms

// 2. æ‰“é–‹å¸‚å ´ Modalï¼ˆå®¢æˆ¶ç«¯åˆ‡æ›ï¼Œç„¡ Function èª¿ç”¨ï¼‰
// åƒ…è§¸ç™¼ API è«‹æ±‚
GET /api/market â†’ æŸ¥è©¢ Supabase â†’ 200ms

// 3. æŸ¥çœ‹åˆŠç™»è©³æƒ…ï¼ˆModal å…§åµŒï¼Œç„¡é¡å¤– SSRï¼‰
GET /api/listings/[id] â†’ 100ms

// 4. ç™»è¨˜è³¼è²·æ„å‘
POST /api/interests â†’ 150ms

ç¸½è¨ˆï¼š550ms â‰ˆ 0.0092 åˆ†é˜/ç”¨æˆ¶
```

**æ–¹æ¡ˆ Bï¼šç¨ç«‹é é¢æ¨¡å¼**

```typescript
// ç”¨æˆ¶å®Œæ•´æµç¨‹çš„ Function èª¿ç”¨

// 1. è¨ªå•ä¸»é 
GET / â†’ SSR æ¸²æŸ“ä¸»é  â†’ 100ms

// 2. å°èˆªåˆ°å¸‚å ´é é¢ï¼ˆè§¸ç™¼ SSRï¼‰
GET /market â†’ SSR æ¸²æŸ“å¸‚å ´é é¢ â†’ 150ms
GET /api/market â†’ åˆå§‹è³‡æ–™è¼‰å…¥ â†’ 200ms

// 3. å°èˆªåˆ°åˆŠç™»è©³æƒ…é ï¼ˆè§¸ç™¼ SSRï¼‰
GET /listings/[id] â†’ SSR æ¸²æŸ“è©³æƒ…é  â†’ 100ms
GET /api/listings/[id] â†’ è¼‰å…¥å®Œæ•´è³‡æ–™ â†’ 100ms

// 4. ç™»è¨˜è³¼è²·æ„å‘
POST /api/interests â†’ 150ms

ç¸½è¨ˆï¼š800ms â‰ˆ 0.0133 åˆ†é˜/ç”¨æˆ¶
å·®ç•°ï¼š+250ms (+45%)
```

**å¯¦éš›ä½¿ç”¨å ´æ™¯ä¼°ç®—**ï¼š

å‡è¨­å¹³å‡ç”¨æˆ¶è¡Œç‚ºï¼ˆçœŸå¯¦äº¤æ˜“ç”¨æˆ¶ 7,000 äºº/æœˆï¼‰ï¼š
- ç€è¦½å¸‚å ´ 5 æ¬¡ï¼ˆæŸ¥çœ‹ä¸åŒç‰©å“ï¼‰
- æŸ¥çœ‹åˆŠç™»è©³æƒ… 3 æ¬¡
- ç™»è¨˜æ„å‘ 1 æ¬¡

```typescript
// Modal æ¨¡å¼
ä¸»é  SSRï¼š100ms Ã— 1 = 100ms
å¸‚å ´ APIï¼š200ms Ã— 5 = 1,000ms
åˆŠç™»è©³æƒ… APIï¼š100ms Ã— 3 = 300ms
ç™»è¨˜æ„å‘ APIï¼š150ms Ã— 1 = 150ms
ç¸½è¨ˆï¼š1,550ms = 0.026 åˆ†é˜/ç”¨æˆ¶

æœˆåº¦ç¸½è¨ˆï¼š7,000 Ã— 0.026 = 182 åˆ†é˜ â‰ˆ 3.0 å°æ™‚/æœˆ
ä½” Vercel é¡åº¦ï¼š3.0 / 100 = 3%

// ç¨ç«‹é é¢æ¨¡å¼
ä¸»é  SSRï¼š100ms Ã— 1 = 100ms
å¸‚å ´ SSRï¼š150ms Ã— 5 = 750msï¼ˆæ¯æ¬¡å°èˆªéƒ½è§¸ç™¼ï¼‰
å¸‚å ´ APIï¼š200ms Ã— 5 = 1,000ms
åˆŠç™»è©³æƒ… SSRï¼š100ms Ã— 3 = 300msï¼ˆæ¯æ¬¡å°èˆªéƒ½è§¸ç™¼ï¼‰
åˆŠç™»è©³æƒ… APIï¼š100ms Ã— 3 = 300ms
ç™»è¨˜æ„å‘ APIï¼š150ms Ã— 1 = 150ms
ç¸½è¨ˆï¼š2,600ms = 0.043 åˆ†é˜/ç”¨æˆ¶

æœˆåº¦ç¸½è¨ˆï¼š7,000 Ã— 0.043 = 301 åˆ†é˜ â‰ˆ 5.0 å°æ™‚/æœˆ
ä½” Vercel é¡åº¦ï¼š5.0 / 100 = 5%

å·®ç•°ï¼š+2.0 å°æ™‚/æœˆ (+67%)
```

**æˆæœ¬å°æ¯”è¡¨**ï¼š

| é …ç›® | Modal æ¨¡å¼ | ç¨ç«‹é é¢ | å·®ç•° |
|------|-----------|---------|------|
| **Bandwidthï¼ˆé »å¯¬ï¼‰** | 5.74 GB/æœˆ | 6.02 GB/æœˆ | +0.28 GB (+5%) |
| **Function Timeï¼ˆå‡½æ•¸æ™‚é–“ï¼‰** | 3.0 å°æ™‚/æœˆ | 5.0 å°æ™‚/æœˆ | **+2.0 å°æ™‚ (+67%)** |
| **ç¸½ Vercel é¡åº¦æ¶ˆè€—** | 8% | 11% | +3% |

**çµè«–èˆ‡å»ºè­°**ï¼š

âœ… **æ¨è–¦æ¡ç”¨ Modal æ¨¡å¼**ï¼š
- ç¯€çœç´„ 2 å°æ™‚ Vercel Functions åŸ·è¡Œæ™‚é–“/æœˆï¼ˆç´„ 2% é¡åº¦ï¼‰
- ç•¶å‰ Vercel ä½¿ç”¨å®‰å…¨ï¼ˆé ä¼°ç¸½ä½¿ç”¨ç‡ < 10%ï¼‰
- ç¬¦åˆå°ˆæ¡ˆç¾æœ‰ UI æ¶æ§‹ï¼ˆ`BaseModal`ã€`ModalManager`ï¼‰
- é–‹ç™¼é€Ÿåº¦æ›´å¿«ï¼ˆé‡ç”¨ç¾æœ‰å…ƒä»¶ï¼‰

âš ï¸ **æµé‡å¢é•·è€ƒé‡**ï¼š
```
è‹¥ç”¨æˆ¶æ•¸å¢é•· 3 å€ï¼ˆ21,000 ç”¨æˆ¶ï¼‰ï¼š

Modal æ¨¡å¼ï¼š
â””â”€ Functionsï¼š3.0 Ã— 3 = 9.0 å°æ™‚/æœˆï¼ˆ9% ä½¿ç”¨ç‡ï¼‰âœ…

ç¨ç«‹é é¢æ¨¡å¼ï¼š
â””â”€ Functionsï¼š5.0 Ã— 3 = 15.0 å°æ™‚/æœˆï¼ˆ15% ä½¿ç”¨ç‡ï¼‰âš ï¸

å·®ç•°æ“´å¤§è‡³ 6 å°æ™‚/æœˆ
```

**Supabase æ–¹æ¡ˆå°æ¯”**ï¼š

| æ–¹æ¡ˆ | MAU | å„²å­˜ç©ºé–“ | è³‡æ–™åº« | æœˆè²» | é©ç”¨å ´æ™¯ |
|------|-----|---------|-------|------|---------|
| **Free** | 50,000 | 500 MB | 500 MB | $0 | ç•¶å‰æµé‡ï¼ˆ1,200-1,600 MAUï¼‰|
| **Pro** | 100,000 | 8 GB | 8 GB | $25 | æˆé•·æœŸ |
| **Team** | ç„¡é™ | 100 GB | 100 GB | $599 | ä¼æ¥­ç´š |

#### å‡ç´šæ™‚æ©Ÿå»ºè­°

**ç«‹å³è¡Œå‹•ï¼ˆ0-2 é€±ï¼‰**ï¼š
1. âœ… **å¯¦ä½œ Bot Detection éšæ®µ 1**ï¼ˆUser-Agent éæ¿¾ï¼‰
   - æˆæœ¬ï¼š$0ï¼ˆé–‹ç™¼ 1 é€±ï¼‰
   - æ•ˆæœï¼šæ¸›å°‘ 40-50% Redis ä½¿ç”¨é‡
   - å„ªå…ˆç´šï¼šğŸ”´ Critical

2. âš ï¸ **å•Ÿç”¨ Vercel åœ–ç‰‡å„ªåŒ–**
   - æˆæœ¬ï¼š$0ï¼ˆå…§å»ºåŠŸèƒ½ï¼‰
   - æ•ˆæœï¼šæ¸›å°‘ 10-20% æµé‡
   - å„ªå…ˆç´šï¼šğŸŸ¡ Medium

**çŸ­æœŸè¨ˆåŠƒï¼ˆ2-4 é€±ï¼‰**ï¼š
3. âœ… **å¯¦ä½œ Bot Detection éšæ®µ 2**ï¼ˆè¡Œç‚ºæ¨¡å¼æª¢æ¸¬ï¼‰
   - æˆæœ¬ï¼š$0ï¼ˆé–‹ç™¼ 2-4 é€±ï¼‰
   - æ•ˆæœï¼šæ¸›å°‘ 60-70% Redis ä½¿ç”¨é‡
   - å„ªå…ˆç´šï¼šğŸ”´ Critical

4. âœ… **å¯¦ä½œ Discord OAuth**
   - æˆæœ¬ï¼š$0ï¼ˆé–‹ç™¼ 2-3 é€±ï¼‰
   - æ•ˆæœï¼šæå‡å®‰å…¨æ€§ï¼Œæ¸›å°‘ 3-5% Bot
   - å„ªå…ˆç´šï¼šğŸŸ¢ High

**ä¸­æœŸè¦åŠƒï¼ˆ1-3 å€‹æœˆï¼‰**ï¼š
5. âš ï¸ **æŒçºŒç›£æ§èˆ‡å„ªåŒ–**
   - ç›£æ§ Redisã€Vercelã€Supabase ä½¿ç”¨ç‡
   - è‹¥ Bot Detection å¾Œä»è¶…æ¨™ï¼Œè€ƒæ…®å‡ç´š Redis Pro $10/æœˆ
   - è‹¥ Vercel æµé‡è¶…é 90 GB/æœˆï¼Œè€ƒæ…®å‡ç´š Pro $20/æœˆ

**å‡ç´šè§¸ç™¼æ¢ä»¶**ï¼š

```typescript
interface UpgradeTrigger {
  service: string
  condition: string
  action: string
  estimated_cost: number
}

const UPGRADE_TRIGGERS: UpgradeTrigger[] = [
  {
    service: 'Upstash Redis',
    condition: 'Bot Detection å¯¦ä½œå¾Œä»è¶…é 9,000 å‘½ä»¤/å¤©ï¼ˆ90%ï¼‰æŒçºŒ 7 å¤©',
    action: 'å‡ç´šè‡³ Pro 200K æ–¹æ¡ˆ',
    estimated_cost: 10
  },
  {
    service: 'Vercel',
    condition: 'æµé‡é€£çºŒ 3 å€‹æœˆè¶…é 95 GB/æœˆï¼ˆ95%ï¼‰',
    action: 'å‡ç´šè‡³ Pro æ–¹æ¡ˆ',
    estimated_cost: 20
  },
  {
    service: 'Supabase',
    condition: 'MAU è¶…é 40,000ï¼ˆ80%ï¼‰æˆ–å„²å­˜ç©ºé–“è¶…é 400 MBï¼ˆ80%ï¼‰',
    action: 'å‡ç´šè‡³ Pro æ–¹æ¡ˆ',
    estimated_cost: 25
  }
]

// è‡ªå‹•æª¢æŸ¥å‡ç´šè§¸ç™¼æ¢ä»¶
export async function checkUpgradeTriggers(): Promise<UpgradeTrigger[]> {
  const triggered: UpgradeTrigger[] = []
  const quotas = await checkAllQuotas()

  // Redis æª¢æŸ¥
  const redis = quotas.find(q => q.service === 'Upstash Redis')
  if (redis && redis.usage_percentage >= 90) {
    // æª¢æŸ¥æ˜¯å¦å·²å¯¦ä½œ Bot Detection
    const botDetectionEnabled = await isBotDetectionEnabled()
    if (botDetectionEnabled) {
      const trigger = UPGRADE_TRIGGERS.find(t => t.service === 'Upstash Redis')
      if (trigger) triggered.push(trigger)
    }
  }

  // Vercel æª¢æŸ¥
  const vercel = quotas.find(q => q.service === 'Vercel')
  if (vercel && vercel.usage_percentage >= 95) {
    const trigger = UPGRADE_TRIGGERS.find(t => t.service === 'Vercel')
    if (trigger) triggered.push(trigger)
  }

  return triggered
}

async function isBotDetectionEnabled(): Promise<boolean> {
  // æª¢æŸ¥ middleware æ˜¯å¦å·²å•Ÿç”¨ Bot Detection
  // å¯¦ä½œé‚è¼¯...
  return false
}
```

### æˆæœ¬æœ€ä½³åŒ–ç­–ç•¥

**é›¶æˆæœ¬å„ªåŒ–**ï¼ˆå„ªå…ˆåŸ·è¡Œï¼‰ï¼š
1. âœ… **Bot Detection**ï¼šæ¸›å°‘ 60-70% ç„¡æ•ˆæµé‡
2. âœ… **åœ–ç‰‡å„ªåŒ–**ï¼šä½¿ç”¨ Next.js Image çµ„ä»¶ï¼ˆè‡ªå‹• WebP è½‰æ›ï¼‰
3. âœ… **API å¿«å–**ï¼šåˆç†è¨­ç½® Cache-Control headers
4. âœ… **è³‡æ–™åº«æŸ¥è©¢å„ªåŒ–**ï¼šæ¸›å°‘ä¸å¿…è¦çš„æŸ¥è©¢ã€ä½¿ç”¨ç´¢å¼•

**ä½æˆæœ¬å„ªåŒ–**ï¼ˆ$0-$20/æœˆï¼‰ï¼š
1. âš ï¸ **Cloudflare CDN**ï¼šå…è²»ç‰ˆæä¾›ç„¡é™æµé‡ï¼ˆéœ€é·ç§» DNSï¼‰
2. âš ï¸ **Upstash Redis Pro**ï¼š$10/æœˆæ”¯æ´ 200K å‘½ä»¤/å¤©
3. âš ï¸ **R2 åœ–ç‰‡å„²å­˜**ï¼š$0ï¼ˆ10 GB å…è²»ï¼‰+ $0.015/GBï¼ˆè¶…å‡ºéƒ¨åˆ†ï¼‰

**é ä¼°ç¸½æˆæœ¬**ï¼ˆå¯¦ä½œæ‰€æœ‰å„ªåŒ–å¾Œï¼‰ï¼š

| å ´æ™¯ | æµé‡ | Redis | Vercel | Supabase | ç¸½æˆæœ¬ |
|------|------|-------|--------|---------|-------|
| **ç•¶å‰ï¼ˆæœªå„ªåŒ–ï¼‰** | 1,559/å¤© | è¶…æ¨™ âŒ | $0 | $0 | $0ï¼ˆä¸å¯æŒçºŒï¼‰|
| **Bot Detection å¾Œ** | 1,559/å¤© | $0 âœ… | $0 | $0 | **$0** âœ… |
| **æµé‡ 2x æˆé•·** | 3,000/å¤© | $10 | $0 | $0 | **$10** |
| **æµé‡ 5x æˆé•·** | 7,500/å¤© | $10 | $20 | $0 | **$30** |
| **æµé‡ 10x æˆé•·** | 15,000/å¤© | $60 | $20 | $25 | **$105** |

**çµè«–**ï¼š
- ğŸ¯ **æœ€ä½³ç­–ç•¥**ï¼šå¯¦ä½œ Bot Detectionï¼ˆå…è²»ï¼‰â†’ å¯ç©©å®šé‹è¡Œåœ¨å…¨å…è²»ç‰ˆ
- ğŸ“ˆ **æˆé•·ç©ºé–“**ï¼šå…è²»ç‰ˆå¯æ”¯æ’è‡³ 3,000 MAUï¼ˆ2x æˆé•·ï¼‰
- ğŸ’° **å‡ç´šæˆæœ¬**ï¼šè‹¥éœ€å‡ç´šï¼Œæœˆè²» $10-30ï¼ˆä¸­ç­‰æµé‡ï¼‰æˆ– $105ï¼ˆé«˜æµé‡ï¼‰

---

## Bot Detection å¯¦ä½œæ–¹æ¡ˆ

### è¨­è¨ˆç›®æ¨™

æœ‰æ•ˆéæ¿¾ 60-70% Bot æµé‡ï¼Œå°‡ Redis ä½¿ç”¨é‡å¾ 10,668 å‘½ä»¤/å¤©é™è‡³ 5,000-6,000 å‘½ä»¤/å¤©ã€‚

### éšæ®µ 1ï¼šåŸºç¤ User-Agent éæ¿¾ï¼ˆ1 é€±å…§å¯¦ä½œï¼‰

#### å¯¦ä½œç­–ç•¥

**é»‘åå–®éæ¿¾**ï¼š

```typescript
// src/lib/middleware/bot-detection.ts
const BOT_USER_AGENTS = [
  // çˆ¬èŸ²å·¥å…·
  'curl', 'wget', 'python-requests', 'java', 'go-http-client',

  // ç„¡é ­ç€è¦½å™¨
  'headless', 'phantomjs', 'selenium', 'puppeteer',

  // è‡ªå‹•åŒ–å·¥å…·
  'scrapy', 'aiohttp', 'axios', 'got', 'node-fetch',

  // æƒ¡æ„å·¥å…·
  'masscan', 'nmap', 'nikto', 'sqlmap',
]

const SEO_CRAWLERS_WHITELIST = [
  'googlebot', 'bingbot', 'baiduspider', 'duckduckbot',
  'yandexbot', 'slurp', 'ia_archiver'
]

export function isBotUserAgent(userAgent: string | null): boolean {
  // 1. ç„¡ User-Agent â†’ 100% Bot
  if (!userAgent) return true

  const ua = userAgent.toLowerCase()

  // 2. SEO çˆ¬èŸ²ç™½åå–® â†’ å…è¨±
  if (SEO_CRAWLERS_WHITELIST.some(bot => ua.includes(bot))) {
    return false
  }

  // 3. é»‘åå–®æª¢æŸ¥ â†’ æ‹’çµ•
  if (BOT_USER_AGENTS.some(bot => ua.includes(bot))) {
    return true
  }

  // 4. æ­£å¸¸ç€è¦½å™¨æª¢æŸ¥
  const browserPatterns = [
    'mozilla', 'chrome', 'safari', 'firefox', 'edge', 'opera'
  ]
  const hasBrowserPattern = browserPatterns.some(pattern => ua.includes(pattern))

  // æ²’æœ‰ä»»ä½•ç€è¦½å™¨ç‰¹å¾µ â†’ ç–‘ä¼¼ Bot
  return !hasBrowserPattern
}
```

**Middleware æ•´åˆ**ï¼š

```typescript
// src/middleware.ts
import { NextRequest, NextResponse } from 'next/server'
import { isBotUserAgent } from '@/lib/middleware/bot-detection'

export function middleware(request: NextRequest) {
  const userAgent = request.headers.get('user-agent')

  // Bot Detection
  if (isBotUserAgent(userAgent)) {
    // è¨˜éŒ„ Bot è«‹æ±‚ï¼ˆå¯é¸ï¼‰
    console.log('[Bot Detected]', {
      path: request.nextUrl.pathname,
      userAgent,
      ip: request.ip
    })

    // è¿”å› 403 Forbidden
    return new NextResponse(
      JSON.stringify({
        error: 'Bot detected',
        message: 'Automated requests are not allowed'
      }),
      {
        status: 403,
        headers: { 'Content-Type': 'application/json' }
      }
    )
  }

  return NextResponse.next()
}

export const config = {
  matcher: [
    '/api/:path*',  // æ‰€æœ‰ API ç«¯é»ï¼ˆModal æ¨¡å¼ç„¡éœ€ä¿è­·é é¢è·¯ç”±ï¼‰
  ]
}
```

**é æœŸæ•ˆæœ**ï¼š
- æ¸›å°‘ 40-50% Bot æµé‡
- Redis é™è‡³ 7,000-8,000 å‘½ä»¤/å¤©ï¼ˆ70-80% ä½¿ç”¨ç‡ï¼‰
- âš ï¸ è‡¨æ™‚ç·©è§£ï¼Œä»éœ€å¾ŒçºŒå„ªåŒ–

---

### éšæ®µ 2ï¼šè¡Œç‚ºæ¨¡å¼æª¢æ¸¬ï¼ˆ2-4 é€±å…§å¯¦ä½œï¼‰

#### é«˜é »è¨ªå•æª¢æ¸¬

```typescript
// src/lib/services/rate-limiter.ts
import { Redis } from '@upstash/redis'

const redis = new Redis({
  url: process.env.UPSTASH_REDIS_REST_URL!,
  token: process.env.UPSTASH_REDIS_REST_TOKEN!,
})

export async function checkHighFrequencyAccess(
  identifier: string,  // IP æˆ– user_id
  endpoint: string,
  threshold: number = 50,  // 1 å°æ™‚å…§æœ€å¤š 50 æ¬¡
): Promise<boolean> {
  const key = `hf:${identifier}:${endpoint}`
  const window = 3600  // 1 å°æ™‚

  const count = await redis.incr(key)

  if (count === 1) {
    await redis.expire(key, window)
  }

  // è¶…éé–¾å€¼ â†’ åˆ¤å®šç‚º Bot
  return count > threshold
}
```

**Middleware æ•´åˆ**ï¼š

```typescript
export async function middleware(request: NextRequest) {
  const userAgent = request.headers.get('user-agent')
  const ip = request.ip || 'unknown'

  // éšæ®µ 1ï¼šUser-Agent éæ¿¾
  if (isBotUserAgent(userAgent)) {
    return new NextResponse('Bot detected', { status: 403 })
  }

  // éšæ®µ 2ï¼šé«˜é »è¨ªå•æª¢æ¸¬
  const isHighFrequency = await checkHighFrequencyAccess(
    ip,
    request.nextUrl.pathname,
    50  // 1 å°æ™‚ 50 æ¬¡
  )

  if (isHighFrequency) {
    return new NextResponse(
      JSON.stringify({
        error: 'Too many requests',
        message: 'Please slow down your requests'
      }),
      {
        status: 429,
        headers: {
          'Content-Type': 'application/json',
          'Retry-After': '3600'  // 1 å°æ™‚å¾Œé‡è©¦
        }
      }
    )
  }

  return NextResponse.next()
}
```

#### æƒæè¡Œç‚ºæª¢æ¸¬

```typescript
// æª¢æ¸¬çŸ­æ™‚é–“å…§è¨ªå•å¤šå€‹ä¸åŒç«¯é»
export async function checkScanningBehavior(
  ip: string,
  threshold: number = 20  // 1 åˆ†é˜å…§è¨ªå• 20 å€‹ä¸åŒç«¯é»
): Promise<boolean> {
  const key = `scan:${ip}`
  const window = 60  // 1 åˆ†é˜

  // ä½¿ç”¨ Redis Set è¨˜éŒ„è¨ªå•çš„ä¸åŒç«¯é»
  const count = await redis.scard(key)

  if (count > threshold) {
    return true  // åˆ¤å®šç‚ºæƒæè¡Œç‚º
  }

  // è¨˜éŒ„ç•¶å‰ç«¯é»
  await redis.sadd(key, request.nextUrl.pathname)
  await redis.expire(key, window)

  return false
}
```

**é æœŸæ•ˆæœ**ï¼š
- æ¸›å°‘ 60-70% Bot æµé‡
- Redis é™è‡³ 5,000-6,000 å‘½ä»¤/å¤©ï¼ˆ50-60% ä½¿ç”¨ç‡ï¼‰
- âœ… å¯ç©©å®šé‹è¡Œåœ¨å…è²»ç‰ˆ

---

### éšæ®µ 3ï¼šIP ä¿¡è­½è©•åˆ†ç³»çµ±ï¼ˆ1-2 å€‹æœˆå…§å¯¦ä½œï¼‰

#### è¨­è¨ˆæ¶æ§‹

```sql
-- IP ä¿¡è­½è¡¨
CREATE TABLE ip_reputation (
  ip_address INET PRIMARY KEY,
  reputation_score INTEGER DEFAULT 50 CHECK (reputation_score >= 0 AND reputation_score <= 100),
  total_requests INT DEFAULT 0,
  bot_requests INT DEFAULT 0,
  blocked_count INT DEFAULT 0,
  last_seen_at TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_low_reputation ON ip_reputation(reputation_score)
  WHERE reputation_score < 30;
```

#### ä¿¡è­½è¨ˆç®—é‚è¼¯

```typescript
// src/lib/services/ip-reputation.ts
export async function calculateIPReputation(ip: string): Promise<number> {
  const data = await supabase
    .from('ip_reputation')
    .select('*')
    .eq('ip_address', ip)
    .single()

  if (!data) {
    return 50  // æ–° IP é è¨­ 50 åˆ†
  }

  let score = 50

  // 1. Bot è«‹æ±‚æ¯”ä¾‹æ‰£åˆ†
  const botRatio = data.bot_requests / data.total_requests
  if (botRatio > 0.8) score -= 30
  else if (botRatio > 0.5) score -= 20
  else if (botRatio > 0.3) score -= 10

  // 2. è¢«å°é–æ¬¡æ•¸æ‰£åˆ†
  score -= Math.min(data.blocked_count * 2, 30)

  // 3. æ´»èºæ™‚é–“åŠ åˆ†ï¼ˆé•·æœŸæ´»èºç”¨æˆ¶ï¼‰
  const daysSinceCreated = Math.floor(
    (Date.now() - new Date(data.created_at).getTime()) / (1000 * 60 * 60 * 24)
  )
  if (daysSinceCreated > 90) score += 10
  else if (daysSinceCreated > 30) score += 5

  // 4. æœ€è¿‘æ´»èºåŠ åˆ†
  const daysSinceLastSeen = Math.floor(
    (Date.now() - new Date(data.last_seen_at).getTime()) / (1000 * 60 * 60 * 24)
  )
  if (daysSinceLastSeen < 7) score += 5

  return Math.max(0, Math.min(100, score))
}
```

#### åŸºæ–¼ä¿¡è­½çš„é™æµç­–ç•¥

```typescript
export async function getRateLimitByReputation(
  ip: string
): Promise<{ limit: number; window: number }> {
  const reputation = await calculateIPReputation(ip)

  if (reputation >= 80) {
    // é«˜ä¿¡è­½ IPï¼šå¯¬é¬†é™åˆ¶
    return { limit: 100, window: 3600 }  // 100 æ¬¡/å°æ™‚
  } else if (reputation >= 50) {
    // ä¸­ç­‰ä¿¡è­½ IPï¼šæ­£å¸¸é™åˆ¶
    return { limit: 60, window: 3600 }  // 60 æ¬¡/å°æ™‚
  } else if (reputation >= 30) {
    // ä½ä¿¡è­½ IPï¼šåš´æ ¼é™åˆ¶
    return { limit: 20, window: 3600 }  // 20 æ¬¡/å°æ™‚
  } else {
    // æ¥µä½ä¿¡è­½ IPï¼šç›´æ¥å°é–
    return { limit: 0, window: 3600 }  // ç¦æ­¢è¨ªå•
  }
}
```

**é æœŸæ•ˆæœ**ï¼š
- æ¸›å°‘ 70-80% Bot æµé‡
- Redis é™è‡³ 4,000-5,000 å‘½ä»¤/å¤©ï¼ˆ40-50% ä½¿ç”¨ç‡ï¼‰
- âœ… å…è²»ç‰ˆé•·æœŸç©©å®š

---

### éšæ®µ 4ï¼šCloudflare Bot Protectionï¼ˆå¯é¸ï¼‰

**å„ªé»**ï¼š
- å…è²»ç‰ˆå¯ç”¨ï¼ˆæœ‰é™åˆ¶ï¼‰
- æ¸›å°‘ 85-95% Bot æµé‡
- ç„¡éœ€è‡ªè¡Œç¶­è­·

**ç¼ºé»**ï¼š
- å…è²»ç‰ˆæœ‰é™åˆ¶ï¼ˆæ¯æœˆ 100,000 è«‹æ±‚ï¼‰
- éœ€è¦å°‡åŸŸå DNS è¨—ç®¡åˆ° Cloudflare
- å¯èƒ½å½±éŸ¿ SEO çˆ¬èŸ²

**å¯¦ä½œæ–¹å¼**ï¼š
1. è¨»å†Š Cloudflare å¸³è™Ÿ
2. å°‡åŸŸå DNS è¨—ç®¡åˆ° Cloudflare
3. å•Ÿç”¨ã€ŒBot Fight Modeã€ï¼ˆå…è²»ç‰ˆï¼‰
4. é…ç½®è¦å‰‡ç™½åå–®ï¼ˆå…è¨± SEO çˆ¬èŸ²ï¼‰

**é æœŸæ•ˆæœ**ï¼š
- æ¸›å°‘ 85-95% Bot æµé‡
- Redis é™è‡³ 2,000-3,000 å‘½ä»¤/å¤©ï¼ˆ20-30% ä½¿ç”¨ç‡ï¼‰
- âœ… ç†æƒ³ç‹€æ…‹

---

### å¯¦ä½œå„ªå…ˆç´šå»ºè­°

**ç«‹å³åŸ·è¡Œï¼ˆP0ï¼‰**ï¼š
1. âœ… éšæ®µ 1ï¼šåŸºç¤ User-Agent éæ¿¾ï¼ˆ1 é€±ï¼‰
   - æœ€å¿«è¦‹æ•ˆï¼ŒæŠ•è³‡å ±é…¬ç‡é«˜
   - å¯ç«‹å³æ¸›å°‘ 40-50% Bot

**çŸ­æœŸåŸ·è¡Œï¼ˆP1ï¼‰**ï¼š
2. âœ… éšæ®µ 2ï¼šè¡Œç‚ºæ¨¡å¼æª¢æ¸¬ï¼ˆ2-4 é€±ï¼‰
   - é«˜é »è¨ªå• + æƒæè¡Œç‚ºæª¢æ¸¬
   - å¯é” 60-70% Bot éæ¿¾ç‡

**ä¸­æœŸåŸ·è¡Œï¼ˆP2ï¼‰**ï¼š
3. â¸ï¸ éšæ®µ 3ï¼šIP ä¿¡è­½è©•åˆ†ï¼ˆ1-2 å€‹æœˆï¼‰
   - é•·æœŸå„ªåŒ–æ–¹æ¡ˆ
   - éœ€è¦ç´¯ç©æ•¸æ“š

**å¯é¸åŸ·è¡Œï¼ˆP3ï¼‰**ï¼š
4. â¸ï¸ éšæ®µ 4ï¼šCloudflareï¼ˆå¯é¸ï¼‰
   - çµ‚æ¥µè§£æ±ºæ–¹æ¡ˆ
   - éœ€è¦è©•ä¼° DNS é·ç§»æˆæœ¬

### ç›£æ§æŒ‡æ¨™

**é—œéµæŒ‡æ¨™**ï¼š

```typescript
// æ¯æ—¥ç›£æ§
const metrics = {
  // Bot æµé‡
  totalRequests: 6334,          // ç¸½è«‹æ±‚æ•¸
  botRequests: 3800,            // Bot è«‹æ±‚æ•¸
  botRatio: 60,                 // Bot æ¯”ä¾‹ï¼ˆ%ï¼‰

  // Redis ä½¿ç”¨é‡
  redisCommands: 10668,         // Redis å‘½ä»¤æ•¸/å¤©
  redisUsageRate: 107,          // ä½¿ç”¨ç‡ï¼ˆ%ï¼‰

  // éæ¿¾æ•ˆæœ
  filteredBots: 2500,           // å·²éæ¿¾ Bot æ•¸
  filterRate: 65,               // éæ¿¾ç‡ï¼ˆ%ï¼‰
}

// å‘Šè­¦é–¾å€¼
const alerts = {
  botRatioWarning: 60,          // Bot æ¯”ä¾‹ > 60% å‘Šè­¦
  redisUsageWarning: 80,        // Redis ä½¿ç”¨ç‡ > 80% å‘Šè­¦
  filterRateWarning: 50,        // éæ¿¾ç‡ < 50% å‘Šè­¦
}
```

**ç›£æ§å„€è¡¨æ¿**ï¼ˆå»ºè­°å¯¦ä½œï¼‰ï¼š
- å¯¦æ™‚ Bot æµé‡æ¯”ä¾‹
- Redis ä½¿ç”¨ç‡è¶¨å‹¢
- å„éšæ®µ Bot Detection æ•ˆæœ
- IP ä¿¡è­½åˆ†å¸ƒ
- è¢«å°é–çš„ Bot åˆ—è¡¨

### ç¸½çµ

**æ ¸å¿ƒç­–ç•¥**ï¼š
- ğŸ”´ **éšæ®µ 1 æ˜¯å¿…é ˆ**ï¼šåŸºç¤ User-Agent éæ¿¾ï¼ˆ1 é€±å…§å¯¦ä½œï¼‰
- ğŸŸ¡ **éšæ®µ 2 æ˜¯é—œéµ**ï¼šè¡Œç‚ºæ¨¡å¼æª¢æ¸¬ï¼ˆ2-4 é€±å…§å¯¦ä½œï¼‰
- ğŸŸ¢ **éšæ®µ 3 æ˜¯å„ªåŒ–**ï¼šIP ä¿¡è­½è©•åˆ†ï¼ˆ1-2 å€‹æœˆå…§å¯¦ä½œï¼‰
- âšª **éšæ®µ 4 æ˜¯å¯é¸**ï¼šCloudflareï¼ˆè©•ä¼°å¾Œæ±ºå®šï¼‰

**é æœŸæˆæœ**ï¼š
```
ç•¶å‰ç‹€æ…‹ï¼š10,668 å‘½ä»¤/å¤©ï¼ˆ107% è¶…æ¨™ï¼‰
  â†“
éšæ®µ 1ï¼š7,000-8,000 å‘½ä»¤/å¤©ï¼ˆ70-80%ï¼‰
  â†“
éšæ®µ 2ï¼š5,000-6,000 å‘½ä»¤/å¤©ï¼ˆ50-60%ï¼‰âœ… ç›®æ¨™é”æˆ
  â†“
éšæ®µ 3ï¼š4,000-5,000 å‘½ä»¤/å¤©ï¼ˆ40-50%ï¼‰
  â†“
éšæ®µ 4ï¼š2,000-3,000 å‘½ä»¤/å¤©ï¼ˆ20-30%ï¼‰
```

---

## ç›£æ§èˆ‡ç¶­è­·

### é—œéµç›£æ§æŒ‡æ¨™

#### 1. ç³»çµ±å¥åº·æŒ‡æ¨™

**Redis ç›£æ§**ï¼š
```typescript
// src/lib/monitoring/redis-monitor.ts
import { redis } from '@/lib/redis'

interface RedisMetrics {
  daily_commands: number
  daily_limit: number
  usage_percentage: number
  memory_used_mb: number
  memory_limit_mb: number
  hit_rate: number
  status: 'healthy' | 'warning' | 'critical'
}

export async function getRedisMetrics(): Promise<RedisMetrics> {
  // 1. ç²å–æ¯æ—¥å‘½ä»¤æ•¸
  const dailyCommands = await redis.get<number>('quota:redis:daily_commands') || 0
  const dailyLimit = 10000
  const usagePercentage = (dailyCommands / dailyLimit) * 100

  // 2. ç²å–è¨˜æ†¶é«”ä½¿ç”¨ï¼ˆéœ€è¦ Redis INFO å‘½ä»¤æ”¯æ´ï¼‰
  // Upstash Redis å…è²»ç‰ˆå¯èƒ½ä¸æ”¯æ´ï¼Œé€™è£¡ç”¨ä¼°ç®—
  const memoryUsedMb = 0.5 // ä¼°ç®—å€¼
  const memoryLimitMb = 256

  // 3. å‘½ä¸­ç‡ä¼°ç®—
  const hitRate = 0.95 // 95% å‘½ä¸­ç‡ç‚ºå¥åº·ç‹€æ…‹

  // 4. ç‹€æ…‹è©•ä¼°
  let status: RedisMetrics['status']
  if (usagePercentage >= 95) status = 'critical'
  else if (usagePercentage >= 80) status = 'warning'
  else status = 'healthy'

  return {
    daily_commands: dailyCommands,
    daily_limit: dailyLimit,
    usage_percentage: usagePercentage,
    memory_used_mb: memoryUsedMb,
    memory_limit_mb: memoryLimitMb,
    hit_rate: hitRate,
    status
  }
}
```

**Supabase ç›£æ§**ï¼š
```typescript
// src/lib/monitoring/supabase-monitor.ts
interface SupabaseMetrics {
  active_users_today: number
  estimated_mau: number
  mau_limit: number
  database_size_mb: number
  database_limit_mb: number
  api_requests_today: number
  status: 'healthy' | 'warning' | 'critical'
}

export async function getSupabaseMetrics(): Promise<SupabaseMetrics> {
  // 1. ç²å–ä»Šæ—¥æ´»èºç”¨æˆ¶
  const { count: activeUsersToday } = await supabase
    .from('users')
    .select('*', { count: 'exact', head: true })
    .gte('last_login_at', new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString())

  // 2. ä¼°ç®— MAUï¼ˆåŸºæ–¼æ—¥æ´»ç‡ 30%ï¼‰
  const estimatedMau = Math.floor((activeUsersToday || 0) / 0.3)
  const mauLimit = 50000

  // 3. è³‡æ–™åº«å¤§å°ä¼°ç®—
  const { count: totalUsers } = await supabase
    .from('users')
    .select('*', { count: 'exact', head: true })

  const { count: totalListings } = await supabase
    .from('listings')
    .select('*', { count: 'exact', head: true })

  // å‡è¨­æ¯å€‹ç”¨æˆ¶ 1KBï¼Œæ¯å€‹åˆŠç™» 2KB
  const databaseSizeMb = ((totalUsers || 0) * 1 + (totalListings || 0) * 2) / 1024
  const databaseLimitMb = 500

  // 4. ç‹€æ…‹è©•ä¼°
  const mauPercentage = (estimatedMau / mauLimit) * 100
  const storagePercentage = (databaseSizeMb / databaseLimitMb) * 100

  let status: SupabaseMetrics['status']
  if (mauPercentage >= 95 || storagePercentage >= 95) status = 'critical'
  else if (mauPercentage >= 80 || storagePercentage >= 80) status = 'warning'
  else status = 'healthy'

  return {
    active_users_today: activeUsersToday || 0,
    estimated_mau: estimatedMau,
    mau_limit: mauLimit,
    database_size_mb: databaseSizeMb,
    database_limit_mb: databaseLimitMb,
    api_requests_today: 0, // éœ€è¦å¾ Supabase Dashboard ç²å–
    status
  }
}
```

#### 2. æ¥­å‹™æŒ‡æ¨™ç›£æ§

```typescript
// src/lib/monitoring/business-metrics.ts
interface BusinessMetrics {
  // ç”¨æˆ¶æ´»èºåº¦
  dau: number  // Daily Active Users
  wau: number  // Weekly Active Users
  mau: number  // Monthly Active Users
  retention_rate_7d: number  // 7 å¤©ç•™å­˜ç‡
  retention_rate_30d: number  // 30 å¤©ç•™å­˜ç‡

  // äº¤æ˜“æŒ‡æ¨™
  total_listings: number
  active_listings: number
  sold_listings_today: number
  purchase_intents_today: number
  conversion_rate: number  // æ„å‘ â†’ æˆäº¤è½‰æ›ç‡

  // Webhook æŒ‡æ¨™
  webhook_sent_today: number
  webhook_failed_today: number
  webhook_success_rate: number
}

export async function getBusinessMetrics(): Promise<BusinessMetrics> {
  const now = new Date()
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate())
  const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000)
  const sevenDaysAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000)
  const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000)

  // DAU/WAU/MAU
  const { count: dau } = await supabase
    .from('users')
    .select('*', { count: 'exact', head: true })
    .gte('last_login_at', today.toISOString())

  const { count: wau } = await supabase
    .from('users')
    .select('*', { count: 'exact', head: true })
    .gte('last_login_at', sevenDaysAgo.toISOString())

  const { count: mau } = await supabase
    .from('users')
    .select('*', { count: 'exact', head: true })
    .gte('last_login_at', thirtyDaysAgo.toISOString())

  // åˆŠç™»æ•¸æ“š
  const { count: totalListings } = await supabase
    .from('listings')
    .select('*', { count: 'exact', head: true })

  const { count: activeListings } = await supabase
    .from('listings')
    .select('*', { count: 'exact', head: true })
    .eq('status', 'active')

  const { count: soldListingsToday } = await supabase
    .from('listings')
    .select('*', { count: 'exact', head: true })
    .eq('status', 'sold')
    .gte('updated_at', today.toISOString())

  // è³¼è²·æ„å‘æ•¸æ“š
  const { count: purchaseIntentsToday } = await supabase
    .from('interests')
    .select('*', { count: 'exact', head: true })
    .gte('created_at', today.toISOString())

  return {
    dau: dau || 0,
    wau: wau || 0,
    mau: mau || 0,
    retention_rate_7d: 0, // éœ€è¦é¡å¤–è¨ˆç®—
    retention_rate_30d: 0,
    total_listings: totalListings || 0,
    active_listings: activeListings || 0,
    sold_listings_today: soldListingsToday || 0,
    purchase_intents_today: purchaseIntentsToday || 0,
    conversion_rate: 0, // éœ€è¦é¡å¤–è¨ˆç®—
    webhook_sent_today: 0, // å¾ webhooks è¡¨çµ±è¨ˆ
    webhook_failed_today: 0,
    webhook_success_rate: 0
  }
}
```

### è­¦å ±æ©Ÿåˆ¶

#### Discord Webhook è­¦å ±

```typescript
// src/lib/monitoring/alerts.ts
interface Alert {
  level: 'info' | 'warning' | 'critical'
  service: string
  metric: string
  message: string
  current_value: number | string
  threshold: number | string
  timestamp: Date
}

export async function sendAlert(alert: Alert): Promise<void> {
  const webhookUrl = process.env.ADMIN_ALERT_WEBHOOK_URL
  if (!webhookUrl) return

  const colorMap = {
    info: 0x3498db,      // è—è‰²
    warning: 0xf39c12,   // é»ƒè‰²
    critical: 0xe74c3c   // ç´…è‰²
  }

  const payload = {
    username: "ç³»çµ±ç›£æ§è­¦å ±",
    embeds: [
      {
        title: `${alert.level === 'critical' ? 'ğŸ”´' : alert.level === 'warning' ? 'âš ï¸' : 'â„¹ï¸'} ${alert.service} è­¦å ±`,
        description: alert.message,
        color: colorMap[alert.level],
        fields: [
          {
            name: "æŒ‡æ¨™",
            value: alert.metric,
            inline: true
          },
          {
            name: "ç•¶å‰å€¼",
            value: String(alert.current_value),
            inline: true
          },
          {
            name: "é–¾å€¼",
            value: String(alert.threshold),
            inline: true
          }
        ],
        footer: {
          text: "MapleStory äº¤æ˜“ç³»çµ±ç›£æ§"
        },
        timestamp: alert.timestamp.toISOString()
      }
    ]
  }

  await fetch(webhookUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
}

// è‡ªå‹•æª¢æŸ¥ä¸¦ç™¼é€è­¦å ±
export async function checkAndAlert(): Promise<void> {
  const alerts: Alert[] = []

  // 1. Redis æª¢æŸ¥
  const redisMetrics = await getRedisMetrics()
  if (redisMetrics.status === 'critical') {
    alerts.push({
      level: 'critical',
      service: 'Upstash Redis',
      metric: 'æ¯æ—¥å‘½ä»¤æ•¸',
      message: `Redis å‘½ä»¤æ•¸å·²é” ${redisMetrics.usage_percentage.toFixed(1)}%ï¼Œè¶…éå±éšªé–¾å€¼ 95%ï¼`,
      current_value: `${redisMetrics.daily_commands} å‘½ä»¤`,
      threshold: `${redisMetrics.daily_limit} å‘½ä»¤/å¤©`,
      timestamp: new Date()
    })
  } else if (redisMetrics.status === 'warning') {
    alerts.push({
      level: 'warning',
      service: 'Upstash Redis',
      metric: 'æ¯æ—¥å‘½ä»¤æ•¸',
      message: `Redis å‘½ä»¤æ•¸å·²é” ${redisMetrics.usage_percentage.toFixed(1)}%ï¼Œè¶…éè­¦å ±é–¾å€¼ 80%ã€‚`,
      current_value: `${redisMetrics.daily_commands} å‘½ä»¤`,
      threshold: `${redisMetrics.daily_limit} å‘½ä»¤/å¤©`,
      timestamp: new Date()
    })
  }

  // 2. Supabase æª¢æŸ¥
  const supabaseMetrics = await getSupabaseMetrics()
  if (supabaseMetrics.status !== 'healthy') {
    alerts.push({
      level: supabaseMetrics.status === 'critical' ? 'critical' : 'warning',
      service: 'Supabase',
      metric: 'MAU / å„²å­˜ç©ºé–“',
      message: `Supabase ä½¿ç”¨ç‡ç•°å¸¸ã€‚MAU: ${supabaseMetrics.estimated_mau}/${supabaseMetrics.mau_limit}, å„²å­˜: ${supabaseMetrics.database_size_mb.toFixed(1)}/${supabaseMetrics.database_limit_mb} MB`,
      current_value: `${supabaseMetrics.estimated_mau} MAU`,
      threshold: `${supabaseMetrics.mau_limit} MAU`,
      timestamp: new Date()
    })
  }

  // 3. ç™¼é€æ‰€æœ‰è­¦å ±
  for (const alert of alerts) {
    await sendAlert(alert)
  }
}
```

### å®šæœŸç¶­è­·ä»»å‹™

#### Vercel Cron Jobs é…ç½®

```json
// vercel.json
{
  "crons": [
    {
      "path": "/api/cron/daily-metrics",
      "schedule": "0 0 * * *"
    },
    {
      "path": "/api/cron/hourly-check",
      "schedule": "0 * * * *"
    },
    {
      "path": "/api/cron/cleanup-sessions",
      "schedule": "0 2 * * *"
    },
    {
      "path": "/api/cron/cleanup-expired-listings",
      "schedule": "0 3 * * *"
    }
  ]
}
```

#### æ¯æ—¥ç¶­è­·ä»»å‹™

```typescript
// src/app/api/cron/daily-metrics/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { getRedisMetrics, getSupabaseMetrics, getBusinessMetrics } from '@/lib/monitoring'

export async function GET(request: NextRequest) {
  // é©—è­‰ Cron Secret
  const authHeader = request.headers.get('authorization')
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return new NextResponse('Unauthorized', { status: 401 })
  }

  // 1. æ”¶é›†æ‰€æœ‰æŒ‡æ¨™
  const [redis, supabase, business] = await Promise.all([
    getRedisMetrics(),
    getSupabaseMetrics(),
    getBusinessMetrics()
  ])

  // 2. å„²å­˜åˆ°è³‡æ–™åº«ï¼ˆç”¨æ–¼æ­·å²è¿½è¹¤ï¼‰
  await supabase.from('daily_metrics').insert({
    date: new Date().toISOString().split('T')[0],
    redis_commands: redis.daily_commands,
    redis_usage_percentage: redis.usage_percentage,
    mau: supabase.estimated_mau,
    database_size_mb: supabase.database_size_mb,
    dau: business.dau,
    active_listings: business.active_listings,
    purchase_intents: business.purchase_intents_today,
    created_at: new Date()
  })

  // 3. æª¢æŸ¥ä¸¦ç™¼é€è­¦å ±
  await checkAndAlert()

  return NextResponse.json({
    success: true,
    metrics: { redis, supabase, business }
  })
}
```

#### æ¯å°æ™‚æª¢æŸ¥ä»»å‹™

```typescript
// src/app/api/cron/hourly-check/route.ts
export async function GET(request: NextRequest) {
  // é©—è­‰ Cron Secret
  const authHeader = request.headers.get('authorization')
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return new NextResponse('Unauthorized', { status: 401 })
  }

  // 1. æª¢æŸ¥ Redis é…é¡
  const redisMetrics = await getRedisMetrics()
  if (redisMetrics.status === 'critical') {
    await sendAlert({
      level: 'critical',
      service: 'Upstash Redis',
      metric: 'æ¯æ—¥å‘½ä»¤æ•¸',
      message: `âš ï¸ ç·Šæ€¥ï¼šRedis å‘½ä»¤æ•¸å·²è¶…æ¨™ï¼`,
      current_value: redisMetrics.daily_commands,
      threshold: redisMetrics.daily_limit,
      timestamp: new Date()
    })
  }

  // 2. æª¢æŸ¥ç•°å¸¸æµé‡
  const currentHourRequests = await redis.get<number>('requests:current_hour') || 0
  if (currentHourRequests > 10000) {
    await sendAlert({
      level: 'warning',
      service: 'æµé‡ç›£æ§',
      metric: 'æ¯å°æ™‚è«‹æ±‚æ•¸',
      message: `âš ï¸ ç•°å¸¸æµé‡ï¼šç•¶å‰å°æ™‚è«‹æ±‚æ•¸ç•°å¸¸é«˜ï¼å¯èƒ½é­å—æ”»æ“Šã€‚`,
      current_value: currentHourRequests,
      threshold: 10000,
      timestamp: new Date()
    })
  }

  return NextResponse.json({ success: true })
}
```

#### æ¸…ç†éæœŸè³‡æ–™

```typescript
// src/app/api/cron/cleanup-expired-listings/route.ts
export async function GET(request: NextRequest) {
  // é©—è­‰ Cron Secret
  const authHeader = request.headers.get('authorization')
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return new NextResponse('Unauthorized', { status: 401 })
  }

  // 1. åˆªé™¤ 30 å¤©æœªæ›´æ–°çš„å·²å”®å‡ºåˆŠç™»
  const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)

  const { count: deletedListings } = await supabase
    .from('listings')
    .delete()
    .eq('status', 'sold')
    .lt('updated_at', thirtyDaysAgo.toISOString())

  // 2. æ¸…ç† 90 å¤©æœªç™»å…¥çš„ç”¨æˆ¶ï¼ˆå¯é¸ï¼‰
  // const ninetyDaysAgo = new Date(Date.now() - 90 * 24 * 60 * 60 * 1000)
  // await supabase
  //   .from('users')
  //   .delete()
  //   .lt('last_login_at', ninetyDaysAgo.toISOString())

  return NextResponse.json({
    success: true,
    deleted_listings: deletedListings || 0
  })
}
```

### ç›£æ§å„€è¡¨æ¿è¨­è¨ˆ

#### ç°¡æ˜“å„€è¡¨æ¿ UI

```tsx
// src/app/admin/dashboard/page.tsx
'use client'

import { useEffect, useState } from 'react'

interface DashboardData {
  redis: RedisMetrics
  supabase: SupabaseMetrics
  business: BusinessMetrics
}

export default function AdminDashboard() {
  const [data, setData] = useState<DashboardData | null>(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    async function fetchMetrics() {
      const response = await fetch('/api/admin/metrics')
      const result = await response.json()
      setData(result)
      setLoading(false)
    }

    fetchMetrics()
    const interval = setInterval(fetchMetrics, 60000) // æ¯åˆ†é˜æ›´æ–°

    return () => clearInterval(interval)
  }, [])

  if (loading || !data) return <div>è¼‰å…¥ä¸­...</div>

  return (
    <div className="p-8 space-y-6">
      <h1 className="text-3xl font-bold">ç³»çµ±ç›£æ§å„€è¡¨æ¿</h1>

      {/* Redis ç›£æ§ */}
      <div className="bg-white rounded-lg shadow p-6">
        <h2 className="text-xl font-semibold mb-4">Upstash Redis</h2>
        <div className="space-y-2">
          <MetricBar
            label="æ¯æ—¥å‘½ä»¤æ•¸"
            current={data.redis.daily_commands}
            max={data.redis.daily_limit}
            status={data.redis.status}
          />
          <MetricBar
            label="è¨˜æ†¶é«”ä½¿ç”¨"
            current={data.redis.memory_used_mb}
            max={data.redis.memory_limit_mb}
            unit="MB"
            status="healthy"
          />
        </div>
      </div>

      {/* Supabase ç›£æ§ */}
      <div className="bg-white rounded-lg shadow p-6">
        <h2 className="text-xl font-semibold mb-4">Supabase</h2>
        <div className="space-y-2">
          <MetricBar
            label="MAU"
            current={data.supabase.estimated_mau}
            max={data.supabase.mau_limit}
            status={data.supabase.status}
          />
          <MetricBar
            label="è³‡æ–™åº«å¤§å°"
            current={data.supabase.database_size_mb}
            max={data.supabase.database_limit_mb}
            unit="MB"
            status={data.supabase.status}
          />
        </div>
      </div>

      {/* æ¥­å‹™æŒ‡æ¨™ */}
      <div className="bg-white rounded-lg shadow p-6">
        <h2 className="text-xl font-semibold mb-4">æ¥­å‹™æŒ‡æ¨™</h2>
        <div className="grid grid-cols-3 gap-4">
          <MetricCard label="DAU" value={data.business.dau} />
          <MetricCard label="MAU" value={data.business.mau} />
          <MetricCard label="æ´»èºåˆŠç™»" value={data.business.active_listings} />
          <MetricCard label="ä»Šæ—¥è³¼è²·æ„å‘" value={data.business.purchase_intents_today} />
          <MetricCard label="ä»Šæ—¥æˆäº¤" value={data.business.sold_listings_today} />
        </div>
      </div>
    </div>
  )
}

function MetricBar({ label, current, max, unit = '', status }: any) {
  const percentage = (current / max) * 100
  const color = status === 'critical' ? 'bg-red-500' : status === 'warning' ? 'bg-yellow-500' : 'bg-green-500'

  return (
    <div>
      <div className="flex justify-between mb-1">
        <span className="text-sm font-medium">{label}</span>
        <span className="text-sm text-gray-600">
          {current.toLocaleString()} / {max.toLocaleString()} {unit} ({percentage.toFixed(1)}%)
        </span>
      </div>
      <div className="w-full bg-gray-200 rounded-full h-2">
        <div className={`${color} h-2 rounded-full`} style={{ width: `${percentage}%` }}></div>
      </div>
    </div>
  )
}

function MetricCard({ label, value }: any) {
  return (
    <div className="bg-gray-50 rounded p-4">
      <div className="text-sm text-gray-600">{label}</div>
      <div className="text-2xl font-bold">{value.toLocaleString()}</div>
    </div>
  )
}
```

---

## å¯¦ä½œè·¯ç·šåœ–

### ğŸ“˜ ä½¿ç”¨æŒ‡å—ï¼šé¸æ“‡æ­£ç¢ºçš„å¯¦ä½œè·¯ç·š

æœ¬è·¯ç·šåœ–åŒ…å«å…©ç¨®æƒ…å¢ƒï¼Œè«‹æ ¹æ“šæ‚¨çš„å¯¦éš›ç‹€æ³é¸æ“‡ï¼š

#### æƒ…å¢ƒ Aï¼šå¾é›¶é–‹å§‹å»ºç«‹ç³»çµ±ï¼ˆæ¨è–¦å¤§å¤šæ•¸å°ˆæ¡ˆï¼‰

**é©ç”¨æƒ…æ³**ï¼š
- âœ… ç›®å‰æ²’æœ‰ä»»ä½•å¾Œç«¯ API
- âœ… æ²’æœ‰å®‰è£ Supabase/Redis
- âœ… äº¤æ˜“ç³»çµ±å°šæœªå¯¦ä½œ
- âœ… æƒ³è¦æŒ‰éƒ¨å°±ç­å»ºç«‹å®Œæ•´ç³»çµ±

**å¯¦ä½œé †åº**ï¼š
1. åŸºç¤æ¶æ§‹ï¼ˆè³‡æ–™åº«ã€Redisã€ç’°å¢ƒé…ç½®ï¼‰
2. Discord OAuth èªè­‰
3. æ ¸å¿ƒåŠŸèƒ½ï¼ˆåˆŠç™»ã€å¸‚å ´ã€æ„å‘ï¼‰
4. ä¸Šç·šè§€å¯Ÿ
5. å„ªåŒ–ï¼ˆBot Detectionï¼Œå¦‚æœéœ€è¦ï¼‰

**æ™‚ç¨‹**ï¼š12-17 é€±

**ğŸ‘‰ è«‹è·³åˆ°ï¼š[æƒ…å¢ƒ A å¯¦ä½œè·¯ç·šåœ–](#æƒ…å¢ƒ-aå¾é›¶é–‹å§‹å»ºç«‹ç³»çµ±)** â¬…ï¸ **å¤§å¤šæ•¸äººå¾é€™è£¡é–‹å§‹**

---

#### æƒ…å¢ƒ Bï¼šå„ªåŒ–ç¾æœ‰ç³»çµ±ï¼ˆå‡è¨­å·²ä¸Šç·šï¼‰

**é©ç”¨æƒ…æ³**ï¼š
- âœ… äº¤æ˜“ç³»çµ±å·²ä¸Šç·šé‹è¡Œ
- âœ… Redis å·²å®‰è£ä¸¦å•Ÿç”¨
- âŒ Redis è¶…æ¨™ï¼ˆ> 90% ä½¿ç”¨ç‡ï¼‰
- âŒ Bot æµé‡éé«˜ï¼ˆ> 60%ï¼‰
- âŒ å¯¦éš›é‡åˆ°é™æµå•é¡Œ

**å¯¦ä½œé †åº**ï¼š
1. ç·Šæ€¥ä¿®å¾©ï¼ˆBot Detection éšæ®µ 1ï¼‰
2. ç©©å®šåŸºç¤ï¼ˆBot Detection éšæ®µ 2ï¼‰
3. å®Œæ•´é˜²è­·ï¼ˆBot Detection éšæ®µ 3+4ï¼‰
4. åŠŸèƒ½å¢å¼·ï¼ˆWebhookã€ä¿¡è­½ç³»çµ±ï¼‰

**æ™‚ç¨‹**ï¼š9-17 é€±

**ğŸ‘‰ è«‹è·³åˆ°ï¼š[æƒ…å¢ƒ B å¯¦ä½œè·¯ç·šåœ–](#æƒ…å¢ƒ-bå„ªåŒ–ç¾æœ‰ç³»çµ±å·²ä¸Šç·š)** â¬…ï¸ åƒ…é©ç”¨æ–¼å·²ä¸Šç·šçš„ç³»çµ±

---

#### ğŸ¤” å¦‚ä½•åˆ¤æ–·æˆ‘æ‡‰è©²é¸å“ªå€‹ï¼Ÿ

**å¿«é€Ÿæª¢æŸ¥æ¸…å–®**ï¼š

| æª¢æŸ¥é …ç›® | æ˜¯ | å¦ |
|---------|----|----|
| `src/app/api/` ç›®éŒ„ä¸‹æœ‰ API routes | â¬œ | â¬œ |
| package.json æœ‰ `@supabase/supabase-js` | â¬œ | â¬œ |
| package.json æœ‰ `@upstash/redis` | â¬œ | â¬œ |
| Vercel Dashboard é¡¯ç¤º Redis ä½¿ç”¨ç‡ > 90% | â¬œ | â¬œ |
| å¯¦éš›é‡åˆ° Redis è¶…æ¨™é™æµå•é¡Œ | â¬œ | â¬œ |

**çµæœåˆ¤æ–·**ï¼š
- **5 å€‹ã€Œå¦ã€** â†’ æƒ…å¢ƒ Aï¼ˆå¾é›¶é–‹å§‹ï¼‰ğŸ‘ˆ **æ‚¨åœ¨é€™è£¡ï¼**
- **5 å€‹ã€Œæ˜¯ã€** â†’ æƒ…å¢ƒ Bï¼ˆå„ªåŒ–ç¾æœ‰ï¼‰
- **æ··åˆæƒ…æ³** â†’ å„ªå…ˆé¸æ“‡æƒ…å¢ƒ A

---

## æƒ…å¢ƒ Aï¼šå¾é›¶é–‹å§‹å»ºç«‹ç³»çµ±

> **ç›®æ¨™å—çœ¾**ï¼šå°šæœªå¯¦ä½œä»»ä½•äº¤æ˜“ç³»çµ±åŠŸèƒ½çš„å°ˆæ¡ˆ
>
> **æ ¸å¿ƒç†å¿µ**ï¼šæŒ‰éƒ¨å°±ç­å»ºç«‹ç©©å›ºåŸºç¤ï¼Œé¿å…éæ—©å„ªåŒ–

### ç¸½è¦½ (æƒ…å¢ƒ A)

| éšæ®µ | æ™‚ç¨‹ | æ ¸å¿ƒä»»å‹™ | ç‹€æ…‹ |
|------|------|---------|------|
| **éšæ®µ 0** | ç¬¬ 1-4 é€± | åŸºç¤æ¶æ§‹ï¼ˆSupabase + Redis + ç’°å¢ƒï¼‰ | ğŸ”´ å¿…è¦ |
| **éšæ®µ 1** | ç¬¬ 5-8 é€± | Discord OAuth èªè­‰ç³»çµ± | ğŸ”´ å¿…è¦ |
| **éšæ®µ 2** | ç¬¬ 9-12 é€± | æ ¸å¿ƒåŠŸèƒ½ï¼ˆåˆŠç™»ã€å¸‚å ´ã€æ„å‘ï¼‰ | ğŸ”´ å¿…è¦ |
| **éšæ®µ 3** | ç¬¬ 13-14 é€± | ä¸Šç·šè§€å¯Ÿèˆ‡ç›£æ§ | ğŸŸ¢ é‡è¦ |
| **éšæ®µ 4** | ç¬¬ 15-17 é€± | Webhook & ä¿¡è­½ç³»çµ± | ğŸŸ¡ å¢å¼· |
| **éšæ®µ 5** | ç¬¬ 18+ é€± | Bot Detectionï¼ˆæŒ‰éœ€å¯¦ä½œï¼‰| âšª å¯é¸ |

**æ™‚ç¨‹æ‘˜è¦**ï¼š
- **MVPï¼ˆæœ€å°å¯è¡Œç‰ˆæœ¬ï¼‰**ï¼š12 é€±ï¼ˆéšæ®µ 0+1+2ï¼Œæ ¸å¿ƒåŠŸèƒ½å®Œæ•´ï¼‰
- **ç”Ÿç”¢å°±ç·’ç‰ˆæœ¬**ï¼š14 é€±ï¼ˆéšæ®µ 0+1+2+3ï¼Œå«ç›£æ§ï¼‰
- **å®Œæ•´åŠŸèƒ½ç‰ˆæœ¬**ï¼š17 é€±ï¼ˆæ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ + Webhookï¼‰

---

### éšæ®µ 0ï¼šåŸºç¤æ¶æ§‹ï¼ˆç¬¬ 1-4 é€±ï¼‰

**ç›®æ¨™**ï¼šå»ºç«‹å°ˆæ¡ˆçš„æŠ€è¡“åŸºç¤ï¼Œå®‰è£å¿…è¦æœå‹™

**å„ªå…ˆç´š**ï¼šğŸ”´ **å¿…è¦**

#### ä»»å‹™æ¸…å–®

> **ğŸ“ æ³¨æ„**ï¼šè©³ç´°çš„ã€Œæƒ…å¢ƒ Aã€å¯¦ä½œå…§å®¹è¦åŠƒä¸­ã€‚ä»¥ä¸‹æä¾›ç°¡è¦æŒ‡å¼•ï¼Œå®Œæ•´æ–‡ä»¶å°‡åŒ…å«ï¼š
> - Supabase å°ˆæ¡ˆè¨­å®šèˆ‡è³‡æ–™åº« Schema
> - Discord OAuth 2.0 å®Œæ•´å¯¦ä½œæ­¥é©Ÿ
> - æ ¸å¿ƒ API é–‹ç™¼ï¼ˆåˆŠç™»ã€å¸‚å ´ã€æ„å‘ï¼‰
> - ä¸Šç·šè§€å¯Ÿèˆ‡ç›£æ§è¨­å®š
>
> ç›®å‰æ‚¨å¯ä»¥åƒè€ƒï¼š
> - [Discord OAuth 2.0 èªè­‰](#discord-oauth-20-èªè­‰) ç« ç¯€ï¼ˆå®Œæ•´è¨­è¨ˆï¼‰
> - [è³‡æ–™åº«è¨­è¨ˆ](#è³‡æ–™åº«è¨­è¨ˆ) ç« ç¯€ï¼ˆSchema å®šç¾©ï¼‰
> - [API è¨­è¨ˆ](#api-è¨­è¨ˆ) ç« ç¯€ï¼ˆç«¯é»è¦æ ¼ï¼‰

**Week 1-2ï¼šSupabase ç’°å¢ƒè¨­å®š**
- [ ] å»ºç«‹ Supabase å°ˆæ¡ˆï¼ˆFree tierï¼‰
- [ ] å®‰è£ä¾è³´ï¼š`npm install @supabase/supabase-js`
- [ ] å»ºç«‹è³‡æ–™åº«è¡¨ï¼š`users`, `sessions`, `listings`, `interests`
- [ ] è¨­å®š RLS ç­–ç•¥

**Week 3-4ï¼šç’°å¢ƒé…ç½®èˆ‡åŸºç¤å·¥å…·**
- [ ] å®‰è£ Redisï¼š`npm install @upstash/redis`
- [ ] å»ºç«‹ Supabase å®¢æˆ¶ç«¯å·¥å…·
- [ ] è¨­å®šç’°å¢ƒè®Šæ•¸ï¼ˆ`.env.local`ï¼‰
- [ ] å»ºç«‹åŸºæœ¬çš„ API route æ¸¬è©¦é€£ç·š

---

### éšæ®µ 1ï¼šDiscord OAuth èªè­‰ï¼ˆç¬¬ 5-8 é€±ï¼‰

**ç›®æ¨™**ï¼šå¯¦ä½œå®Œæ•´çš„ Discord OAuth 2.0 èªè­‰æµç¨‹

**å„ªå…ˆç´š**ï¼šğŸ”´ **å¿…è¦**

#### ä»»å‹™æ¸…å–®

**Week 5-6ï¼šOAuth æ ¸å¿ƒæµç¨‹**
- [ ] å»ºç«‹ Discord Applicationï¼ˆDeveloper Portalï¼‰
- [ ] å¯¦ä½œ OAuth å•Ÿå‹•ï¼š`GET /api/auth/discord`
- [ ] å¯¦ä½œ OAuth å›èª¿ï¼š`GET /api/auth/discord/callback`
- [ ] State token CSRF é˜²è­·

**Week 7-8ï¼šSession ç®¡ç†**
- [ ] JWT Token ç”Ÿæˆèˆ‡é©—è­‰
- [ ] Cookie å®‰å…¨é…ç½®ï¼ˆHttpOnly, Secure, SameSiteï¼‰
- [ ] Session åˆ·æ–°æ©Ÿåˆ¶
- [ ] ç™»å…¥/ç™»å‡ºåŠŸèƒ½

---

### éšæ®µ 2ï¼šæ ¸å¿ƒåŠŸèƒ½ï¼ˆç¬¬ 9-12 é€±ï¼‰

**ç›®æ¨™**ï¼šå¯¦ä½œäº¤æ˜“ç³»çµ±æ ¸å¿ƒæ¥­å‹™åŠŸèƒ½

**å„ªå…ˆç´š**ï¼šğŸ”´ **å¿…è¦**

#### ä»»å‹™æ¸…å–®

**Week 9-10ï¼šåˆŠç™»ç³»çµ±**
- [ ] å¯¦ä½œåˆŠç™» CRUD API
- [ ] å¯¦ä½œèªè­‰ä¸­é–“ä»¶ï¼ˆ`withAuthAndError`ï¼‰
- [ ] å»ºç«‹åˆŠç™» Modal å…ƒä»¶ï¼ˆ`CreateListingModal`ï¼‰
  - é‡ç”¨ `BaseModal` åŸºç¤å…ƒä»¶
  - è¡¨å–®é©—è­‰èˆ‡éŒ¯èª¤è™•ç†
  - æ•´åˆ API å‘¼å«ï¼ˆPOST `/api/listings`ï¼‰

**Week 11-12ï¼šå¸‚å ´èˆ‡æ„å‘**
- [ ] å¯¦ä½œå¸‚å ´åˆ—è¡¨ API
- [ ] å¯¦ä½œè³¼è²·æ„å‘ API
- [ ] å»ºç«‹å¸‚å ´ç€è¦½ Modalï¼ˆ`MarketBrowserModal`ï¼‰
  - å•†å“åˆ—è¡¨å±•ç¤ºï¼ˆå«åˆ†é /ç¯©é¸ï¼‰
  - åˆŠç™»è©³æƒ…å­ Modalï¼ˆåµŒå¥—é¡¯ç¤ºï¼‰
  - è³¼è²·æ„å‘ç™»è¨˜åŠŸèƒ½

---

### éšæ®µ 3ï¼šä¸Šç·šè§€å¯Ÿï¼ˆç¬¬ 13-14 é€±ï¼‰

**ç›®æ¨™**ï¼šä¸Šç·šåˆ°ç”Ÿç”¢ç’°å¢ƒï¼Œç›£æ§å¯¦éš›æµé‡

**å„ªå…ˆç´š**ï¼šğŸŸ¢ **é‡è¦**

#### ä»»å‹™æ¸…å–®

**Week 13ï¼šä¸Šç·šæº–å‚™**
- [ ] Production ç’°å¢ƒè®Šæ•¸è¨­å®š
- [ ] æ•ˆèƒ½æ¸¬è©¦ï¼ˆAPI å›æ‡‰æ™‚é–“ < 200msï¼‰
- [ ] å®‰å…¨æª¢æŸ¥ï¼ˆRLS, XSS, CSRFï¼‰

**Week 14ï¼šç›£æ§èˆ‡è§€å¯Ÿ**
- [ ] è¨­å®š Vercel Analytics
- [ ] ç›£æ§ Redis ä½¿ç”¨ç‡
- [ ] æ”¶é›†ç”¨æˆ¶åé¥‹

**ğŸ¯ é—œéµæ±ºç­–é»**ï¼š

```
è§€å¯Ÿ 2 é€±å¾Œçš„ Redis ä½¿ç”¨ç‡ï¼š

â”œâ”€ < 70% ä½¿ç”¨ç‡ï¼ˆæ­£å¸¸ï¼‰
â”‚  â””â”€ ç¹¼çºŒéšæ®µ 4ï¼šå¯¦ä½œ Webhook & ä¿¡è­½ç³»çµ±
â”‚
â”œâ”€ 70-80% ä½¿ç”¨ç‡ï¼ˆæ¥è¿‘ä¸Šé™ï¼‰
â”‚  â””â”€ ç¹¼çºŒè§€å¯Ÿ 1 é€±ï¼Œè€ƒæ…®ç°¡å–®çš„ Rate Limiting
â”‚
â””â”€ > 80% ä½¿ç”¨ç‡ï¼ˆè­¦å‘Šï¼‰
   â””â”€ è·³åˆ°æƒ…å¢ƒ Bï¼šå¯¦ä½œ Bot Detection
```

---

### éšæ®µ 4-5ï¼šå¢å¼·åŠŸèƒ½ï¼ˆç¬¬ 15+ é€±ï¼‰

**ç›®æ¨™**ï¼šWebhook é€šçŸ¥ã€ä¿¡è­½ç³»çµ±ç­‰å¢å¼·åŠŸèƒ½

**å„ªå…ˆç´š**ï¼šğŸŸ¡ **å¢å¼·**ï¼ˆå¯é¸ï¼‰

è©³ç´°å…§å®¹è«‹åƒè€ƒåŸã€Œéšæ®µ 4-5ã€ç« ç¯€ã€‚

---

## æƒ…å¢ƒ Bï¼šå„ªåŒ–ç¾æœ‰ç³»çµ±ï¼ˆå·²ä¸Šç·šï¼‰

> **âš ï¸ å‰ææ¢ä»¶**ï¼šæ­¤è·¯ç·šåœ–å‡è¨­æ‚¨çš„äº¤æ˜“ç³»çµ±å·²ç¶“ä¸Šç·šï¼Œä¸”é‡åˆ°ä»¥ä¸‹å•é¡Œï¼š
> - âœ… äº¤æ˜“ç³»çµ±å·²å¯¦ä½œä¸¦ä¸Šç·šé‹è¡Œ
> - âœ… Redis å·²å®‰è£ä¸¦å•Ÿç”¨ Rate Limiting
> - âŒ Redis ä½¿ç”¨ç‡ > 90%ï¼ˆå¯¦éš›è¶…æ¨™ï¼‰
> - âŒ Bot æµé‡æ¯”ä¾‹ > 60%ï¼ˆå¯¦éš›è§€å¯Ÿåˆ°ï¼‰
> - âŒ å¯¦éš›é‡åˆ°é™æµå•é¡Œ
>
> **å¦‚æœæ‚¨çš„ç³»çµ±å°šæœªä¸Šç·š**ï¼Œè«‹å›åˆ° [æƒ…å¢ƒ A](#æƒ…å¢ƒ-aå¾é›¶é–‹å§‹å»ºç«‹ç³»çµ±)

### ç¸½è¦½ (æƒ…å¢ƒ B)

> **åŸºæ–¼å¯¦éš›æµé‡åˆ†æ**ï¼š7,794 è¨ªå®¢/5å¤©ï¼Œ60-80% Bot æµé‡ï¼ŒRedis å·²è¶…æ¨™ 107%

| éšæ®µ | æ™‚ç¨‹ | æ ¸å¿ƒä»»å‹™ | Redis ä½¿ç”¨ç‡ | ç‹€æ…‹ |
|------|------|---------|-------------|------|
| **éšæ®µ 0** | ç¬¬ 1 é€± | Bot Detection éšæ®µ 1ï¼ˆç·Šæ€¥ä¿®å¾©ï¼‰ | 70-80% | ğŸ”´ Critical |
| **éšæ®µ 1** | ç¬¬ 2-5 é€± | Bot Detection éšæ®µ 2ï¼ˆç©©å®šåŸºç¤ï¼‰ | 50-60% | ğŸ”´ Critical |
| **éšæ®µ 2** | ç¬¬ 6-9 é€± | Bot Detection éšæ®µ 3+4ï¼ˆå®Œæ•´é˜²è­·ï¼‰ | 20-30% | ğŸŸ¢ Recommended |
| **éšæ®µ 3** | ç¬¬ 10-13 é€± | Discord OAuth å¼·åŒ– | - | ğŸŸ¢ High Priority |
| **éšæ®µ 4** | ç¬¬ 14-17 é€± | Webhook & ä¿¡è­½ç³»çµ± | - | ğŸŸ¡ Medium |

---

### éšæ®µ 0ï¼ˆæƒ…å¢ƒ Bï¼‰ï¼šç·Šæ€¥ä¿®å¾© - Bot Detection éšæ®µ 1ï¼ˆç¬¬ 1 é€±ï¼‰

**ç›®æ¨™**ï¼šè‡¨æ™‚ç·©è§£ Redis è¶…æ¨™å•é¡Œï¼Œé™è‡³ 70-80% ä½¿ç”¨ç‡

**å„ªå…ˆç´š**ï¼šğŸ”´ **Critical**ï¼ˆåƒ…é©ç”¨æ–¼ Redis ç•¶å‰å·²è¶…æ¨™çš„æƒ…æ³ï¼‰

#### ä»»å‹™æ¸…å–®

**Week 2ï¼šé«˜é »è¨ªå•æª¢æ¸¬**
- [ ] å¯¦ä½œ Rate Limiter æœå‹™
  - æª”æ¡ˆï¼š`src/lib/services/rate-limiter.ts`
  - åŠŸèƒ½ï¼šå›ºå®šçª—å£ç®—æ³•ï¼ˆINCR + EXPIREï¼‰
- [ ] è¨­å®šç«¯é»ç´šåˆ¥é™æµ
  - trendingï¼š10 æ¬¡/åˆ†é˜
  - å¸‚å ´åˆ—è¡¨ï¼š30 æ¬¡/åˆ†é˜
  - å…¶ä»– APIï¼š50 æ¬¡/å°æ™‚
- [ ] æ•´åˆåˆ° Middleware
  - æª¢æ¸¬ä¸¦é˜»æ“‹é«˜é »è«‹æ±‚
  - è¿”å› 429 Too Many Requests

**Week 3ï¼šæƒæè¡Œç‚ºæª¢æ¸¬**
- [ ] å¯¦ä½œè·¯å¾‘å¤šæ¨£æ€§æª¢æ¸¬
  - æª”æ¡ˆï¼š`src/lib/services/scan-detector.ts`
  - åŠŸèƒ½ï¼šè¿½è¹¤ IP è¨ªå•çš„ç«¯é»æ•¸é‡
- [ ] è¨­å®šæƒæé–¾å€¼
  - 1 åˆ†é˜å…§è¨ªå• > 20 å€‹ä¸åŒç«¯é» â†’ æ¨™è¨˜ç‚ºæƒæ
- [ ] Redis Set è³‡æ–™çµæ§‹å„ªåŒ–
  - ä½¿ç”¨ SADD + EXPIRE å„²å­˜è¨ªå•è¨˜éŒ„
  - è‡ªå‹•éæœŸæ©Ÿåˆ¶ï¼ˆ60 ç§’ï¼‰

**Week 4ï¼šæ•´åˆèˆ‡æ¸¬è©¦**
- [ ] ç¶œåˆ Bot æª¢æ¸¬é‚è¼¯
  - User-Agent éæ¿¾ + é«˜é »æª¢æ¸¬ + æƒææª¢æ¸¬
  - å¤šé‡æ¢ä»¶åˆ¤æ–·ï¼ˆä»»ä¸€æ¢ä»¶è§¸ç™¼å³é˜»æ“‹ï¼‰
- [ ] æ’°å¯«æ•´åˆæ¸¬è©¦
  - æ¨¡æ“¬æ­£å¸¸ç”¨æˆ¶è¡Œç‚ºï¼ˆé€šéï¼‰
  - æ¨¡æ“¬ Bot è¡Œç‚ºï¼ˆé˜»æ“‹ï¼‰
- [ ] å£“åŠ›æ¸¬è©¦
  - 1000 ä½µç™¼è«‹æ±‚
  - ç¢ºèª Redis ä½¿ç”¨é‡åœ¨é æœŸç¯„åœ

**Week 5ï¼šä¸Šç·šèˆ‡ç›£æ§**
- [ ] Staging ç’°å¢ƒé©—è­‰
  - 7 å¤©æ¸¬è©¦æœŸ
  - ç›£æ§èª¤åˆ¤ç‡ï¼ˆ< 1%ï¼‰
- [ ] Production éƒ¨ç½²
  - ç°åº¦ç™¼å¸ƒï¼ˆ10% â†’ 50% â†’ 100%ï¼‰
  - å³æ™‚ç›£æ§ Redis ä½¿ç”¨ç‡
- [ ] å»ºç«‹å‘Šè­¦æ©Ÿåˆ¶
  - Redis ä½¿ç”¨ç‡ > 70% ç™¼é€è­¦å ±
  - èª¤åˆ¤æ¡ˆä¾‹è‡ªå‹•è¨˜éŒ„

#### é©—æ”¶æ¨™æº–

âœ… **åŠŸèƒ½é©—æ”¶**ï¼š
- é«˜é »è¨ªå•æ­£ç¢ºæª¢æ¸¬ä¸¦é˜»æ“‹ï¼ˆ> 50 æ¬¡/å°æ™‚ï¼‰
- æƒæè¡Œç‚ºæ­£ç¢ºè­˜åˆ¥ï¼ˆ1 åˆ†é˜ > 20 ç«¯é»ï¼‰
- èª¤åˆ¤ç‡ < 1%ï¼ˆçœŸå¯¦ç”¨æˆ¶ä¸å—å½±éŸ¿ï¼‰

âœ… **æ•ˆèƒ½é©—æ”¶**ï¼š
- Redis å‘½ä»¤æ•¸é™è‡³ 5,000-6,000/å¤©ï¼ˆ50-60% ä½¿ç”¨ç‡ï¼‰
- Middleware è™•ç†æ™‚é–“ < 10ms
- ç³»çµ±å›æ‡‰æ™‚é–“ç„¡æ˜é¡¯å¢åŠ 

âš ï¸ **é¢¨éšªæç¤º**ï¼š
- è¤‡é›œé‚è¼¯å¯èƒ½å¢åŠ  Middleware å»¶é²ï¼ˆéœ€å„ªåŒ–ï¼‰
- Redis å‘½ä»¤æ•¸æœ¬èº«æœƒå¢åŠ ï¼ˆéœ€å¹³è¡¡éæ¿¾æ•ˆç›Š vs æª¢æ¸¬æˆæœ¬ï¼‰

---

### éšæ®µ 2ï¼šå®Œæ•´é˜²è­· - Bot Detection éšæ®µ 3+4ï¼ˆç¬¬ 6-9 é€±ï¼‰

**ç›®æ¨™**ï¼šå¯¦ä½œ IP ä¿¡è­½ç³»çµ± + Cloudflare æ•´åˆï¼Œé™è‡³ 20-30% Redis ä½¿ç”¨ç‡

**å„ªå…ˆç´š**ï¼šğŸŸ¢ **Recommended**ï¼ˆéç·Šæ€¥ï¼Œä½†å¯é¡¯è‘—æå‡ç³»çµ±ç©©å®šæ€§ï¼‰

#### ä»»å‹™æ¸…å–®

**Week 6-7ï¼šIP ä¿¡è­½ç³»çµ±ï¼ˆéšæ®µ 3ï¼‰**
- [ ] è¨­è¨ˆ IP ä¿¡è­½è³‡æ–™åº«
  - è¡¨ï¼š`ip_reputation`
  - æ¬„ä½ï¼šip_address, reputation_score, total_requests, bot_requests ç­‰
- [ ] å¯¦ä½œä¿¡è­½è¨ˆç®—é‚è¼¯
  - Bot æ¯”ä¾‹ï¼š> 80% â†’ æ‰£ 30 åˆ†
  - é˜»æ“‹æ¬¡æ•¸ï¼šæ¯æ¬¡ â†’ æ‰£ 2 åˆ†
  - æ´»èºæ™‚é–“ï¼š> 90 å¤© â†’ åŠ  10 åˆ†
- [ ] æ•´åˆåˆ° Bot Detection
  - ä¿¡è­½ < 30 åˆ† â†’ è‡ªå‹•é˜»æ“‹
  - ä¿¡è­½ 30-50 åˆ† â†’ åŠ å¼·ç›£æ§
- [ ] å¯¦ä½œè‡ªå‹•å­¸ç¿’
  - æ ¹æ“šå¯¦éš› Bot è¡Œç‚ºå‹•æ…‹èª¿æ•´è©•åˆ†
  - æ¯æ—¥æ‰¹æ¬¡æ›´æ–°ä¿¡è­½åˆ†æ•¸

**Week 8ï¼šCloudflare Bot Protectionï¼ˆéšæ®µ 4ï¼Œå¯é¸ï¼‰**
- [ ] è©•ä¼° Cloudflare å…è²»ç‰ˆåŠŸèƒ½
  - Bot Fight Modeï¼ˆå…è²»ï¼‰
  - Super Bot Fight Modeï¼ˆProï¼Œ$20/æœˆï¼‰
- [ ] æ•´åˆ Cloudflare Worker
  - å‰ç½®éæ¿¾ï¼ˆåœ¨åˆ°é” Vercel å‰é˜»æ“‹ï¼‰
  - é™ä½ Vercel æµé‡æ¶ˆè€—
- [ ] é…ç½® Challenge è¦å‰‡
  - å¯ç–‘è«‹æ±‚é¡¯ç¤º CAPTCHA
  - å·²çŸ¥ Bot IP ç›´æ¥é˜»æ“‹

**Week 9ï¼šç›£æ§å„€è¡¨æ¿é–‹ç™¼**
- [ ] å»ºç«‹ Admin Dashboard é é¢
  - è·¯å¾‘ï¼š`/admin/dashboard`ï¼ˆæª”æ¡ˆï¼š`src/app/admin/dashboard/page.tsx`ï¼‰
  - åŠŸèƒ½ï¼šå³æ™‚ç›£æ§ Bot æµé‡ã€é˜»æ“‹çµ±è¨ˆã€ç³»çµ±æŒ‡æ¨™
- [ ] å¯¦ä½œåœ–è¡¨è¦–è¦ºåŒ–
  - Redis ä½¿ç”¨ç‡è¶¨å‹¢åœ–
  - Bot é¡å‹åˆ†å¸ƒåœ“é¤…åœ–
  - æ¯å°æ™‚è«‹æ±‚é‡æŠ˜ç·šåœ–
- [ ] å¯¦ä½œæ‰‹å‹•æ§åˆ¶
  - IP ç™½åå–®/é»‘åå–®ç®¡ç†
  - Bot Detection è¦å‰‡é–‹é—œ

#### é©—æ”¶æ¨™æº–

âœ… **åŠŸèƒ½é©—æ”¶**ï¼š
- IP ä¿¡è­½ç³»çµ±æ­£ç¢ºè©•åˆ†ï¼ˆæº–ç¢ºç‡ > 90%ï¼‰
- Cloudflare æ•´åˆæ­£å¸¸å·¥ä½œï¼ˆå¯é¸ï¼‰
- ç›£æ§å„€è¡¨æ¿æ•¸æ“šæº–ç¢º

âœ… **æ•ˆèƒ½é©—æ”¶**ï¼š
- Redis å‘½ä»¤æ•¸é™è‡³ 2,000-3,000/å¤©ï¼ˆ20-30% ä½¿ç”¨ç‡ï¼‰
- ç³»çµ±ç©©å®šæ€§ > 99.9%
- Bot éæ¿¾ç‡ 85-95%

âš ï¸ **é¢¨éšªæç¤º**ï¼š
- IP ä¿¡è­½è³‡æ–™åº«æœƒå¢åŠ  Supabase å„²å­˜ä½¿ç”¨
- Cloudflare å¯èƒ½éœ€è¦é¡å¤–è²»ç”¨ï¼ˆPro æ–¹æ¡ˆ $20/æœˆï¼‰

---

### éšæ®µ 3ï¼šDiscord OAuth å¯¦ä½œï¼ˆç¬¬ 10-13 é€±ï¼‰

**ç›®æ¨™**ï¼šå¯¦ä½œ Discord OAuth 2.0 èªè­‰ï¼Œæä¾›çœŸå¯¦èº«ä»½é©—è­‰

**å„ªå…ˆç´š**ï¼šğŸŸ¢ **High Priority**ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼Œä½†éç·Šæ€¥ï¼‰

#### ä»»å‹™æ¸…å–®

**Week 10ï¼šDiscord Application è¨­ç½®**
- [ ] å»ºç«‹ Discord Application
  - å‰å¾€ [Discord Developer Portal](https://discord.com/developers/applications)
  - è¨­å®š OAuth2 Redirect URIs
- [ ] é…ç½®ç’°å¢ƒè®Šæ•¸
  - `DISCORD_CLIENT_ID`
  - `DISCORD_CLIENT_SECRET`
  - `DISCORD_REDIRECT_URI`
- [ ] è¨­å®š OAuth2 Scopes
  - åƒ…ä½¿ç”¨ `identify`ï¼ˆæœ€å°åŒ–æ¬Šé™ï¼‰

**Week 11-12ï¼šOAuth æµç¨‹å¯¦ä½œ**
- [ ] å¯¦ä½œ OAuth å•Ÿå‹•ç«¯é»
  - è·¯å¾‘ï¼š`/api/auth/discord`
  - åŠŸèƒ½ï¼šç”Ÿæˆ state tokenï¼Œé‡å°å‘è‡³ Discord
- [ ] å¯¦ä½œ OAuth å›èª¿ç«¯é»
  - è·¯å¾‘ï¼š`/api/auth/discord/callback`
  - åŠŸèƒ½ï¼šé©—è­‰ stateï¼Œäº¤æ› access_token
- [ ] å¯¦ä½œ Session ç®¡ç†
  - JWT token ç”Ÿæˆèˆ‡é©—è­‰
  - Cookie å®‰å…¨é…ç½®ï¼ˆHttpOnly, Secure, SameSiteï¼‰
- [ ] å¯¦ä½œ Token åˆ·æ–°æ©Ÿåˆ¶
  - å‰©é¤˜æ™‚é–“ < 25% è‡ªå‹•åˆ·æ–°
  - å®¢æˆ¶ç«¯æ¯ 5 åˆ†é˜æª¢æŸ¥

**Week 13ï¼šè³‡æ–™åº«èˆ‡å‰ç«¯æ•´åˆ**
- [ ] å»ºç«‹è³‡æ–™åº« Schema
  - è¡¨ï¼š`users`, `sessions`, `user_sessions`
  - RLS ç­–ç•¥é…ç½®
- [ ] é–‹ç™¼ç™»å…¥ Modalï¼ˆè¦‹ DDR-003ï¼‰
  - å…ƒä»¶ä½ç½®ï¼š`src/components/auth/LoginModal.tsx`
  - é‡ç”¨ BaseModal åŸºç¤å…ƒä»¶
  - å¯¦ä½œè§¸ç™¼æ©Ÿåˆ¶ï¼šCustomEvent `show-login-modal`
  - ã€Œä½¿ç”¨ Discord ç™»å…¥ã€æŒ‰éˆ•ï¼ˆDiscord å“ç‰Œè‰² #5865F2ï¼‰
  - è¼‰å…¥ç‹€æ…‹è™•ç†ï¼ˆspinner + ã€Œè·³è½‰ä¸­...ã€ï¼‰
  - éŒ¯èª¤è¨Šæ¯é¡¯ç¤ºï¼ˆåœ¨ Modal å…§é¡¯ç¤ºï¼‰
- [ ] æ•´åˆåˆ°ç¾æœ‰åŠŸèƒ½
  - API 401 éŒ¯èª¤è‡ªå‹•è§¸ç™¼ LoginModal
  - Session éæœŸè‡ªå‹•é¡¯ç¤º LoginModal
  - åˆŠç™»åŠŸèƒ½éœ€è¦ç™»å…¥
  - è³¼è²·æ„å‘éœ€è¦ç™»å…¥
  - å€‹äººä¸­å¿ƒé¡¯ç¤º Discord è³‡è¨Š

#### é©—æ”¶æ¨™æº–

âœ… **åŠŸèƒ½é©—æ”¶**ï¼š
- OAuth æµç¨‹å®Œæ•´é‹ä½œï¼ˆå•Ÿå‹• â†’ æˆæ¬Š â†’ å›èª¿ â†’ Sessionï¼‰
- State token CSRF é˜²è­·æ­£ç¢º
- Session è‡ªå‹•åˆ·æ–°æ­£å¸¸
- å¤šè£ç½®ç™»å…¥æ”¯æ´

âœ… **å®‰å…¨é©—æ”¶**ï¼š
- Token åŠ å¯†å­˜å„²ï¼ˆAES-256-GCMï¼‰
- Cookie å®‰å…¨ flags æ­£ç¢ºï¼ˆHttpOnly, Secure, SameSiteï¼‰
- CSRF æ”»æ“Šé˜²è­·æœ‰æ•ˆ

---

### éšæ®µ 4ï¼šWebhook & ä¿¡è­½ç³»çµ±ï¼ˆç¬¬ 14-17 é€±ï¼‰

**ç›®æ¨™**ï¼šå¯¦ä½œ Discord Webhook é€šçŸ¥èˆ‡ç°¡åŒ–ç‰ˆä¿¡è­½ç³»çµ±

**å„ªå…ˆç´š**ï¼šğŸŸ¡ **Medium**ï¼ˆå¢å¼·åŠŸèƒ½ï¼Œéæ ¸å¿ƒï¼‰

#### ä»»å‹™æ¸…å–®

**Week 14-15ï¼šDiscord Webhook é€šçŸ¥**
- [ ] å¯¦ä½œ Webhook é…ç½® API
  - POST `/api/webhooks`ï¼šå»ºç«‹ Webhook
  - GET `/api/webhooks`ï¼šæŸ¥è©¢ç”¨æˆ¶ Webhook
  - DELETE `/api/webhooks/[id]`ï¼šåˆªé™¤ Webhook
- [ ] å¯¦ä½œ Webhook å®‰å…¨æ©Ÿåˆ¶
  - URL é©—è­‰ï¼ˆåƒ…å…è¨± Discord å®˜æ–¹æ ¼å¼ï¼‰
  - æ¸¬è©¦ç™¼é€ï¼ˆå„²å­˜å‰é©—è­‰ï¼‰
  - é€Ÿç‡é™åˆ¶ï¼ˆ30 æ¢/å°æ™‚/Webhookï¼‰
- [ ] å¯¦ä½œè³¼è²·æ„å‘é€šçŸ¥
  - è‡ªå‹•ç™¼é€åˆ°è³£å®¶ Webhook
  - åŒ…å«è²·å®¶è³‡è¨Šã€ç‰©å“ã€åƒ¹æ ¼ã€å‚™è¨»
- [ ] å¯¦ä½œå¤±æ•—è™•ç†
  - é€£çºŒ 5 æ¬¡å¤±æ•—è‡ªå‹•åœç”¨
  - é€šçŸ¥ç”¨æˆ¶ Webhook å¤±æ•ˆ

**Week 16ï¼šç°¡åŒ–ç‰ˆä¿¡è­½ç³»çµ±**
- [ ] å¯¦ä½œä¿¡è­½è¨ˆç®—é‚è¼¯ï¼ˆv1.0 ç°¡åŒ–ç‰ˆï¼‰
  - åƒ…ä½¿ç”¨ Discord å¸³è™Ÿå¹´é½¡
  - å…¬å¼ï¼š3 å¹´+ â†’ 70 åˆ†ï¼Œå®˜æ–¹é©—è­‰ +30 åˆ†
- [ ] å»ºç«‹ä¿¡è­½è³‡æ–™è¡¨
  - è¡¨ï¼š`user_reputation`
  - æ¯æ—¥æ‰¹æ¬¡æ›´æ–°ï¼ˆCron Jobï¼‰
- [ ] é¡¯ç¤ºä¿¡è­½å¾½ç« 
  - åˆŠç™»åˆ—è¡¨é¡¯ç¤ºè³£å®¶ä¿¡è­½
  - è³¼è²·æ„å‘é¡¯ç¤ºè²·å®¶ä¿¡è­½
  - å€‹äººä¸­å¿ƒé¡¯ç¤ºè‡ªå·±ä¿¡è­½

**Week 17ï¼šç›£æ§èˆ‡å„ªåŒ–**
- [ ] å¯¦ä½œç›£æ§ Cron Jobs
  - æ¯æ—¥æŒ‡æ¨™æ”¶é›†ï¼ˆ`/api/cron/daily-metrics`ï¼‰
  - æ¯å°æ™‚å¥åº·æª¢æŸ¥ï¼ˆ`/api/cron/hourly-check`ï¼‰
  - Session æ¸…ç†ï¼ˆ`/api/cron/cleanup-sessions`ï¼‰
- [ ] é…ç½® Vercel Cron Jobs
  - vercel.json è¨­å®š
  - Cron Secret ç’°å¢ƒè®Šæ•¸
- [ ] å»ºç«‹ Discord Webhook è­¦å ±
  - Redis ä½¿ç”¨ç‡ > 80% ç™¼é€è­¦å ±
  - ç³»çµ±éŒ¯èª¤å³æ™‚é€šçŸ¥

#### é©—æ”¶æ¨™æº–

âœ… **Webhook é©—æ”¶**ï¼š
- Webhook é…ç½®æµç¨‹å®Œæ•´
- è³¼è²·æ„å‘é€šçŸ¥å³æ™‚ç™¼é€
- é€Ÿç‡é™åˆ¶æ­£ç¢ºé‹ä½œ
- å¤±æ•—è™•ç†æ©Ÿåˆ¶æœ‰æ•ˆ

âœ… **ä¿¡è­½ç³»çµ±é©—æ”¶**ï¼š
- ä¿¡è­½è¨ˆç®—æº–ç¢º
- å¾½ç« é¡¯ç¤ºæ­£ç¢º
- æ¯æ—¥æ‰¹æ¬¡æ›´æ–°æ­£å¸¸

---

### éšæ®µ 5ï¼šDiscord Bot & å¢å¼·åŠŸèƒ½ï¼ˆç¬¬ 18+ é€±ï¼Œå¯é¸ï¼‰

**ç›®æ¨™**ï¼šé–‹ç™¼ Discord Bot èˆ‡é€²éšåŠŸèƒ½

**å„ªå…ˆç´š**ï¼šâšª **Optional**ï¼ˆéå¿…è¦ï¼Œè¦–ç”¨æˆ¶éœ€æ±‚æ±ºå®šï¼‰

#### ä»»å‹™æ¸…å–®ï¼ˆå¯é¸ï¼‰

**Discord Bot é–‹ç™¼**
- [ ] Bot åŸºç¤æ¶æ§‹ï¼ˆdiscord.jsï¼‰
- [ ] å¯¦ä½œ Bot æŒ‡ä»¤
  - `/listings` - æŸ¥è©¢å€‹äººåˆŠç™»
  - `/market` - æœå°‹å¸‚å ´ç‰©å“
  - `/stats` - æŸ¥çœ‹äº¤æ˜“çµ±è¨ˆ
- [ ] Bot éƒ¨ç½²ï¼ˆRender å…è²»ç‰ˆï¼‰

**ä¿¡è­½ç³»çµ±å¢å¼·ï¼ˆå¯é¸ï¼‰**
- [ ] æ•´åˆäº¤æ˜“æ­·å²è©•åˆ†
- [ ] ç¤¾ç¾¤è©•åƒ¹ç³»çµ±
- [ ] å¤–éƒ¨ä¿¡è­½ä¾†æºæ•´åˆ

**å…¶ä»–å¢å¼·åŠŸèƒ½**
- [ ] å¤šèªè¨€æ”¯æ´ï¼ˆi18nï¼‰
- [ ] æ·±è‰²æ¨¡å¼
- [ ] åœ–ç‰‡ä¸Šå‚³ï¼ˆç‰©å“åœ–ç‰‡ï¼‰

---

### ç¸½çµèˆ‡å»ºè­°

æœ¬å¯¦ä½œè·¯ç·šåœ–æä¾›å…©ç¨®æƒ…å¢ƒï¼Œè«‹æ ¹æ“šæ‚¨çš„å¯¦éš›ç‹€æ³é¸æ“‡ï¼š

#### æƒ…å¢ƒ Aï¼šå¾é›¶é–‹å§‹ï¼ˆæ¨è–¦å¤§å¤šæ•¸å°ˆæ¡ˆï¼‰

**12 é€± MVP**ï¼ˆæœ€å°å¯è¡Œç‰ˆæœ¬ï¼‰ï¼š
```
Week 1-4ï¼š   åŸºç¤æ¶æ§‹ï¼ˆSupabase + Redisï¼‰
Week 5-8ï¼š   Discord OAuth èªè­‰
Week 9-12ï¼š  æ ¸å¿ƒåŠŸèƒ½ï¼ˆåˆŠç™»ã€å¸‚å ´ã€æ„å‘ï¼‰
â†’ çµæœï¼šå®Œæ•´çš„äº¤æ˜“ç³»çµ±ï¼Œå¯ä¸Šç·šé‹è¡Œ
```

**14 é€±ç”Ÿç”¢å°±ç·’ç‰ˆæœ¬**ï¼š
```
Week 1-12ï¼š  MVPï¼ˆåŒä¸Šï¼‰
Week 13-14ï¼š ä¸Šç·šè§€å¯Ÿèˆ‡ç›£æ§
â†’ çµæœï¼šå«ç›£æ§çš„ç©©å®šç³»çµ±ï¼Œæ ¹æ“šå¯¦éš›æµé‡æ±ºå®šæ˜¯å¦éœ€è¦å„ªåŒ–
```

**17 é€±å®Œæ•´ç‰ˆæœ¬**ï¼š
```
Week 1-14ï¼š  ç”Ÿç”¢å°±ç·’ç‰ˆæœ¬ï¼ˆåŒä¸Šï¼‰
Week 15-17ï¼š Webhook & ä¿¡è­½ç³»çµ±
â†’ çµæœï¼šåŒ…å«æ‰€æœ‰å¢å¼·åŠŸèƒ½çš„å®Œæ•´äº¤æ˜“å¹³å°
```

**é—œéµæ±ºç­–é»**ï¼š
- Week 13-14ï¼šè§€å¯Ÿ Redis ä½¿ç”¨ç‡
  - å¦‚æœ < 70%ï¼šç¹¼çºŒ Webhook å¯¦ä½œ âœ…
  - å¦‚æœ > 80%ï¼šåˆ‡æ›åˆ°æƒ…å¢ƒ Bï¼ˆBot Detectionï¼‰âš ï¸

---

#### æƒ…å¢ƒ Bï¼šå„ªåŒ–ç¾æœ‰ç³»çµ±ï¼ˆåƒ…é©ç”¨æ–¼å·²ä¸Šç·šä¸”é‡åˆ°å•é¡Œï¼‰

**âš ï¸ å‰æ**ï¼šç³»çµ±å·²ä¸Šç·šï¼ŒRedis ä½¿ç”¨ç‡ > 90%ï¼ŒBot æµé‡ > 60%

**5 é€±ç·Šæ€¥ä¿®å¾©**ï¼š
```
Week 1ï¼š     Bot Detection éšæ®µ 1ï¼ˆåŸºç¤éæ¿¾ï¼‰
Week 2-5ï¼š   Bot Detection éšæ®µ 2ï¼ˆè¡Œç‚ºæª¢æ¸¬ï¼‰
â†’ çµæœï¼šRedis ä½¿ç”¨ç‡é™è‡³ 50-60%ï¼Œç³»çµ±ç©©å®š
```

**9 é€±å®Œæ•´é˜²è­·**ï¼š
```
Week 1-5ï¼š   ç·Šæ€¥ä¿®å¾©ï¼ˆåŒä¸Šï¼‰
Week 6-9ï¼š   Bot Detection éšæ®µ 3+4ï¼ˆIP ä¿¡è­½ + Cloudflareï¼‰
â†’ çµæœï¼šRedis ä½¿ç”¨ç‡é™è‡³ 20-30%ï¼Œç†æƒ³ç‹€æ…‹
```

**17 é€±å…¨åŠŸèƒ½**ï¼š
```
Week 1-9ï¼š   å®Œæ•´é˜²è­·ï¼ˆåŒä¸Šï¼‰
Week 10-13ï¼š Discord OAuth å¼·åŒ–
Week 14-17ï¼š Webhook & ä¿¡è­½ç³»çµ±
â†’ çµæœï¼šå„ªåŒ–å®Œæˆçš„ç”Ÿç”¢ç´šå¹³å°
```

---

#### å¿«é€Ÿé¸æ“‡æŒ‡å—

| æ‚¨çš„æƒ…æ³ | å»ºè­°è·¯ç·š | èµ·é» |
|---------|---------|------|
| ğŸ†• é‚„æ²’é–‹å§‹é–‹ç™¼ | æƒ…å¢ƒ A | [éšæ®µ 0ï¼šåŸºç¤æ¶æ§‹](#éšæ®µ-0åŸºç¤æ¶æ§‹ç¬¬-1-4-é€±) |
| ğŸš§ æ­£åœ¨é–‹ç™¼ä¸­ | æƒ…å¢ƒ A | æ ¹æ“šé€²åº¦é¸æ“‡å°æ‡‰éšæ®µ |
| âœ… å·²ä¸Šç·šä½†æ­£å¸¸ | ç¹¼çºŒè§€å¯Ÿ | [éšæ®µ 3ï¼šä¸Šç·šè§€å¯Ÿ](#éšæ®µ-3ä¸Šç·šè§€å¯Ÿç¬¬-13-14-é€±) |
| âš ï¸ å·²ä¸Šç·š + Redis è¶…æ¨™ | æƒ…å¢ƒ B | [éšæ®µ 0ï¼ˆæƒ…å¢ƒ Bï¼‰](#éšæ®µ-0æƒ…å¢ƒ-bç·Šæ€¥ä¿®å¾©---bot-detection-éšæ®µ-1ç¬¬-1-é€±) |

#### é—œéµé‡Œç¨‹ç¢‘å°ç…§

**æƒ…å¢ƒ Aï¼ˆå¾é›¶é–‹å§‹ï¼‰**ï¼š
| é‡Œç¨‹ç¢‘ | æ™‚é–“é» | æˆæœ |
|--------|--------|------|
| ğŸ¯ **åŸºç¤å°±ç·’** | Week 4 | Supabase + Redis ç’°å¢ƒå®Œæˆ |
| ğŸ” **èªè­‰å®Œæˆ** | Week 8 | Discord OAuth ä¸Šç·š |
| âœ… **MVP ä¸Šç·š** | Week 12 | æ ¸å¿ƒåŠŸèƒ½å®Œæ•´ |
| ğŸ“Š **ç›£æ§æ±ºç­–** | Week 14 | æ ¹æ“šæ•¸æ“šæ±ºå®šæ˜¯å¦éœ€è¦ Bot Detection |
| ğŸš€ **å®Œæ•´åŠŸèƒ½** | Week 17 | åŒ…å« Webhook çš„å®Œæ•´ç³»çµ± |

**æƒ…å¢ƒ Bï¼ˆå„ªåŒ–ç¾æœ‰ï¼‰**ï¼š
| é‡Œç¨‹ç¢‘ | æ™‚é–“é» | æˆæœ |
|--------|--------|------|
| ğŸ”´ **ç·Šæ€¥ä¿®å¾©** | Week 1 | Redis é™è‡³ 70-80% |
| ğŸŸ¢ **ç©©å®šé‹è¡Œ** | Week 5 | Redis é™è‡³ 50-60% |
| ğŸ¯ **ç†æƒ³ç‹€æ…‹** | Week 9 | Redis é™è‡³ 20-30% |
| âœ… **åŠŸèƒ½å¼·åŒ–** | Week 13 | Discord OAuth å¼·åŒ– |
| ğŸš€ **å®Œæ•´åŠŸèƒ½** | Week 17 | æ‰€æœ‰å„ªåŒ–å®Œæˆ |

---

## è¨­è¨ˆæ±ºç­–è¨˜éŒ„

### DDR-001ï¼šé¸æ“‡ Discord OAuth è€Œéè§’è‰² ID ç³»çµ±

**æ—¥æœŸ**ï¼š2025-10-25

**èƒŒæ™¯**ï¼šåŸç³»çµ±ä½¿ç”¨è§’è‰² ID + Token çš„ç„¡å¯†ç¢¼èªè­‰ï¼Œä½†å­˜åœ¨ä»¥ä¸‹å•é¡Œï¼š
- ç„¡æ³•é©—è­‰ç”¨æˆ¶çœŸå¯¦èº«ä»½
- å®¹æ˜“è¢«æ¿«ç”¨ï¼ˆå¤šå¸³è™Ÿè¨»å†Šï¼‰
- ç¼ºä¹ä¿¡ä»»æ©Ÿåˆ¶

**æ±ºç­–**ï¼šæ”¹ç”¨ Discord OAuth 2.0 èªè­‰

**ç†ç”±**ï¼š
- âœ… çœŸå¯¦èº«ä»½é©—è­‰ï¼ˆç¶å®š Discord IDï¼‰
- âœ… é˜²æ­¢å¤šå¸³è™Ÿæ¿«ç”¨ï¼ˆä¸€å€‹ Discord ID åªèƒ½ç¶å®šä¸€å€‹å¸³è™Ÿï¼‰
- âœ… ä¿¡è­½ç³»çµ±åŸºç¤ï¼ˆDiscord å¸³è™Ÿå¹´é½¡å¯é©—è­‰ï¼‰
- âœ… å…è²»ä¸”ç„¡ä½¿ç”¨é™åˆ¶
- âœ… ç”¨æˆ¶åŸºç¤é¾å¤§ï¼ˆDiscord åœ¨éŠæˆ²ç¤¾ç¾¤æ™®åŠï¼‰

**æ¬Šè¡¡**ï¼š
- âŒ éœ€è¦ç”¨æˆ¶æœ‰ Discord å¸³è™Ÿï¼ˆä½†ç›®æ¨™ç”¨æˆ¶ç¾¤é«”å·²å»£æ³›ä½¿ç”¨ Discordï¼‰
- âŒ OAuth æµç¨‹è¼ƒè¤‡é›œï¼ˆä½†æä¾›æ›´å¥½çš„å®‰å…¨æ€§ï¼‰

**çµæœ**ï¼š
- æå‡ç³»çµ±å®‰å…¨æ€§
- å»ºç«‹ä¿¡è­½ç³»çµ±åŸºç¤
- æ•´åˆ Discord ç”Ÿæ…‹ç³»çµ±ï¼ˆWebhookã€Botï¼‰

---

### DDR-002ï¼šé¸æ“‡ Modal æ¨¡å¼è€Œéç¨ç«‹é é¢

**æ—¥æœŸ**ï¼š2025-10-26

**èƒŒæ™¯**ï¼šäº¤æ˜“ç³»çµ± UI æœ‰å…©ç¨®å¯¦ä½œæ–¹å¼å¯é¸ï¼š
1. **Modal æ¨¡å¼**ï¼šä½¿ç”¨ `BaseModal` åœ¨ä¸»é ä¸Šç–ŠåŠ é¡¯ç¤º
2. **ç¨ç«‹é é¢**ï¼šå»ºç«‹ `/market`ã€`/listings/[id]` ç­‰è·¯ç”±

**æ±ºç­–**ï¼šæ¡ç”¨ Modal æ¨¡å¼å¯¦ä½œäº¤æ˜“ç³»çµ± UI

**ç†ç”±**ï¼š

1. **ç¬¦åˆå°ˆæ¡ˆç¾æœ‰æ¶æ§‹** âœ…
   - å°ˆæ¡ˆå·²å¯¦ä½œå®Œæ•´çš„ Modal åŸºç¤å»ºè¨­ï¼ˆ`BaseModal`ã€`ModalManager`ï¼‰
   - ç¾æœ‰æ‰€æœ‰åŠŸèƒ½å‡æ¡ç”¨ Modal æ¨¡å¼ï¼ˆItemModalã€MonsterModalã€GachaMachineModal ç­‰ï¼‰
   - ä¿æŒ UI ä¸€è‡´æ€§ï¼Œé™ä½ç”¨æˆ¶å­¸ç¿’æˆæœ¬

2. **ç¯€çœ Vercel è³‡æºæ¶ˆè€—** âœ…
   - æ¸›å°‘ Serverless Functions åŸ·è¡Œæ™‚é–“ï¼š~2 å°æ™‚/æœˆï¼ˆç¯€çœ 2% é¡åº¦ï¼‰
   - é™ä½ Bandwidth æ¶ˆè€—ï¼š~0.3 GB/æœˆï¼ˆç¯€çœ 0.3% é¡åº¦ï¼‰
   - ç¸½é«”ç¯€çœç´„ 3% Vercel å…è²»é¡åº¦

3. **é–‹ç™¼æ•ˆç‡æ›´é«˜** âœ…
   - é‡ç”¨ç¾æœ‰ `BaseModal` å…ƒä»¶ï¼ˆç„¡éœ€å»ºç«‹è·¯ç”±æ¶æ§‹ï¼‰
   - é‡ç”¨ç¾æœ‰ç‹€æ…‹ç®¡ç†é‚è¼¯ï¼ˆ`useModalManager`ï¼‰
   - é–‹ç™¼æ™‚é–“é ä¼°ç¯€çœ 30-40%

4. **ä½¿ç”¨è€…é«”é©—æµæš¢** âœ…
   - ç„¡éœ€é›¢é–‹ä¸»é ï¼Œä¿æŒæœå°‹ä¸Šä¸‹æ–‡
   - Modal åˆ‡æ›å³æ™‚ï¼ˆç„¡é é¢å°èˆªå»¶é²ï¼‰
   - é©åˆå¿«é€Ÿç€è¦½å’Œæ¯”åƒ¹çš„ä½¿ç”¨æƒ…å¢ƒ

**æ¬Šè¡¡**ï¼š

1. âŒ **ç©ºé–“é™åˆ¶**
   - Modal å¯è¦–ç¯„åœå—é™ï¼ˆmax-w-6xlï¼‰ï¼Œä¸é©åˆè¤‡é›œä»‹é¢
   - è§£æ±ºæ–¹æ¡ˆï¼šMVP éšæ®µä¿æŒåŠŸèƒ½ç°¡æ½”ï¼Œå¿…è¦æ™‚å¯æ“´å±•ç‚ºç¨ç«‹é é¢

2. âŒ **å·¢ç‹€ Modal è¤‡é›œåº¦**
   - ã€Œå¸‚å ´åˆ—è¡¨ â†’ åˆŠç™»è©³æƒ… â†’ ç™»è¨˜æ„å‘ã€å¯èƒ½éœ€è¦å¤šå±¤ Modal
   - è§£æ±ºæ–¹æ¡ˆï¼šä½¿ç”¨ `hasPreviousModal` å’Œ `onGoBack` å¯¦ä½œå°èˆªé‚è¼¯

3. âŒ **ç„¡ç¨ç«‹ URL**
   - ç„¡æ³•ç›´æ¥åˆ†äº«ç‰¹å®šåˆŠç™»é€£çµ
   - è§£æ±ºæ–¹æ¡ˆï¼šæœªä¾†å¯é€é URL hash åƒæ•¸å¯¦ä½œï¼ˆå¦‚ `/#listing-12345`ï¼‰

**æ“´å±•æ€§è€ƒé‡**ï¼š

ä¿ç•™æ··åˆæ¶æ§‹çš„å½ˆæ€§ï¼š
- **MVP éšæ®µ**ï¼ˆWeek 9-12ï¼‰ï¼šå®Œå…¨ä½¿ç”¨ Modal æ¨¡å¼
- **å„ªåŒ–éšæ®µ**ï¼ˆå¯é¸ï¼‰ï¼šè‹¥ç™¼ç¾ä»¥ä¸‹æƒ…æ³ï¼Œå¯æ“´å±•ç‚ºç¨ç«‹é é¢
  - è³£å®¶éœ€è¦ç®¡ç†å¤§é‡åˆŠç™»ï¼ˆ> 10 å€‹ï¼‰
  - éœ€è¦è¤‡é›œçš„å¸‚å ´åˆ†æä»‹é¢
  - éœ€è¦ SEO å‹å–„çš„å¸‚å ´é é¢

**å¯¦ä½œæŒ‡å—**ï¼š

```typescript
// src/components/trade/CreateListingModal.tsx
import { BaseModal } from '@/components/common/BaseModal'

export function CreateListingModal({ isOpen, onClose }: Props) {
  return (
    <BaseModal isOpen={isOpen} onClose={onClose} maxWidth="max-w-2xl">
      {/* åˆŠç™»è¡¨å–® */}
    </BaseModal>
  )
}

// src/components/trade/MarketBrowserModal.tsx
export function MarketBrowserModal({ isOpen, onClose }: Props) {
  const [selectedListing, setSelectedListing] = useState<string | null>(null)

  return (
    <>
      <BaseModal isOpen={isOpen} onClose={onClose} maxWidth="max-w-6xl">
        {/* å¸‚å ´åˆ—è¡¨ */}
      </BaseModal>

      {/* åˆŠç™»è©³æƒ…å­ Modal */}
      {selectedListing && (
        <ListingDetailModal
          isOpen={!!selectedListing}
          onClose={() => setSelectedListing(null)}
          onGoBack={() => setSelectedListing(null)}
          hasPreviousModal
        />
      )}
    </>
  )
}
```

**çµæœ**ï¼š
- ç¬¦åˆå°ˆæ¡ˆä¸€è‡´æ€§åŸå‰‡ï¼ˆé‡ç”¨ç¾æœ‰æ¶æ§‹ï¼‰
- ç¯€çœ Vercel æˆæœ¬ï¼ˆFunction Time -67%ï¼ŒBandwidth -5%ï¼‰
- åŠ å¿« MVP é–‹ç™¼é€Ÿåº¦ï¼ˆé ä¼°ç¯€çœ 1-2 é€±ï¼‰
- ä¿ç•™æœªä¾†æ“´å±•ç‚ºç¨ç«‹é é¢çš„é¸é …

**åƒè€ƒè³‡æ–™**ï¼š
- [æˆæœ¬é ä¼° - Vercel Functions åŸ·è¡Œæ™‚é–“åˆ†æ](#vercel-functions-åŸ·è¡Œæ™‚é–“åˆ†æ)
- [å¯¦ä½œè·¯ç·šåœ– - éšæ®µ 2ï¼šæ ¸å¿ƒåŠŸèƒ½](#éšæ®µ-2æ ¸å¿ƒåŠŸèƒ½ç¬¬-9-12-é€±)

---

### DDR-003ï¼šé¸æ“‡ LoginModal è€Œéç™»å…¥é é¢

**æ—¥æœŸ**ï¼š2025-10-26

**èƒŒæ™¯**ï¼šç”¨æˆ¶éœ€è¦ç™»å…¥æ‰èƒ½ä½¿ç”¨åˆŠç™»å’Œè³¼è²·æ„å‘åŠŸèƒ½ã€‚ç•¶ API è¿”å› 401 Unauthorized æ™‚ï¼Œéœ€è¦å¼•å°ç”¨æˆ¶ç™»å…¥ã€‚

æœ‰å…©ç¨®å¯¦ä½œé¸æ“‡ï¼š
1. **LoginModal**ï¼šåœ¨ä¸»é ä¸Šç–ŠåŠ  Modal é¡¯ç¤ºç™»å…¥æŒ‰éˆ•
2. **ç™»å…¥é é¢**ï¼šç¨ç«‹çš„ `/auth/login` è·¯ç”±é é¢

**æ±ºç­–**ï¼šæ¡ç”¨ LoginModal

**ç†ç”±**ï¼š

1. **ç¬¦åˆ DDR-002 Modal å„ªå…ˆåŸå‰‡** âœ…
   - èˆ‡äº¤æ˜“ç³»çµ± UIï¼ˆCreateListingModalã€MarketBrowserModalï¼‰ä¿æŒä¸€è‡´
   - æ•´å€‹æ‡‰ç”¨çµ±ä¸€ä½¿ç”¨ Modal æ¨¡å¼
   - é™ä½ç”¨æˆ¶å­¸ç¿’æˆæœ¬

2. **æ›´å¥½çš„ç”¨æˆ¶é«”é©—** âœ…
   - ç”¨æˆ¶åœç•™åœ¨ä¸»é ä¸Šä¸‹æ–‡ï¼ˆä¸ä¸­æ–·ç€è¦½æµç¨‹ï¼‰
   - æ¸…æ™°çš„ç™»å…¥èªªæ˜å’Œ Discord OAuth æµç¨‹æç¤º
   - è¦–è¦ºåŒ–çš„è¼‰å…¥ç‹€æ…‹ï¼ˆé˜²æ­¢ç”¨æˆ¶å›°æƒ‘æ–¼è·³è½‰éç¨‹ï¼‰
   - å³æ™‚å›é¥‹ï¼ˆéŒ¯èª¤è¨Šæ¯å¯ä»¥åœ¨ Modal å…§é¡¯ç¤ºï¼‰

3. **ç¬¦åˆæ¶æ§‹è¦æ±‚** âœ…
   - æ»¿è¶³ã€Œè¼‰å…¥ç‹€æ…‹è™•ç†ã€éœ€æ±‚ï¼ˆLine 4213ï¼‰
   - æ»¿è¶³ã€ŒéŒ¯èª¤è¨Šæ¯é¡¯ç¤ºã€éœ€æ±‚ï¼ˆLine 4214ï¼‰
   - æ»¿è¶³ã€Œä½¿ç”¨ Discord ç™»å…¥æŒ‰éˆ•ã€éœ€æ±‚ï¼ˆLine 4212ï¼‰
   - é‡ç”¨ BaseModal åŸºç¤å»ºè¨­

4. **é–‹ç™¼æ•ˆç‡** âœ…
   - ç„¡éœ€å»ºç«‹é¡å¤–è·¯ç”±ï¼ˆç¯€çœé–‹ç™¼æ™‚é–“ï¼‰
   - é‡ç”¨ç¾æœ‰ Modal ç®¡ç†é‚è¼¯
   - èˆ‡å…¶ä»– Modal ä¸€è‡´çš„ç‹€æ…‹ç®¡ç†æ–¹å¼

**æ¬Šè¡¡**ï¼š

1. âŒ **éœ€è¦å…¨å±€ç‹€æ…‹ç®¡ç†**
   - Modal éœ€è¦åœ¨ä»»ä½•åœ°æ–¹éƒ½èƒ½è§¸ç™¼ï¼ˆç•¶ API è¿”å› 401 æ™‚ï¼‰
   - è§£æ±ºæ–¹æ¡ˆï¼šä½¿ç”¨ CustomEvent å¯¦ä½œå…¨å±€è§¸ç™¼æ©Ÿåˆ¶

2. âŒ **ç„¡ç¨ç«‹ URL**
   - ç„¡æ³•ç›´æ¥åˆ†äº«ã€Œç™»å…¥é é¢ã€é€£çµ
   - è§£æ±ºæ–¹æ¡ˆï¼šç”¨æˆ¶éœ€è¦ç™»å…¥æ™‚è‡ªå‹•é¡¯ç¤º Modalï¼ˆé«”é©—æ›´æµæš¢ï¼‰

**å¯¦ä½œè¨­è¨ˆ**ï¼š

```typescript
// src/components/auth/LoginModal.tsx
import { BaseModal } from '@/components/common/BaseModal'
import { useState } from 'react'

interface LoginModalProps {
  isOpen: boolean
  onClose: () => void
}

export function LoginModal({ isOpen, onClose }: LoginModalProps) {
  const [isLoading, setIsLoading] = useState(false)

  const handleDiscordLogin = () => {
    setIsLoading(true)
    // è·³è½‰åˆ° Discord OAuth å•Ÿå‹•ç«¯é»
    window.location.href = '/api/auth/discord'
  }

  return (
    <BaseModal
      isOpen={isOpen}
      onClose={onClose}
      maxWidth="max-w-md"
      preventBackdropClose={isLoading}  // è¼‰å…¥æ™‚é˜²æ­¢é—œé–‰
    >
      <div className="p-8 text-center">
        {/* Discord Logo */}
        <div className="mb-6 flex justify-center">
          <svg className="w-16 h-16 text-[#5865F2]" viewBox="0 0 24 24">
            {/* Discord icon SVG path */}
          </svg>
        </div>

        <h2 className="text-2xl font-bold mb-3 text-gray-900 dark:text-white">
          ç™»å…¥
        </h2>

        <p className="text-gray-600 dark:text-gray-400 mb-6">
          ä½¿ç”¨ Discord å¸³è™Ÿç™»å…¥ä»¥ä½¿ç”¨åˆŠç™»å’Œè³¼è²·æ„å‘åŠŸèƒ½
        </p>

        <button
          onClick={handleDiscordLogin}
          disabled={isLoading}
          className="w-full bg-[#5865F2] hover:bg-[#4752C4]
                     text-white font-semibold rounded-lg py-3 px-4
                     transition-colors duration-200
                     disabled:opacity-50 disabled:cursor-not-allowed
                     flex items-center justify-center gap-2"
        >
          {isLoading ? (
            <>
              <svg className="animate-spin h-5 w-5" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10"
                        stroke="currentColor" strokeWidth="4" fill="none"/>
                <path className="opacity-75" fill="currentColor"
                      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
              </svg>
              <span>è·³è½‰ä¸­...</span>
            </>
          ) : (
            <>
              <svg className="w-5 h-5" viewBox="0 0 24 24">
                {/* Discord icon */}
              </svg>
              <span>ä½¿ç”¨ Discord ç™»å…¥</span>
            </>
          )}
        </button>

        <p className="mt-4 text-xs text-gray-500 dark:text-gray-400">
          ç™»å…¥å³è¡¨ç¤ºæ‚¨åŒæ„æˆ‘å€‘çš„æœå‹™æ¢æ¬¾
        </p>
      </div>
    </BaseModal>
  )
}
```

**è§¸ç™¼æ©Ÿåˆ¶**ï¼š

```typescript
// src/lib/api-client.ts
export async function apiClient(endpoint: string, options = {}) {
  const response = await fetch(endpoint, {
    ...options,
    credentials: 'include'
  })

  if (response.status === 401) {
    // è§¸ç™¼ç™»å…¥ Modal
    const event = new CustomEvent('show-login-modal')
    window.dispatchEvent(event)
    throw new Error('éœ€è¦ç™»å…¥')
  }

  return response.json()
}

// src/app/page.tsx
export default function HomePage() {
  const [isLoginModalOpen, setIsLoginModalOpen] = useState(false)

  useEffect(() => {
    // ç›£è½å…¨å±€ç™»å…¥ Modal è§¸ç™¼äº‹ä»¶
    const handleShowLogin = () => setIsLoginModalOpen(true)
    window.addEventListener('show-login-modal', handleShowLogin)

    return () => {
      window.removeEventListener('show-login-modal', handleShowLogin)
    }
  }, [])

  return (
    <>
      {/* ä¸»é å…§å®¹ */}

      {/* ç™»å…¥ Modal */}
      <LoginModal
        isOpen={isLoginModalOpen}
        onClose={() => setIsLoginModalOpen(false)}
      />
    </>
  )
}
```

**è¦–è¦ºè¨­è¨ˆ**ï¼š
- ä½¿ç”¨ Discord å“ç‰Œè‰² `#5865F2`ï¼ˆä¸»è¦æŒ‰éˆ•ï¼‰
- Hover ç‹€æ…‹ï¼š`#4752C4`ï¼ˆç¨æ·±ï¼‰
- è¼‰å…¥ç‹€æ…‹ï¼šé¡¯ç¤º spinner + ã€Œè·³è½‰ä¸­...ã€æ–‡å­—
- ç¦ç”¨ç‹€æ…‹ï¼š50% é€æ˜åº¦ + ç¦ç”¨æŒ‡æ¨™

**çµæœ**ï¼š
- ç¬¦åˆ Modal å„ªå…ˆè¨­è¨ˆåŸå‰‡ï¼ˆèˆ‡ DDR-002 ä¸€è‡´ï¼‰
- æä¾›å®Œæ•´çš„ç™»å…¥ UXï¼ˆèªªæ˜ã€è¼‰å…¥ã€éŒ¯èª¤è™•ç†ï¼‰
- ä¿æŒæ‡‰ç”¨ UI ä¸€è‡´æ€§ï¼ˆæ‰€æœ‰åŠŸèƒ½å‡ä½¿ç”¨ Modalï¼‰
- ç¯€çœé–‹ç™¼æ™‚é–“ï¼ˆé‡ç”¨ BaseModal åŸºç¤å»ºè¨­ï¼‰

**åƒè€ƒè³‡æ–™**ï¼š
- [DDR-002ï¼šé¸æ“‡ Modal æ¨¡å¼è€Œéç¨ç«‹é é¢](#ddr-002é¸æ“‡-modal-æ¨¡å¼è€Œéç¨ç«‹é é¢)
- [å¯¦ä½œè·¯ç·šåœ– - éšæ®µ 1ï¼šDiscord OAuth èªè­‰](#éšæ®µ-1discord-oauth-èªè­‰ç¬¬-5-8-é€±)

---

*ï¼ˆæ¶æ§‹æ–‡ä»¶å®Œæˆï¼‰*
