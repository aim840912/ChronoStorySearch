# JSON è³‡æ–™æµé‡å„ªåŒ–æŒ‡å—

æœ¬æ–‡ä»¶èªªæ˜å¦‚ä½•é€²ä¸€æ­¥å„ªåŒ–å°ˆæ¡ˆä¸­å¤§å‹ JSON è³‡æ–™çš„è¼‰å…¥æ–¹å¼ï¼Œé™ä½ Vercel æµé‡æ¶ˆè€—ã€‚

---

## ğŸ“Š ç•¶å‰ç‹€æ³

### ç¾æœ‰å„ªåŒ–æˆæœ

âœ… **å·²å¯¦æ–½çš„å„ªåŒ–**ï¼š
- åœ–ç‰‡å…¨éƒ¨æ”¹ç”¨ Cloudflare R2 CDNï¼ˆé™ä½ 90% Vercel Edge Requestsï¼‰
- å¤§å‹ JSON æ¡ç”¨æ‡¶åŠ è¼‰ç­–ç•¥ï¼ˆåªåœ¨éœ€è¦æ™‚è¼‰å…¥ï¼‰
- å•Ÿç”¨ gzip å£“ç¸®ï¼ˆæ¸›å°‘ 80% å‚³è¼¸é‡ï¼‰
- ç€è¦½å™¨å¿«å–ç­–ç•¥ï¼ˆæ¯å€‹ç”¨æˆ¶åªä¸‹è¼‰ä¸€æ¬¡ï¼‰

### æµé‡æ¶ˆè€—åˆ†æ

| è³‡æ–™é¡å‹ | æª”æ¡ˆå¤§å° | gzip å¾Œ | è¼‰å…¥æ™‚æ©Ÿ |
|---------|---------|---------|---------|
| `item-attributes.json` | ~2.5MB | ~0.5MB | é€²éšç¯©é¸æ™‚ |
| `mob-info.json` | ~134KB | ~30KB | é–‹å•Ÿæ€ªç‰© Modal æ™‚ |
| `gacha/*.json` (7å€‹) | ~200KB | ~50KB | é¦–æ¬¡æœå°‹æ™‚ |
| **ç¸½è¨ˆ** | ~2.8MB | **~0.6MB** | æŒ‰éœ€è¼‰å…¥ |

**çµè«–**ï¼šç•¶å‰æ¯å€‹ç”¨æˆ¶æœ€å¤šæ¶ˆè€—ç´„ **0.6MB Vercel æµé‡**ï¼ˆé¦–æ¬¡ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½æ™‚ï¼‰

---

## ğŸ¯ å„ªåŒ–æ–¹æ¡ˆ

ä»¥ä¸‹æä¾›å…©ç¨®é€²éšå„ªåŒ–æ–¹æ¡ˆï¼Œé©ç”¨æ–¼ Vercel æµé‡æ¥è¿‘é™åˆ¶æˆ–å¸Œæœ›é€²ä¸€æ­¥æå‡æ•ˆèƒ½çš„æƒ…å¢ƒã€‚

---

## é¸é … 2ï¼šå°‡ JSON è³‡æ–™ç§»åˆ° R2 CDN

### æ¦‚è¿°

å°‡å¤§å‹ JSON æª”æ¡ˆä¸Šå‚³åˆ° Cloudflare R2ï¼Œä½¿ç”¨ `fetch()` è€Œéå‹•æ…‹ `import()` è¼‰å…¥è³‡æ–™ã€‚

### å„ªé»

âœ… **å®Œå…¨æ¶ˆé™¤ Vercel æµé‡æ¶ˆè€—**ï¼ˆJSON è³‡æ–™æ”¹ç”± R2 CDN æä¾›ï¼‰
âœ… **é™ä½ Next.js Bundle å¤§å°**ï¼ˆæ¸›å°‘éƒ¨ç½²æ™‚é–“ï¼‰
âœ… **åˆ©ç”¨ R2 å…è²»é¡åº¦**ï¼ˆ1000 è¬æ¬¡è«‹æ±‚/æœˆï¼Œegress-freeï¼‰
âœ… **æ›´æ–°è³‡æ–™ç„¡éœ€é‡æ–°éƒ¨ç½²**ï¼ˆç›´æ¥æ›´æ–° R2 ä¸Šçš„æª”æ¡ˆï¼‰

### ç¼ºé»

âš ï¸ **éœ€è¦è™•ç† CORS è¨­å®š**ï¼ˆR2 éœ€è¦å…è¨±è·¨åŸŸè«‹æ±‚ï¼‰
âš ï¸ **éœ€è¦å¯¦ä½œéŒ¯èª¤è™•ç†**ï¼ˆç¶²è·¯è«‹æ±‚å¯èƒ½å¤±æ•—ï¼‰
âš ï¸ **éœ€è¦ç®¡ç†å¿«å–ç­–ç•¥**ï¼ˆæ‰‹å‹•è¨­å®š Cache-Control headersï¼‰
âš ï¸ **å¢åŠ ç¶­è­·è¤‡é›œåº¦**ï¼ˆè³‡æ–™æ›´æ–°éœ€è¦åŒæ­¥åˆ° R2ï¼‰

---

### å¯¦ä½œæ­¥é©Ÿæ¦‚è¦

#### æ­¥é©Ÿ 1ï¼šä¸Šå‚³ JSON åˆ° R2

```bash
# å»ºç«‹è³‡æ–™å¤¾çµæ§‹
~/rclone mkdir r2:maplestory-images/data
~/rclone mkdir r2:maplestory-images/data/gacha

# ä¸Šå‚³æª”æ¡ˆ
~/rclone copy data/item-attributes.json r2:maplestory-images/data/
~/rclone copy data/mob-info.json r2:maplestory-images/data/
~/rclone copy data/gacha/ r2:maplestory-images/data/gacha/ --progress

# é©—è­‰
~/rclone ls r2:maplestory-images/data/
```

#### æ­¥é©Ÿ 2ï¼šè¨­å®š R2 CORS

å‰å¾€ **Cloudflare Dashboard** â†’ **R2** â†’ **maplestory-images** â†’ **Settings** â†’ **CORS Policy**

æ–°å¢è¦å‰‡ï¼š
```json
[
  {
    "AllowedOrigins": [
      "https://yourdomain.com",
      "https://*.vercel.app",
      "http://localhost:3000"
    ],
    "AllowedMethods": ["GET", "HEAD"],
    "AllowedHeaders": ["*"],
    "MaxAgeSeconds": 3600
  }
]
```

#### æ­¥é©Ÿ 3ï¼šå»ºç«‹ R2 è³‡æ–™è¼‰å…¥å·¥å…·

å»ºç«‹ `src/lib/r2-data-loader.ts`ï¼Œå¯¦ä½œï¼š
- `loadJsonFromR2<T>()` - å¾ R2 è¼‰å…¥ JSONï¼Œå¸¶é‡è©¦æ©Ÿåˆ¶
- éŒ¯èª¤è™•ç†å’Œå¿«å–æ§åˆ¶
- ç€è¦½å™¨å¿«å–ç­–ç•¥ï¼ˆ`cache: 'force-cache'`ï¼‰

#### æ­¥é©Ÿ 4ï¼šä¿®æ”¹ Hook ä½¿ç”¨ R2

ä¿®æ”¹ä»¥ä¸‹æª”æ¡ˆæ”¹ç”¨ `loadJsonFromR2()`ï¼š
- `src/hooks/useLazyData.ts` - ç‰©å“å±¬æ€§å’Œæ€ªç‰©è³‡è¨Š
- `src/hooks/useDataManagement.ts` - è½‰è›‹æ©Ÿè³‡æ–™

#### æ­¥é©Ÿ 5ï¼šæ–°å¢ç¶­è­·è…³æœ¬

åœ¨ `package.json` æ–°å¢ï¼š
```json
{
  "scripts": {
    "r2:sync-data": "~/rclone copy data/ r2:maplestory-images/data/ --exclude '.DS_Store' --progress",
    "r2:sync-all": "npm run r2:sync && npm run r2:sync-data"
  }
}
```

---

### æ¸¬è©¦èˆ‡ç¶­è­·

**æ¸¬è©¦æµç¨‹**ï¼š
1. ä¸Šå‚³è³‡æ–™ï¼š`npm run r2:sync-data`
2. æœ¬åœ°æ¸¬è©¦ï¼š`npm run dev`
3. ç¢ºèª Network é¢æ¿ä¸­ JSON ä¾†æºç‚º R2
4. éƒ¨ç½²åˆ° Vercel

**æ›´æ–° JSON è³‡æ–™æ™‚**ï¼š
```bash
# 1. æ›´æ–°æœ¬åœ°è³‡æ–™
npm run generate-data

# 2. åŒæ­¥åˆ° R2
npm run r2:sync-data

# 3. é©—è­‰
curl https://pub-xxx.r2.dev/data/item-attributes.json | jq '.[:5]'
```

**å¿«å–å¤±æ•ˆç­–ç•¥**ï¼š
- é¸é … Aï¼šç‰ˆæœ¬åŒ–æª”åï¼ˆ`item-attributes-20250119.json`ï¼‰
- é¸é … Bï¼šè¨­å®š `Cache-Control: public, max-age=3600`

---

## é¸é … 3ï¼šå¯¦ä½œ Service Worker å¿«å–ç­–ç•¥

### æ¦‚è¿°

ä½¿ç”¨ Progressive Web App (PWA) æŠ€è¡“å¯¦ä½œ Service Workerï¼Œæä¾›æ›´å¼·å¤§çš„å¿«å–æ§åˆ¶å’Œé›¢ç·šé«”é©—ã€‚

### å„ªé»

âœ… **å®Œå…¨æ§åˆ¶å¿«å–ç­–ç•¥**ï¼ˆè‡ªè¨‚å¿«å–é‚è¼¯ï¼‰
âœ… **æä¾›é›¢ç·šé«”é©—**ï¼ˆä½¿ç”¨è€…é›¢ç·šæ™‚ä¹Ÿèƒ½ç€è¦½å·²å¿«å–çš„è³‡æ–™ï¼‰
âœ… **èƒŒæ™¯åŒæ­¥**ï¼ˆå®šæœŸæ›´æ–°è³‡æ–™ï¼Œç„¡éœ€ä½¿ç”¨è€…ç­‰å¾…ï¼‰
âœ… **ç‰ˆæœ¬æ§åˆ¶**ï¼ˆè‡ªå‹•æ¸…ç†èˆŠç‰ˆæœ¬å¿«å–ï¼‰
âœ… **è·¨é é¢å…±äº«å¿«å–**ï¼ˆæ¸›å°‘é‡è¤‡è¼‰å…¥ï¼‰

### ç¼ºé»

âš ï¸ **å¯¦ä½œè¤‡é›œåº¦é«˜**ï¼ˆéœ€è¦ç†è§£ Service Worker ç”Ÿå‘½é€±æœŸï¼‰
âš ï¸ **é™¤éŒ¯å›°é›£**ï¼ˆService Worker åœ¨èƒŒæ™¯åŸ·è¡Œï¼Œé›£ä»¥åµéŒ¯ï¼‰
âš ï¸ **ç€è¦½å™¨æ”¯æ´**ï¼ˆéœ€è¦ HTTPSï¼ŒèˆŠç‰ˆç€è¦½å™¨ä¸æ”¯æ´ï¼‰
âš ï¸ **å¿«å–ç®¡ç†**ï¼ˆéœ€è¦è™•ç†å¿«å–å¤§å°é™åˆ¶ã€æ›´æ–°é‚è¼¯ï¼‰
âš ï¸ **é¦–æ¬¡è¼‰å…¥ç„¡å¿«å–**ï¼ˆç¬¬ä¸€æ¬¡è¨ªå•ä»éœ€ä¸‹è¼‰è³‡æ–™ï¼‰

---

### å¯¦ä½œæ­¥é©Ÿæ¦‚è¦

#### æ­¥é©Ÿ 1ï¼šå®‰è£ next-pwa

```bash
npm install next-pwa
npm install --save-dev @types/serviceworker
```

#### æ­¥é©Ÿ 2ï¼šè¨­å®š next.config.ts

ä½¿ç”¨ `withPWA` åŒ…è£é…ç½®ï¼Œè¨­å®šï¼š
- `runtimeCaching` - å®šç¾©å¿«å–ç­–ç•¥
- åœ–ç‰‡ä½¿ç”¨ `CacheFirst`ï¼ˆå„ªå…ˆå¿«å–ï¼‰
- JSON ä½¿ç”¨ `StaleWhileRevalidate`ï¼ˆå…ˆè¿”å›å¿«å–ï¼ŒèƒŒæ™¯æ›´æ–°ï¼‰

#### æ­¥é©Ÿ 3ï¼šå»ºç«‹ Service Worker

å»ºç«‹ `public/sw.js`ï¼Œå¯¦ä½œï¼š
- é å¿«å–è³‡æ–™æª”æ¡ˆï¼ˆinstall äº‹ä»¶ï¼‰
- æ¸…ç†èˆŠå¿«å–ï¼ˆactivate äº‹ä»¶ï¼‰
- æ””æˆªè«‹æ±‚ä¸¦å¥—ç”¨å¿«å–ç­–ç•¥ï¼ˆfetch äº‹ä»¶ï¼‰
- èƒŒæ™¯åŒæ­¥ï¼ˆsync äº‹ä»¶ï¼‰

#### æ­¥é©Ÿ 4ï¼šè¨»å†Š Service Worker

å»ºç«‹ `src/lib/sw-registration.ts`ï¼Œæä¾›ï¼š
- `registerServiceWorker()` - è¨»å†Šä¸¦ç›£è½æ›´æ–°
- `unregisterServiceWorker()` - ç§»é™¤è¨»å†Š
- `clearServiceWorkerCache()` - æ¸…é™¤å¿«å–

#### æ­¥é©Ÿ 5ï¼šåœ¨ App ä¸­å•Ÿç”¨

ä¿®æ”¹ `src/app/layout.tsx`ï¼š
- åœ¨ `useEffect` ä¸­å‘¼å« `registerServiceWorker()`
- åªåœ¨ç”Ÿç”¢ç’°å¢ƒå•Ÿç”¨

#### æ­¥é©Ÿ 6ï¼šå»ºç«‹ PWA Manifest

å»ºç«‹ `public/manifest.json` å’Œåœ–ç¤ºæª”æ¡ˆã€‚

---

### æ¸¬è©¦èˆ‡ç¶­è­·

**æ¸¬è©¦æµç¨‹**ï¼š
1. å»ºç½®ï¼š`npm run build && npm start`
2. é–‹å•Ÿ Chrome DevTools â†’ Application â†’ Service Workers
3. ç¢ºèªç‹€æ…‹ç‚º "activated and is running"
4. æª¢æŸ¥ Cache Storage ä¸­çš„å¿«å–
5. æ¸¬è©¦é›¢ç·šæ¨¡å¼ï¼ˆNetwork â†’ Offlineï¼‰

**æ›´æ–°å¿«å–ç‰ˆæœ¬**ï¼š
```javascript
// public/sw.js
const CACHE_VERSION = 'v1.0.1' // æ›´æ–°ç‰ˆæœ¬è™Ÿ
```

**é™¤éŒ¯æŠ€å·§**ï¼š
- `chrome://inspect/#service-workers` - æŸ¥çœ‹æ—¥èªŒ
- `chrome://serviceworker-internals/` - ç®¡ç† Service Worker
- DevTools â†’ Application â†’ Cache Storage - æª¢æŸ¥å¿«å–å…§å®¹

---

## ğŸ“Š æ–¹æ¡ˆæ¯”è¼ƒ

| è©•ä¼°é …ç›® | é¸é … 2ï¼šR2 CDN | é¸é … 3ï¼šService Worker | ç•¶å‰æ–¹æ¡ˆï¼ˆå‹•æ…‹ importï¼‰ |
|---------|---------------|----------------------|----------------------|
| **Vercel æµé‡ç¯€çœ** | 100% | 50-80% | 0% |
| **å¯¦ä½œè¤‡é›œåº¦** | ğŸŸ¡ ä¸­ç­‰ | ğŸ”´ é«˜ | ğŸŸ¢ ä½ |
| **ç¶­è­·æˆæœ¬** | ğŸŸ¡ ä¸­ç­‰ | ğŸ”´ é«˜ | ğŸŸ¢ ä½ |
| **ç€è¦½å™¨å¿«å–** | ä¾è³´ HTTP å¿«å– | å®Œå…¨æ§åˆ¶ | ä¾è³´ HTTP å¿«å– |
| **é›¢ç·šæ”¯æ´** | âŒ ç„¡ | âœ… å®Œæ•´æ”¯æ´ | âŒ ç„¡ |
| **é¦–æ¬¡è¼‰å…¥é€Ÿåº¦** | ğŸŸ¡ ç¨æ…¢ï¼ˆç¶²è·¯è«‹æ±‚ï¼‰ | ğŸŸ¡ ç¨æ…¢ï¼ˆç¶²è·¯è«‹æ±‚ï¼‰ | ğŸŸ¢ å¿«ï¼ˆbundledï¼‰ |
| **äºŒæ¬¡è¼‰å…¥é€Ÿåº¦** | ğŸŸ¢ å¿«ï¼ˆå¿«å–ï¼‰ | ğŸŸ¢ æ¥µå¿«ï¼ˆSW å¿«å–ï¼‰ | ğŸŸ¢ å¿«ï¼ˆå¿«å–ï¼‰ |
| **è³‡æ–™æ›´æ–°éˆæ´»æ€§** | âœ… ç„¡éœ€é‡æ–°éƒ¨ç½² | ğŸŸ¡ éœ€æ›´æ–°ç‰ˆæœ¬è™Ÿ | âŒ éœ€é‡æ–°éƒ¨ç½² |
| **éŒ¯èª¤è™•ç†** | ğŸŸ¡ éœ€æ‰‹å‹•å¯¦ä½œ | ğŸŸ¡ éœ€æ‰‹å‹•å¯¦ä½œ | ğŸŸ¢ è‡ªå‹•è™•ç† |
| **é©ç”¨å ´æ™¯** | Vercel æµé‡ç·Šå¼µ | éœ€è¦é›¢ç·šé«”é©— | æµé‡å……è¶³ |

---

## ğŸ¯ æ¨è–¦æ±ºç­–æ¨¹

```
æ˜¯å¦æ¥è¿‘ Vercel æµé‡é™åˆ¶ï¼Ÿ
â”œâ”€ å¦ â†’ **ä¿æŒç•¶å‰æ–¹æ¡ˆ**ï¼ˆå·²ç¶“è¶³å¤ å„ªåŒ–ï¼‰
â”‚
â””â”€ æ˜¯ â†’ æ˜¯å¦éœ€è¦é›¢ç·šé«”é©—ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ **é¸é … 3ï¼šService Worker**ï¼ˆPWA å®Œæ•´æ–¹æ¡ˆï¼‰
    â”‚
    â””â”€ å¦ â†’ **é¸é … 2ï¼šR2 CDN**ï¼ˆç°¡å–®ç›´æ¥ï¼‰
```

---

## ğŸš€ å¿«é€Ÿå¯¦ä½œæª¢æŸ¥æ¸…å–®

### é¸é … 2ï¼šR2 CDN

- [ ] ä¸Šå‚³ JSON æª”æ¡ˆåˆ° R2
- [ ] è¨­å®š R2 CORS è¦å‰‡
- [ ] å»ºç«‹ `r2-data-loader.ts` å·¥å…·å‡½æ•¸
- [ ] ä¿®æ”¹ `useLazyData.ts` æ”¹ç”¨ fetch
- [ ] ä¿®æ”¹ `useDataManagement.ts` æ”¹ç”¨ fetch
- [ ] æ¸¬è©¦æœ¬åœ°è¼‰å…¥åŠŸèƒ½
- [ ] éƒ¨ç½²åˆ° Vercel
- [ ] é©—è­‰ç”Ÿç”¢ç’°å¢ƒæ­£å¸¸é‹ä½œ

### é¸é … 3ï¼šService Worker

- [ ] å®‰è£ `next-pwa` å¥—ä»¶
- [ ] è¨­å®š `next.config.ts`
- [ ] å»ºç«‹ `public/sw.js`
- [ ] å»ºç«‹ `sw-registration.ts`
- [ ] ä¿®æ”¹ `layout.tsx` è¨»å†Š SW
- [ ] å»ºç«‹ `manifest.json` å’Œ icon åœ–ç¤º
- [ ] æœ¬åœ°æ¸¬è©¦ Service Worker
- [ ] æ¸¬è©¦é›¢ç·šæ¨¡å¼
- [ ] éƒ¨ç½²åˆ° Vercel
- [ ] é©—è­‰ PWA åŠŸèƒ½æ­£å¸¸

---

## ğŸ“š ç›¸é—œæ–‡æª”

- [Cloudflare R2 è¨­å®šæŒ‡å—](../infrastructure/cloudflare-r2-setup.md)
- [R2 ç¶­è­·æŒ‡å—](../infrastructure/r2-maintenance.md)
- [Next.js PWA å®˜æ–¹æ–‡æª”](https://github.com/shadowwalker/next-pwa)
- [Service Worker API åƒè€ƒ](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)
- [Cache API åƒè€ƒ](https://developer.mozilla.org/en-US/docs/Web/API/Cache)
