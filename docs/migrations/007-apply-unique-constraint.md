# Migration 007ï¼šæ‡‰ç”¨å”¯ä¸€æ€§ç´„æŸä¿®å¾©ä¸¦ç™¼å•é¡Œ

> **åŸ·è¡Œæ™‚é–“**ï¼š5 åˆ†é˜
> **ç›®çš„**ï¼šé˜²æ­¢ç”¨æˆ¶åŒæ™‚åˆŠç™»ç›¸åŒç‰©å“å°è‡´çš„è³‡æ–™åº«å®Œæ•´æ€§å•é¡Œ

---

## ğŸ“‹ å•é¡ŒèƒŒæ™¯

ç•¶ç”¨æˆ¶å¿«é€Ÿé‡è¤‡é»æ“Šã€ŒåˆŠç™»ã€æŒ‰éˆ•ï¼Œæˆ–åœ¨ä¸åŒè£ç½®åŒæ™‚åˆŠç™»ç›¸åŒç‰©å“æ™‚ï¼Œå¯èƒ½ç¹éæ‡‰ç”¨å±¤çš„æª¢æŸ¥ï¼Œå°è‡´ï¼š
- âŒ çªç ´é…é¡é™åˆ¶ï¼ˆè¶…é 5 å€‹æ´»èºåˆŠç™»ï¼‰
- âŒ å¸‚å ´ä¸Šå‡ºç¾é‡è¤‡åˆŠç™»
- âŒ è³‡æ–™å®Œæ•´æ€§å•é¡Œ

**æ ¹æœ¬åŸå› **ï¼šCheck-Then-Act åæ¨¡å¼ + ç¼ºå°‘è³‡æ–™åº«å±¤ç´šç´„æŸ

---

## âœ… è§£æ±ºæ–¹æ¡ˆ

æ·»åŠ éƒ¨åˆ†å”¯ä¸€ç´¢å¼•ï¼ˆPartial Unique Indexï¼‰ï¼Œåœ¨è³‡æ–™åº«å±¤ç´šé˜²æ­¢é‡è¤‡åˆŠç™»ã€‚

---

## ğŸš€ åŸ·è¡Œæ­¥é©Ÿ

### æ­¥é©Ÿ 1ï¼šæ‡‰ç”¨ Migration

1. ç™»å…¥ [Supabase Dashboard](https://supabase.com/dashboard)
2. é¸æ“‡æ‚¨çš„å°ˆæ¡ˆï¼š`maplestory-trading`
3. é»æ“Šå·¦å´é¸å–®çš„ **ã€ŒSQL Editorã€**
4. é»æ“Š **ã€ŒNew queryã€** æŒ‰éˆ•
5. é–‹å•Ÿæª”æ¡ˆï¼š`supabase/migrations/007_add_unique_active_listing_constraint.sql`
6. è¤‡è£½å®Œæ•´çš„ SQL å…§å®¹ä¸¦è²¼åˆ° SQL Editor
7. é»æ“Š **ã€ŒRunã€** æŒ‰éˆ•ï¼ˆæˆ–æŒ‰ `Ctrl/Cmd + Enter`ï¼‰

**é æœŸè¼¸å‡º**ï¼š
```
SUCCESS
Rows: 0

Comment on index successful
```

å¦‚æœçœ‹åˆ° `"already exists"` éŒ¯èª¤ï¼Œè¡¨ç¤ºç´„æŸå·²ç¶“å­˜åœ¨ï¼Œå¯ä»¥å¿½ç•¥ã€‚

---

### æ­¥é©Ÿ 2ï¼šé©—è­‰ç´„æŸå·²å»ºç«‹

åœ¨ SQL Editor ä¸­åŸ·è¡Œä»¥ä¸‹æŸ¥è©¢ï¼š

```sql
SELECT
  indexname,
  indexdef
FROM pg_indexes
WHERE indexname = 'unique_active_listing_per_user_item';
```

**é æœŸçµæœ**ï¼š

| indexname | indexdef |
|-----------|----------|
| unique_active_listing_per_user_item | CREATE UNIQUE INDEX ... WHERE status = 'active' AND deleted_at IS NULL |

---

### æ­¥é©Ÿ 3ï¼šåŸ·è¡Œå®Œæ•´æ¸¬è©¦ï¼ˆå¯é¸ä½†å¼·çƒˆå»ºè­°ï¼‰

1. é–‹å•Ÿæª”æ¡ˆï¼š`supabase/migrations/007_test_unique_constraint.sql`
2. è¤‡è£½å®Œæ•´çš„ SQL å…§å®¹ä¸¦è²¼åˆ° SQL Editor
3. é»æ“Š **ã€ŒRunã€** æŒ‰éˆ•

**é æœŸè¼¸å‡º**ï¼š

```
NOTICE: æ¸¬è©¦ç”¨æˆ¶å·²å»ºç«‹ï¼š00000000-0000-0000-0000-000000000001
NOTICE: âœ… æ¸¬è©¦ 1 é€šéï¼šæ­£å¸¸æ’å…¥æˆåŠŸ
NOTICE: âœ… æ¸¬è©¦ 2 é€šéï¼šå”¯ä¸€æ€§ç´„æŸæ­£å¸¸é‹ä½œï¼ˆé˜»æ­¢é‡è¤‡åˆŠç™»ï¼‰
NOTICE: éŒ¯èª¤ä»£ç¢¼ï¼š23505ï¼ˆunique_violationï¼‰
NOTICE: âœ… æ¸¬è©¦ 3 é€šéï¼šä¸åŒç‹€æ…‹çš„åˆŠç™»å¯ä»¥å…±å­˜
NOTICE: âœ… æ¸¬è©¦ 4 é€šéï¼šå·²åˆªé™¤çš„åˆŠç™»ä¸å—ç´„æŸå½±éŸ¿
NOTICE: âœ… æ¸¬è©¦ 5 é€šéï¼šä¸åŒç”¨æˆ¶å¯ä»¥åˆŠç™»ç›¸åŒç‰©å“
NOTICE: ğŸ§¹ æ¸¬è©¦è³‡æ–™å·²æ¸…ç†
NOTICE: ========================================
NOTICE: ğŸ‰ æ‰€æœ‰æ¸¬è©¦é€šéï¼å”¯ä¸€æ€§ç´„æŸé‹ä½œæ­£å¸¸
NOTICE: ========================================
```

**å¦‚æœä»»ä½•æ¸¬è©¦å¤±æ•—**ï¼Œè«‹åœæ­¢ä¸¦å ±å‘Šå•é¡Œã€‚

---

## ğŸ”§ å¾ŒçºŒå·¥ä½œï¼ˆéšæ®µäºŒï¼‰

ç´„æŸå·²ç”Ÿæ•ˆå¾Œï¼Œéœ€è¦æ›´æ–°æ‡‰ç”¨ç¨‹å¼ç¨‹å¼ç¢¼ä¾†å„ªé›…è™•ç†éŒ¯èª¤ï¼š

### 1. æ›´æ–° API éŒ¯èª¤è™•ç†

åœ¨ `src/app/api/listings/route.ts` ä¸­æ•ç²å”¯ä¸€æ€§é•åéŒ¯èª¤ï¼š

```typescript
// ç•¶å‰ç¨‹å¼ç¢¼ï¼ˆç¬¬ 270 è¡Œé™„è¿‘ï¼‰
const { data: listing, error: insertError } = await supabaseAdmin
  .from('listings')
  .insert(listingData)
  .select()
  .single()

if (insertError) {
  // æ–°å¢ï¼šæª¢æŸ¥å”¯ä¸€æ€§é•åéŒ¯èª¤
  if (insertError.code === '23505') {
    throw new ValidationError('æ‚¨å·²ç¶“åˆŠç™»æ­¤ç‰©å“ï¼Œç„¡æ³•é‡è¤‡åˆŠç™»')
  }

  // åŸæœ‰éŒ¯èª¤è™•ç†
  throw ErrorFactory.fromSupabaseError(insertError, 'å»ºç«‹åˆŠç™»å¤±æ•—')
}
```

### 2. å‰ç«¯æç¤ºå„ªåŒ–

åœ¨ `CreateListingModal.tsx` ä¸­é¡¯ç¤ºå‹å–„éŒ¯èª¤è¨Šæ¯ï¼š

```typescript
// å·²æœ‰çš„éŒ¯èª¤è™•ç†é‚è¼¯
if (error.includes('å·²ç¶“åˆŠç™»æ­¤ç‰©å“')) {
  toast.error('æ‚¨å·²ç¶“åˆŠç™»æ­¤ç‰©å“ï¼Œç„¡æ³•é‡è¤‡åˆŠç™»')
}
```

---

## ğŸ“Š ç´„æŸè©³ç´°èªªæ˜

### ä»€éº¼æƒ…æ³æœƒè¢«é˜»æ­¢ï¼Ÿ

- âœ… **æœƒè¢«é˜»æ­¢**ï¼šåŒä¸€ç”¨æˆ¶åŒæ™‚æ“æœ‰å¤šå€‹ç›¸åŒç‰©å“çš„**æ´»èºåˆŠç™»**
  ```sql
  user_id = A, item_id = 1002000, status = 'active', deleted_at = NULL
  user_id = A, item_id = 1002000, status = 'active', deleted_at = NULL âŒ
  ```

### ä»€éº¼æƒ…æ³ä»ç„¶å…è¨±ï¼Ÿ

- âœ… **å…è¨±**ï¼šåŒä¸€ç‰©å“çš„æ­·å²è¨˜éŒ„ï¼ˆå·²å”®å‡ºã€å·²å–æ¶ˆï¼‰
  ```sql
  user_id = A, item_id = 1002000, status = 'active'
  user_id = A, item_id = 1002000, status = 'sold' âœ…
  ```

- âœ… **å…è¨±**ï¼šå·²åˆªé™¤çš„åˆŠç™»
  ```sql
  user_id = A, item_id = 1002000, status = 'active', deleted_at = NULL
  user_id = A, item_id = 1002000, status = 'active', deleted_at = NOW() âœ…
  ```

- âœ… **å…è¨±**ï¼šä¸åŒç”¨æˆ¶åˆŠç™»ç›¸åŒç‰©å“
  ```sql
  user_id = A, item_id = 1002000, status = 'active'
  user_id = B, item_id = 1002000, status = 'active' âœ…
  ```

---

## ğŸ”„ å›æ»¾æ–¹å¼

å¦‚éœ€ç§»é™¤æ­¤ç´„æŸï¼ˆä¸å»ºè­°ï¼‰ï¼š

```sql
DROP INDEX IF EXISTS unique_active_listing_per_user_item;
```

---

## âœ… å®Œæˆæª¢æŸ¥æ¸…å–®

- [ ] Migration å·²æˆåŠŸåŸ·è¡Œ
- [ ] ç´„æŸç´¢å¼•å·²å»ºç«‹ï¼ˆæ­¥é©Ÿ 2 é©—è­‰é€šéï¼‰
- [ ] æ¸¬è©¦è…³æœ¬å…¨éƒ¨é€šéï¼ˆæ­¥é©Ÿ 3ï¼‰
- [ ] API éŒ¯èª¤è™•ç†å·²æ›´æ–°ï¼ˆæ•ç² 23505 éŒ¯èª¤ï¼‰
- [ ] å‰ç«¯éŒ¯èª¤æç¤ºå·²å„ªåŒ–

---

## ğŸ“ é‡åˆ°å•é¡Œï¼Ÿ

### Q1: åŸ·è¡Œ migration æ™‚å‡ºç¾æ¬Šé™éŒ¯èª¤

**è§£æ±ºæ–¹æ³•**ï¼šç¢ºèªæ‚¨åœ¨ Supabase Dashboard çš„ SQL Editor ä¸­åŸ·è¡Œï¼ˆé è¨­ä½¿ç”¨ `postgres` è§’è‰²ï¼‰ã€‚

### Q2: ç´„æŸå·²å­˜åœ¨éŒ¯èª¤

**åŸå› **ï¼šä¹‹å‰å·²åŸ·è¡Œéæ­¤ migrationã€‚

**è§£æ±ºæ–¹æ³•**ï¼šåŸ·è¡Œæ­¥é©Ÿ 2 é©—è­‰ç´„æŸæ˜¯å¦æ­£å¸¸é‹ä½œã€‚

### Q3: æ¸¬è©¦è…³æœ¬å¤±æ•—

**åŸå› **ï¼šå¯èƒ½æ˜¯ï¼š
1. ç´„æŸæœªæ­£ç¢ºå»ºç«‹
2. è³‡æ–™åº«ä¸­å·²æœ‰è¡çªçš„æ¸¬è©¦è³‡æ–™

**è§£æ±ºæ–¹æ³•**ï¼š
1. é‡æ–°åŸ·è¡Œæ­¥é©Ÿ 1 çš„ migration
2. æ¸…ç†æ¸¬è©¦è³‡æ–™ï¼š
   ```sql
   DELETE FROM users WHERE email LIKE 'test_unique_constraint%';
   ```
3. é‡æ–°åŸ·è¡Œæ¸¬è©¦è…³æœ¬

---

**ä¸‹ä¸€æ­¥**ï¼šç¹¼çºŒåŸ·è¡Œ[éšæ®µäºŒï¼šå¯¦ä½œè³‡æ–™åº«äº¤æ˜“å‡½æ•¸](./008-apply-database-transaction.md)ï¼ˆå³å°‡å»ºç«‹ï¼‰
