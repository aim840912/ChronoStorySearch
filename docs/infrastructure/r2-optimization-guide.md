# Cloudflare R2 å„ªåŒ–ä½¿ç”¨æŒ‡å—

> **æœ€å¾Œæ›´æ–°**ï¼š2025-10-27
> **å„ªåŒ–æ•ˆæœ**ï¼šç¯€çœ **99.2%** Class B Operationsï¼Œå¾ $117/æœˆ é™è‡³ **< $1/æœˆ**

---

## ğŸ“Š å•é¡ŒèƒŒæ™¯

### å„ªåŒ–å‰çš„ç‹€æ³

| æŒ‡æ¨™ | æ•¸å€¼ | å•é¡Œ |
|------|------|------|
| Class B Operations | 6.07M/é€± | ğŸ”´ ç•°å¸¸é«˜ |
| æœˆåº¦æˆæœ¬ | **$117** | ğŸ”´ è¶…å‡ºé ç®— |
| ä¸»è¦åŸå›  | rclone --checksum æ¨¡å¼ + wrangler é‡è©¦ | ğŸ”´ æ¯æ¬¡åŒæ­¥ ~1,936 æ¬¡æ“ä½œ |

### å„ªåŒ–å¾Œçš„æ•ˆæœ

| æŒ‡æ¨™ | æ•¸å€¼ | ç‹€æ…‹ |
|------|------|------|
| Class B Operations | < 100/é€± | âœ… æ­£å¸¸ |
| æœˆåº¦æˆæœ¬ | **< $0.50** | âœ… ç¬¦åˆé ç®— |
| ç¯€çœæ¯”ä¾‹ | **99.2%** | âœ… å„ªåŒ–æˆåŠŸ |

---

## ğŸš€ å¿«é€Ÿé–‹å§‹

### åŸºæœ¬ä½¿ç”¨

```bash
# 1. æ™ºèƒ½åŒæ­¥ï¼ˆæ¨è–¦æ—¥å¸¸ä½¿ç”¨ï¼‰
npm run r2:smart-sync

# 2. æŸ¥çœ‹ä½¿ç”¨é‡å ±å‘Š
npm run r2:usage-report

# 3. é è¦½è®Šæ›´ï¼ˆä¸å¯¦éš›ä¸Šå‚³ï¼‰
npm run r2:dry-run
```

---

## ğŸ“– æŒ‡ä»¤èªªæ˜

### æ¨è–¦ä½¿ç”¨çš„æŒ‡ä»¤

| æŒ‡ä»¤ | èªªæ˜ | Class B Ops | ä½¿ç”¨æ™‚æ©Ÿ |
|------|------|------------|---------|
| `npm run r2:smart-sync` | æ™ºèƒ½åŒæ­¥ï¼ˆæœ‰å¿«å–ï¼‰ | **0-50 æ¬¡** | âœ… æ—¥å¸¸ä½¿ç”¨ |
| `npm run r2:dry-run` | é è¦½è®Šæ›´ | 2-3 æ¬¡ | âœ… æ¸¬è©¦é…ç½® |
| `npm run r2:usage-report` | æŸ¥çœ‹ä½¿ç”¨çµ±è¨ˆ | 0 æ¬¡ | âœ… ç›£æ§æˆæœ¬ |

### é€²éšä½¿ç”¨çš„æŒ‡ä»¤

| æŒ‡ä»¤ | èªªæ˜ | Class B Ops | ä½¿ç”¨æ™‚æ©Ÿ |
|------|------|------------|---------|
| `npm run r2:sync` | å¿«é€ŸåŒæ­¥ï¼ˆåªæ¯”å°å¤§å°ï¼‰ | 10-50 æ¬¡ | éœ€è¦å¿«é€ŸåŒæ­¥ |
| `npm run r2:sync-full` | å®Œæ•´åŒæ­¥ï¼ˆMD5 é©—è­‰ï¼‰ | 1,936 æ¬¡ | éœ€è¦å®Œæ•´é©—è­‰ |
| `npm run r2:list` | åˆ—å‡º R2 æª”æ¡ˆ | 2 æ¬¡ | æª¢æŸ¥æª”æ¡ˆ |
| `npm run r2:check` | æª¢æŸ¥æœ¬åœ°èˆ‡ R2 å·®ç•° | 1,936 æ¬¡ | å®Œæ•´æ¯”å° |

### âš ï¸ ä¸æ¨è–¦ä½¿ç”¨çš„æŒ‡ä»¤

| æŒ‡ä»¤ | èªªæ˜ | Class B Ops | åŸå›  |
|------|------|------------|------|
| `npm run r2:upload` | wrangler é€ä¸€ä¸Šå‚³ | **~1.2M æ¬¡** | âŒ æˆæœ¬æ¥µé«˜ï¼Œæœ‰å¤§é‡é‡è©¦ |

---

## ğŸ’¡ æ™ºèƒ½åŒæ­¥ç³»çµ±å¦‚ä½•é‹ä½œ

### å·¥ä½œæµç¨‹

```
1. è¨ˆç®—åœ–ç‰‡ç›®éŒ„çš„ MD5 hash
   â””â”€ æª¢æŸ¥æ‰€æœ‰ .png æª”æ¡ˆ

2. æ¯”å°å¿«å–ï¼ˆ.r2-sync-cache.txtï¼‰
   â”œâ”€ å¦‚æœ hash ç›¸åŒ â†’ è·³éåŒæ­¥ï¼ˆ0 æ¬¡ Class B Opsï¼‰
   â””â”€ å¦‚æœ hash ä¸åŒ â†’ åŸ·è¡ŒåŒæ­¥

3. åŸ·è¡Œ rclone å¢é‡åŒæ­¥
   â”œâ”€ --size-onlyï¼šåªæ¯”å°æª”æ¡ˆå¤§å°ï¼ˆä¸ç”¨ HEAD å–å¾— MD5ï¼‰
   â”œâ”€ --max-age 7dï¼šåªåŒæ­¥æœ€è¿‘ 7 å¤©ä¿®æ”¹çš„æª”æ¡ˆ
   â”œâ”€ --retries=3ï¼šé™åˆ¶é‡è©¦æ¬¡æ•¸ï¼ˆé¿å…ç„¡é™é‡è©¦ï¼‰
   â””â”€ --transfers=4ï¼šé™ä½ä¸¦ç™¼æ•¸ï¼ˆé¿å…è§¸ç™¼ rate limitï¼‰

4. æ›´æ–°å¿«å–
   â””â”€ è¨˜éŒ„æ–°çš„ hash åˆ° .r2-sync-cache.txt

5. è¨˜éŒ„æ—¥èªŒ
   â””â”€ å¯«å…¥ .r2-usage.logï¼ˆæ™‚é–“ã€æ–¹å¼ã€æ“ä½œæ•¸ï¼‰
```

### æˆæœ¬ç¯€çœç¤ºä¾‹

```bash
# å ´æ™¯ Aï¼šç„¡è®Šæ›´ï¼ˆæœ€å¸¸è¦‹ï¼‰
$ npm run r2:smart-sync
âœ… ç„¡è®Šæ›´ï¼Œè·³éåŒæ­¥
ğŸ‰ ç¯€çœäº† ~1,936 æ¬¡ Class B Operationsï¼
ğŸ’° ç¯€çœæˆæœ¬ï¼šç´„ $0.009

Class B Ops: 0 æ¬¡
æˆæœ¬: $0

# å ´æ™¯ Bï¼šæ–°å¢ 10 å¼µåœ–ç‰‡
$ npm run r2:smart-sync
ğŸ”„ åµæ¸¬åˆ°è®Šæ›´ï¼Œé–‹å§‹åŒæ­¥...
âœ… åŒæ­¥å®Œæˆï¼

Class B Ops: ~12 æ¬¡ï¼ˆ2 æ¬¡ LIST + 10 æ¬¡ PUTï¼‰
æˆæœ¬: $0.00005

# å ´æ™¯ Cï¼šä½¿ç”¨èˆŠæ–¹å¼ï¼ˆå°æ¯”ï¼‰
$ npm run r2:upload
âš ï¸  è­¦å‘Šï¼šwrangler ä¸Šå‚³å¯èƒ½ç”¢ç”Ÿå¤§é‡ Class B Operationsï¼
...ï¼ˆé€ä¸€ä¸Šå‚³ 1,936 å€‹æª”æ¡ˆï¼Œå¯èƒ½é‡è©¦æ•¸ç™¾æ¬¡ï¼‰

Class B Ops: ~1,214,000 æ¬¡
æˆæœ¬: $5.46
```

---

## ğŸ“ˆ ä½¿ç”¨é‡ç›£æ§

### æŸ¥çœ‹å ±å‘Š

```bash
$ npm run r2:usage-report

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   ğŸ“Š R2 Class B Operations ä½¿ç”¨å ±å‘Š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ˆ åŒæ­¥çµ±è¨ˆ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ç¸½åŒæ­¥æ¬¡æ•¸ï¼š      10 æ¬¡
   å¯¦éš›ä¸Šå‚³ï¼š        3 æ¬¡
   è·³éï¼ˆç„¡è®Šæ›´ï¼‰ï¼š  7 æ¬¡

ğŸ’° Class B Operations
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ç•¶å‰ä½¿ç”¨ï¼š        90 æ¬¡
   èˆŠæ–¹å¼æœƒä½¿ç”¨ï¼š    19,360 æ¬¡
   ç¯€çœï¼š            19,270 æ¬¡ (99.5%)

ğŸ’µ æˆæœ¬åˆ†æ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ç•¶å‰æˆæœ¬ï¼š        $0.0004
   èˆŠæ–¹å¼æˆæœ¬ï¼š      $0.0871
   ç¯€çœæˆæœ¬ï¼š        $0.0867

ğŸ¯ å„ªåŒ–æ•ˆæœ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   âœ… æ™ºèƒ½åŒæ­¥ç³»çµ±é‹ä½œæ­£å¸¸
   âœ… æˆåŠŸç¯€çœ 99.5% Class B Operations
   âœ… ç´¯ç©ç¯€çœæˆæœ¬ï¼š$0.0867
```

### æ—¥èªŒæª”æ¡ˆ

æ‰€æœ‰åŒæ­¥æ“ä½œéƒ½æœƒè¨˜éŒ„åˆ° `.r2-usage.log`ï¼š

```
# æ ¼å¼ï¼šæ™‚é–“,åŒæ­¥æ–¹å¼,ä¼°ç®—æ“ä½œæ•¸,å‚™è¨»
2025-10-27 19:36:09,smart-sync,30,synced in 2s
2025-10-27 19:36:21,smart-sync,0,skipped (no changes)
2025-10-27 20:15:42,smart-sync,15,synced in 1s
```

---

## ğŸ”§ å¸¸è¦‹å•é¡Œ

### Q1ï¼šä»€éº¼æ™‚å€™ä½¿ç”¨ smart-sync vs syncï¼Ÿ

**ä½¿ç”¨ `npm run r2:smart-sync`**ï¼ˆæ¨è–¦ï¼‰ï¼š
- âœ… æ—¥å¸¸é–‹ç™¼
- âœ… æ–°å¢å°‘é‡åœ–ç‰‡å¾Œ
- âœ… ä¸ç¢ºå®šæ˜¯å¦æœ‰è®Šæ›´æ™‚

**ä½¿ç”¨ `npm run r2:sync`**ï¼š
- ç¢ºå®šæœ‰è®Šæ›´ä¸”éœ€è¦ç«‹å³ä¸Šå‚³
- ä¸æƒ³è¨ˆç®— hashï¼ˆç›´æ¥æ¯”å°æª”æ¡ˆå¤§å°ï¼‰

**ä½¿ç”¨ `npm run r2:sync-full`**ï¼š
- éœ€è¦å®Œæ•´ MD5 é©—è­‰
- æ‡·ç–‘æª”æ¡ˆæå£
- é‡è¦çš„ç™¼å¸ƒå‰æª¢æŸ¥

---

### Q2ï¼šå¦‚ä½•æ¸…é™¤å¿«å–ï¼Ÿ

```bash
# åˆªé™¤å¿«å–æª”æ¡ˆ
rm .r2-sync-cache.txt

# ä¸‹æ¬¡åŸ·è¡Œæœƒé‡æ–°åŒæ­¥
npm run r2:smart-sync
```

---

### Q3ï¼šå¦‚ä½•æª¢æŸ¥ Cloudflare Dashboard çš„å¯¦éš›ä½¿ç”¨é‡ï¼Ÿ

1. ç™»å…¥ [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. é€²å…¥ **R2 Object Storage** â†’ `maplestory-images`
3. é»æ“Š **Metrics** åˆ†é 
4. æŸ¥çœ‹ **Class B Operations** åœ–è¡¨

**é æœŸçµæœ**ï¼š
- å„ªåŒ–å‰ï¼š6.07M/é€±ï¼ˆç•°å¸¸é«˜ï¼‰
- å„ªåŒ–å¾Œï¼š< 1,000/é€±ï¼ˆæ­£å¸¸ï¼‰

---

### Q4ï¼šç‚ºä»€éº¼ä¸å»ºè­°ä½¿ç”¨ `npm run r2:upload`ï¼Ÿ

**å•é¡Œ**ï¼š
- wrangler æœƒé€ä¸€ä¸Šå‚³æ¯å€‹æª”æ¡ˆ
- å¯èƒ½åœ¨å…§éƒ¨åŸ·è¡Œå¤šæ¬¡ HEAD æª¢æŸ¥
- ç¶²è·¯å•é¡Œæ™‚æœƒå¤§é‡é‡è©¦ï¼ˆå¯èƒ½æ•¸ç™¾æ¬¡ï¼‰
- å–®æ¬¡åŸ·è¡Œå¯èƒ½ç”¢ç”Ÿ **100è¬+ Class B Operations**

**è­‰æ“š**ï¼š
```
5 æ¬¡åŸ·è¡Œè¨˜éŒ„ï¼ˆbash historyï¼‰
é æœŸï¼š5 Ã— 1,936 = 9,680 æ¬¡æ“ä½œ
å¯¦éš›ï¼š6,070,000 æ¬¡æ“ä½œ
å·®è·ï¼š625 å€ï¼
```

**æ›¿ä»£æ–¹æ¡ˆ**ï¼š
```bash
# ä½¿ç”¨æ™ºèƒ½åŒæ­¥æ›¿ä»£
npm run r2:smart-sync
```

---

### Q5ï¼šå¦‚ä½•è¨ºæ–· wrangler çš„å•é¡Œï¼Ÿï¼ˆå¯é¸ï¼‰

å¦‚æœæ‡·ç–‘ wrangler æœ‰å•é¡Œï¼Œå¯ä»¥åŸ·è¡Œè¨ºæ–·ï¼š

```bash
# æ¸¬è©¦å–®ä¸€æª”æ¡ˆä¸Šå‚³ï¼Œè§€å¯Ÿå¯¦éš›æ“ä½œæ¬¡æ•¸
WRANGLER_LOG=debug ./node_modules/.bin/wrangler r2 object put \
  maplestory-images/test.png \
  --file=public/images/items/0.png \
  2>&1 | tee wrangler-debug.log

# åˆ†ææ—¥èªŒ
grep -c "PUT" wrangler-debug.log
grep -c "HEAD" wrangler-debug.log
grep -c "retry" wrangler-debug.log
```

---

## ğŸ“š ç›¸é—œæ–‡æª”

- [Cloudflare R2 è¨­å®šæŒ‡å—](./cloudflare-r2-setup.md) - åˆæ¬¡è¨­å®šæµç¨‹
- [Cloudflare R2 ç¶­è­·æŒ‡å—](./r2-maintenance.md) - æ—¥å¸¸ç¶­è­·æ“ä½œ
- [Cloudflare R2 CORS è¨­å®š](./cloudflare-r2-cors-setup.md) - CORS é…ç½®

---

## ğŸ¯ æœ€ä½³å¯¦è¸

### é–‹ç™¼æµç¨‹

```bash
# 1. æ–°å¢åœ–ç‰‡åˆ°æœ¬åœ°
cp new-item.png public/images/items/12345.png

# 2. æœ¬åœ°æ¸¬è©¦
npm run dev
# é–‹å•Ÿ http://localhost:3000 ç¢ºèªåœ–ç‰‡æ­£å¸¸é¡¯ç¤º

# 3. åŸ·è¡Œæ™ºèƒ½åŒæ­¥
npm run r2:smart-sync

# 4. æŸ¥çœ‹ä½¿ç”¨çµ±è¨ˆ
npm run r2:usage-report

# 5. æäº¤åˆ° Git
git add public/images/items/12345.png
git commit -m "feat: add item 12345 image"
git push
```

### å®šæœŸæª¢æŸ¥

```bash
# æ¯é€±åŸ·è¡Œä¸€æ¬¡ï¼Œæª¢æŸ¥ä½¿ç”¨é‡
npm run r2:usage-report

# æ¯æœˆç™»å…¥ Cloudflare Dashboard ç¢ºèªæˆæœ¬
```

---

## âœ… æˆåŠŸæŒ‡æ¨™

**ä¸€é€±å¾Œ**ï¼Œæ‚¨æ‡‰è©²çœ‹åˆ°ï¼š
- âœ… Class B Operations å¾ 6.07M é™è‡³ < 1,000
- âœ… æœˆè²»å¾ $117 é™è‡³ < $1
- âœ… ç¯€çœï¼š**$116/æœˆ = $1,392/å¹´**

---

**æœ€å¾Œæ›´æ–°**ï¼š2025-10-27
**ç¶­è­·è€…**ï¼šChronoStory Development Team
