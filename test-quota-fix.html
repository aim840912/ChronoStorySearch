<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é…é¡ä¿®å¾©æ¸¬è©¦å·¥å…·</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #4CAF50;
      padding-bottom: 10px;
    }
    h2 {
      color: #666;
      margin-top: 0;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
      margin-top: 10px;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .danger {
      background: #f44336;
    }
    .danger:hover {
      background: #da190b;
    }
    .info {
      background: #2196F3;
    }
    .info:hover {
      background: #0b7dda;
    }
    pre {
      background: #f4f4f4;
      padding: 16px;
      border-radius: 4px;
      overflow-x: auto;
      max-height: 400px;
      overflow-y: auto;
    }
    .log {
      margin-top: 16px;
    }
    .success {
      color: #4CAF50;
      font-weight: bold;
    }
    .error {
      color: #f44336;
      font-weight: bold;
    }
    .step {
      background: #e3f2fd;
      padding: 12px;
      border-left: 4px solid #2196F3;
      margin: 16px 0;
    }
  </style>
</head>
<body>
  <h1>ğŸ› ï¸ é…é¡ä¿®å¾©æ¸¬è©¦å·¥å…·</h1>

  <div class="card">
    <h2>ğŸ“‹ æ¸¬è©¦æ­¥é©Ÿ</h2>
    <div class="step">
      <strong>æ­¥é©Ÿ 1:</strong> åŸ·è¡Œé…é¡ä¿®å¾© APIï¼ˆä¿®å¾©ä½ ç›®å‰çš„ 2 å€‹å¹½éˆåˆŠç™»ï¼‰
    </div>
    <div class="step">
      <strong>æ­¥é©Ÿ 2:</strong> æŸ¥è©¢ä½ çš„åˆŠç™»ï¼Œç¢ºèªé…é¡å·²ä¿®å¾©
    </div>
    <div class="step">
      <strong>æ­¥é©Ÿ 3:</strong> æ¸¬è©¦åˆªé™¤åŠŸèƒ½ï¼ˆå»ºç«‹æ¸¬è©¦åˆŠç™»ä¸¦åˆªé™¤ï¼‰
    </div>
  </div>

  <div class="card">
    <h2>ğŸ”§ æ­¥é©Ÿ 1: åŸ·è¡Œé…é¡ä¿®å¾©</h2>
    <p>é»æ“ŠæŒ‰éˆ•åŸ·è¡Œä¿®å¾© APIï¼Œé€™æœƒè‡ªå‹•ä¿®å¾©æ‰€æœ‰ç”¨æˆ¶çš„é…é¡è¨ˆæ•¸å™¨</p>
    <button onclick="runFixQuotas()">åŸ·è¡Œé…é¡ä¿®å¾©</button>
    <div class="log" id="fix-log"></div>
  </div>

  <div class="card">
    <h2>ğŸ” æ­¥é©Ÿ 2: æŸ¥è©¢æˆ‘çš„åˆŠç™»</h2>
    <p>æŸ¥è©¢ä½ çš„åˆŠç™»åˆ—è¡¨ï¼Œç¢ºèªé…é¡æ•¸å­—æ­£ç¢º</p>
    <button class="info" onclick="checkMyListings()">æŸ¥è©¢æˆ‘çš„åˆŠç™»</button>
    <div class="log" id="listings-log"></div>
  </div>

  <div class="card">
    <h2>ğŸ§ª æ­¥é©Ÿ 3: æ¸¬è©¦åˆªé™¤åŠŸèƒ½</h2>
    <p><strong>è­¦å‘Šï¼š</strong>é€™æœƒå»ºç«‹ä¸€å€‹æ¸¬è©¦åˆŠç™»ä¸¦ç«‹å³åˆªé™¤å®ƒï¼Œç”¨æ–¼é©—è­‰é…é¡æ˜¯å¦æ­£ç¢ºæ›´æ–°</p>
    <button class="info" onclick="testDeleteFunction()">æ¸¬è©¦åˆªé™¤åŠŸèƒ½</button>
    <div class="log" id="delete-log"></div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3001';

    function log(elementId, message, isError = false) {
      const element = document.getElementById(elementId);
      const div = document.createElement('div');
      div.className = isError ? 'error' : 'success';
      div.textContent = message;
      element.appendChild(div);
    }

    function logPre(elementId, title, data) {
      const element = document.getElementById(elementId);
      const container = document.createElement('div');
      const strong = document.createElement('strong');
      strong.textContent = title + ':';
      const pre = document.createElement('pre');
      pre.textContent = JSON.stringify(data, null, 2);
      container.appendChild(strong);
      container.appendChild(pre);
      element.appendChild(container);
    }

    function clearLog(elementId) {
      const element = document.getElementById(elementId);
      element.textContent = '';
    }

    async function runFixQuotas() {
      clearLog('fix-log');
      log('fix-log', 'æ­£åœ¨åŸ·è¡Œé…é¡ä¿®å¾©...');

      try {
        const response = await fetch(`${API_BASE}/api/admin/fix-quotas`, {
          method: 'POST',
          credentials: 'include'
        });

        const data = await response.json();

        if (data.success) {
          log('fix-log', 'âœ… ä¿®å¾©æˆåŠŸï¼');
          logPre('fix-log', 'ä¿®å¾©çµæœ', data.data);
          log('fix-log', `æª¢æŸ¥äº† ${data.data.summary.total_users_checked} å€‹ç”¨æˆ¶`);
          log('fix-log', `ä¿®å¾©äº† ${data.data.summary.total_fixed} å€‹ä¸åŒæ­¥çš„é…é¡`);
        } else {
          log('fix-log', `âŒ ä¿®å¾©å¤±æ•—: ${data.error || 'æœªçŸ¥éŒ¯èª¤'}`, true);
        }
      } catch (error) {
        log('fix-log', `âŒ ç¶²è·¯éŒ¯èª¤: ${error.message}`, true);
      }
    }

    async function checkMyListings() {
      clearLog('listings-log');
      log('listings-log', 'æ­£åœ¨æŸ¥è©¢åˆŠç™»...');

      try {
        const response = await fetch(`${API_BASE}/api/listings?status=all`, {
          credentials: 'include'
        });

        const data = await response.json();

        if (data.success) {
          const activeListings = data.data.filter(l => l.status === 'active' && !l.deleted_at);
          const cancelledListings = data.data.filter(l => l.status === 'cancelled' || l.deleted_at);

          log('listings-log', 'âœ… æŸ¥è©¢æˆåŠŸï¼');
          log('listings-log', `æ´»èºåˆŠç™»æ•¸: ${activeListings.length}`);
          log('listings-log', `å·²å–æ¶ˆåˆŠç™»æ•¸: ${cancelledListings.length}`);
          log('listings-log', `ç¸½åˆŠç™»æ•¸: ${data.data.length}`);

          if (activeListings.length > 0) {
            logPre('listings-log', 'æ´»èºåˆŠç™»åˆ—è¡¨', activeListings.map(l => ({
              id: l.id,
              item_id: l.item_id,
              trade_type: l.trade_type,
              created_at: l.created_at
            })));
          }
        } else {
          log('listings-log', `âŒ æŸ¥è©¢å¤±æ•—: ${data.error || 'æœªçŸ¥éŒ¯èª¤'}`, true);
        }
      } catch (error) {
        log('listings-log', `âŒ ç¶²è·¯éŒ¯èª¤: ${error.message}`, true);
      }
    }

    async function testDeleteFunction() {
      clearLog('delete-log');
      log('delete-log', 'é–‹å§‹æ¸¬è©¦åˆªé™¤åŠŸèƒ½...');

      try {
        // æ­¥é©Ÿ 1: å»ºç«‹æ¸¬è©¦åˆŠç™»
        log('delete-log', 'æ­¥é©Ÿ 1: å»ºç«‹æ¸¬è©¦åˆŠç™»...');
        const createResponse = await fetch(`${API_BASE}/api/listings`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            trade_type: 'sell',
            item_id: 1002140, // æ¸¬è©¦ç‰©å“
            quantity: 1,
            price: 1000
          })
        });

        const createData = await createResponse.json();

        if (!createData.success) {
          log('delete-log', `âŒ å»ºç«‹åˆŠç™»å¤±æ•—: ${createData.error}`, true);
          return;
        }

        const listingId = createData.data.id;
        log('delete-log', `âœ… æ¸¬è©¦åˆŠç™»å»ºç«‹æˆåŠŸ (ID: ${listingId})`);

        // ç­‰å¾… 1 ç§’
        await new Promise(resolve => setTimeout(resolve, 1000));

        // æ­¥é©Ÿ 2: æŸ¥è©¢é…é¡ï¼ˆåˆªé™¤å‰ï¼‰
        log('delete-log', 'æ­¥é©Ÿ 2: æŸ¥è©¢é…é¡ï¼ˆåˆªé™¤å‰ï¼‰...');
        let beforeResponse = await fetch(`${API_BASE}/api/listings?status=active`, {
          credentials: 'include'
        });
        let beforeData = await beforeResponse.json();
        const beforeCount = beforeData.data.length;
        log('delete-log', `åˆªé™¤å‰æ´»èºåˆŠç™»æ•¸: ${beforeCount}`);

        // æ­¥é©Ÿ 3: åˆªé™¤åˆŠç™»
        log('delete-log', 'æ­¥é©Ÿ 3: åˆªé™¤æ¸¬è©¦åˆŠç™»...');
        const deleteResponse = await fetch(`${API_BASE}/api/listings/${listingId}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        const deleteData = await deleteResponse.json();

        if (!deleteData.success) {
          log('delete-log', `âŒ åˆªé™¤å¤±æ•—: ${deleteData.error}`, true);
          return;
        }

        log('delete-log', 'âœ… åˆŠç™»åˆªé™¤æˆåŠŸ');

        // ç­‰å¾… 1 ç§’
        await new Promise(resolve => setTimeout(resolve, 1000));

        // æ­¥é©Ÿ 4: æŸ¥è©¢é…é¡ï¼ˆåˆªé™¤å¾Œï¼‰
        log('delete-log', 'æ­¥é©Ÿ 4: æŸ¥è©¢é…é¡ï¼ˆåˆªé™¤å¾Œï¼‰...');
        let afterResponse = await fetch(`${API_BASE}/api/listings?status=active`, {
          credentials: 'include'
        });
        let afterData = await afterResponse.json();
        const afterCount = afterData.data.length;
        log('delete-log', `åˆªé™¤å¾Œæ´»èºåˆŠç™»æ•¸: ${afterCount}`);

        // é©—è­‰
        if (afterCount === beforeCount - 1) {
          log('delete-log', `âœ… æ¸¬è©¦é€šéï¼é…é¡æ­£ç¢ºéæ¸›ï¼ˆ${beforeCount} â†’ ${afterCount}ï¼‰`);
        } else {
          log('delete-log', `âŒ æ¸¬è©¦å¤±æ•—ï¼é…é¡æ²’æœ‰æ­£ç¢ºæ›´æ–°ï¼ˆ${beforeCount} â†’ ${afterCount}ï¼‰`, true);
        }

      } catch (error) {
        log('delete-log', `âŒ æ¸¬è©¦éŒ¯èª¤: ${error.message}`, true);
      }
    }
  </script>
</body>
</html>
