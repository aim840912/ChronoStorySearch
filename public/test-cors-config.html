<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CORS é…ç½®é©—è­‰å·¥å…· - ChronoStory</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 40px;
      max-width: 900px;
      width: 100%;
    }
    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 28px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f7fafc;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }
    .section h2 {
      color: #2d3748;
      font-size: 18px;
      margin-bottom: 15px;
    }
    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    button {
      flex: 1;
      min-width: 200px;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-primary {
      background: #667eea;
      color: white;
    }
    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
    }
    .btn-primary:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
      transform: none;
    }
    .results {
      margin-top: 20px;
    }
    .test-item {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-name {
      font-weight: 600;
      color: #2d3748;
    }
    .test-status {
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .status-pending {
      background: #e2e8f0;
      color: #4a5568;
    }
    .status-running {
      background: #bee3f8;
      color: #2c5282;
      animation: pulse 2s infinite;
    }
    .status-success {
      background: #c6f6d5;
      color: #22543d;
    }
    .status-error {
      background: #fed7d7;
      color: #742a2a;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    .summary {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }
    .summary-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e2e8f0;
    }
    .summary-item:last-child {
      border-bottom: none;
    }
    .summary-label {
      color: #4a5568;
      font-weight: 500;
    }
    .summary-value {
      font-weight: 600;
    }
    .success-value {
      color: #22543d;
    }
    .error-value {
      color: #742a2a;
    }
    .log {
      background: #1a202c;
      color: #48bb78;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
      line-height: 1.6;
    }
    .log-entry {
      margin-bottom: 5px;
      display: flex;
      align-items: flex-start;
    }
    .log-time {
      color: #718096;
      margin-right: 10px;
      flex-shrink: 0;
    }
    .log-success { color: #48bb78; }
    .log-error { color: #f56565; }
    .log-info { color: #4299e1; }
    .log-warning { color: #ed8936; }
    .instructions {
      background: #fffbeb;
      border: 1px solid #fbbf24;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .instructions h3 {
      color: #92400e;
      font-size: 14px;
      margin-bottom: 10px;
    }
    .instructions p {
      color: #78350f;
      font-size: 13px;
      line-height: 1.8;
      margin-bottom: 8px;
    }
    .instructions code {
      background: #fef3c7;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” CORS é…ç½®é©—è­‰å·¥å…·</h1>
    <p class="subtitle">Cloudflare R2 CORS Configuration Validator</p>

    <div class="instructions">
      <h3>ğŸ“‹ ä½¿ç”¨èªªæ˜</h3>
      <p>1. è«‹å…ˆæŒ‰ç…§ <code>docs/cloudflare-r2-cors-setup.md</code> å®Œæˆ CORS é…ç½®</p>
      <p>2. é»æ“Šã€Œé–‹å§‹é©—è­‰ã€æŒ‰éˆ•åŸ·è¡Œæ¸¬è©¦</p>
      <p>3. æŸ¥çœ‹æ¸¬è©¦çµæœå’Œè©³ç´°æ—¥èªŒ</p>
      <p>4. æ‰€æœ‰æ¸¬è©¦é€šéå³è¡¨ç¤º CORS é…ç½®æˆåŠŸ</p>
    </div>

    <div class="section">
      <h2>ğŸ§ª æ¸¬è©¦é …ç›®</h2>
      <div class="button-group">
        <button class="btn-primary" id="startBtn" onclick="runAllTests()">ğŸš€ é–‹å§‹é©—è­‰</button>
      </div>
      <div class="results" id="results"></div>
    </div>

    <div class="section" id="summarySection" style="display: none;">
      <h2>ğŸ“Š æ¸¬è©¦ç¸½çµ</h2>
      <div class="summary" id="summary"></div>
    </div>

    <div class="section">
      <h2>ğŸ“ è©³ç´°æ—¥èªŒ</h2>
      <div id="log" class="log">
        <div class="log-entry">
          <span class="log-time">[ç³»çµ±]</span>
          <span class="log-info">ç­‰å¾…é–‹å§‹æ¸¬è©¦...</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // R2 å…¬é–‹ URL
    const R2_PUBLIC_URL = 'https://pub-a1c4c32d4c65452098ab977db77e349e.r2.dev';

    // æ¸¬è©¦é …ç›®
    const tests = [
      {
        id: 'fetch-image',
        name: 'æ¸¬è©¦ 1ï¼šFetch API è¼‰å…¥åœ–ç‰‡',
        fn: testFetchImage
      },
      {
        id: 'blob-conversion',
        name: 'æ¸¬è©¦ 2ï¼šBlob è½‰æ›',
        fn: testBlobConversion
      },
      {
        id: 'cors-headers',
        name: 'æ¸¬è©¦ 3ï¼šCORS æ¨™é ­é©—è­‰',
        fn: testCorsHeaders
      },
      {
        id: 'multiple-origins',
        name: 'æ¸¬è©¦ 4ï¼šç•¶å‰ Origin æ¸¬è©¦',
        fn: testCurrentOrigin
      }
    ];

    let testResults = {
      total: tests.length,
      passed: 0,
      failed: 0,
      details: []
    };

    function log(message, type = 'info') {
      const logEl = document.getElementById('log');
      const time = new Date().toLocaleTimeString('zh-TW', { hour12: false });
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `
        <span class="log-time">[${time}]</span>
        <span class="log-${type}">${message}</span>
      `;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function updateTestStatus(testId, status) {
      const testEl = document.getElementById(`test-${testId}`);
      if (!testEl) return;

      const statusEl = testEl.querySelector('.test-status');
      statusEl.className = `test-status status-${status}`;

      const statusText = {
        'pending': 'â³ å¾…æ¸¬è©¦',
        'running': 'ğŸ”„ æ¸¬è©¦ä¸­',
        'success': 'âœ… é€šé',
        'error': 'âŒ å¤±æ•—'
      };
      statusEl.textContent = statusText[status] || status;
    }

    function renderTestItems() {
      const resultsEl = document.getElementById('results');
      resultsEl.innerHTML = tests.map(test => `
        <div class="test-item" id="test-${test.id}">
          <span class="test-name">${test.name}</span>
          <span class="test-status status-pending">â³ å¾…æ¸¬è©¦</span>
        </div>
      `).join('');
    }

    async function testFetchImage() {
      const testUrl = `${R2_PUBLIC_URL}/images/items/1062002.png`;
      log(`æ­£åœ¨æ¸¬è©¦ Fetch APIï¼š${testUrl}`, 'info');

      const response = await fetch(testUrl, {
        method: 'GET',
        mode: 'cors'
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      log(`âœ“ Fetch è«‹æ±‚æˆåŠŸï¼šHTTP ${response.status}`, 'success');
      return { success: true, status: response.status };
    }

    async function testBlobConversion() {
      const testUrl = `${R2_PUBLIC_URL}/images/items/1062002.png`;
      log('æ­£åœ¨æ¸¬è©¦ Blob è½‰æ›...', 'info');

      const response = await fetch(testUrl, { mode: 'cors' });
      const blob = await response.blob();

      if (blob.size === 0) {
        throw new Error('Blob å¤§å°ç‚º 0');
      }

      const blobUrl = URL.createObjectURL(blob);
      log(`âœ“ Blob è½‰æ›æˆåŠŸï¼š${blob.size} bytes, URL: ${blobUrl.substring(0, 50)}...`, 'success');
      URL.revokeObjectURL(blobUrl);

      return { success: true, blobSize: blob.size };
    }

    async function testCorsHeaders() {
      const testUrl = `${R2_PUBLIC_URL}/images/items/1062002.png`;
      log('æ­£åœ¨æª¢æŸ¥ CORS æ¨™é ­...', 'info');

      const response = await fetch(testUrl, { mode: 'cors' });

      const requiredHeaders = [
        'access-control-allow-origin',
        'content-type'
      ];

      const headers = {};
      requiredHeaders.forEach(header => {
        headers[header] = response.headers.get(header);
      });

      log(`âœ“ CORS æ¨™é ­ï¼š`, 'info');
      Object.entries(headers).forEach(([key, value]) => {
        log(`  - ${key}: ${value || '(æœªè¨­å®š)'}`, value ? 'success' : 'warning');
      });

      if (!headers['access-control-allow-origin']) {
        throw new Error('ç¼ºå°‘ Access-Control-Allow-Origin æ¨™é ­');
      }

      return { success: true, headers };
    }

    async function testCurrentOrigin() {
      const currentOrigin = window.location.origin;
      log(`æ­£åœ¨æ¸¬è©¦ç•¶å‰ Originï¼š${currentOrigin}`, 'info');

      const testUrl = `${R2_PUBLIC_URL}/images/items/1062002.png`;
      const response = await fetch(testUrl, { mode: 'cors' });

      const allowOrigin = response.headers.get('access-control-allow-origin');

      if (allowOrigin === '*' || allowOrigin === currentOrigin) {
        log(`âœ“ ç•¶å‰ Origin å·²è¢«å…è¨±`, 'success');
        return { success: true, allowOrigin };
      } else {
        throw new Error(`Origin ä¸åŒ¹é…ï¼šæœŸæœ› ${currentOrigin}ï¼Œå¯¦éš› ${allowOrigin}`);
      }
    }

    async function runAllTests() {
      // é‡ç½®
      testResults = {
        total: tests.length,
        passed: 0,
        failed: 0,
        details: []
      };

      const startBtn = document.getElementById('startBtn');
      startBtn.disabled = true;
      startBtn.textContent = 'ğŸ”„ æ¸¬è©¦é€²è¡Œä¸­...';

      document.getElementById('summarySection').style.display = 'none';
      renderTestItems();

      log('=== é–‹å§‹ CORS é…ç½®é©—è­‰ ===', 'info');
      log(`æ¸¬è©¦é …ç›®æ•¸ï¼š${tests.length}`, 'info');
      log('', 'info');

      for (const test of tests) {
        updateTestStatus(test.id, 'running');
        log(`â–¶ ${test.name}`, 'info');

        try {
          const result = await test.fn();
          updateTestStatus(test.id, 'success');
          log(`âœ… ${test.name} - é€šé`, 'success');

          testResults.passed++;
          testResults.details.push({
            test: test.name,
            status: 'success',
            result
          });
        } catch (error) {
          updateTestStatus(test.id, 'error');
          log(`âŒ ${test.name} - å¤±æ•—ï¼š${error.message}`, 'error');

          testResults.failed++;
          testResults.details.push({
            test: test.name,
            status: 'error',
            error: error.message
          });
        }

        log('', 'info');
      }

      // é¡¯ç¤ºç¸½çµ
      showSummary();

      startBtn.disabled = false;
      startBtn.textContent = 'ğŸ”„ é‡æ–°æ¸¬è©¦';
    }

    function showSummary() {
      const summarySection = document.getElementById('summarySection');
      const summaryEl = document.getElementById('summary');

      summarySection.style.display = 'block';

      const passRate = ((testResults.passed / testResults.total) * 100).toFixed(0);
      const allPassed = testResults.failed === 0;

      summaryEl.innerHTML = `
        <div class="summary-item">
          <span class="summary-label">ç¸½æ¸¬è©¦æ•¸ï¼š</span>
          <span class="summary-value">${testResults.total}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">é€šéï¼š</span>
          <span class="summary-value success-value">${testResults.passed}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">å¤±æ•—ï¼š</span>
          <span class="summary-value error-value">${testResults.failed}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">é€šéç‡ï¼š</span>
          <span class="summary-value ${allPassed ? 'success-value' : 'error-value'}">${passRate}%</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">æ¸¬è©¦çµæœï¼š</span>
          <span class="summary-value ${allPassed ? 'success-value' : 'error-value'}">
            ${allPassed ? 'âœ… å…¨éƒ¨é€šé' : 'âŒ æœ‰æ¸¬è©¦å¤±æ•—'}
          </span>
        </div>
      `;

      if (allPassed) {
        log('', 'info');
        log('ğŸ‰ æ­å–œï¼æ‰€æœ‰æ¸¬è©¦é€šéï¼ŒCORS é…ç½®æ­£ç¢ºï¼', 'success');
        log('æ‚¨ç¾åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨åœ–ç‰‡å¿«å–ç³»çµ±äº†ã€‚', 'success');
      } else {
        log('', 'info');
        log('âš ï¸ éƒ¨åˆ†æ¸¬è©¦å¤±æ•—ï¼Œè«‹æª¢æŸ¥ CORS é…ç½®ã€‚', 'warning');
        log('è«‹åƒè€ƒ docs/cloudflare-r2-cors-setup.md é€²è¡Œé…ç½®ã€‚', 'warning');
      }
    }

    // åˆå§‹åŒ–
    renderTestItems();
    log('CORS é©—è­‰å·¥å…·å·²å°±ç·’', 'success');
    log(`ç•¶å‰ Originï¼š${window.location.origin}`, 'info');
    log(`ç›®æ¨™ R2 URLï¼š${R2_PUBLIC_URL}`, 'info');
    log('', 'info');
  </script>
</body>
</html>
